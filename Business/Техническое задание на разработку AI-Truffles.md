# Техническое задание на разработку AI-платформы Truffles v1.0

## Комплексный путеводитель по реализации проекта

---

# ЧАСТЬ I: СТРАТЕГИЧЕСКИЙ ФУНДАМЕНТ

---

## 1. Введение и цели документа

### 1.1. Назначение документа

Настоящий документ является **мастер-путеводителем** для поэтапной реализации AI-платформы Truffles. Он не содержит детального кода, но предоставляет исчерпывающую архитектурную карту, последовательность действий и критерии успеха для каждого этапа.

**Документ предназначен для:**
- Самостоятельной реализации основателем проекта
- Делегирования задач LLM-агентам (Claude, GPT, Gemini)
- Постановки задач фрилансерам и подрядчикам
- Контроля прогресса и качества

### 1.2. Структура использования

```
┌─────────────────────────────────────────────────────────────────┐
│                    КАК РАБОТАТЬ С ДОКУМЕНТОМ                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. Читаете раздел текущей фазы                                │
│  2. Выполняете задачи по чек-листу                             │
│  3. Проверяете по критериям приёмки                            │
│  4. Переходите к следующей фазе                                │
│                                                                 │
│  При работе с LLM-агентом:                                     │
│  → Копируете описание задачи из документа                      │
│  → Добавляете контекст текущего состояния                      │
│  → Получаете конкретную реализацию                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3. Ключевые метрики успеха проекта

| Метрика | Целевое значение | Срок |
|---------|------------------|------|
| MVP готов к первым клиентам | Да | 6 недель |
| Первые 5 платящих клиентов | SaaS Starter | 10 недель |
| Время развёртывания нового клиента | < 30 минут | 8 недель |
| Uptime платформы | > 99% | Постоянно |
| Стоимость AI на 1 диалог | < 5 ₸ | 8 недель |

---

## 2. Бизнес-контекст и требования

### 2.1. Описание продукта

**Truffles** — это AI-платформа для автоматизации бизнес-коммуникаций в WhatsApp/Instagram с интеграцией Kaspi Pay, ориентированная на малый и средний бизнес Казахстана.

### 2.2. Целевые сегменты

```
┌─────────────────────────────────────────────────────────────────┐
│                      СЕГМЕНТЫ РЫНКА                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  СЕГМЕНТ 1: МСБ (SaaS)                                         │
│  ├── Салоны красоты                                            │
│  ├── Instagram-магазины                                        │
│  ├── Автосервисы                                               │
│  ├── Доставка еды                                              │
│  └── Стоматологии                                              │
│                                                                 │
│  СЕГМЕНТ 2: Mid-Market (SaaS Pro / Лицензия)                   │
│  ├── Сети магазинов                                            │
│  ├── Логистические компании                                    │
│  └── Медицинские центры                                        │
│                                                                 │
│  СЕГМЕНТ 3: Enterprise (On-Premise)                            │
│  ├── Банки                                                     │
│  ├── Страховые компании                                        │
│  └── Квазигосударственные структуры                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3. Ключевые бизнес-требования

| Требование | Приоритет | Обоснование |
|------------|-----------|-------------|
| Интеграция WhatsApp Business API | Критический | Основной канал коммуникации в КЗ |
| Интеграция Kaspi Pay | Критический | Автопроверка оплаты — главное УТП |
| AI-ответы на базе знаний | Критический | Отличие от сценарных ботов |
| Локализация данных в КЗ | Высокий | Требование закона 2025 |
| Мультитенантность | Высокий | Масштабирование SaaS |
| Панель управления | Высокий | Самообслуживание клиентов |
| Интеграция CRM | Средний | Расширение функционала Pro |

### 2.4. Регуляторные ограничения

**Закон РК «О персональных данных» (редакция 2025):**
- Хранение ПДн граждан РК на территории РК
- Уведомление об инцидентах в течение 24 часов
- Ведение реестра обработки данных

**Технические следствия:**
- Серверы только в казахстанских ЦОД (PS.kz, Kazteleport)
- Логирование всех операций с ПДн
- Возможность экспорта/удаления данных клиента

---

## 3. Архитектурная стратегия

### 3.1. Выбор архитектурного паттерна

**Решение: Multi-Instance (Dedicated Stack per Client)**

Каждый клиент получает изолированный набор контейнеров Docker. Это не «виртуальная изоляция» на уровне базы данных, а физическое разделение процессов.

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПОЧЕМУ MULTI-INSTANCE                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ✓ Гарантированная изоляция данных (требование закона)         │
│  ✓ Нет «шумного соседа» (один клиент не влияет на других)     │
│  ✓ Возможность On-Premise (тот же стек у клиента)             │
│  ✓ Независимое масштабирование каждого клиента                │
│  ✓ Простота диагностики проблем                                │
│                                                                 │
│  Компромисс:                                                    │
│  × Больше ресурсов на инфраструктуру                          │
│  × Сложнее управление (решается автоматизацией)               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2. Высокоуровневая архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                         ИНТЕРНЕТ                                │
│                            │                                    │
│                    ┌───────▼───────┐                           │
│                    │   Cloudflare   │ ← SSL, DDoS, CDN         │
│                    │     DNS        │                           │
│                    └───────┬───────┘                           │
│                            │                                    │
├────────────────────────────┼────────────────────────────────────┤
│                     HOST SERVER                                 │
│                            │                                    │
│                    ┌───────▼───────┐                           │
│                    │    Traefik    │ ← Reverse Proxy           │
│                    │   (Host)      │   SSL Termination         │
│                    └───────┬───────┘                           │
│                            │                                    │
│         ┌──────────────────┼──────────────────┐                │
│         │                  │                  │                │
│  ┌──────▼──────┐   ┌──────▼──────┐   ┌──────▼──────┐         │
│  │  Client A   │   │  Client B   │   │  Client C   │         │
│  │    Stack    │   │    Stack    │   │    Stack    │         │
│  └─────────────┘   └─────────────┘   └─────────────┘         │
│                                                                 │
│  Каждый Stack = изолированная сеть + свои volumes              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3. Компоненты клиентского стека

**Минимальный стек (MVP):**

| Компонент | Технология | Назначение |
|-----------|------------|------------|
| Оркестратор | n8n | Бизнес-логика, воркфлоу, интеграции |
| База данных | PostgreSQL | Хранение данных приложения |
| Векторная БД | Qdrant | RAG, семантический поиск по базе знаний |
| Кэш | Redis | Сессии, очереди, pub/sub |
| Прокси | Traefik | Маршрутизация, SSL |

**Расширенный стек (Pro/Enterprise):**

| Компонент | Технология | Назначение |
|-----------|------------|------------|
| Локальный LLM | Ollama | Обработка чувствительных данных локально |
| Аутентификация | Authentik | SSO, интеграция с корпоративными IdP |
| Мониторинг | Prometheus + Grafana | Метрики, алерты |
| Туннель | Cloudflare Tunnel | On-Premise без открытых портов |

### 3.4. Принцип «Фабрики»

Платформа функционирует как **фабрика**, способная автоматически производить изолированные окружения:

```
┌─────────────────────────────────────────────────────────────────┐
│                     ФАБРИКА ОКРУЖЕНИЙ                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ВХОД:                                                          │
│  ├── Имя клиента (slug)                                        │
│  ├── Выбранные модули                                          │
│  └── Конфигурация (домен, ключи API)                           │
│                                                                 │
│  ПРОЦЕСС:                                                       │
│  ├── 1. Генерация секретов                                     │
│  ├── 2. Рендеринг конфигурации                                 │
│  ├── 3. Развёртывание контейнеров                              │
│  ├── 4. Инъекция воркфлоу                                      │
│  └── 5. Настройка маршрутизации                                │
│                                                                 │
│  ВЫХОД:                                                         │
│  └── Готовое изолированное окружение                           │
│      → https://clientname.truffles.kz                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. Модульная система

### 4.1. Концепция модулей

**Модуль** — это самодостаточная единица функциональности, которая может быть включена или выключена для конкретного клиента.

```
┌─────────────────────────────────────────────────────────────────┐
│                      СТРУКТУРА МОДУЛЯ                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  modules/                                                       │
│  └── integration_kaspi/                                        │
│      ├── manifest.json         ← Метаданные модуля             │
│      ├── workflows/                                            │
│      │   └── kaspi_payment.json  ← n8n workflow                │
│      ├── migrations/                                           │
│      │   └── 001_create_payments.sql ← Схема БД               │
│      ├── credentials/                                          │
│      │   └── kaspi_api.template.json ← Шаблон credentials     │
│      └── README.md             ← Документация                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2. Каталог модулей

| Модуль | Тариф | Описание |
|--------|-------|----------|
| **core_chat** | Все | Базовый AI-чат с RAG |
| **core_admin** | Все | Панель управления |
| **channel_whatsapp** | Все | Интеграция WhatsApp Business API |
| **channel_instagram** | Pro | Instagram Direct Messages |
| **channel_telegram** | Pro | Telegram Bot API |
| **integration_kaspi** | Pro | Kaspi Pay уведомления |
| **integration_amocrm** | Pro | Интеграция AmoCRM |
| **integration_bitrix** | Pro | Интеграция Bitrix24 |
| **integration_1c** | Enterprise | Интеграция 1С:Предприятие |
| **feature_broadcasts** | Pro | Массовые рассылки |
| **feature_analytics** | Pro | Расширенная аналитика |
| **security_sso** | Enterprise | Single Sign-On (SAML/OIDC) |
| **sovereign_llm** | Enterprise | Локальный LLM (Ollama) |

### 4.3. Принцип «Zero-State»

**Каждое новое окружение создаётся с нуля:**
- Никогда не клонируем существующую базу данных
- Никогда не копируем volumes другого клиента
- Все секреты генерируются уникальными
- Все credentials создаются заново

Это гарантирует, что данные одного клиента никогда не окажутся в окружении другого.

---

## 5. Экономическая модель AI

### 5.1. Проблема юнит-экономики AI

```
┌─────────────────────────────────────────────────────────────────┐
│                  ЭКОНОМИКА ТРАДИЦИОННОГО SAAS                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Клиент платит:     $100/мес                                   │
│  Стоимость сервера: ~$10/мес (фиксированная)                   │
│  Маржа:             ~90%                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    ЭКОНОМИКА AI-ПЛАТФОРМЫ                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Клиент платит:     $100/мес                                   │
│  Стоимость сервера: ~$10/мес                                   │
│  Стоимость токенов: $5-500/мес (ПЕРЕМЕННАЯ!)                   │
│  Маржа:             от -400% до +85%                           │
│                                                                 │
│  ⚠️ Без контроля — убыточность гарантирована                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2. Решение: Model Router

**Model Router** — компонент, который направляет каждый запрос к оптимальной по стоимости модели:

```
┌─────────────────────────────────────────────────────────────────┐
│                      ЛОГИКА МАРШРУТИЗАЦИИ                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ВХОДЯЩЕЕ СООБЩЕНИЕ                                            │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐                                               │
│  │ Классификатор│ ← Gemini 2.0 Flash ($0.30/1M tokens)         │
│  │   интентов   │                                               │
│  └──────┬──────┘                                               │
│         │                                                       │
│         ├─── Приветствие ────→ Шаблон (бесплатно)              │
│         │                                                       │
│         ├─── Простой FAQ ────→ RAG + Gemini Flash ($0.30/1M)   │
│         │                                                       │
│         ├─── Сложный вопрос ──→ RAG + GPT-4.1 ($2.00/1M)       │
│         │                                                       │
│         └─── Чувствит. данные → Локальный Llama (бесплатно)    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3. Таблица стоимости моделей

| Модель | Провайдер | Input/1M tokens | Output/1M tokens | Применение |
|--------|-----------|-----------------|------------------|------------|
| Gemini 2.0 Flash | Google | $0.30 | $0.30 | 80% трафика: FAQ, рутина |
| GPT-4.1 mini | OpenAI | $0.40 | $1.60 | Сложные FAQ, извлечение данных |
| GPT-4.1 | OpenAI | $2.00 | $8.00 | Сложные рассуждения, продажи |
| Claude Sonnet 4 | Anthropic | $3.00 | $15.00 | Длинные тексты, нюансы |
| Llama 3.3 (Ollama) | Local | $0.00 | $0.00 | ПДн, суверенные данные |

### 5.4. Биллинг и учёт

**Каждый вызов LLM логируется:**

```sql
INSERT INTO billing_events (
    tenant_id,
    model_provider,
    model_name,
    input_tokens,
    output_tokens,
    cost_usd
) VALUES (
    'client-a',
    'openai',
    'gpt-4o-mini',
    150,
    300,
    0.000203
);
```

**Это позволяет:**
- Видеть расходы по каждому клиенту
- Устанавливать лимиты и алерты
- Оптимизировать промпты
- Биллить клиентов по потреблению (если нужно)

---

# ЧАСТЬ II: ПЛАН РЕАЛИЗАЦИИ ПО ФАЗАМ

---

## Фаза 0: Подготовка инфраструктуры

**Длительность:** 3-5 дней

### 0.1. Цели фазы

- Настроить рабочее окружение разработчика
- Развернуть базовый сервер
- Подготовить систему контроля версий
- Настроить домен и DNS

### 0.2. Задачи

#### 0.2.1. Локальное окружение

```
□ Установить Docker Desktop (или Docker Engine для Linux)
□ Установить Git
□ Установить VS Code + расширения:
  ├── Docker
  ├── YAML
  ├── PostgreSQL
  └── Remote - SSH
□ Настроить терминал (iTerm2 / Windows Terminal)
□ Создать SSH-ключи для серверов
```

#### 0.2.2. Облачная инфраструктура

```
□ Арендовать VPS в Казахстане:
  ├── Провайдер: PS.kz или Kazteleport
  ├── Минимум: 4 vCPU, 8 GB RAM, 100 GB SSD
  └── ОС: Ubuntu 22.04 LTS

□ Настроить сервер:
  ├── Обновить систему
  ├── Создать пользователя (не root)
  ├── Настроить SSH (отключить вход по паролю)
  ├── Установить Docker + Docker Compose
  ├── Настроить firewall (UFW)
  └── Установить fail2ban

□ Купить домен truffles.kz (если ещё нет)
□ Настроить DNS:
  ├── A-запись: @ → IP сервера
  ├── A-запись: *.truffles.kz → IP сервера (wildcard)
  └── Включить Cloudflare (proxy)
```

#### 0.2.3. Репозиторий

```
□ Создать приватный репозиторий GitHub/GitLab
□ Структура папок:
  
  truffles-platform/
  ├── docker/                    # Docker конфигурации
  │   ├── base/                  # Базовые сервисы (Traefik)
  │   └── client-template/       # Шаблон клиентского стека
  ├── modules/                   # Модули платформы
  │   ├── core_chat/
  │   ├── core_admin/
  │   └── integration_kaspi/
  ├── scripts/                   # Скрипты автоматизации
  │   ├── provision.sh
  │   └── backup.sh
  ├── docs/                      # Документация
  └── .env.example              # Пример переменных окружения

□ Настроить .gitignore (секреты, volumes, .env)
□ Первый коммит со структурой
```

### 0.3. Критерии приёмки фазы 0

```
✓ Можно подключиться к серверу по SSH
✓ Docker и Docker Compose работают на сервере
✓ Домен резолвится на IP сервера
✓ Репозиторий создан и склонирован локально
✓ Базовая структура папок в репозитории
```

---

## Фаза 1: Базовая инфраструктура (Host Level)

**Длительность:** 5-7 дней

### 1.1. Цели фазы

- Развернуть Traefik как центральный reverse proxy
- Настроить автоматические SSL-сертификаты
- Создать сеть для клиентских стеков
- Развернуть первый тестовый клиентский стек

### 1.2. Задачи

#### 1.2.1. Host Traefik

**Файл:** `docker/base/docker-compose.yml`

**Что должно быть настроено:**
- Traefik v3 как единая точка входа
- Автоматические SSL через Let's Encrypt
- Dashboard (защищённый паролем)
- Docker provider для автообнаружения контейнеров

**Ключевые параметры:**
```yaml
# Порты
- "80:80"      # HTTP (редирект на HTTPS)
- "443:443"   # HTTPS

# Сети
networks:
  - web_gateway  # Публичная сеть для клиентов

# Volumes
volumes:
  - ./letsencrypt:/letsencrypt  # SSL сертификаты
  - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker API
```

#### 1.2.2. Шаблон клиентского стека

**Файл:** `docker/client-template/docker-compose.yml`

**Контейнеры MVP:**
1. **n8n** — оркестратор воркфлоу
2. **PostgreSQL** — база данных
3. **Qdrant** — векторная база для RAG
4. **Redis** — кэш и очереди

**Ключевые принципы:**
```yaml
# НЕ использовать container_name!
# Использовать проект для изоляции: docker compose -p client_slug up

# Сети
networks:
  web_gateway:
    external: true      # Для Traefik
  internal:
    driver: bridge      # Приватная сеть стека

# Volumes — уникальные для каждого клиента
volumes:
  pg_data:
  n8n_data:
  qdrant_data:
  redis_data:
```

**Traefik Labels для n8n:**
```yaml
labels:
  - "traefik.enable=true"
  - "traefik.http.routers.${CLIENT_SLUG}-n8n.rule=Host(`${CLIENT_SLUG}.truffles.kz`)"
  - "traefik.http.routers.${CLIENT_SLUG}-n8n.tls=true"
  - "traefik.http.routers.${CLIENT_SLUG}-n8n.tls.certresolver=letsencrypt"
```

#### 1.2.3. Скрипт провизионирования (MVP)

**Файл:** `scripts/provision.sh`

**Логика:**
```bash
#!/bin/bash
# Использование: ./provision.sh client-slug

CLIENT_SLUG=$1

# 1. Генерация секретов
POSTGRES_PASSWORD=$(openssl rand -base64 32)
N8N_ENCRYPTION_KEY=$(openssl rand -hex 32)

# 2. Создание .env файла
cat > /opt/clients/${CLIENT_SLUG}/.env << EOF
CLIENT_SLUG=${CLIENT_SLUG}
POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
...
EOF

# 3. Копирование шаблона
cp -r /opt/templates/client-template /opt/clients/${CLIENT_SLUG}

# 4. Запуск стека
cd /opt/clients/${CLIENT_SLUG}
docker compose -p ${CLIENT_SLUG} up -d

# 5. Ожидание готовности
sleep 30

# 6. Вывод информации
echo "✓ Клиент ${CLIENT_SLUG} развёрнут"
echo "  URL: https://${CLIENT_SLUG}.truffles.kz"
```

### 1.3. Критерии приёмки фазы 1

```
✓ Traefik доступен на https://traefik.truffles.kz (с паролем)
✓ SSL сертификаты выпускаются автоматически
✓ Тестовый клиент развёрнут: https://test.truffles.kz
✓ n8n открывается и работает
✓ PostgreSQL доступен изнутри контейнера n8n
✓ Qdrant отвечает на health check
✓ Скрипт provision.sh создаёт нового клиента за < 5 минут
```

---

## Фаза 2: Ядро AI-бота (Core Chat)

**Длительность:** 7-10 дней

### 2.1. Цели фазы

- Создать базовый AI-чат с подключением к LLM
- Реализовать RAG (ответы на основе базы знаний)
- Настроить Model Router для оптимизации расходов
- Создать административный интерфейс (базовый)

### 2.2. Задачи

#### 2.2.1. Воркфлоу: Обработка сообщений

**Модуль:** `modules/core_chat/`

**Основной воркфлоу:** `chat_handler.json`

**Логика обработки:**
```
┌─────────────────────────────────────────────────────────────────┐
│                   ВОРКФЛОУ ОБРАБОТКИ СООБЩЕНИЯ                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. WEBHOOK TRIGGER                                            │
│     ← Получение сообщения от WhatsApp                          │
│                                                                 │
│  2. ВАЛИДАЦИЯ                                                  │
│     ← Проверка формата, дедупликация                          │
│                                                                 │
│  3. ЗАГРУЗКА КОНТЕКСТА                                         │
│     ← История диалога из PostgreSQL                            │
│     ← Профиль клиента (если есть)                              │
│                                                                 │
│  4. КЛАССИФИКАЦИЯ ИНТЕНТА                                      │
│     ← Gemini 2.0 Flash определяет тип запроса                  │
│     ← Результат: greeting / faq / complex / escalate          │
│                                                                 │
│  5. МАРШРУТИЗАЦИЯ                                              │
│     ├── greeting → Шаблонный ответ                             │
│     ├── faq → RAG Pipeline                                     │
│     ├── complex → GPT-4.1 Pipeline                             │
│     └── escalate → Уведомление менеджеру                       │
│                                                                 │
│  6. RAG PIPELINE (для faq)                                     │
│     ← Поиск в Qdrant                                           │
│     ← Формирование контекста                                   │
│     ← Генерация ответа (Gemini 2.0 Flash)                      │
│                                                                 │
│  7. ОТПРАВКА ОТВЕТА                                            │
│     ← Форматирование                                           │
│     ← Отправка через WhatsApp API                              │
│                                                                 │
│  8. ЛОГИРОВАНИЕ                                                │
│     ← Сохранение в PostgreSQL                                  │
│     ← Запись billing_event                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 2.2.2. База знаний и RAG

**Воркфлоу:** `knowledge_ingest.json`

**Процесс загрузки документа:**
```
1. Загрузка файла (PDF/DOCX/TXT)
2. Извлечение текста
3. Разбиение на чанки (500-1000 токенов с перекрытием)
4. Генерация эмбеддингов (OpenAI text-embedding-3-small)
5. Сохранение в Qdrant с метаданными
```

**Процесс поиска:**
```
1. Получение вопроса
2. Генерация эмбеддинга вопроса
3. Поиск Top-5 релевантных чанков в Qdrant
4. Формирование контекста для LLM
5. Генерация ответа с указанием источников
```

#### 2.2.3. Model Router

**Воркфлоу:** `model_router.json`

**Классификация интентов:**
```json
{
  "greeting": ["привет", "здравствуйте", "добрый день"],
  "farewell": ["пока", "до свидания", "спасибо"],
  "faq": "Вопросы, на которые можно ответить из базы знаний",
  "complex": "Требует рассуждений, сравнений, рекомендаций",
  "escalate": "Жалобы, негатив, просьба о человеке"
}
```

**Промпт классификатора:**
```
Ты — классификатор интентов. Проанализируй сообщение пользователя и верни JSON:
{"intent": "greeting|faq|complex|escalate", "confidence": 0.0-1.0}

Правила:
- greeting: Приветствия, прощания, благодарности
- faq: Вопросы о ценах, услугах, времени работы
- complex: Сложные вопросы, требующие рассуждений
- escalate: Негатив, жалобы, просьба связать с человеком

Сообщение: {user_message}
```

#### 2.2.4. Схема базы данных

**Файл:** `modules/core_chat/migrations/001_init.sql`

```sql
-- Таблица клиентов (конечных пользователей бота)
CREATE TABLE customers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    phone VARCHAR(20) UNIQUE,
    name VARCHAR(255),
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Таблица диалогов
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID REFERENCES customers(id),
    channel VARCHAR(50), -- whatsapp, instagram, telegram
    status VARCHAR(20) DEFAULT 'active', -- active, closed, escalated
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Таблица сообщений
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID REFERENCES conversations(id),
    direction VARCHAR(10), -- inbound, outbound
    content TEXT,
    message_type VARCHAR(20), -- text, image, document
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Таблица базы знаний (метаданные)
CREATE TABLE knowledge_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    filename VARCHAR(255),
    file_type VARCHAR(50),
    chunk_count INTEGER,
    status VARCHAR(20) DEFAULT 'processing', -- processing, ready, error
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Таблица биллинга AI
CREATE TABLE billing_events (
    id BIGSERIAL PRIMARY KEY,
    model_provider VARCHAR(50),
    model_name VARCHAR(100),
    input_tokens INTEGER,
    output_tokens INTEGER,
    cost_usd NUMERIC(10, 6),
    conversation_id UUID,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Индексы
CREATE INDEX idx_messages_conversation ON messages(conversation_id);
CREATE INDEX idx_conversations_customer ON conversations(customer_id);
CREATE INDEX idx_billing_created ON billing_events(created_at);
```

### 2.3. Критерии приёмки фазы 2

```
✓ Можно отправить сообщение через Webhook и получить AI-ответ
✓ Загрузка документа создаёт эмбеддинги в Qdrant
✓ Вопрос по базе знаний возвращает релевантный ответ
✓ Model Router направляет простые вопросы в дешёвую модель
✓ Все взаимодействия с LLM логируются в billing_events
✓ История диалога сохраняется и используется как контекст
```

---

## Фаза 3: Интеграция WhatsApp

**Длительность:** 5-7 дней

### 3.1. Цели фазы

- Подключить WhatsApp Business API
- Настроить приём и отправку сообщений
- Реализовать шаблонные сообщения
- Обработать медиа-файлы

### 3.2. Задачи

#### 3.2.1. Выбор провайдера

**Варианты:**

| Провайдер | Стоимость | Особенности |
|-----------|-----------|-------------|
| Meta Cloud API | $0.05-0.15/сообщение | Официальный, сложная верификация |
| 360Dialog | €49/мес + сообщения | Проще верификация, хороший API |
| Twilio | Pay-as-you-go | Дорого, но надёжно |
| WABA (через Meta BSP) | Зависит от BSP | Локальные партнёры |

**Рекомендация для MVP:** 360Dialog или Meta Cloud API напрямую

#### 3.2.2. Воркфлоу: Webhook обработки

**Модуль:** `modules/channel_whatsapp/`

**Воркфлоу:** `whatsapp_webhook.json`

```
┌─────────────────────────────────────────────────────────────────┐
│                  WEBHOOK WHATSAPP                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. WEBHOOK TRIGGER                                            │
│     ← POST /webhook/whatsapp                                   │
│     ← Верификация подписи (X-Hub-Signature)                    │
│                                                                 │
│  2. ПАРСИНГ PAYLOAD                                            │
│     ← Извлечение: from, text, type, media_id                   │
│                                                                 │
│  3. SWITCH ПО ТИПУ                                             │
│     ├── messages → Обработка сообщения                         │
│     ├── statuses → Обновление статуса доставки                │
│     └── errors → Логирование ошибки                            │
│                                                                 │
│  4. ВЫЗОВ CORE_CHAT                                            │
│     ← Передача в основной обработчик                           │
│                                                                 │
│  5. ОТПРАВКА ОТВЕТА                                            │
│     ← POST to WhatsApp API                                     │
│     ← Retry при ошибке                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.2.3. Отправка сообщений

**Типы сообщений:**

```json
// Текстовое сообщение
{
  "messaging_product": "whatsapp",
  "to": "77771234567",
  "type": "text",
  "text": {
    "body": "Здравствуйте! Чем могу помочь?"
  }
}

// Шаблонное сообщение (для инициации диалога)
{
  "messaging_product": "whatsapp",
  "to": "77771234567",
  "type": "template",
  "template": {
    "name": "order_confirmation",
    "language": {"code": "ru"},
    "components": [
      {
        "type": "body",
        "parameters": [
          {"type": "text", "text": "Артём"},
          {"type": "text", "text": "12345"}
        ]
      }
    ]
  }
}
```

#### 3.2.4. Обработка медиа

**Воркфлоу для изображений:**
```
1. Получение media_id из webhook
2. Запрос URL медиа через API
3. Скачивание файла
4. (Опционально) Анализ через Vision API
5. Сохранение в storage
```

### 3.3. Критерии приёмки фазы 3

```
✓ Webhook принимает сообщения от WhatsApp
✓ Текстовые ответы отправляются корректно
✓ Шаблонные сообщения работают
✓ Изображения принимаются и сохраняются
✓ Статусы доставки обновляются
✓ Ошибки логируются и обрабатываются
```

---

## Фаза 4: Интеграция Kaspi Pay

**Длительность:** 5-7 дней

### 4.1. Цели фазы

- Реализовать автоматическую проверку оплаты
- Создать генератор платёжных ссылок
- Настроить уведомления о платежах

### 4.2. Задачи

#### 4.2.1. Архитектура интеграции

**Два метода:**

```
┌─────────────────────────────────────────────────────────────────┐
│                    МЕТОДЫ ИНТЕГРАЦИИ KASPI                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  МЕТОД 1: Официальный (Merchant API)                           │
│  ├── Требует договор с Kaspi                                   │
│  ├── Токен X-Auth-Token                                        │
│  ├── Полный доступ к транзакциям                               │
│  └── Для крупных клиентов                                      │
│                                                                 │
│  МЕТОД 2: Notification Listener                                │
│  ├── Android-устройство с Kaspi Business                       │
│  ├── Слушатель пуш-уведомлений                                 │
│  ├── Webhook в n8n                                             │
│  └── Для МСБ без API-доступа                                   │
│                                                                 │
│  ⚠️ Метод 2 — не официальный, использовать на свой риск       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.2.2. Воркфлоу: Генерация платёжной ссылки

**Модуль:** `modules/integration_kaspi/`

**Воркфлоу:** `kaspi_link_generator.json`

```
1. Получение данных заказа (сумма, описание)
2. Формирование ссылки Kaspi Gold:
   kaspi.kz/pay/MERCHANT_ID?amount=15000&order_id=12345
3. Генерация QR-кода (опционально)
4. Отправка клиенту
```

#### 4.2.3. Воркфлоу: Обработка уведомления

**Воркфлоу:** `kaspi_payment_handler.json`

```
┌─────────────────────────────────────────────────────────────────┐
│                  ОБРАБОТКА ПЛАТЕЖА                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. WEBHOOK                                                    │
│     ← Уведомление от Listener / Merchant API                   │
│     ← Данные: сумма, отправитель, время                        │
│                                                                 │
│  2. ПОИСК ЗАКАЗА                                               │
│     ← По сумме + окну времени                                  │
│     ← Или по order_id (если есть)                              │
│                                                                 │
│  3. МАТЧИНГ                                                    │
│     ├── Найден → Обновить статус                               │
│     └── Не найден → Логировать как неопознанный               │
│                                                                 │
│  4. УВЕДОМЛЕНИЕ КЛИЕНТА                                        │
│     ← "✅ Оплата получена!"                                    │
│     ← Детали заказа                                            │
│                                                                 │
│  5. ОБНОВЛЕНИЕ CRM (если есть)                                 │
│     ← Смена статуса сделки                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.2.4. Схема данных

```sql
-- Таблица платежей
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id VARCHAR(100),
    amount NUMERIC(12, 2),
    currency VARCHAR(3) DEFAULT 'KZT',
    status VARCHAR(20) DEFAULT 'pending', -- pending, matched, confirmed, failed
    customer_id UUID REFERENCES customers(id),
    kaspi_reference VARCHAR(100),
    sender_name VARCHAR(255),
    raw_notification JSONB,
    matched_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Индексы для быстрого поиска
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_amount ON payments(amount);
CREATE INDEX idx_payments_created ON payments(created_at);
```

### 4.3. Критерии приёмки фазы 4

```
✓ Генерация платёжной ссылки Kaspi
✓ Приём уведомлений о платежах (webhook)
✓ Автоматический матчинг платежа с заказом
✓ Уведомление клиента об успешной оплате
✓ Логирование всех транзакций
✓ Обработка неопознанных платежей
```

---

## Фаза 5: Панель администратора

**Длительность:** 7-10 дней

### 5.1. Цели фазы

- Создать веб-интерфейс для клиентов
- Реализовать просмотр диалогов
- Добавить управление базой знаний
- Показать статистику использования

### 5.2. Задачи

#### 5.2.1. Выбор технологии

**Варианты:**

| Вариант | Плюсы | Минусы |
|---------|-------|--------|
| n8n Forms + Custom UI | Быстро, без кода | Ограниченный UX |
| Directus | Готовый headless CMS | Нужна настройка |
| Суперсет React/Next.js | Полный контроль | Долго разрабатывать |
| Supabase Studio + кастом | Готовый UI для БД | Нужна доработка |

**Рекомендация для MVP:** n8n + простой фронтенд на HTML/JS или Directus

#### 5.2.2. Функции панели

**MVP:**
```
┌─────────────────────────────────────────────────────────────────┐
│                    ФУНКЦИИ АДМИН-ПАНЕЛИ                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  РАЗДЕЛ: Диалоги                                               │
│  ├── Список всех диалогов                                      │
│  ├── Фильтры: статус, дата, канал                              │
│  ├── Просмотр истории сообщений                                │
│  └── Подключение к диалогу (ответ вручную)                     │
│                                                                 │
│  РАЗДЕЛ: База знаний                                           │
│  ├── Список загруженных документов                             │
│  ├── Загрузка нового документа                                 │
│  ├── Удаление документа                                        │
│  └── Просмотр статуса индексации                               │
│                                                                 │
│  РАЗДЕЛ: Статистика                                            │
│  ├── Количество сообщений за период                            │
│  ├── Расход AI-токенов                                         │
│  ├── Топ вопросов                                              │
│  └── Конверсия (если настроена)                                │
│                                                                 │
│  РАЗДЕЛ: Настройки                                             │
│  ├── Имя бота, приветствие                                     │
│  ├── Рабочие часы                                              │
│  └── Подключение каналов                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 5.2.3. API Endpoints

**Реализация через n8n Webhook:**

| Endpoint | Метод | Описание |
|----------|-------|----------|
| `/api/conversations` | GET | Список диалогов |
| `/api/conversations/:id` | GET | Детали диалога |
| `/api/conversations/:id/messages` | GET | Сообщения диалога |
| `/api/conversations/:id/reply` | POST | Ответить вручную |
| `/api/knowledge` | GET | Список документов |
| `/api/knowledge/upload` | POST | Загрузить документ |
| `/api/knowledge/:id` | DELETE | Удалить документ |
| `/api/stats` | GET | Статистика |

#### 5.2.4. Аутентификация

**MVP:** Простая HTTP Basic Auth или API Key

**Pro:** JWT + сессии через Redis

### 5.3. Критерии приёмки фазы 5

```
✓ Веб-интерфейс доступен по URL
✓ Авторизация работает
✓ Список диалогов отображается
✓ Можно просмотреть историю сообщений
✓ Можно загрузить документ в базу знаний
✓ Статистика отображается корректно
```

---

## Фаза 6: Автоматизация и DevOps

**Длительность:** 7-10 дней

### 6.1. Цели фазы

- Автоматизировать провизионирование клиентов
- Настроить резервное копирование
- Реализовать мониторинг и алерты
- Подготовить процесс обновлений

### 6.2. Задачи

#### 6.2.1. Скрипты провизионирования

**Файл:** `scripts/provision.sh` (полная версия)

**Функции:**
```bash
# Создание нового клиента
./provision.sh create client-name --modules="core_chat,channel_whatsapp,integration_kaspi"

# Обновление модулей
./provision.sh update client-name --module="integration_kaspi"

# Удаление клиента
./provision.sh delete client-name --backup

# Резервное копирование
./provision.sh backup client-name

# Восстановление
./provision.sh restore client-name --from="2024-01-15"
```

#### 6.2.2. Резервное копирование

**Стратегия:**
```
┌─────────────────────────────────────────────────────────────────┐
│                    СТРАТЕГИЯ БЭКАПОВ                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  PostgreSQL:                                                    │
│  ├── pg_dump ежедневно в 03:00                                 │
│  ├── Хранение: 7 дней локально, 30 дней в S3/MinIO            │
│  └── Point-in-time recovery через WAL (Pro)                    │
│                                                                 │
│  Qdrant:                                                        │
│  ├── Snapshot API ежедневно                                    │
│  └── Хранение: 7 дней                                          │
│                                                                 │
│  n8n Workflows:                                                 │
│  ├── Экспорт через CLI                                         │
│  └── Версионирование в Git                                     │
│                                                                 │
│  Volumes:                                                       │
│  └── rsync на резервный сервер (Pro)                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Cron задачи:**
```cron
# Ежедневный бэкап всех клиентов
0 3 * * * /opt/scripts/backup-all.sh

# Очистка старых бэкапов
0 4 * * * /opt/scripts/cleanup-backups.sh --keep=7
```

#### 6.2.3. Мониторинг

**Стек:** Prometheus + Grafana (опционально для MVP)

**Метрики для отслеживания:**
```
# Системные
- CPU usage per container
- Memory usage per container
- Disk space

# Приложение
- Requests per second
- Response latency (p50, p95, p99)
- Error rate

# Бизнес
- Messages processed
- AI tokens consumed
- Active conversations

# Здоровье сервисов
- n8n health
- PostgreSQL connections
- Qdrant status
- Redis memory
```

**Алерты:**
```yaml
alerts:
  - name: HighErrorRate
    condition: error_rate > 5%
    action: Telegram notification

  - name: DiskSpaceLow
    condition: disk_usage > 85%
    action: Telegram + Email

  - name: ServiceDown
    condition: health_check failed for 2 min
    action: Telegram + Email + PagerDuty
```

#### 6.2.4. Процесс обновлений

**Rolling Update:**
```
1. Обновить шаблон в репозитории
2. Протестировать на staging-клиенте
3. Создать список клиентов для обновления
4. Для каждого клиента:
   a. Создать бэкап
   b. Применить обновление
   c. Проверить health check
   d. Откатить при ошибке
5. Уведомить о завершении
```

### 6.3. Критерии приёмки фазы 6

```
✓ Скрипт создаёт нового клиента за < 5 минут
✓ Бэкапы выполняются по расписанию
✓ Можно восстановить клиента из бэкапа
✓ Базовый мониторинг работает
✓ Алерты приходят при проблемах
✓ Документирован процесс обновления
```

---

## Фаза 7: Подготовка к продакшену

**Длительность:** 5-7 дней

### 7.1. Цели фазы

- Провести security audit
- Оптимизировать производительность
- Подготовить документацию
- Настроить процессы поддержки

### 7.2. Задачи

#### 7.2.1. Security Checklist

```
□ SSL/TLS везде (проверить SSL Labs: A+)
□ Секреты не в коде (только в .env / Vault)
□ Docker контейнеры не от root
□ Firewall настроен (только нужные порты)
□ Rate limiting на API
□ SQL injection protection (параметризованные запросы)
□ XSS protection (Content-Security-Policy)
□ CORS настроен корректно
□ Логи не содержат sensitive data
□ Бэкапы шифруются
```

#### 7.2.2. Оптимизация

**PostgreSQL:**
```sql
-- Анализ медленных запросов
CREATE EXTENSION pg_stat_statements;

-- Оптимизация соединений
max_connections = 100
shared_buffers = 256MB
effective_cache_size = 768MB
```

**Docker:**
```yaml
# Ограничение ресурсов
deploy:
  resources:
    limits:
      cpus: '1.0'
      memory: 1G
    reservations:
      cpus: '0.5'
      memory: 512M
```

**n8n:**
```
# Переменные для production
EXECUTIONS_PROCESS=main
EXECUTIONS_DATA_PRUNE=true
EXECUTIONS_DATA_MAX_AGE=168  # 7 дней
```

#### 7.2.3. Документация

**Для команды:**
```
docs/
├── architecture.md          # Описание архитектуры
├── deployment.md            # Процесс деплоя
├── troubleshooting.md       # Решение типовых проблем
├── runbooks/                # Инструкции для инцидентов
│   ├── service-down.md
│   ├── restore-backup.md
│   └── scale-up.md
└── api/                     # API документация
    └── openapi.yaml
```

**Для клиентов:**
```
help/
├── getting-started.md       # Быстрый старт
├── knowledge-base.md        # Работа с базой знаний
├── faq.md                   # Частые вопросы
└── troubleshooting.md       # Проблемы и решения
```

#### 7.2.4. Процессы поддержки

**Каналы:**
- Email: support@truffles.kz
- WhatsApp: +7 XXX XXX XXXX
- Telegram: @truffles_support

**SLA (по тарифам):**

| Приоритет | Starter | Pro |
|-----------|---------|-----|
| Критический (не работает) | 8ч | 4ч |
| Высокий (частично работает) | 24ч | 8ч |
| Средний (вопрос) | 48ч | 24ч |

### 7.3. Критерии приёмки фазы 7

```
✓ Security checklist пройден на 100%
✓ SSL оценка A+ на SSL Labs
✓ Load test: 100 RPS без деградации
✓ Документация для команды готова
✓ Help-центр для клиентов готов
✓ Каналы поддержки настроены
```

---

# ЧАСТЬ III: СПРАВОЧНЫЕ МАТЕРИАЛЫ

---

## 8. Схема базы данных (полная)

```sql
-- ============================================
-- СХЕМА БАЗЫ ДАННЫХ TRUFFLES v1.0
-- ============================================

-- Расширения
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ============================================
-- КЛИЕНТЫ И ПОЛЬЗОВАТЕЛИ
-- ============================================

-- Конечные пользователи бота (покупатели)
CREATE TABLE customers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    phone VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(255),
    email VARCHAR(255),
    channel VARCHAR(50), -- whatsapp, instagram, telegram
    language VARCHAR(10) DEFAULT 'ru',
    timezone VARCHAR(50) DEFAULT 'Asia/Almaty',
    metadata JSONB DEFAULT '{}',
    tags TEXT[],
    is_blocked BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================
-- ДИАЛОГИ И СООБЩЕНИЯ
-- ============================================

CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,
    channel VARCHAR(50) NOT NULL,
    channel_conversation_id VARCHAR(255), -- ID диалога в канале
    status VARCHAR(20) DEFAULT 'active', -- active, closed, escalated
    assigned_to VARCHAR(255), -- ID оператора (если эскалация)
    last_message_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
    direction VARCHAR(10) NOT NULL, -- inbound, outbound
    sender_type VARCHAR(20) NOT NULL, -- customer, bot, operator
    content TEXT,
    content_type VARCHAR(20) DEFAULT 'text', -- text, image, document, audio, template
    media_url TEXT,
    template_name VARCHAR(100),
    metadata JSONB DEFAULT '{}',
    channel_message_id VARCHAR(255), -- ID сообщения в канале
    status VARCHAR(20) DEFAULT 'sent', -- sent, delivered, read, failed
    error_message TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================
-- БАЗА ЗНАНИЙ
-- ============================================

CREATE TABLE knowledge_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    filename VARCHAR(255) NOT NULL,
    original_filename VARCHAR(255),
    file_type VARCHAR(50),
    file_size_bytes BIGINT,
    content_hash VARCHAR(64), -- SHA256 для дедупликации
    chunk_count INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'processing', -- processing, ready, error, deleted
    error_message TEXT,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE knowledge_chunks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID REFERENCES knowledge_documents(id) ON DELETE CASCADE,
    chunk_index INTEGER NOT NULL,
    content TEXT NOT NULL,
    token_count INTEGER,
    vector_id VARCHAR(100), -- ID в Qdrant
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================
-- ПЛАТЕЖИ (KASPI)
-- ============================================

CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_number VARCHAR(50) UNIQUE,
    customer_id UUID REFERENCES customers(id),
    conversation_id UUID REFERENCES conversations(id),
    amount NUMERIC(12, 2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'KZT',
    description TEXT,
    status VARCHAR(20) DEFAULT 'pending', -- pending, paid, cancelled, refunded
    payment_link TEXT,
    metadata JSONB DEFAULT '{}',
    expires_at TIMESTAMPTZ,
    paid_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID REFERENCES orders(id),
    amount NUMERIC(12, 2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'KZT',
    provider VARCHAR(50) DEFAULT 'kaspi', -- kaspi, card, etc.
    provider_reference VARCHAR(100),
    sender_name VARCHAR(255),
    sender_phone VARCHAR(20),
    status VARCHAR(20) DEFAULT 'received', -- received, matched, confirmed, disputed
    matched_at TIMESTAMPTZ,
    raw_notification JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================
-- БИЛЛИНГ AI
-- ============================================

CREATE TABLE billing_events (
    id BIGSERIAL PRIMARY KEY,
    event_type VARCHAR(50) NOT NULL, -- llm_call, embedding, transcription
    model_provider VARCHAR(50) NOT NULL,
    model_name VARCHAR(100) NOT NULL,
    input_tokens INTEGER DEFAULT 0,
    output_tokens INTEGER DEFAULT 0,
    total_tokens INTEGER GENERATED ALWAYS AS (input_tokens + output_tokens) STORED,
    cost_usd NUMERIC(10, 6),
    conversation_id UUID REFERENCES conversations(id),
    workflow_id VARCHAR(255),
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================
-- НАСТРОЙКИ И КОНФИГУРАЦИЯ
-- ============================================

CREATE TABLE settings (
    key VARCHAR(100) PRIMARY KEY,
    value JSONB NOT NULL,
    description TEXT,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Предустановленные настройки
INSERT INTO settings (key, value, description) VALUES
('bot_name', '"Truffles Assistant"', 'Имя бота'),
('welcome_message', '"Здравствуйте! Чем могу помочь?"', 'Приветственное сообщение'),
('working_hours', '{"start": "09:00", "end": "18:00", "timezone": "Asia/Almaty"}', 'Рабочие часы'),
('escalation_keywords', '["оператор", "человек", "менеджер", "жалоба"]', 'Ключевые слова для эскалации');

-- ============================================
-- AUDIT LOG
-- ============================================

CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    actor_id VARCHAR(255),
    actor_type VARCHAR(50), -- user, system, api
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(100),
    resource_id VARCHAR(255),
    old_value JSONB,
    new_value JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================
-- ИНДЕКСЫ
-- ============================================

CREATE INDEX idx_customers_phone ON customers(phone);
CREATE INDEX idx_customers_created ON customers(created_at);

CREATE INDEX idx_conversations_customer ON conversations(customer_id);
CREATE INDEX idx_conversations_status ON conversations(status);
CREATE INDEX idx_conversations_last_message ON conversations(last_message_at DESC);

CREATE INDEX idx_messages_conversation ON messages(conversation_id);
CREATE INDEX idx_messages_created ON messages(created_at);
CREATE INDEX idx_messages_channel_id ON messages(channel_message_id);

CREATE INDEX idx_knowledge_docs_status ON knowledge_documents(status);
CREATE INDEX idx_knowledge_chunks_document ON knowledge_chunks(document_id);

CREATE INDEX idx_orders_customer ON orders(customer_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_number ON orders(order_number);

CREATE INDEX idx_payments_order ON payments(order_id);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_amount ON payments(amount);

CREATE INDEX idx_billing_created ON billing_events(created_at);
CREATE INDEX idx_billing_model ON billing_events(model_provider, model_name);

CREATE INDEX idx_audit_created ON audit_logs(created_at);
CREATE INDEX idx_audit_resource ON audit_logs(resource_type, resource_id);
```

---

## 9. Диаграмма архитектуры

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 ИНТЕРНЕТ                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ HTTPS (443)
                                      │
┌─────────────────────────────────────▼───────────────────────────────────────┐
│                              CLOUDFLARE                                     │
│                    (DNS, SSL, DDoS Protection, CDN)                        │
└─────────────────────────────────────┬───────────────────────────────────────┘
                                      │
══════════════════════════════════════╪═══════════════════════════════════════
                                      │         HOST SERVER
                                      │         (Kazakhstan DC)
                                      │
┌─────────────────────────────────────▼───────────────────────────────────────┐
│                           HOST TRAEFIK                                      │
│                      (Reverse Proxy + SSL)                                 │
│                                                                             │
│   Routes:                                                                   │
│   ├── *.truffles.kz → Client Stacks                                        │
│   ├── traefik.truffles.kz → Dashboard                                      │
│   └── api.truffles.kz → Control Plane API                                  │
└───────┬─────────────────────────────────────────────────────────┬───────────┘
        │                                                         │
        │ web_gateway network                                     │
        │                                                         │
┌───────▼───────────────────────┐         ┌───────────────────────▼───────────┐
│                               │         │                                   │
│     CLIENT STACK: client-a    │         │     CLIENT STACK: client-b        │
│                               │         │                                   │
│  ┌─────────────────────────┐  │         │  ┌─────────────────────────────┐  │
│  │      n8n (5678)         │  │         │  │        n8n (5678)           │  │
│  │   Workflow Orchestrator │  │         │  │    Workflow Orchestrator    │  │
│  └────────────┬────────────┘  │         │  └──────────────┬──────────────┘  │
│               │               │         │                 │                 │
│  ┌────────────▼────────────┐  │         │  ┌──────────────▼──────────────┐  │
│  │   client_a_internal     │  │         │  │    client_b_internal        │  │
│  │   (Private Network)     │  │         │  │    (Private Network)        │  │
│  │                         │  │         │  │                             │  │
│  │  ┌──────────────────┐   │  │         │  │  ┌────────────────────┐     │  │
│  │  │ PostgreSQL (5432)│   │  │         │  │  │  PostgreSQL (5432) │     │  │
│  │  └──────────────────┘   │  │         │  │  └────────────────────┘     │  │
│  │                         │  │         │  │                             │  │
│  │  ┌──────────────────┐   │  │         │  │  ┌────────────────────┐     │  │
│  │  │  Qdrant (6333)   │   │  │         │  │  │   Qdrant (6333)    │     │  │
│  │  └──────────────────┘   │  │         │  │  └────────────────────┘     │  │
│  │                         │  │         │  │                             │  │
│  │  ┌──────────────────┐   │  │         │  │  ┌────────────────────┐     │  │
│  │  │  Redis (6379)    │   │  │         │  │  │   Redis (6379)     │     │  │
│  │  └──────────────────┘   │  │         │  │  └────────────────────┘     │  │
│  │                         │  │         │  │                             │  │
│  └─────────────────────────┘  │         │  └─────────────────────────────┘  │
│                               │         │                                   │
│  Volumes:                     │         │  Volumes:                         │
│  ├── client_a_pg_data         │         │  ├── client_b_pg_data             │
│  ├── client_a_n8n_data        │         │  ├── client_b_n8n_data            │
│  ├── client_a_qdrant_data     │         │  ├── client_b_qdrant_data         │
│  └── client_a_redis_data      │         │  └── client_b_redis_data          │
│                               │         │                                   │
└───────────────────────────────┘         └───────────────────────────────────┘

══════════════════════════════════════════════════════════════════════════════
                              EXTERNAL SERVICES
══════════════════════════════════════════════════════════════════════════════

┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐
│   WhatsApp API  │  │    Kaspi Pay    │  │   OpenAI API    │  │  Google AI   │
│   (Meta Cloud)  │  │   (Merchant)    │  │   (GPT-4.1)     │  │  (Gemini 2)  │
└─────────────────┘  └─────────────────┘  └─────────────────┘  └──────────────┘
```

---

## 10. Глоссарий терминов

| Термин | Определение |
|--------|-------------|
| **Multi-Instance** | Архитектура, где каждый клиент получает изолированный набор контейнеров |
| **Tenant** | Клиент платформы (бизнес, использующий Truffles) |
| **Customer** | Конечный пользователь (покупатель клиента) |
| **RAG** | Retrieval-Augmented Generation — генерация ответов с использованием базы знаний |
| **Embedding** | Векторное представление текста для семантического поиска |
| **Model Router** | Компонент, направляющий запросы к оптимальной AI-модели |
| **Провизионирование** | Процесс создания и настройки нового клиентского окружения |
| **Zero-State** | Принцип создания окружений с чистого состояния |
| **Воркфлоу** | Автоматизированный бизнес-процесс в n8n |
| **Webhook** | HTTP-callback для получения событий от внешних систем |
| **SSO** | Single Sign-On — единая точка входа |
| **BYOK** | Bring Your Own Key — клиент использует свои API-ключи |

---

## 11. Контакты и ресурсы

**Проект:** Truffles AI Platform

**Автор:** Жанбол, ТОО «Truffles»

**Репозиторий:** [указать после создания]

**Документация:**
- Бизнес-план: `Стратегический Мастер-Документ`
- Юридические документы: Договор SaaS, Политика конфиденциальности
- Коммерческие материалы: КП, Презентация, Сценарий демо

**Технические ресурсы:**
- n8n: https://docs.n8n.io
- Qdrant: https://qdrant.tech/documentation
- Traefik: https://doc.traefik.io/traefik
- PostgreSQL: https://www.postgresql.org/docs
- WhatsApp Business API: https://developers.facebook.com/docs/whatsapp

---

## 12. История версий документа

| Версия | Дата | Изменения |
|--------|------|-----------|
| 1.0 | [текущая дата] | Первая версия документа |

---

**КОНЕЦ ДОКУМЕНТА**

---

*Для продолжения реализации: начните с Фазы 0, последовательно выполняя задачи по чек-листам. При возникновении вопросов по конкретной задаче — обращайтесь к LLM-агенту с описанием задачи из соответствующего раздела.*