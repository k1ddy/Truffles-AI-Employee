# Аудит системы Truffles — 9 декабря 2025

## Активные workflows (Truffles)

| Workflow | ID | Назначение |
|----------|-----|------------|
| 1_Webhook | 656fmXR6GPZrJbxm | Точка входа, запускает цепочку |
| 9_Telegram_Callback | HQOWuMDIBPphC86v | Обработка кнопок менеджеров |
| 10_Handover_Monitor | ZRcuYYCv1o9B0MyY | Напоминания каждые 5 мин |
| Knowledge Sync | zTbaCLWLJN6vPMk4 | Синхронизация базы знаний |

Sub-workflows (вызываются из 1_Webhook):
- 2_ChannelAdapter → 3_Normalize → 4_MessageBuffer → 5_TurnDetector → 6_Multi-Agent
- 7_Escalation_Handler → 8_Telegram_Adapter

## База данных

21 таблица. Ключевые:

**conversations** — разговоры
- id, client_id, user_id, channel, status
- bot_status (active/muted) — КОСТЫЛЬ
- bot_muted_until — КОСТЫЛЬ  
- no_count — КОСТЫЛЬ
- telegram_topic_id

**handovers** — заявки на менеджера
- id, conversation_id, status (pending/active/resolved/timeout)
- trigger_type, escalation_reason
- reminder_1_sent_at, reminder_2_sent_at
- skipped_by (JSONB), resolved_by_name, resolved_by_id
- telegram_message_id

**messages** — история сообщений
- id, conversation_id, role (user/assistant/manager/system)
- content, intent, confidence, metadata

**users** — клиенты
- id, phone, remote_jid, name, telegram_topic_id

**client_settings** — настройки клиента
- telegram_chat_id, telegram_bot_token
- reminder_timeout_1, reminder_timeout_2
- silence_after_first_no_minutes

## Проверки состояний (размазаны)

- 6_Multi-Agent: Check Bot Muted, Is Bot Muted?
- 7_Escalation_Handler: Load Status, Decide Action, should_mute
- 9_Telegram_Callback: Take Handover, Resolve Handover, Unmute Bot
- 10_Handover_Monitor: Load Active Handovers, Decide Action

## Известные проблемы

1. **Дублирование сообщений** — каждое сообщение записывается дважды
2. **Закрепление не уходит** — после [Решено] pin остаётся
3. **Mute на время** — костыль вместо явного состояния
4. **no_count** — костыль вместо проверки активной заявки
5. **Race condition** — бот может ответить после эскалации
6. **Сломанные ссылки** — 2 в 6_Multi-Agent (Send Fallback2 -> Parse Quality, Quality Decision)

## Вывод

Архитектура костыльная. Логика размазана по workflows. Нужен рефакторинг:
- Вынести бизнес-логику в Python сервис
- n8n только для интеграций (WhatsApp, Telegram)
- Централизованный state machine
