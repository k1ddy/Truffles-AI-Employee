# MULTI-TENANT АРХИТЕКТУРА

**Дата:** 2025-12-07
**Статус:** В разработке

---

## КОНТЕКСТ

### Из чего исходим

Жанбол готовится идти к первым заказчикам (салоны красоты). Нужна система которая:
- Позволяет быстро онбордить заказчика
- Масштабируется на 50+ заказчиков
- Не требует копирования workflow под каждого

### Как пришли

1. Обсуждали качество ответов бота — бот вываливает всё сразу, информация устарела
2. Поняли что база знаний (faq.md) заточена под Truffles, а нужно под заказчиков
3. Начали думать про демо для салона
4. Вопрос: "есть ли конфигуратор который подставит значения?"
5. Ответ: нет, но в БД уже заложена архитектура multi-tenant
6. Решили сделать нормально, не костылить

### Что решаем

1. Как онбордить заказчика быстро (часы, не дни)
2. Как разделять данные заказчиков
3. Как настраивать параметры под каждого
4. Как масштабировать без копирования workflow

### Какой исход

- Один workflow обслуживает всех заказчиков
- Данные (промпты, настройки, знания) разделены по client_id
- Онбординг = создать записи в БД + загрузить знания
- Заказчик работает через свой номер WhatsApp

---

## ТЕРМИНОЛОГИЯ

| Термин | Значение |
|--------|----------|
| **Заказчик** | Покупатель услуги Truffles (салон, магазин) |
| **Клиент** | Клиент заказчика (человек который пишет в салон) |
| **client_id** | UUID заказчика в системе |

---

## ЧТО УЖЕ ЕСТЬ В БД

Таблицы которые уже созданы:

### clients
```sql
id         UUID (PK)
name       TEXT
status     TEXT (onboarding/active/suspended/deleted)
config     JSONB
created_at TIMESTAMP
```

### client_settings
```sql
client_id                    UUID (FK → clients)
primary_timeout              INT (дефолт 5)
others_timeout               INT (дефолт 5)
leadership_timeout           INT (дефолт 10)
total_timeout                INT (дефолт 20)
quiet_hours_enabled          BOOLEAN (дефолт true)
quiet_hours_start            TIME (дефолт 23:00)
quiet_hours_end              TIME (дефолт 08:00)
quiet_hours_behavior         TEXT (дефолт 'queue')
escalation_cooldown_minutes  INT (дефолт 30)
tone                         TEXT (дефолт 'friendly')
messages                     JSONB (шаблоны сообщений)
```

### prompts
```sql
id          UUID (PK)
client_id   UUID (FK → clients)
name        TEXT
text        TEXT
model       TEXT
temperature NUMERIC
is_active   BOOLEAN
```

**Проблема:** Workflow не использует эти таблицы. Промпт захардкожен в ноде.

---

## АРХИТЕКТУРА

### Принцип
```
Один workflow → читает данные из БД по client_id → отвечает
```

### Поток данных
```
Входящее сообщение (webhook)
        ↓
Определить client_id (по webhook URL)
        ↓
Проверить status = 'active'
        ↓
Загрузить из БД:
  - промпт (prompts WHERE client_id)
  - настройки (client_settings WHERE client_id)
        ↓
RAG поиск (Qdrant WHERE metadata.client_id)
        ↓
Генерация ответа
        ↓
Эскалация если нужно (контакты из БД)
        ↓
Счётчик сообщений +1
        ↓
Отправка
```

---

## ВОПРОСЫ И РЕШЕНИЯ

### 1. Как определять client_id по входящему сообщению?

**Решение:** Отдельный webhook path на заказчика.
```
/webhook/salon_mira
/webhook/beauty_lab
```
client_id определяется из URL.

В ChatFlow настраивается webhook URL для каждого номера.

---

### 2. База знаний в Qdrant — как разделять?

**Решение:** Одна коллекция, фильтр по client_id в metadata.
```json
{
  "client_id": "uuid-salon-mira",
  "doc_name": "services.md",
  "section": "Маникюр"
}
```

Поиск: `filter: { client_id: "uuid-salon-mira" }`

---

### 3. Эскалация — куда слать?

**Решение:** JSONB в client_settings.

```json
{
  "escalation_contacts": [
    {"role": "manager", "telegram": "@manager1", "priority": 1},
    {"role": "owner", "telegram": "@owner", "priority": 2}
  ]
}
```

**Active Learning логика:**
- Учредитель ответил → слова = истина, сразу в RAG
- Менеджер ответил → требует модерации учредителя
- После модерации → в БД → в Drive → knowledge_sync workflow

---

### 4. Что если заказчик не оплатил?

**Решение:** Проверка в начале workflow.
```
IF client.status != 'active' → не отвечать
```

Бот просто молчит. Клиент не знает почему.

---

### 5. Счётчик сообщений и ценообразование

**Что считать:** Входящие сообщения от клиентов.

**Лимит Starter:** 1000 входящих/мес

**Цена:**
- Starter: 50,000 ₸/мес
- При оплате за год: -10% (540,000 ₸/год)

**Таблица usage:**
```sql
CREATE TABLE usage (
  client_id    UUID
  month        DATE
  messages_in  INT
);
```

**Логика:**
- После каждого входящего: UPDATE +1
- 80% лимита → алерт заказчику
- 100% → блок или доплата (решить позже)

**Модели LLM:**
- Response: GPT-5 (или GPT-4o пока)
- Classifier: GPT-5-mini (или GPT-4o-mini пока)

---

### 6. Как создавать заказчика технически?

**Вопрос открыт.** Варианты:
- Скрипт Python
- SQL напрямую
- Форма/UI (потом)

---

### 7. База знаний — как загружать?

**Вопрос открыт.** Нужно определить:
- Формат (markdown? текст?)
- Кто загружает (Жанбол? заказчик?)
- Процесс обновления

---

### 8. Промпт — кто пишет?

**Вопрос открыт.** Варианты:
- Шаблон + переменные (название, тон)
- Жанбол пишет под каждого
- Комбинация

---

### 9. Время работы заказчика

**Вопрос открыт.** 
- Бот 24/7?
- Или разное поведение ночью?
- Настройка через quiet_hours в client_settings?

---

### 10. Тестирование перед запуском

**Вопрос открыт.**
- Как проверить бота до продакшена?
- Тестовый номер?
- Тестовый режим в системе?

---

### 11. Заказчик ушёл — что с данными?

**Вопрос открыт.**
- Удалять?
- Архивировать?
- Срок хранения?

---

### 12. Dashboard для заказчика

**Решение:** Потом. Сейчас не приоритет.

---

### 13. Язык (казахский/русский)

**Вопрос открыт.**
- Автоопределение по сообщению?
- Настройка основного языка?

---

### 14. Несколько номеров у одного заказчика

**Вопрос открыт.**
- Филиалы = один заказчик или разные?
- Разные базы знаний на филиал?

---

### 15. Ошибки — что отвечать клиенту?

**Решение:** Fallback сообщение.
"Извините, возникла техническая проблема. Менеджер свяжется с вами."
+ эскалация

---

### 16. Версии промптов

**Вопрос открыт.**
- Хранить историю?
- Как откатить?

В таблице prompts есть поле version, но не используется.

---

### 17. Active Learning — кто модерирует?

**Вопрос открыт.**
- Жанбол модерирует всех?
- Заказчик сам?
- Автомодерация для owner?

---

### 18. Интеграции (CRM, календарь)

**Решение:** Потом. Не приоритет для MVP.

---

## ВОПРОСЫ И ОТВЕТЫ

### По документам:
1. **Презентация, КП — показывал?** → Нет, теория
2. **Бриф — как заполняется?** → Ещё не пробовал

### По противоречиям:
3. **Pro/Kaspi/CRM в документах?** → Pro оставить "в разработке", Kaspi УБРАТЬ (нет API, костыли)
4. **Если спросят про Pro?** → Не упоминать, только если спросят

### По материалам:
5. **objections.md, slang.md — для кого?** → Для обоих (RAG + продажи)
6. **cases.md — реальные?** → Выдуманные для примера (0 клиентов)

### По процессу:
7. **Где хранить данные заказчиков?** → Нет системы, нужно создать

### По демо:
8. **Как показываешь демо?** → Ещё не показывал
9. **Есть номер WhatsApp для демо?** → ДА ✅

### По юридике:
10. **Договор критичен?** → Первый на доверии, зависит от заказчика
11. **Юрлицо или физлицо?** → Пока неизвестно

### По приоритетам:
12. **Без чего НЕЛЬЗЯ идти:**
    - [x] Рабочий демо-бот
    - [x] База знаний под салон (не Truffles)
    - [x] Понимание цены и что входит
    - [x] Бриф/анкета для сбора данных
    - [x] Контакт для эскалации
    - [x] Договор (хотя бы базовый)

### По архиву:
13. **BLUEPRINT vs NORTH_STAR?** → Дополняют друг друга
14. **Архив актуален?** → Частично, нужно вернуть/дополнить основные

### По фазам:
15. **Multi-tenant раньше эскалации?** → Да, эскалация работает базово
16. **Где мы по иерархии?** → Между NOW и QUARTER
17. **Что нужно из QUARTER?** → Multi-tenant, база заказчика, промпт, контакт эскалации
18. **Бот ведёт по этапам?** → Нет, просто отвечает (потом добавим)
19. **Приоритет?** → Multi-tenant важнее

---

## СЛЕДУЮЩИЕ ШАГИ

1. [x] Прочитать Business, context, knowledge, prompts
2. [x] Прочитать .archive
3. [x] Жанбол отвечает на вопросы
4. [x] Интегрировать архив в основные документы
5. [x] Договор → Business/Legal/ (готов, Starter правильный)
6. [ ] Разработка: workflow читает из БД
7. [ ] Разработка: онбординг скрипт
8. [ ] Тестирование на демо-салоне
9. [ ] Жанбол готов идти к заказчику

---

## ПРИНЦИПЫ РАБОТЫ

- Не костылить
- Не преувеличивать чего нет
- Не преуменьшать что есть
- Сначала понять, потом делать

---

*Документ обновляется по мере работы*
