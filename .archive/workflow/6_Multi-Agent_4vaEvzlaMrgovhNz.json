{
  "name": "6_Multi-Agent_4vaEvzlaMrgovhNz",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// –ê–î–ê–ü–¢–ï–†: –ø—Ä–∏–Ω–∏–º–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –Ω–æ–≤–æ–π —Ü–µ–ø–æ—á–∫–∏\n     // –í—Ö–æ–¥: turn_analysis.merged_message, session_id, user_id\n     // –ò–õ–ò —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç body.message (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)\n\n     const raw = $json;\n\n     // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö\n     let phone, remoteJid, text, originalText, senderName, messageId, msgTimestamp;\n\n     if (raw.turn_analysis) {\n       // –ù–û–í–´–ô –§–û–†–ú–ê–¢ –∏–∑ TurnDetector\n       phone = raw.user_id || '';\n       remoteJid = raw.session_id || '';\n       text = raw.turn_analysis.merged_message || '';\n       originalText = raw.merged_text || text;\n       senderName = raw.sender_name || '';\n       messageId = raw.buffered_messages?.[0]?.message_id || `turn_${Date.now()}`;\n       msgTimestamp = Date.now();\n     } else {\n       // –°–¢–ê–†–´–ô –§–û–†–ú–ê–¢ (body.message) - –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å\n       const body = raw.body || {};\n       const metadata = body.metadata || {};\n       remoteJid = metadata.remoteJid || '';\n       phone = remoteJid.replace('@s.whatsapp.net', '');\n       text = body.message || '';\n       originalText = text;\n       senderName = metadata.sender || '';\n       messageId = metadata.messageId || '';\n       msgTimestamp = (metadata.timestamp || 0) * 1000 || Date.now();\n     }\n\n     // === VALIDATION ===\n     if (!text.trim() || text.trim().length < 2) {\n       return [];\n     }\n\n     if (text.length > 1000) {\n       text = text.substring(0, 1000) + '...';\n     }\n\n     // –ó–∞—â–∏—Ç–∞ –æ—Ç replay –∞—Ç–∞–∫ (—Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç) - —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞\n     const now = Date.now();\n     if (msgTimestamp && now - msgTimestamp > 300000) {\n       // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (–±—É—Ñ–µ—Ä —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª)\n       if (!$json.turn_analysis) {\n         return [];\n       }\n     }\n\n     return [{\n       json: {\n         phone,\n         remoteJid,\n         text: text.trim(),\n         originalText: originalText.trim(),\n         messageType: 'text',\n         senderName,\n         messageId,\n         timestamp: msgTimestamp,\n         client_slug: raw.client_slug || 'truffles'\n       }\n     }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4368,
        688
      ],
      "id": "22a5bb61-5a2f-4c04-a222-08a8917d6da5",
      "name": "Parse Input"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH client AS (\n  SELECT id FROM clients WHERE name = '{{ $('Parse Input').first().json.client_slug }}'\n),\nupserted_user AS (\n  INSERT INTO users (client_id, phone, remote_jid, name, last_active_at)\n  SELECT\n    (SELECT id FROM client),\n    '{{ $('Parse Input').first().json.phone }}',\n    '{{ $('Parse Input').first().json.remoteJid }}',\n    '{{ $('Parse Input').first().json.senderName }}',\n    NOW()\n  ON CONFLICT (client_id, phone) DO UPDATE SET\n    last_active_at = NOW(),\n    name = COALESCE(NULLIF('{{ $('Parse Input').first().json.senderName }}', ''), users.name)\n  RETURNING id\n),\nexisting_conv AS (\n  SELECT id FROM conversations\n  WHERE user_id = (SELECT id FROM upserted_user)\n    AND status = 'active'\n  ORDER BY last_message_at DESC\n  LIMIT 1\n),\nnew_conv AS (\n  INSERT INTO conversations (client_id, user_id, channel, status, last_message_at)\n  SELECT\n    (SELECT id FROM client),\n    (SELECT id FROM upserted_user),\n    'whatsapp',\n    'active',\n    NOW()\n  WHERE NOT EXISTS (SELECT 1 FROM existing_conv)\n  RETURNING id\n)\nSELECT\n  (SELECT id FROM upserted_user) AS user_id,\n  COALESCE(\n    (SELECT id FROM existing_conv),\n    (SELECT id FROM new_conv)\n  ) AS conversation_id,\n  (SELECT id FROM client) AS client_id;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2672,
        656
      ],
      "id": "3f451a65-5b58-4fe1-a0e9-4d1df86a7c93",
      "name": "Upsert User",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT role, content\n     FROM messages\n     WHERE conversation_id = '{{ $('Upsert User').item.json.conversation_id }}'\n       AND content IS NOT NULL\n       AND content != ''\n       AND LENGTH(content) < 1000\n     ORDER BY created_at DESC\n     LIMIT 10;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2224,
        656
      ],
      "id": "d51cd10e-5881-412e-9a94-5d27fb1f0eda",
      "name": "Load History",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO messages (conversation_id, client_id, role, content)\n     VALUES\n       ('{{ $json.conversation_id }}', '{{ $json.client_id }}', 'user', '{{ $json.safe_message }}'),\n       ('{{ $json.conversation_id }}', '{{ $json.client_id }}', 'assistant', '{{ $json.safe_response }}');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        720,
        688
      ],
      "id": "58d4e715-9929-43ea-83eb-b2bc07fa07f1",
      "name": "Save Messages",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot<TELEGRAM_BOT_TOKEN>/setWebhook?url=https://n8n.truffles.kz/webhook/flow",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4592,
        -320
      ],
      "id": "644656fb-e2e8-4b15-8bdd-d19e1dde7074",
      "name": "HTTP Request1",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO messages (conversation_id, client_id, role, content, metadata)\n     SELECT\n       '{{ $json.conversation_id }}',\n       '{{ $json.client_id }}',\n       'user',\n       '{{ $('Parse Input').first().json.text.replace(/'/g, \"''\") }}',\n       '{\"message_id\": \"{{ $('Parse Input').first().json.messageId }}\"}'\n     WHERE NOT EXISTS (\n       SELECT 1 FROM messages\n       WHERE metadata->>'message_id' = '{{ $('Parse Input').first().json.messageId }}'\n     );",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2448,
        656
      ],
      "id": "e8b5bc48-6bc1-4146-b4f7-adbb0219efcd",
      "name": "Save User Message",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "builtInTools": {},
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        -3248,
        688
      ],
      "id": "bb864994-88b2-4b95-a0fe-64371bfcd49d",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "C31JRkzPBiItNcOT",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n       \"type\": \"object\",\n       \"properties\": {\n         \"intent\": {\n           \"type\": \"string\",\n           \"enum\": [\"greeting\", \"pricing\", \"what_is_this\", \"how_to_start\", \"availability\", \"order\", \"payment\", \"delivery\", \"details\", \"integration\", \"objection_expensive\", \"objection_later\", \"objection_doubt\", \"complaint\", \"frustration\", \"human_request\", \"thanks_positive\", \"thanks_bye\", \"out_of_domain\", \"attack\"],\n           \"description\": \"–¢–∏–ø –Ω–∞–º–µ—Ä–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞\"\n         },\n         \"confidence\": {\n           \"type\": \"number\",\n           \"description\": \"–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å 0.0-1.0\"\n         }\n       },\n       \"required\": [\"intent\", \"confidence\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -3120,
        688
      ],
      "id": "fd40fa94-ed28-4bb3-b92e-2f95b6f28d85",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5b6e6bf2-e38c-4d2d-9772-aed284b3fec2",
              "leftValue": "={{ !['out_of_domain', 'attack'].includes($json.output.intent) }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2896,
        560
      ],
      "id": "d433b9bc-de00-4acc-8146-0a2d43fce766",
      "name": "Is On Topic"
    },
    {
      "parameters": {
        "jsCode": "const prev = $('RAG Search').first().json;\n\nreturn [{\n    json: {\n        ...prev\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1104,
        800
      ],
      "id": "cdc8f869-bffa-4d1d-b5f1-ad03b4e0d53a",
      "name": "Add Knowledge"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5",
          "mode": "list",
          "cachedResultName": "gpt-5"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        -656,
        1024
      ],
      "id": "382e3b3c-c97b-4283-97b9-a79d9b6c083d",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "C31JRkzPBiItNcOT",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"thinking\": {\n      \"type\": \"string\",\n      \"description\": \"–¢–≤–æ–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è: —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª –∫–ª–∏–µ–Ω—Ç, –µ—Å—Ç—å –ª–∏ –æ—Ç–≤–µ—Ç –≤ –±–∞–∑–µ, —á—Ç–æ –¥–µ–ª–∞—Ç—å\"\n    },\n    \"has_answer\": {\n      \"type\": \"boolean\",\n      \"description\": \"true –µ—Å–ª–∏ –º–æ–∂–µ—à—å –¥–∞—Ç—å –ø–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç, false –µ—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å\"\n    },\n    \"needs_escalation\": {\n      \"type\": \"boolean\",\n      \"description\": \"true –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä (—Å–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –∂–∞–ª–æ–±–∞, –≤–æ–∑–≤—Ä–∞—Ç)\"\n    },\n    \"source\": {\n      \"type\": \"string\",\n      \"description\": \"–î–æ–∫—É–º–µ–Ω—Ç –æ—Ç–∫—É–¥–∞ –≤–∑—è–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é: faq.md, objections.md, cases.md, examples.md, –∏–ª–∏ none –µ—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞\"\n    },\n    \"response\": {\n      \"type\": \"string\",\n      \"description\": \"–û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É\"\n    }\n  },\n  \"required\": [\n    \"thinking\",\n    \"has_answer\",\n    \"needs_escalation\",\n    \"source\",\n    \"response\"\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -528,
        1024
      ],
      "id": "e2decc2c-d8a7-4dc8-9718-2dd1d7244575",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "jsCode": "const input = $('Parse Input').first().json;\nconst history = $('Load History').all() || [];\nconst user = $('Upsert User').first().json;\n\n// Get summary if exists\nlet summaryContext = '';\ntry {\n  const summaryData = $('Load Summary').first()?.json;\n  if (summaryData?.summary) {\n    summaryContext = '[–ü–†–ï–î–´–î–£–©–ò–ô –ö–û–ù–¢–ï–ö–°–¢] ' + summaryData.summary + '\\n\\n';\n  }\n} catch (e) {}\n\n// Check escalation cooldown\nlet isInCooldown = false;\nlet escalatedAt = null;\ntry {\n  const escStatus = $('Load Escalation Status').first()?.json;\n  isInCooldown = escStatus?.is_in_cooldown || false;\n  escalatedAt = escStatus?.escalated_at;\n} catch (e) {}\n\n// –ü–æ–ª—É—á–∞–µ–º intent\nlet currentIntent = 'unknown';\ntry {\n  const classifyResult = $('Classify Intent').first()?.json?.output;\n  if (classifyResult?.intent) {\n    currentIntent = classifyResult.intent;\n  }\n} catch (e) {\n  const routing = input._routing || {};\n  if (routing.isGreetingByText || routing.routeReason === 'greeting_on_topic') {\n    currentIntent = 'greeting';\n  } else if (routing.isShortAnswer || routing.routeReason === 'answer_in_dialog') {\n    currentIntent = 'details';\n  }\n}\n\n// History\nconst historyLimit = summaryContext ? 5 : 10;\nconst recentHistory = history.slice(0, historyLimit);\nconst historyText = recentHistory\n  .reverse()\n  .map(m => { const r = m.json.role; if (r === 'user') return '–ö–ª–∏–µ–Ω—Ç: ' + m.json.content; if (r === 'assistant') return '–ë–æ—Ç: ' + m.json.content; if (r === 'manager') return '–ú–µ–Ω–µ–¥–∂–µ—Ä: ' + m.json.content; if (r === 'system') return '[' + m.json.content + ']'; return m.json.content; })\n  .join('\\n') || '(–Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥)';\n\n// Deadlock detection (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é, –Ω–æ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)\nconst isFrustration = currentIntent === 'frustration';\nconst isHumanRequest = currentIntent === 'human_request';\nconst isDeadlock = isFrustration || isHumanRequest;\nlet deadlockReason = null;\nif (isFrustration) deadlockReason = 'frustration';\nelse if (isHumanRequest) deadlockReason = 'human_request';\n\nreturn [{\n  json: {\n    message: input.text,\n    originalMessage: input.originalText || input.text,\n    history: summaryContext + historyText,\n    conversation_id: user.conversation_id,\n    client_id: user.client_id,\n    remoteJid: input.remoteJid,\n    phone: input.phone,\n    currentIntent,\n    isInCooldown,\n    escalatedAt,\n    isDeadlock,\n    deadlockReason\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1776,
        656
      ],
      "id": "11c44d56-f39f-4514-9685-e901f862bcad",
      "name": "Build Context"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": " INSERT INTO messages (conversation_id, client_id, role, content, metadata)\n     VALUES\n       ('{{ $json.conversation_id }}', '{{ $json.client_id }}', 'user', '{{ $json.safe_message }}', '{\"fallback\": true}'),\n       ('{{ $json.conversation_id }}', '{{ $json.client_id }}', 'assistant', '{{ $json.safe_response }}', '{\"fallback\":\n     true, \"reason\": \"{{ $json.quality_reason }}\"}');",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2896,
        368
      ],
      "id": "37ab71b5-1ee1-4c88-beae-49e5c6a0e435",
      "name": "Save Messages (Fallback)1",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "url": "https://app.chatflow.kz/api/v1/send-text",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "REDACTED_JWT"
            },
            {
              "name": "instance_id",
              "value": "={{ $('Prepare Response').first().json.instance_id }}"
            },
            {
              "name": "jid",
              "value": "={{ $('Parse Quality').item.json.remoteJid }}"
            },
            {
              "name": "msg",
              "value": "={{ $('Quality Decision').item.json.response }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2672,
        368
      ],
      "id": "c9dbd13f-0523-48e1-ae96-379e85dd7548",
      "name": "Send Fallback2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT m.role, m.content FROM messages m JOIN conversations c ON m.conversation_id = c.id JOIN users u ON c.user_id = u.id WHERE u.phone = '{{ $json.phone }}' AND m.content IS NOT NULL AND m.content != '' ORDER BY m.created_at DESC LIMIT 5;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3696,
        464
      ],
      "id": "load-history-classifier-001",
      "name": "Load History for Classifier",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $('Skip Classifier?').first().json;\nconst historyRows = $('Load History for Classifier').all() || [];\n\nconst historyText = historyRows\n  .reverse()\n  .map(m => { const r = m.json.role; if (r === 'user') return '–ö–ª–∏–µ–Ω—Ç: ' + m.json.content; if (r === 'assistant') return '–ë–æ—Ç: ' + m.json.content; if (r === 'manager') return '–ú–µ–Ω–µ–¥–∂–µ—Ä: ' + m.json.content; if (r === 'system') return '[' + m.json.content + ']'; return m.json.content; })\n  .join('\\n') || '(–Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥)';\n\nreturn [{\n  json: {\n    ...input,\n    text: input.text,\n    historyContext: historyText\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3472,
        464
      ],
      "id": "format-classifier-input-001",
      "name": "Format Classifier Input"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:\n{{ $json.historyContext }}\n\n–¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:\n{{ $json.text }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "–û–ø—Ä–µ–¥–µ–ª–∏ intent –¢–ï–ö–£–©–ï–ì–û —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞. –ò—Å—Ç–æ—Ä–∏—è –¥–∞–Ω–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –Ω–æ –æ—Ü–µ–Ω–∏–≤–∞–π –¢–ï–ö–£–©–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ.\n\nINTENT'–´:\n- greeting: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n- pricing: –≤–æ–ø—Ä–æ—Å –æ —Ü–µ–Ω–µ\n- what_is_this: —á—Ç–æ —ç—Ç–æ –∑–∞ –ø—Ä–æ–¥—É–∫—Ç\n- how_to_start: –∫–∞–∫ –Ω–∞—á–∞—Ç—å/–ø–æ–¥–∫–ª—é—á–∏—Ç—å\n- availability: –Ω–∞–ª–∏—á–∏–µ/–∑–∞–ø–∏—Å—å\n- order: –∑–∞–∫–∞–∑\n- payment: –æ–ø–ª–∞—Ç–∞/Kaspi\n- delivery: –¥–æ—Å—Ç–∞–≤–∫–∞\n- details: —É—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π, –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –±–æ—Ç–∞\n- integration: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏\n- objection_expensive: –¥–æ—Ä–æ–≥–æ\n- objection_later: –ø–æ–¥—É–º–∞—é/–ø–æ–∑–∂–µ\n- objection_doubt: —Å–æ–º–Ω–µ–Ω–∏—è, —Å–∫–µ–ø—Ç–∏—Ü–∏–∑–º (–≤—ã —Ç–æ—á–Ω–æ —É–º–µ–µ—Ç–µ? –∞ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç? –Ω–µ –≤–µ—Ä—é)\n- complaint: –∂–∞–ª–æ–±–∞ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç/—Å–µ—Ä–≤–∏—Å (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤–æ–∑–≤—Ä–∞—Ç)\n- frustration: –¢–û–õ–¨–ö–û –º–∞—Ç, –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, —è–≤–Ω–∞—è –∞–≥—Ä–µ—Å—Å–∏—è (–±–ª—è—Ç—å, —Ö—É–π–Ω—è, –∏–¥–∏–æ—Ç—ã)\n- human_request: —Ö–æ—á–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞/—á–µ–ª–æ–≤–µ–∫–∞\n- thanks_positive: –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å\n- thanks_bye: –ø—Ä–æ—â–∞–Ω–∏–µ\n- out_of_domain: —Å–æ–≤—Å–µ–º –Ω–µ –ø–æ —Ç–µ–º–µ (–ø–æ–≥–æ–¥–∞, —Ä–µ—Ü–µ–ø—Ç—ã)\n- attack: –ø–æ–ø—ã—Ç–∫–∞ –≤–∑–ª–æ–º–∞\n\n–í–ê–ñ–ù–û:\n1. frustration = –¢–û–õ–¨–ö–û –ú–ê–¢ –ò –û–°–ö–û–†–ë–õ–ï–ù–ò–Ø. –ë–µ–∑ –º–∞—Ç–∞ = –ù–ï frustration\n2. –°–æ–º–Ω–µ–Ω–∏—è –±–µ–∑ –º–∞—Ç–∞ (–≤—ã —Ç–æ—á–Ω–æ —É–º–µ–µ—Ç–µ?) = objection_doubt, –ù–ï frustration\n3. –°–∫–µ–ø—Ç–∏—Ü–∏–∑–º = objection_doubt\n4. –ò—Å—Ç–æ—Ä–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–π, –Ω–æ –µ—Å–ª–∏ –¢–ï–ö–£–©–ï–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –º–∞—Ç–∞ ‚Äî —ç—Ç–æ –ù–ï frustration"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -3248,
        464
      ],
      "id": "385c47d3-57b7-431d-87b6-841dd3a703cf",
      "name": "Classify Intent",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.message }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "={{ $json.full_prompt }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -656,
        800
      ],
      "id": "d0c2e59a-bda7-4af9-a4cb-5ec61efbbc78",
      "name": "Generate Response"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.output.needs_escalation }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "0a52ed57-fcfd-4cc8-a9d5-520a62eb4f23"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -304,
        800
      ],
      "id": "38848881-1ebf-4306-8a7d-2d80fc7be538",
      "name": "Check Escalation"
    },
    {
      "parameters": {
        "jsCode": "const prev = $('Build Context').first().json;\nconst generation = $('Generate Response').first().json.output;\nconst instanceId = $('Prepare Prompt').first().json.instance_id;\n\nconst escapeSQL = (str) => String(str || '').replace(/'/g, \"''\");\n\nreturn [{\n  json: {\n    conversation_id: prev.conversation_id,\n    client_id: prev.client_id,\n    remoteJid: prev.remoteJid,\n    phone: prev.phone,\n    message: prev.message,\n    response: generation.response,\n    safe_message: escapeSQL(prev.message),\n    safe_response: escapeSQL(generation.response),\n    thinking: generation.thinking,\n    has_answer: generation.has_answer,\n    needs_escalation: generation.needs_escalation,\n    source: generation.source || 'none',\n    instance_id: instanceId\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        688
      ],
      "id": "29dc5b93-4bd1-4147-8a58-1b2bbf58077e",
      "name": "Prepare Response"
    },
    {
      "parameters": {
        "jsCode": "const input = $('Parse Input').first().json;\n     const intent = $json.output?.intent || $json.intent;\n\n     let response;\n     if (intent === 'attack') {\n       response = '–Ø –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç Truffles. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º AI-–±–æ—Ç–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞?';\n     } else {\n       response = '–Ø –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç Truffles ‚Äî –º—ã –¥–µ–ª–∞–µ–º AI-–±–æ—Ç–æ–≤ –¥–ª—è WhatsApp, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–≤–µ—á–∞—é—Ç –≤–∞—à–∏–º –∫–ª–∏–µ–Ω—Ç–∞–º 24/7. –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –Ω–æ—á—å—é, –∫–æ–≥–¥–∞ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–ø–∏—Ç üòä\\n\\n–ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ!'; }\n\n     return [{\n       json: {\n         phone: input.phone,\n         remoteJid: input.remoteJid,\n         response: response,\n         intent: intent\n       }\n     }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2672,
        848
      ],
      "id": "79f0bd09-f6a1-4310-a0a3-793b14fecd3c",
      "name": "Build Off-Topic Response"
    },
    {
      "parameters": {
        "url": "https://app.chatflow.kz/api/v1/send-text",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "REDACTED_JWT"
            },
            {
              "name": "instance_id",
              "value": "={{ $('Load Prompt').first().json.instance_id }}"
            },
            {
              "name": "jid",
              "value": "={{ $json.remoteJid }}"
            },
            {
              "name": "msg",
              "value": "={{ $json.response }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2448,
        944
      ],
      "id": "9393af23-76e9-4624-81e2-588808d82b48",
      "name": "Send Off-Topic"
    },
    {
      "parameters": {
        "url": "https://app.chatflow.kz/api/v1/send-text",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "REDACTED_JWT"
            },
            {
              "name": "instance_id",
              "value": "={{ $('Prepare Response').first().json.instance_id }}"
            },
            {
              "name": "jid",
              "value": "={{ $('Prepare Response').item.json.remoteJid }}"
            },
            {
              "name": "msg",
              "value": "={{ $('Prepare Response').first().json.response }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Me",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        944,
        784
      ],
      "id": "6e23777c-3f15-43a5-8f7a-4f046b7e291e"
    },
    {
      "parameters": {
        "url": "https://app.chatflow.kz/api/v1/send-text",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "REDACTED_JWT"
            },
            {
              "name": "instance_id",
              "value": "={{ $('Prepare Response').first().json.instance_id }}"
            },
            {
              "name": "jid",
              "value": "={{ $('Prepare Response').item.json.remoteJid }}"
            },
            {
              "name": "msg",
              "value": "={{ $('Prepare Response').item.json.response }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4592,
        -96
      ],
      "id": "dbaa64be-2315-4980-9766-076ba5f3f1ff",
      "name": "Send to WhatsApp",
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "1969855532",
        "text": "=üì± –ö–ª–∏–µ–Ω—Ç: {{ $('Prepare Response').item.json.phone }}\nüí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: {{ $('Prepare Response').item.json.message }}\n\nü§ñ –ë–æ—Ç: {{ $('Prepare Response').item.json.response }}\nüß† Intent: {{ $('Build Context').item.json.currentIntent }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "id": "dc623a97-5934-4324-9f24-61814ac3a6c0",
      "name": "Me1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        944,
        592
      ],
      "webhookId": "2cc848c8-10f5-4ade-9164-426d7d84dac9",
      "credentials": {
        "telegramApi": {
          "id": "1YMuki43SISyhVa0",
          "name": "TradingBot"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "1969855532",
        "text": "=üö® –≠–°–ö–ê–õ–ê–¶–ò–Ø\n\nüì± –ö–ª–∏–µ–Ω—Ç: {{ $('Build Context').first().json.phone }}\nüí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: {{ $('Build Context').first().json.message }}\n\nü§ñ –û—Ç–≤–µ—Ç –±–æ—Ç–∞: {{ $json.output.response }}\nüß† –ü—Ä–∏—á–∏–Ω–∞: {{ $json.output.thinking }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "id": "12b399c1-a6d0-4752-a631-1206cda1b03d",
      "name": "Me2",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        208,
        1296
      ],
      "webhookId": "2cc848c8-10f5-4ade-9164-426d7d84dac9",
      "credentials": {
        "telegramApi": {
          "id": "DFybSmTMlRzSErWx",
          "name": "TrufflesChatBot"
        }
      }
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -4592,
        688
      ],
      "id": "95c425cb-c680-4eee-87c0-e124020f1118",
      "name": "Start"
    },
    {
      "parameters": {
        "jsCode": "// Intent Router ‚Äî –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Ç–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ intent_type\n// greeting/answer ‚Üí Main Flow (skip Classifier)\n// question/statement ‚Üí Classifier\n\nconst input = $json;\n\n// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç TurnDetector —á–µ—Ä–µ–∑ Start\nconst rawData = $('Start').first().json;\nconst turnAnalysis = rawData.turn_analysis || {};\nconst intentType = turnAnalysis.intent_type || 'unknown';\nconst mergedMessage = turnAnalysis.merged_message || input.text || '';\nconst contextHint = turnAnalysis.context_hint || '';\n\n// –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏\nconst textLower = mergedMessage.toLowerCase().trim();\n\n// === –≠–í–†–ò–°–¢–ò–ö–ò –î–õ–Ø –ü–†–ò–í–ï–¢–°–¢–í–ò–ô ===\nconst greetingPatterns = [\n  '–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π', '–¥–æ–±—Ä—ã–π –¥–µ–Ω—å', '–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä',\n  '–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ', '–¥–æ–±—Ä—ã–π', '—Ö–∞–π', '—Ö–µ–ª–ª–æ', 'hello', 'hi',\n  '—Å–∞–ª–µ–º', '—Å”ô–ª–µ–º', '–∞—Å—Å–∞–ª–∞–º', '–∑–¥–æ—Ä–æ–≤–æ', '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é',\n  '–¥–æ–±—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏', '–¥–µ–Ω—å –¥–æ–±—Ä—ã–π', '–≤–µ—á–µ—Ä –¥–æ–±—Ä—ã–π'\n];\n\nconst isGreetingByText = greetingPatterns.some(p => textLower.includes(p));\nconst isGreetingByHint = contextHint.toLowerCase().includes('–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤');\n\n// === –≠–í–†–ò–°–¢–ò–ö–ò –î–õ–Ø –ö–û–†–û–¢–ö–ò–• –û–¢–í–ï–¢–û–í ===\nconst shortAnswers = [\n  '–¥–∞', '–Ω–µ—Ç', '–æ–∫', '–æ–∫–µ–π', '—Ö–æ—Ä–æ—à–æ', '–ª–∞–¥–Ω–æ', '–ø–æ–Ω—è–ª',\n  '–∞–≥–∞', '—É–≥—É', '–¥–∞–≤–∞–π', '–≥–æ', '–∫–æ–Ω–µ—á–Ω–æ', '—Å–æ–≥–ª–∞—Å–µ–Ω'\n];\nconst isShortAnswer = shortAnswers.includes(textLower);\n\n// === –û–ü–†–ï–î–ï–õ–Ø–ï–ú –†–û–£–¢–ò–ù–ì ===\nlet skipClassifier = false;\nlet routeReason = '';\n\n// 1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî –≤—Å–µ–≥–¥–∞ ON-TOPIC\nif (intentType === 'greeting' || isGreetingByText || isGreetingByHint) {\n  skipClassifier = true;\n  routeReason = 'greeting_on_topic';\n}\n// 2. –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –±–æ—Ç–∞ ‚Äî –∫–ª–∏–µ–Ω—Ç —É–∂–µ –≤ –¥–∏–∞–ª–æ–≥–µ\nelse if (intentType === 'answer' || isShortAnswer) {\n  skipClassifier = true;\n  routeReason = 'answer_in_dialog';\n}\n// 3. –í–æ–ø—Ä–æ—Å –∏–ª–∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Äî –Ω—É–∂–Ω–∞ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞\nelse {\n  skipClassifier = false;\n  routeReason = 'needs_topic_check';\n}\n\nreturn [{\n  json: {\n    ...input,\n    _routing: {\n      intentType,\n      skipClassifier,\n      routeReason,\n      isGreetingByText,\n      isGreetingByHint,\n      isShortAnswer,\n      mergedMessage\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4144,
        592
      ],
      "id": "045ea37e-bd83-4bef-9b90-bfaa8404b665",
      "name": "Intent Router"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f5f218a5-0a1e-412f-92a3-b3b5c7521df0",
              "leftValue": "={{ $json._routing.skipClassifier }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3920,
        592
      ],
      "id": "aa432e5b-f3bd-482c-9c15-137f4be2b020",
      "name": "Skip Classifier?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "deadlock-check-1",
              "leftValue": "={{ $json.isDeadlock }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1552,
        656
      ],
      "id": "deadlock-router-001",
      "name": "Is Deadlock"
    },
    {
      "parameters": {
        "jsCode": "const ctx = $('Build Context').first().json;\nconst escapeSQL = (str) => String(str || '').replace(/'/g, \"''\");\n\nlet response;\nif (ctx.deadlockReason === 'human_request') {\n  response = '–ü–µ—Ä–µ–¥–∞—é –≤–∞—à –≤–æ–ø—Ä–æ—Å –º–µ–Ω–µ–¥–∂–µ—Ä—É ‚Äî —Å–≤—è–∂–µ—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.';\n} else if (ctx.deadlockReason === 'frustration') {\n  response = '–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ –≤—ã —Ä–∞—Å—Å—Ç—Ä–æ–µ–Ω—ã. –ü–µ—Ä–µ–¥–∞—é –º–µ–Ω–µ–¥–∂–µ—Ä—É ‚Äî —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –ª–∏—á–Ω–æ.';\n} else if (ctx.deadlockReason === 'post_deadlock') {\n  response = '–ú–µ–Ω–µ–¥–∂–µ—Ä —É–∂–µ –≤ –∫—É—Ä—Å–µ –∏ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏.';\n} else {\n  response = '–ü–µ—Ä–µ–¥–∞—é –º–µ–Ω–µ–¥–∂–µ—Ä—É ‚Äî —Å–≤—è–∂–µ—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.';\n}\n\nreturn [{\n  json: {\n    conversation_id: ctx.conversation_id,\n    client_id: ctx.client_id,\n    remoteJid: ctx.remoteJid,\n    phone: ctx.phone,\n    message: ctx.message,\n    response: response,\n    safe_message: escapeSQL(ctx.message),\n    safe_response: escapeSQL(response),\n    isDeadlock: true,\n    deadlockReason: ctx.deadlockReason\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2672,
        1040
      ],
      "id": "deadlock-response-001",
      "name": "Deadlock Response"
    },
    {
      "parameters": {
        "jsCode": "const ctx = $('Build Context').first().json;\nconst prep = $('Prepare Response').first().json;\n\n// Format conversation for summarization\nconst history = ctx.history || '';\nconst lastMessage = ctx.message;\nconst botResponse = prep.response;\n\nconst fullConversation = history + '\\n–ö–ª–∏–µ–Ω—Ç: ' + lastMessage + '\\n–ë–æ—Ç: ' + botResponse;\n\nreturn [{\n  json: {\n    conversation_id: ctx.conversation_id,\n    client_id: ctx.client_id,\n    conversation: fullConversation,\n    current_intent: ctx.currentIntent\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -80,
        928
      ],
      "id": "summarize-prep-001",
      "name": "Prepare for Summary"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.conversation }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "–¢—ã ‚Äî —Å—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–æ–≤. –°–∂–º–∏ –¥–∏–∞–ª–æ–≥ –≤ –∫—Ä–∞—Ç–∫—É—é –≤—ã–∂–∏–º–∫—É.\n\n–ß–¢–û –í–ö–õ–Æ–ß–ê–¢–¨:\n- –ß—Ç–æ —Ö–æ—Ç–µ–ª –∫–ª–∏–µ–Ω—Ç (intent)\n- –ö–∞–∫–æ–π –±–∏–∑–Ω–µ—Å (–µ—Å–ª–∏ —Å–∫–∞–∑–∞–ª)\n- –ß—Ç–æ —Ä–µ—à–∏–ª–∏: interested, refused, thinking, unknown\n- –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏\n\n–ß–¢–û –ù–ï –í–ö–õ–Æ–ß–ê–¢–¨:\n- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –º–∞—Ç, –∂–∞–ª–æ–±—ã\n- –ü–æ–≤—Ç–æ—Ä—ã\n\n–§–û–†–ú–ê–¢ JSON:\n{\n  \"summary\": \"1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è\",\n  \"key_facts\": {\n    \"intent\": \"—á—Ç–æ —Ö–æ—Ç–µ–ª\",\n    \"business\": \"—Ç–∏–ø –±–∏–∑–Ω–µ—Å–∞ –∏–ª–∏ unknown\",\n    \"decision\": \"interested | refused | thinking | unknown\"\n  },\n  \"last_intent\": \"–ø–æ—Å–ª–µ–¥–Ω–∏–π intent\"\n}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        144,
        816
      ],
      "id": "summarize-llm-001",
      "name": "Summarize Conversation"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"summary\": {\"type\": \"string\"},\n    \"key_facts\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"intent\": {\"type\": \"string\"},\n        \"business\": {\"type\": \"string\"},\n        \"decision\": {\"type\": \"string\", \"enum\": [\"interested\", \"refused\", \"thinking\", \"unknown\"]}\n      }\n    },\n    \"last_intent\": {\"type\": \"string\"}\n  },\n  \"required\": [\"summary\", \"key_facts\", \"last_intent\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        288,
        1040
      ],
      "id": "summary-parser-001",
      "name": "Summary Parser"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        160,
        1040
      ],
      "id": "summary-model-001",
      "name": "Summary Model",
      "credentials": {
        "openAiApi": {
          "id": "C31JRkzPBiItNcOT",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO conversation_summaries (conversation_id, client_id, summary, key_facts, last_intent)\nVALUES (\n  '{{ $('Prepare for Summary').item.json.conversation_id }}',\n  '{{ $('Prepare for Summary').item.json.client_id }}',\n  '{{ $json.output.summary.replace(/'/g, \"''\") }}',\n  '{{ JSON.stringify($json.output.key_facts).replace(/'/g, \"''\") }}'::jsonb,\n  '{{ $json.output.last_intent.replace(/'/g, \"''\") }}'\n)\nON CONFLICT (conversation_id) DO UPDATE SET\n  summary = EXCLUDED.summary,\n  key_facts = EXCLUDED.key_facts,\n  last_intent = EXCLUDED.last_intent,\n  updated_at = NOW();",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        496,
        1008
      ],
      "id": "save-summary-001",
      "name": "Save Summary",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT summary, key_facts, last_intent\nFROM conversation_summaries\nWHERE conversation_id = '{{ $('Upsert User').item.json.conversation_id }}'\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -4592,
        1584
      ],
      "id": "load-summary-001",
      "name": "Load Summary",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  escalated_at,\n  CASE \n    WHEN escalated_at IS NULL THEN FALSE\n    WHEN escalated_at > NOW() - INTERVAL '30 minutes' THEN TRUE\n    ELSE FALSE\n  END as is_in_cooldown\nFROM conversations\nWHERE id = '{{ $('Upsert User').item.json.conversation_id }}';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -4592,
        128
      ],
      "id": "load-escalation-status-001",
      "name": "Load Escalation Status",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE conversations \nSET escalated_at = NOW()\nWHERE id = '{{ $('Build Context').first().json.conversation_id }}';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        496,
        1360
      ],
      "id": "update-escalation-001",
      "name": "Update Escalation Time",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const ctx = $('Build Context').first().json;\nconst clientSlug = $('Parse Input').first().json.client_slug || 'truffles';\n\n// 1. Get embedding from BGE-M3\nconst bgeResponse = await this.helpers.httpRequest({\n    method: 'POST',\n    url: 'http://bge-m3:80/embed',\n    body: { inputs: ctx.message },\n    json: true\n});\n\nconst vector = bgeResponse[0];\n\n// 2. Search Qdrant with client filter\nconst searchPayload = {\n    vector: vector,\n    limit: 5,\n    with_payload: true,\n    filter: {\n        must: [\n            { key: 'metadata.client_slug', match: { value: clientSlug } }\n        ]\n    }\n};\n\nconst searchResponse = await this.helpers.httpRequest({\n    method: 'POST',\n    url: 'http://qdrant:6333/collections/truffles_knowledge/points/search',\n    headers: {\n        'api-key': 'REDACTED_PASSWORD',\n        'Content-Type': 'application/json'\n    },\n    body: searchPayload,\n    json: true\n});\n\nconst results = searchResponse.result || [];\n\n// 3. Format knowledge\nconst knowledge = results\n    .map(r => r.payload?.content || '')\n    .filter(t => t)\n    .join('\\n\\n---\\n\\n') || '(–Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –±–∞–∑–µ)';\n\nreturn {\n    json: {\n        ...ctx,\n        knowledge: knowledge,\n        rag_scores: results.map(r => r.score),\n        client_slug: clientSlug\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1328,
        800
      ],
      "id": "7b1a9b49-1856-4f17-9c74-4a9e2fb3fa59",
      "name": "RAG Search"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO message_traces (\n    phone,\n    conversation_id,\n    message,\n    intent,\n    rag_top_score,\n    rag_top_doc,\n    rag_scores,\n    response,\n    has_answer,\n    needs_escalation\n) VALUES (\n    '{{ $('Build Context').first().json.phone }}',\n    '{{ $('Build Context').first().json.conversation_id }}',\n    '{{ $('Build Context').first().json.message.replace(/'/g, \"''\") }}',\n    '{{ $('Build Context').first().json.currentIntent }}',\n    {{ $('RAG Search').first().json.rag_scores[0] || 0 }},\n    '{{ $('RAG Search').first().json.knowledge.substring(0, 50).replace(/'/g, \"''\") }}',\n    '{{ JSON.stringify($('RAG Search').first().json.rag_scores || []) }}',\n    '{{ $json.response.replace(/'/g, \"''\") }}',\n    {{ $json.has_answer || false }},\n    {{ $json.needs_escalation || false }}\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        720,
        880
      ],
      "id": "09f4ae61-aa8a-4f8e-9ab2-7c3e880b18e8",
      "name": "Save Trace",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  p.text as system_prompt,\n  c.config->>'instance_id' as instance_id\nFROM clients c\nLEFT JOIN prompts p ON p.client_id = c.id AND p.name IN ('system', 'system_prompt') AND p.is_active = true\nWHERE c.name = '{{ $('Parse Input').first().json.client_slug }}'\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2000,
        656
      ],
      "id": "load-prompt-001",
      "name": "Load Prompt",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—ã–π prompt + instance_id\nconst ctx = $json; // –æ—Ç Add Knowledge\nconst loadedPrompt = $('Load Prompt').first().json;\n\nconst basePrompt = loadedPrompt.system_prompt || `–¢—ã ‚Äî AI-–ø–æ–º–æ—â–Ω–∏–∫. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.`;\nconst instanceId = loadedPrompt.instance_id || '';\n\nconst fullPrompt = basePrompt + `\n\n## –î–ê–ù–ù–´–ï\n–ò—Å—Ç–æ—Ä–∏—è: ${ctx.history}\n–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π: ${ctx.knowledge}\n\nIntent: ${ctx.currentIntent}\nisInCooldown: ${ctx.isInCooldown}\n\n## –≠–°–ö–ê–õ–ê–¶–ò–Ø (needs_escalation = true)\n–°—Ç–∞–≤—å needs_escalation = true –∫–æ–≥–¥–∞:\n1. –ú–ê–¢ –∏–ª–∏ –û–°–ö–û–†–ë–õ–ï–ù–ò–Ø –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏\n2. –ö–ª–∏–µ–Ω—Ç –Ø–í–ù–û –ø—Ä–æ—Å–∏—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞/—á–µ–ª–æ–≤–µ–∫–∞\n3. –ö–ª–∏–µ–Ω—Ç 2+ —Ä–∞–∑–∞ –≤—ã—Ä–∞–∂–∞–ª –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ\n4. –°–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å –≤–Ω–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π\n\n## COOLDOWN\n–ï—Å–ª–∏ isInCooldown = true –ò intent –ù–ï human_request:\n- –ù–ï —ç—Å–∫–∞–ª–∏—Ä—É–π\n- –û—Ç–≤–µ—Ç—å: \"–ú–µ–Ω–µ–¥–∂–µ—Ä —É–∂–µ –≤ –∫—É—Ä—Å–µ.\"\n\n## –ü–†–ê–í–ò–õ–ê\n1. –ö–æ—Ä–æ—Ç–∫–æ (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)\n2. –ù–ï –í–´–î–£–ú–´–í–ê–ô ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π\n3. –£–∫–∞–∑—ã–≤–∞–π SOURCE\n4. –ï—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ñ–æ ‚Äî —Å–∫–∞–∂–∏ —á–µ—Å—Ç–Ω–æ\n\n## SOURCE\n–£–∫–∞–∂–∏ –¥–æ–∫—É–º–µ–Ω—Ç: faq.md, services.md, objections.md, rules.md, –∏–ª–∏ 'none'\n`;\n\nreturn [{\n  json: {\n    ...ctx,\n    full_prompt: fullPrompt,\n    instance_id: instanceId\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -880,
        800
      ],
      "id": "prepare-prompt-001",
      "name": "Prepare Prompt"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  c.bot_status,\n  c.bot_muted_until,\n  CASE \n    WHEN c.bot_status = 'muted' AND c.bot_muted_until > NOW() THEN true\n    ELSE false\n  END as is_muted\nFROM conversations c\nJOIN users u ON c.user_id = u.id\nWHERE u.phone = '{{ $('Parse Input').first().json.phone }}'\n  AND c.status = 'active'\nORDER BY c.last_message_at DESC\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -4144,
        992
      ],
      "id": "check-muted-001",
      "name": "Check Bot Muted",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "muted-check",
              "leftValue": "={{ $json.is_muted }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3920,
        992
      ],
      "id": "is-muted-001",
      "name": "Is Bot Muted?"
    },
    {
      "parameters": {
        "jsCode": "// –ë–æ—Ç –∑–∞–º—å—é—á–µ–Ω - –≤—ã—Ö–æ–¥–∏–º –º–æ–ª—á–∞, –Ω–µ –æ—Ç–≤–µ—á–∞–µ–º\nreturn [];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3696,
        992
      ],
      "id": "silent-exit-muted-001",
      "name": "Silent Exit (Muted)"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "7jGZrdbaAAvtTnQX",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "autoMapInputData",
          "value": {}
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        208,
        528
      ],
      "id": "call-escalation-001",
      "name": "Call Escalation Handler"
    },
    {
      "parameters": {
        "jsCode": "// –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Escalation Handler\nconst ctx = $('Build Context').first().json;\nconst genResponse = $json.output || {};\n\nreturn [{\n  json: {\n    conversation_id: ctx.conversation_id,\n    client_id: ctx.client_id,\n    phone: ctx.phone,\n    remoteJid: ctx.remoteJid,\n    message: ctx.message,\n    reason: ctx.deadlockReason || 'escalation',\n    bot_response: genResponse.response || ''\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -80,
        528
      ],
      "id": "prep-escalation-001",
      "name": "Prepare Escalation Data"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  h.id as handover_id,\n  h.conversation_id as handover_conversation_id,\n  c.telegram_topic_id,\n  cs.telegram_chat_id,\n  cs.telegram_bot_token,\n  COALESCE(u.name, u.phone, '–ö–ª–∏–µ–Ω—Ç') as client_name\nFROM conversations c\nLEFT JOIN handovers h ON h.conversation_id = c.id AND h.status = 'active'\nLEFT JOIN client_settings cs ON cs.client_id = c.client_id\nLEFT JOIN users u ON u.id = c.user_id\nWHERE c.id = '{{ $('Build Context').first().json.conversation_id }}'\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1200,
        304
      ],
      "id": "ma-check-handover",
      "name": "Check Active Handover",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "caseSensitive": true,
            "leftValue": ""
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-handover",
              "leftValue": "={{ $json.handover_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1408,
        304
      ],
      "id": "ma-has-handover",
      "name": "Handover Active?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('Check Active Handover').first().json.telegram_bot_token }}/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('Check Active Handover').first().json.telegram_chat_id }}"
            },
            {
              "name": "message_thread_id",
              "value": "={{ $('Check Active Handover').first().json.telegram_topic_id }}"
            },
            {
              "name": "text",
              "value": "=üí¨ {{ $('Check Active Handover').first().json.client_name }}: {{ $('Build Context').first().json.originalMessage }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1600,
        256
      ],
      "id": "ma-forward-topic",
      "name": "Forward to Topic"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE handovers \nSET messages = COALESCE(messages, '[]'::jsonb) || \n  jsonb_build_array(jsonb_build_object(\n    'from', 'client',\n    'text', '{{ $('Build Context').first().json.originalMessage }}',\n    'at', NOW()::text\n  ))\nWHERE id = '{{ $('Check Active Handover').first().json.handover_id }}';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1808,
        256
      ],
      "id": "ma-save-client-msg",
      "name": "Save Client Message",
      "credentials": {
        "postgres": {
          "id": "SUHrbh39Ig0fBusT",
          "name": "ChatbotDB"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2000,
        256
      ],
      "id": "ma-exit-handover",
      "name": "Exit (Handover Active)"
    }
  ],
  "pinData": {
    "Start": [
      {
        "json": {
          "channel": "whatsapp",
          "user_id": "77015705555",
          "session_id": "77015705555@s.whatsapp.net",
          "sender_name": "Zh.",
          "buffered_messages": [
            {
              "text": "—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∫–æ–º–ø–∞–Ω–∏—é",
              "type": "text",
              "timestamp": 1765070184,
              "message_id": "3F1360425D02B7902C41"
            },
            {
              "text": "—á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å",
              "type": "text",
              "timestamp": 1765070188,
              "message_id": "3FDB3E5E83B2F5BAB163"
            }
          ],
          "buffered_count": 2,
          "merged_text": "—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∫–æ–º–ø–∞–Ω–∏—é\n—á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å",
          "has_audio": false,
          "has_image": false,
          "last_message_type": "text",
          "heuristics": {
            "confidence": 0.7,
            "intent_type": "unknown",
            "skip_llm": false
          },
          "turn_analysis": {
            "is_complete": true,
            "intent_type": "question",
            "merged_message": "–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∫–æ–º–ø–∞–Ω–∏—é, —á–µ–º –≤—ã –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å?",
            "context_hint": "–∫–æ–º–ø–∞–Ω–∏—è, –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
            "confidence": 0.7
          }
        }
      }
    ]
  },
  "connections": {
    "Parse Input": {
      "main": [
        [
          {
            "node": "Intent Router",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Bot Muted",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert User": {
      "main": [
        [
          {
            "node": "Save User Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load History": {
      "main": [
        [
          {
            "node": "Load Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Messages": {
      "main": [
        [
          {
            "node": "Me",
            "type": "main",
            "index": 0
          },
          {
            "node": "Me1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save User Message": {
      "main": [
        [
          {
            "node": "Load History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Classify Intent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Classify Intent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Is On Topic": {
      "main": [
        [
          {
            "node": "Upsert User",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Off-Topic Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Knowledge": {
      "main": [
        [
          {
            "node": "Prepare Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Generate Response",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Generate Response",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Build Context": {
      "main": [
        [
          {
            "node": "Check Active Handover",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Deadlock": {
      "main": [
        [
          {
            "node": "Prepare Escalation Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "RAG Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deadlock Response": {
      "main": [
        [
          {
            "node": "Send Off-Topic",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Messages (Fallback)1": {
      "main": [
        [
          {
            "node": "Send Fallback2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classify Intent": {
      "main": [
        [
          {
            "node": "Is On Topic",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Save Messages (Fallback)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Response": {
      "main": [
        [
          {
            "node": "Check Escalation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Escalation": {
      "main": [
        [
          {
            "node": "Prepare Escalation Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare for Summary",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Response": {
      "main": [
        [
          {
            "node": "Save Messages",
            "type": "main",
            "index": 0
          },
          {
            "node": "Save Trace",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Off-Topic Response": {
      "main": [
        [
          {
            "node": "Send Off-Topic",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Me2": {
      "main": [
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          },
          {
            "node": "Update Escalation Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Start": {
      "main": [
        [
          {
            "node": "Parse Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Intent Router": {
      "main": [
        [
          {
            "node": "Skip Classifier?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip Classifier?": {
      "main": [
        [
          {
            "node": "Upsert User",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Load History for Classifier",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load History for Classifier": {
      "main": [
        [
          {
            "node": "Format Classifier Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Classifier Input": {
      "main": [
        [
          {
            "node": "Classify Intent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for Summary": {
      "main": [
        [
          {
            "node": "Summarize Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Summarize Conversation": {
      "main": [
        [
          {
            "node": "Save Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Summary Model": {
      "ai_languageModel": [
        [
          {
            "node": "Summarize Conversation",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Summary Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Summarize Conversation",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "RAG Search": {
      "main": [
        [
          {
            "node": "Add Knowledge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Prompt": {
      "main": [
        [
          {
            "node": "Build Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Prompt": {
      "main": [
        [
          {
            "node": "Generate Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Bot Muted": {
      "main": [
        [
          {
            "node": "Is Bot Muted?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Bot Muted?": {
      "main": [
        [
          {
            "node": "Silent Exit (Muted)",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Call Escalation Handler": {
      "main": [
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Escalation Data": {
      "main": [
        [
          {
            "node": "Call Escalation Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Active Handover": {
      "main": [
        [
          {
            "node": "Handover Active?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handover Active?": {
      "main": [
        [
          {
            "node": "Forward to Topic",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is Deadlock",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Forward to Topic": {
      "main": [
        [
          {
            "node": "Save Client Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Client Message": {
      "main": [
        [
          {
            "node": "Exit (Handover Active)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "versionId": "c48e04ce-54dd-4e6e-888a-b8db0b633174",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "01b56804ece88a9cc615224a075b1fb601dddc8bc8fa664ead4d87907f4c7973"
  },
  "id": "4vaEvzlaMrgovhNz",
  "tags": []
}