# CORE PLAN — Когнитивное ядро Truffles

**Дата:** 2025-12-04
**Обновлено:** 2025-12-04 (актуальное состояние)
**Статус:** Фаза 1-2 выполнены, Фаза 3-4 следующие

---

## СУТЬ

**Truffles** — AI бот-автоответчик для бизнеса (WhatsApp).
- Фокус: Качество ядра — бот отвечает как настоящий консультант
- Ценность: Клиент получает ответ в 11 вечера

---

## ТЕКУЩАЯ АРХИТЕКТУРА (работает)

```
WhatsApp → ChatFlow Webhook
                ↓
┌─────────────────────────────────────────────┐
│  Parse Input                                │
│  Извлечь: phone, name, message              │
└─────────────────┬───────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│  LLM CLASSIFIER (GPT-4o-mini)               │
│  Вопрос: "Это про Truffles/боты/бизнес?"    │
│  Output: YES / NO / BLOCK                   │
└─────────────────┬───────────────────────────┘
                  ↓
        ┌────────┴────────┐
        │                 │
       YES               NO/BLOCK
        ↓                 ↓
┌───────────────┐  ┌──────────────────┐
│ Save Message  │  │ Respond Out of   │
│ Load History  │  │ Domain           │
│ Build Context │  │ "Я консультант   │
│ RAG Search    │  │  Truffles..."    │
└───────┬───────┘  └──────────────────┘
        ↓
┌─────────────────────────────────────────────┐
│  GENERATION (GPT-4o + Structured Outputs)   │
│  {                                          │
│    thinking: "внутреннее рассуждение",      │
│    has_answer: true/false,                  │
│    needs_escalation: true/false,            │
│    response: "ответ клиенту"                │
│  }                                          │
└─────────────────┬───────────────────────────┘
                  ↓
        ┌────────┴────────┐
        │                 │
   has_answer        needs_escalation
        ↓                 ↓
┌───────────────┐  ┌──────────────────┐
│ Send WhatsApp │  │ Escalate to      │
│               │  │ Manager (TODO)   │
└───────────────┘  └──────────────────┘
```

---

## WORKFLOWS (только 2)

| ID | Название | Назначение |
|----|----------|------------|
| 4vaEvzlaMrgovhNz | Truffles v2 - Multi-Agent | Основной бот |
| zTbaCLWLJN6vPMk4 | Knowledge Sync | Google Docs → Qdrant |

---

## QDRANT (только 1 коллекция)

| Коллекция | Назначение |
|-----------|------------|
| truffles_knowledge | База знаний (FAQ, документы) |

Metadata: `client_id`, `doc_id`, `doc_name`, `section_title`, `updated_at`

---

## ЧТО СДЕЛАНО

### Фаза 1: Классификация ✅
- ~~Semantic Router с эталонами~~ → заменён на LLM-классификатор
- LLM понимает смысл, не просто похожесть слов
- "Сколько стоит собака?" → NO (не про Truffles)
- "Сколько стоит бот?" → YES (про Truffles)

### Фаза 2: Reasoning Engine ✅
- Structured Outputs в Generation
- Бот думает (thinking), решает (has_answer, needs_escalation), отвечает (response)
- Switch по флагам в n8n

### Убрано (было лишнее):
- Agent: Analysis (дублировал классификацию)
- Agent: Quality Check (дублировал generation)
- semantic_routes коллекция (не масштабируется)
- FAQ_ru, truffles_intents коллекции (мусор)

---

## ЧТО ОСТАЛОСЬ

### Фаза 3: Эскалация (следующая)
- [ ] needs_escalation=true → сообщение менеджеру
- [ ] Менеджер отвечает → ответ клиенту
- [ ] Таймаут 10 минут → fallback

### Фаза 4: Active Learning
- [ ] Ответ менеджера → в базу знаний
- [ ] Бот учится через работу

### Фаза 5: Multi-tenant
- [ ] Фильтрация по client_id
- [ ] Разные базы знаний для разных клиентов

### Фаза 6: Тестирование
- [ ] Реальные диалоги
- [ ] Edge cases

---

## КРИТЕРИИ УСПЕХА

| Критерий | Статус |
|----------|--------|
| Отвечает по теме | ✅ Работает |
| Не отвечает не по теме | ✅ LLM Classifier |
| Не галлюцинирует | ⏳ needs_escalation TODO |
| Эскалация работает | ❌ TODO |
| Обучение работает | ❌ TODO |

---

*Обновлено: 2025-12-04*
