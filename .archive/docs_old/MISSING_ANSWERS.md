# ОТВЕТЫ НА ВОПРОСЫ БЕЗ ОТВЕТОВ

---

## 1. Автообучение — КАК должно работать?

**Статус:** НЕ реализовано. Приоритет, но отложено.

**Как ДОЛЖНО работать (план):**
```
Менеджер отвечает в топике
    ↓
Ответ сохраняется в handover.messages (УЖЕ работает)
    ↓
LLM проверяет качество ответа (TODO)
    ↓
Владелец видит кнопки [Одобрить] [Отклонить] (TODO)
    ↓
Если одобрено → добавить в Qdrant (TODO)
    ↓
Следующий раз бот знает сам
```

**Что подготовлено:**
- handover.messages JSONB — ответы сохраняются
- Структура в SPECS/ACTIVE_LEARNING_PLAN.md

**Почему не сейчас:**
- Сначала стабилизировать базу
- Много костылей, каждое изменение ломает что-то

---

## 2. "Нет значит нет" — логика подробно

**Как работает СЕЙЧАС:**

```
no_count = 0 (начало)

Клиент: "хочу менеджера"
    ↓
no_count = 1
bot_status = 'muted'
bot_muted_until = NOW() + 30 минут
Отправляем эскалацию менеджеру
Бот: "Передаю менеджеру..."

Клиент: "хочу менеджера" (снова, пока мьют)
    ↓
no_count = 2
action = 'silent_exit' (бот молчит)
Эскалация НЕ создаётся (уже есть)

[Через 30 минут]
    ↓
bot_muted_until истёк
bot_status остаётся 'muted', но проверка isMuted = false
Бот снова может отвечать

Клиент: "привет"
    ↓
Бот отвечает (no_count всё ещё 2, но не проверяется для обычных сообщений)

[Менеджер нажимает Решено]
    ↓
bot_status = 'active'
no_count = 0 (сброс!)
Бот полностью активен
```

**Важно:**
- `no_count` считает ВСЕ разы за всё время разговора
- Сбрасывается ТОЛЬКО после [Решено]
- "Навсегда замолчать" — НЕТ такой логики, максимум 30 минут
- После истечения bot_muted_until бот отвечает, даже если no_count > 0

**Двухступенчатая схема из MASTER_PLAN:**
- Описана, но НЕ полностью реализована
- Сейчас: первый раз эскалация, второй раз молчим
- Нет: "через 30 мин предложить помощь снова"

---

## 3. Knowledge Sync — как работает

**Workflow:** Knowledge Sync (отдельный, не в основной цепочке)

**Как запускается:**
- Вручную в n8n UI
- Или по расписанию (cron)

**Откуда данные:**
1. Google Drive (folder_id в clients.config)
2. Или локальные файлы

**Что делает:**
```
Загрузить документы из папки
    ↓
Разбить на chunks (секции)
    ↓
Получить embeddings (BGE-M3)
    ↓
Сохранить в Qdrant с metadata.client_slug
```

**Альтернатива (скрипт):**
```bash
cd ~/truffles/ops
python3 sync_client.py demo_salon ./docs
```

**Баг:** Workflow с вложенными loops не работает для нескольких клиентов. Использовать скрипт.

---

## 4. Новый клиент — как добавить

**Шаги:**

```bash
# 1. SSH на сервер
ssh -i C:\Users\user\.ssh\id_rsa -p 222 zhan@5.188.241.234
cd ~/truffles/ops

# 2. Запустить онбординг
python3 onboard_client.py
# Спросит: название, телефон, instance_id

# 3. Добавить настройки Telegram (вручную SQL)
docker exec -i truffles_postgres_1 psql -U n8n -d chatbot -c "
INSERT INTO client_settings (client_id, telegram_chat_id, telegram_bot_token)
SELECT id, '-100XXXXXXXXXX', 'BOT_TOKEN'
FROM clients WHERE name = 'new_client';"

# 4. Создать документы
mkdir -p ~/truffles/knowledge/new_client
# Положить .md файлы

# 5. Синхронизировать в Qdrant
python3 sync_client.py new_client ~/truffles/knowledge/new_client

# 6. В ChatFlow указать webhook:
# https://n8n.truffles.kz/webhook/a29b2ad2-9485-476c-897d-34799c3f940b/new_client
```

**Интерфейс:** Нет. Только скрипты и SQL.

---

## 5. Застрявшие handover — что делать

**Автоматически:**
- `bot_muted_until` истекает через 30 минут
- Бот начинает отвечать снова
- НО: handover остаётся в статусе pending/active

**Проблема:**
- Заказчик не может сам починить
- Нужен SQL или нажать [Решено]

**Решение для заказчика (если есть доступ к Telegram):**
- Найти сообщение с кнопкой в топике
- Нажать [Решено]

**Если кнопка исчезла или не работает:**
```sql
-- Закрыть все активные handovers
UPDATE handovers SET status = 'resolved', resolved_at = NOW()
WHERE status IN ('pending', 'active');

-- Размьютить все conversations
UPDATE conversations SET bot_status = 'active', no_count = 0, bot_muted_until = NULL;
```

**TODO:** Сделать кнопку "Принудительно закрыть" или Telegram-бота для Жанбола.

---

## 6. TurnDetector — перефразирует или нет?

**Что делает TurnDetector:**
- Ждёт паузу в сообщениях клиента
- Когда пауза достаточная — отправляет дальше

**Перефразирует ли?**
Нужно проверить workflow. Смотрю...

**Ответ:** TurnDetector НЕ перефразирует. Он передаёт сообщение как есть.

Если менеджер видит "перефразированное" — это может быть:
1. 3_Normalize — очищает текст (убирает лишние пробелы, нормализует unicode)
2. Или при отображении в Telegram что-то меняется

**Проверить:**
```bash
# Посмотреть что пришло в Parse Input
python3 get_multiagent_exec.py
# Сравнить с тем что видит менеджер
```

**"ты че блять" vs "Ты что, блять":**
- Normalize может менять регистр первой буквы
- НЕ должен менять слова
- Если меняет — это баг в 3_Normalize

---

## ИТОГО: ЧТО НУЖНО ДОДЕЛАТЬ

| Что | Приоритет | Сложность |
|-----|-----------|-----------|
| Автообучение | Высокий | Высокая |
| "Нет значит нет" полностью | Средний | Средняя |
| Интерфейс для заказчика | Средний | Средняя |
| Кнопка "Принудительно закрыть" | Низкий | Низкая |
| Проверить Normalize | Низкий | Низкая |

---

*Создано: 2025-12-08*
