# STATE — Состояние проекта

**Центральный хаб. Обновляется каждую сессию.**

---

## ТЕКУЩЕЕ СОСТОЯНИЕ

### Что работает
- [x] Бот отвечает на сообщения WhatsApp
- [x] RAG поиск по базе знаний (Qdrant)
- [x] Классификация интентов
- [x] Эскалация в Telegram (кнопки Беру/Решено)
- [x] Ответ менеджера → клиенту
- [x] Напоминания (15 мин, 1 час) — cron
- [x] Мультитенант (truffles, demo_salon)

### Что не работает / в процессе
- [ ] Автообучение на ответах менеджеров — план: `SPECS/ACTIVE_LEARNING.md`
- [ ] Метрики (Quality Deflection, CSAT) — план: `SPECS/ESCALATION.md`, часть 6
- [ ] Dashboard для заказчика — backlog
- [ ] Quiet hours для напоминаний — P2

### Блокеры
- Нет

---

## ТЕКУЩИЙ ПЛАН

> Источники: `STRATEGY/TECH_ROADMAP.md`, `STRATEGY/REQUIREMENTS.md`

### Сейчас (эта сессия / неделя)
1. [x] Аудит документов и структуры
2. [ ] Мозги LLM — исправить промпт

### Следующее
1. [ ] Мозги LLM — confidence threshold (не выдумывать если RAG пустой)
2. [ ] Эскалация — добить
3. [ ] Автообучение — `SPECS/ACTIVE_LEARNING.md`
4. [ ] История переписки в заявке
5. [ ] Автоприветствие менеджера

---

## BACKLOG (хотелки)

> Идеи на потом. НЕ ДЕЛАТЬ пока не в плане.

| Идея | Зачем | Приоритет | Откуда |
|------|-------|-----------|--------|
| Алерт "бот пронёс хуйню" | Критичные ошибки сразу владельцу | P1 | my_notes |
| Dashboard для заказчика | Видеть статистику | P2 | REQUIREMENTS |
| Kaspi Pay проверка | Автопроверка оплат | P2 | REQUIREMENTS |
| Telegram чат для владельца | Модерация, обсуждение, быстрая связь | P2 | my_notes |
| Ежедневный отчёт владельцу | Сколько диалогов, эскалаций, проблем | P2 | my_notes |
| Аргументы для сбора данных | В договор — почему выгодно делиться | P2 | my_notes |
| CRM интеграция | Синхронизация | P3 | Идея |
| Голосовые сообщения | Расшифровка | P3 | Идея |
| Google Drive для баз знаний | Заказчик сам обновляет FAQ | P3 | my_notes |
| Скрипт синхронизации knowledge/ → Qdrant | Автозагрузка базы знаний | P1 | папки |
| Скрипт загрузки prompts/ → БД | Автозагрузка промптов | P2 | папки |
| Использовать context/intents/ в классификаторе | Улучшить intent detection | P2 | папки |
| Автотесты из tests/test_cases.json | Проверка качества бота | P2 | папки |
| Исследование LLM моделей | Найти оптимальные модели для задач | P2 | сессия |
| Сжатие диалогов (summarizer) | Киллер-фича для длинных разговоров | P2 | сессия |
| Скрипт update_parameter | Управление параметрами с защитой от дураков | P2 | сессия |
| Веб-интерфейс (личный кабинет) | Заказчик сам меняет параметры | P3 | сессия |

---

## КАРТА ДОКУМЕНТОВ

| Область | Документ | Когда обновлять |
|---------|----------|-----------------|
| **Принципы** | `AGENTS.md` | Редко, только важное |
| **Состояние** | `STATE.md` | Каждую сессию |
| **Структура** | `STRUCTURE.md` | При добавлении/удалении файлов |
| **Техника** | `TECH.md` | При изменении доступов/команд |
| | | |
| **Эскалация** | `SPECS/ESCALATION.md` | handovers, напоминания, Telegram |
| **Поведение бота** | `SPECS/CONSULTANT.md` | промпт, правила ответов |
| **Автообучение** | `SPECS/ACTIVE_LEARNING.md` | модерация, Qdrant |
| **Архитектура** | `SPECS/ARCHITECTURE.md` | новые сервисы, потоки данных |
| **Мультитенант** | `SPECS/MULTI_TENANT.md` | онбординг, новые клиенты |
| | | |
| **Требования** | `STRATEGY/REQUIREMENTS.md` | Требования Жанбола |
| **Roadmap** | `STRATEGY/TECH_ROADMAP.md` | Технический план |
| **Продукт** | `STRATEGY/PRODUCT.md` | Тарифы, фичи |
| **Рынок** | `STRATEGY/MARKET.md` | Исследования, метрики |
| | | |
| **База знаний** | `knowledge/*.md` | FAQ, примеры, сленг |
| **Интенты** | `context/intents/*.txt` | Новые интенты |
| **Промпты** | `prompts/*.md` | Системный промпт |

---

## ИСТОРИЯ СЕССИЙ

### 2025-12-10 — Аудит документов + Мозги LLM

**Что сделали:**

*Часть 1: Документы и структура*
- Обновили все SPECS/ документы (синхронизация с кодом)
- Добавили метрики North Star в ESCALATION.md
- Добавили чеклист онбординга 35 мин в MULTI_TENANT.md
- Создали STRUCTURE.md — карту проекта
- Создали HOW_TO_WORK.md — инструкция для Жанбола
- Создали droid'ы: truffles-architect, truffles-coder
- Удалили мусор из ops/ (~175 файлов → архив)
- Создали STATE.md — центральный хаб
- Добавили .gitignore (исключает .archive/ops_old/)

*Часть 2: Мозги LLM*
- Проанализировали как работает бот: webhook → intent → RAG → LLM
- Нашли проблему: промпт слишком общий, бот обещает то что не умеет
- Создали API для управления промптами: `PUT /admin/prompt/{client_slug}`
- Создали API для управления настройками: `PUT /admin/settings/{client_slug}`
- Создали скрипт: `ops/update_prompt.py` с защитой от дураков
- Создали шаблон промпта: `ops/templates/prompt_template.md`

**Затронутые документы/файлы:**
- [x] STATE.md — создан, обновлён
- [x] STRUCTURE.md — создан
- [x] HOW_TO_WORK.md — создан
- [x] SPECS/ESCALATION.md — добавлены метрики
- [x] SPECS/MULTI_TENANT.md — добавлен чеклист онбординга
- [x] .factory/droids/truffles-architect.md — создан
- [x] .factory/droids/truffles-coder.md — создан
- [x] truffles-api/app/routers/admin.py — создан (API управления)
- [x] truffles-api/app/main.py — добавлен admin router
- [x] ops/update_prompt.py — скрипт управления промптами
- [x] ops/templates/prompt_template.md — шаблон промпта
- [x] .gitignore — создан

**Архитектура LLM (для справки):**
```
Сообщение → Webhook 
    → classify_intent() [LLM #1]
    → Решение (эскалация/мьют/ответ)
    → generate_ai_response() [LLM #2]
        → get_system_prompt() из БД
        → search_knowledge() из Qdrant (RAG)
        → full_prompt = system + RAG_context
        → history (10 сообщений)
        → LLM.generate()
```

**Почему так решили:**
- Документы были разрознены → создали карту и хаб
- Нет удобного управления промптами → создали API
- Промпт не ограничивал бота → создали шаблон с чёткими границами
- Хардкод SQL — плохо → API + скрипт с валидацией

**Следующая сессия:**
- [ ] Обновить промпт truffles через новый API
- [ ] Тестировать что бот не обещает лишнего
- [ ] Confidence threshold (не выдумывать если RAG пустой)
- [ ] Эскалация — добить

---

*Последнее обновление: 2025-12-10*
