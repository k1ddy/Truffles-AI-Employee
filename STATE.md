# STATE — Состояние проекта

**Центральный хаб. Обновляется каждую сессию.**

---

## ТЕКУЩЕЕ СОСТОЯНИЕ

### Что работает
- [x] Бот отвечает на сообщения WhatsApp
- [x] RAG поиск по базе знаний (Qdrant)
- [x] Классификация интентов
- [x] Эскалация в Telegram (кнопки Беру/Решено)
- [x] Ответ менеджера → клиенту
- [x] Напоминания (15 мин, 1 час) — cron
- [x] Мультитенант (truffles, demo_salon)

### Что не работает / в процессе
- [ ] **Branch не подключен** — модель есть, но роутинг идёт через client_id → `SPECS/MULTI_TENANT.md`
- [ ] Автообучение на ответах менеджеров — план: `SPECS/ACTIVE_LEARNING.md`
- [ ] Метрики (Quality Deflection, CSAT) — план: `SPECS/ESCALATION.md`, часть 6
- [ ] Dashboard для заказчика — backlog
- [ ] Quiet hours для напоминаний — P2

### Блокеры
- Нет

---

## ТЕКУЩИЙ ПЛАН

> Источники: `STRATEGY/TECH_ROADMAP.md`, `STRATEGY/REQUIREMENTS.md`

### Сейчас (эта сессия / неделя)
1. [x] Аудит документов и структуры
2. [x] **Gap в спеке: state=manager_active без топика** (P0) ✅
3. [x] **Промпт: бот представляется** (Закон РК об ИИ) ✅
   - Бот говорит "Я виртуальный помощник" при приветствии
4. [x] **Confidence threshold** — score < 0.7 → не выдумывать ✅
   - Реализовано в ai_service.py
5. [ ] **Эскалация при низком RAG** — сейчас говорит "уточню", нужно реально эскалировать

### Следующее (по порядку)

**НЕДЕЛЯ 1: Критичная инфраструктура [P0]** → `SPECS/INFRASTRUCTURE.md`
1. [ ] Секреты → .env (убрать из кода)
2. [ ] Бэкап PostgreSQL (cron)
3. [ ] Бэкап Qdrant
4. [ ] Алерты в Telegram

**НЕДЕЛЯ 2: Качество кода [P1]**
5. [ ] Базовые тесты (10-15 шт)
6. [ ] Логирование (JSON вместо print)
7. [ ] CI/CD (GitHub Actions)
8. [ ] Линтер (ruff)

**НЕДЕЛЯ 3: Защита кода [P0]** → `SPECS/ARCHITECTURE.md` ЧАСТЬ 10
9. [ ] Result pattern — `services/result.py`
10. [ ] SQL Constraints — невалидные состояния невозможны
11. [ ] Транзакционные переходы — `state_service.py`

**НЕДЕЛЯ 4+: Функционал**
12. [ ] Эскалация при низком confidence
13. [ ] Active Learning — сохранять manager_response
14. [ ] Multi-level confidence (0.85/0.6/0)

---

## BACKLOG (хотелки)

> Идеи на потом. НЕ ДЕЛАТЬ пока не в плане.

| Идея | Зачем | Приоритет | Откуда |
|------|-------|-----------|--------|
| **Омниканальность (Channel)** | Instagram, Telegram bot, CRM — без переделки | P2 | архитектура |
| **Branch к роутингу** | Несколько номеров WhatsApp у одного клиента | P2 | архитектура |
| Алерт "бот пронёс хуйню" | Критичные ошибки сразу владельцу | P1 | my_notes |
| Dashboard для заказчика | Видеть статистику | P2 | REQUIREMENTS |
| Kaspi Pay проверка | Автопроверка оплат | P2 | REQUIREMENTS |
| Telegram чат для владельца | Модерация, обсуждение, быстрая связь | P2 | my_notes |
| Ежедневный отчёт владельцу | Сколько диалогов, эскалаций, проблем | P2 | my_notes |
| Аргументы для сбора данных | В договор — почему выгодно делиться | P2 | my_notes |
| CRM интеграция | Синхронизация | P3 | Идея |
| Голосовые сообщения | Расшифровка | P3 | Идея |
| Google Drive для баз знаний | Заказчик сам обновляет FAQ | P3 | my_notes |
| Скрипт синхронизации knowledge/ → Qdrant | Автозагрузка базы знаний | P1 | папки |
| Скрипт загрузки prompts/ → БД | Автозагрузка промптов | P2 | папки |
| Использовать context/intents/ в классификаторе | Улучшить intent detection | P2 | папки |
| Автотесты из tests/test_cases.json | Проверка качества бота | P2 | папки |
| Исследование LLM моделей | Найти оптимальные модели для задач | P2 | сессия |
| Сжатие диалогов (summarizer) | Киллер-фича для длинных разговоров | P2 | сессия |
| Скрипт update_parameter | Управление параметрами с защитой от дураков | P2 | сессия |
| Веб-интерфейс (личный кабинет) | Заказчик сам меняет параметры | P3 | сессия |

---

## КАРТА ДОКУМЕНТОВ

| Область | Документ | Когда обновлять |
|---------|----------|-----------------|
| **Принципы** | `AGENTS.md` | Редко, только важное |
| **Состояние** | `STATE.md` | Каждую сессию |
| **Структура** | `STRUCTURE.md` | При добавлении/удалении файлов |
| **Техника** | `TECH.md` | При изменении доступов/команд |
| | | |
| **Эскалация** | `SPECS/ESCALATION.md` | handovers, напоминания, Telegram |
| **Поведение бота** | `SPECS/CONSULTANT.md` | промпт, правила ответов |
| **Автообучение** | `SPECS/ACTIVE_LEARNING.md` | модерация, Qdrant |
| **Архитектура** | `SPECS/ARCHITECTURE.md` | новые сервисы, потоки данных |
| **Инфраструктура** | `SPECS/INFRASTRUCTURE.md` | безопасность, CI/CD, тесты |
| **Мультитенант** | `SPECS/MULTI_TENANT.md` | онбординг, новые клиенты |
| | | |
| **Требования** | `STRATEGY/REQUIREMENTS.md` | Требования Жанбола |
| **Roadmap** | `STRATEGY/TECH_ROADMAP.md` | Технический план |
| **Продукт** | `STRATEGY/PRODUCT.md` | Тарифы, фичи |
| **Рынок** | `STRATEGY/MARKET.md` | Исследования, метрики |
| | | |
| **База знаний** | `knowledge/*.md` | FAQ, примеры, сленг |
| **Интенты** | `context/intents/*.txt` | Новые интенты |
| **Промпты** | `prompts/*.md` | Системный промпт |

---

## ИСТОРИЯ СЕССИЙ

### 2025-12-10 (вечер) — Архитектура мультитенанта + Дройды

**Что сделали:**

*Архитектура:*
- Разобрали иерархию Company → Client → Branch
- Обнаружили: Branch существует в БД, но не подключен к роутингу
- Добавили в план: подключить Branch (conversation.branch_id вместо client_id)
- Добавили в backlog: омниканальность (Channel) для Instagram/Telegram

*Дройды:*
- truffles-architect.md — добавили: СТАРТ СЕССИИ, РАБОТА С ЖАНБОЛОМ, ДИАГНОСТИКА, РЕВЬЮ КОДЕРА
- truffles-coder.md — добавили: СТАНДАРТ КАЧЕСТВА
- AGENTS.md — добавили: ошибка #0 "Экономлю на качестве"

*Документы:*
- SPECS/ARCHITECTURE.md — обновили схему БД (companies, branches)
- SPECS/MULTI_TENANT.md — добавили полную иерархию, роли, текущее vs конечное

**Затронутые файлы:**
- [x] STATE.md
- [x] SPECS/ARCHITECTURE.md
- [x] SPECS/MULTI_TENANT.md
- [x] AGENTS.md
- [x] .factory/droids/truffles-architect.md
- [x] .factory/droids/truffles-coder.md

**Почему так решили:**
- Документы не отражали реальную архитектуру БД → синхронизировали
- Дройд не понимал контекст на старте → добавили СТАРТ СЕССИИ
- AI экономил на качестве → добавили СТАНДАРТ КАЧЕСТВА как принцип #0
- Не было диагностики проблем → добавили раздел ДИАГНОСТИКА

**Следующая сессия:**
- [ ] Диагностика: бот не отвечает (блокер)
- [ ] Подключить Branch к роутингу
- [ ] Мозги LLM — промпт

---

### 2025-12-10 — Аудит документов + Мозги LLM

**Что сделали:**

*Часть 1: Документы и структура*
- Обновили все SPECS/ документы (синхронизация с кодом)
- Добавили метрики North Star в ESCALATION.md
- Добавили чеклист онбординга 35 мин в MULTI_TENANT.md
- Создали STRUCTURE.md — карту проекта
- Создали HOW_TO_WORK.md — инструкция для Жанбола
- Создали droid'ы: truffles-architect, truffles-coder
- Удалили мусор из ops/ (~175 файлов → архив)
- Создали STATE.md — центральный хаб
- Добавили .gitignore (исключает .archive/ops_old/)

*Часть 2: Мозги LLM*
- Проанализировали как работает бот: webhook → intent → RAG → LLM
- Нашли проблему: промпт слишком общий, бот обещает то что не умеет
- Создали API для управления промптами: `PUT /admin/prompt/{client_slug}`
- Создали API для управления настройками: `PUT /admin/settings/{client_slug}`
- Создали скрипт: `ops/update_prompt.py` с защитой от дураков
- Создали шаблон промпта: `ops/templates/prompt_template.md`

**Затронутые документы/файлы:**
- [x] STATE.md — создан, обновлён
- [x] STRUCTURE.md — создан
- [x] HOW_TO_WORK.md — создан
- [x] SPECS/ESCALATION.md — добавлены метрики
- [x] SPECS/MULTI_TENANT.md — добавлен чеклист онбординга
- [x] .factory/droids/truffles-architect.md — создан
- [x] .factory/droids/truffles-coder.md — создан
- [x] truffles-api/app/routers/admin.py — создан (API управления)
- [x] truffles-api/app/main.py — добавлен admin router
- [x] ops/update_prompt.py — скрипт управления промптами
- [x] ops/templates/prompt_template.md — шаблон промпта
- [x] .gitignore — создан

**Архитектура LLM (для справки):**
```
Сообщение → Webhook 
    → classify_intent() [LLM #1]
    → Решение (эскалация/мьют/ответ)
    → generate_ai_response() [LLM #2]
        → get_system_prompt() из БД
        → search_knowledge() из Qdrant (RAG)
        → full_prompt = system + RAG_context
        → history (10 сообщений)
        → LLM.generate()
```

**Почему так решили:**
- Документы были разрознены → создали карту и хаб
- Нет удобного управления промптами → создали API
- Промпт не ограничивал бота → создали шаблон с чёткими границами
- Хардкод SQL — плохо → API + скрипт с валидацией

**Следующая сессия:**
- [ ] Обновить промпт truffles через новый API
- [ ] Тестировать что бот не обещает лишнего
- [ ] Confidence threshold (не выдумывать если RAG пустой)
- [ ] Эскалация — добить

---

*Последнее обновление: 2025-12-10 (вечер)*
