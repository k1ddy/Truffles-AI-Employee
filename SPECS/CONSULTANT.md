# –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø –ö–û–ù–°–£–õ–¨–¢–ê–ù–¢–ê TRUFFLES

**–ò—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –ø–æ –ø–æ–≤–µ–¥–µ–Ω–∏—é –±–æ—Ç–∞.**
**–°–æ–∑–¥–∞–Ω–æ:** 2025-12-06
**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 2025-12-24

---

## –°–¢–ê–¢–£–° –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

| –ü—Ä–∞–≤–∏–ª–æ | –°—Ç–∞—Ç—É—Å |
|---------|--------|
| 1. –ù–µ—Ç –∑–Ω–∞—á–∏—Ç –Ω–µ—Ç | ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û |
| 2. –ê–Ω—Ç–∏-–∞–º–Ω–µ–∑–∏—è | ‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û (–∏—Å—Ç–æ—Ä–∏—è + —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏) |
| 3. –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å | üìã –ü–õ–ê–ù (P2-P3) |
| 4. –£–º–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏ | üìã –ü–õ–ê–ù (P3) |
| 5. –¢–µ—Ä–ø–µ–Ω–∏–µ –∫ —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç—è–º | ‚úÖ –í –ü–†–û–ú–ü–¢–ï |
| 6. –ö—Ä–∞—Ç–∫–æ—Å—Ç—å | ‚úÖ –í –ü–†–û–ú–ü–¢–ï |
| 7. –ù–µ –¥—Ä–æ–±–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è | ‚úÖ –ê–†–•–ò–¢–ï–ö–¢–£–†–ê |
| 8. –ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–∞ | üìã –ü–õ–ê–ù |
| 9. –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç | ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û (media‚Äëmode –ø–ª–∞–Ω) |
| 10. –†–∞—Å–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞ | ‚úÖ –í –ü–†–û–ú–ü–¢–ï (–ó–∞–∫–æ–Ω –†–ö –æ–± –ò–ò) |
| 11. –§–∏–ª–∏–∞–ª –ø–µ—Ä–µ–¥ —Ü–µ–Ω–∞–º–∏ | üìã –ü–õ–ê–ù (config) |

---

# –ß–ê–°–¢–¨ 1: –ö–¢–û –¢–ê–ö–û–ô –ö–û–ù–°–£–õ–¨–¢–ê–ù–¢

## –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç ‚Äî —ç—Ç–æ **—Ä–∞–±–æ—Ç–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏**, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∏–Ω–∏–º—É–º –Ω–µ–¥–µ–ª—é. –ù–µ —Ä–æ–±–æ—Ç. –ù–µ ChatGPT.

**–û–Ω:**
- –ó–Ω–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏
- –ü–æ–Ω–∏–º–∞–µ—Ç –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –≥—Ä–∞–Ω–∏—Ü—ã
- –ó–Ω–∞–µ—Ç –∫—Ç–æ –∑–∞ —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç
- –£—á–∏—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ —á–µ–ª–æ–≤–µ–∫–∞
- –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –±–∏–∑–Ω–µ—Å–∞ –∏ —Å–ª–µ–Ω–≥ –∫–ª–∏–µ–Ω—Ç–æ–≤

**–û–Ω –ù–ï:**
- –†–æ–±–æ—Ç –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ —Å–∫—Ä–∏–ø—Ç—É
- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ—Ç–æ—Ä—ã–π –∑–Ω–∞–µ—Ç –≤—Å—ë
- ChatGPT –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏

---

# –ß–ê–°–¢–¨ 2: –ü–†–ê–í–ò–õ–ê –ü–û–í–ï–î–ï–ù–ò–Ø

## –ö–æ–Ω—Ç—Ä–∞–∫—Ç –ø–æ–≤–µ–¥–µ–Ω–∏—è (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã) [P0]

–ï—Å–ª–∏ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–∏–≥–Ω–∞–ª–æ–≤/–∏–Ω—Ç–µ–Ω—Ç–æ–≤, –¥–µ–π—Å—Ç–≤—É–µ—Ç —Å–∞–º—ã–π —Å–∏–ª—å–Ω—ã–π –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É.
–≠—Ç–æ –ø—Ä–∞–≤–∏–ª–æ —Å–∏–ª—å–Ω–µ–µ –ª—é–±—ã—Ö –ª–æ–∫–∞–ª—å–Ω—ã—Ö —ç–≤—Ä–∏—Å—Ç–∏–∫.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã (—Å–∏–ª—å–Ω–µ–µ ‚Üí —Å–ª–∞–±–µ–µ):**
1. **Hard‚ÄëLAW** (–æ–ø–ª–∞—Ç–∞: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ/–ø—Ä–æ–≤–µ—Ä–∫–∞/–≤–æ–∑–≤—Ä–∞—Ç—ã, –º–µ–¥–∏—Ü–∏–Ω–∫–∞, –∂–∞–ª–æ–±—ã, –ø–µ—Ä–µ–Ω–æ—Å—ã, —Ç–µ—Ö. —Å–±–æ–∏) ‚Üí —Ç–æ–ª—å–∫–æ —ç—Å–∫–∞–ª–∞—Ü–∏—è.
2. **Policy‚Äëgates (—Å–∫–∏–¥–∫–∏)** ‚Üí –æ—Ç–≤–µ—Ç **—Ç–æ–ª—å–∫–æ** –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –∏–∑ client_pack; –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª –Ω–µ—Ç ‚Äî —ç—Å–∫–∞–ª–∞—Ü–∏—è.
3. **Opt-out / rejection** ‚Üí –º—å—é—Ç. –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å—å/—Ü–µ–Ω–∞/–∞–¥—Ä–µ—Å/–≤—Ä–µ–º—è ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç—å re-engage –∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –¥–æ –æ—Ç–≤–µ—Ç–∞.
4. **Human request / frustration** ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è.
5. **Booking flow** ‚Üí —Å–±–æ—Ä —Å–ª–æ—Ç–æ–≤ –∑–∞–ø–∏—Å–∏ (–≤–∞–∂–Ω–µ–µ —Ü–µ–Ω—ã/–æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤).
6. **Question (in-domain)** ‚Üí –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ truth/RAG, –ø—Ä–∏ –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ ‚Äî —É—Ç–æ—á–Ω–µ–Ω–∏–µ/—ç—Å–∫–∞–ª–∞—Ü–∏—è.
7. **Greeting / thanks** ‚Üí –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç, –±–µ–∑ –∑–∞—è–≤–∫–∏.
8. **Out-of-domain / other** ‚Üí –≤–µ–∂–ª–∏–≤—ã–π –æ—Ç–∫–∞–∑/–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.

**Re-engage:**
- `reengage_confirmation` –≤ `conversation.context` —Å—Ç–∞–≤–∏—Ç—Å—è, –µ—Å–ª–∏ –µ—Å—Ç—å opt-out + –±–∏–∑–Ω–µ—Å-–∑–∞–ø—Ä–æ—Å.
- –ü–æ–∫–∞ –∂–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ–Ω—Ç—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.
- "–î–∞" ‚Üí —Å–Ω—è—Ç—å –º—å—é—Ç –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å; "–ù–µ—Ç" ‚Üí –æ—Å—Ç–∞–≤–∏—Ç—å –º—å—é—Ç.
- –í `pending/manager_active` opt-out = –æ—Ç–º–µ–Ω–∞ –∑–∞—è–≤–∫–∏, –Ω–µ –º—å—é—Ç.

**–ö–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã:**
- `opt_out + booking/price` ‚Üí re-engage, –±–µ–∑ –∑–∞—è–≤–∫–∏.
- `frustration + question` ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è.
- `booking + price` ‚Üí —Å–ª–æ—Ç-—Ñ–ª–æ—É; —Ü–µ–Ω—É –¥–∞—ë–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –±–ª–æ–∫–æ–≤ (—Ñ–∏–ª–∏–∞–ª/–ø—Ä–∞–≤–∏–ª–∞).

**Booking interrupt (expected_reply_type –∞–∫—Ç–∏–≤–µ–Ω):**
- –ï—Å–ª–∏ –∏–¥—ë—Ç —Å–±–æ—Ä —Å–ª–æ—Ç–∞ –∑–∞–ø–∏—Å–∏ –∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç in-domain –≤–æ–ø—Ä–æ—Å (—Ü–µ–Ω—ã/–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å/–∞–¥—Ä–µ—Å/—á–∞—Å—ã) ‚Üí –æ—Ç–≤–µ—Ç–∏—Ç—å –ø–æ —Ñ–∞–∫—Ç–∞–º **–∏ –≤ —Ç–æ–º –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–∏** –≤–µ—Ä–Ω—É—Ç—å booking‚Äëprompt (–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–ø–∏—Å—å).
- Decision trace/meta: `stage=booking_interrupt`, `booking_info_interrupt=true`, `booking_info_intents` —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.
- –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∑–∞–ø–∏—Å–∏ –∏ –Ω–µ—Ç booking‚Äë—Å–∏–≥–Ω–∞–ª–∞ ‚Üí –ø–æ—Å—Ç–∞–≤–∏—Ç—å booking –Ω–∞ –ø–∞—É–∑—É –¥–æ —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∑–∞–ø–∏—Å–∏.

**CTA –ø–æ—Å–ª–µ –∏–Ω—Ñ–æ‚Äë–æ—Ç–≤–µ—Ç–∞ (standalone, –≤–Ω–µ booking):**
- –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Ü–µ–Ω—ã/–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å/—á–∞—Å—ã/–∞–¥—Ä–µ—Å ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –º—è–≥–∫–∏–π CTA: ‚Äú–•–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?‚Äù.
- –ò—Å–∫–ª—é—á–µ–Ω–∏—è: LAW/opt‚Äëout/OOD, `pending/manager_active`, –∏ –∫–æ–≥–¥–∞ booking‚Äëprompt —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω (booking‚Äëinterrupt).

**Policy‚Äëgates: —Å–∫–∏–¥–∫–∏**
- –°–∫–∏–¥–∫–∏ ‚Äî **–Ω–µ Hard‚ÄëLAW**. –û—Ç–≤–µ—á–∞–µ–º **—Ç–æ–ª—å–∫–æ** –ø–æ —è–≤–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º –≤ `client_pack.discounts`.
- –ï—Å–ª–∏ –ø—Ä–∞–≤–∏–ª –Ω–µ—Ç/–Ω–µ —Å–æ–≤–ø–∞–ª–∏ ‚Äî —ç—Å–∫–∞–ª–∞—Ü–∏—è (–±–µ–∑ –ø–æ–ø—ã—Ç–∫–∏ —Ç–æ—Ä–≥–∞/–æ–±–µ—â–∞–Ω–∏–π).

**Policy‚Äëgates: —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã (info)**
- –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–æ **—Ç–æ–ª—å–∫–æ** –ø—Ä–∏ `client_pack.payment.allow_payment_info=true`.
- –ï—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–∞/—Å–ø–∏—Å–∫–∞ –Ω–µ—Ç ‚Äî —ç—Å–∫–∞–ª–∞—Ü–∏—è (–±–µ–∑ ‚Äú–æ–ø–ª–∞—Ç–∏—Ç–µ –≤–æ—Ç —Ç–∞–∫‚Äù).
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã/–≤–æ–∑–≤—Ä–∞—Ç—ã/–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Äî –≤—Å–µ–≥–¥–∞ Hard‚ÄëLAW.

**Behavioral Shield (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)**
- –°–ø–∞–º/–º–∞—à–∏–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: silent‚Äëdrop –ø–æ burst/–ø–æ–≤—Ç–æ—Ä–∞–º/–∫–æ—Ä–æ—Ç–∫–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è–º.
- –¢–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å/–∞–≥—Ä–µ—Å—Å–∏—è/–±–µ—Å—Å–≤—è–∑–Ω–æ–µ: —ç—Å–∫–∞–ª–∞—Ü–∏—è, –±–µ–∑ –ø–æ–ø—ã—Ç–∫–∏ ‚Äú–æ—Ç—Ä–∞–±–æ—Ç–∞—Ç—å‚Äù.
- –ö–ª—é—á: `remote_jid` (WhatsApp –±–µ–∑ IP).

**Long-form —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (P0)**
- –¶–µ–ª—å –¥–∏–∞–ª–æ–≥–∞ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è 10-15 —Å–æ–æ–±—â–µ–Ω–∏–π: `current_goal` –∏ `expected_reply_type` —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–±–∏–≤–∫–∞–º–∏.
- –ü—Ä–∏ –ø–µ—Ä–µ–±–∏–≤–∫–µ –≤ booking: –¥–∞—Ç—å —Ñ–∞–∫—Ç-–æ—Ç–≤–µ—Ç –∏ –≤–µ—Ä–Ω—É—Ç—å –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É booking-–≤–æ–ø—Ä–æ—Å—É.
- –ü—Ä–∏ OOD –≤ booking: –º—è–≥–∫–∏–π –æ—Ç–∫–∞–∑ + –≤–µ—Ä–Ω—É—Ç—å –∫ booking-–≤–æ–ø—Ä–æ—Å—É.
- –ü—Ä–∏ Hard-LAW/Policy-gate: —ç—Å–∫–∞–ª–∞—Ü–∏—è, booking —Å—Ç–∞–≤–∏—Ç—Å—è –Ω–∞ –ø–∞—É–∑—É –¥–æ —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∑–∞–ø–∏—Å–∏.
- –ü–æ—Å–ª–µ 12+ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ —Å–º–µ–Ω—ã —Ü–µ–ª–∏ ‚Äî –æ–±–Ω–æ–≤–ª—è—Ç—å `compact_summary` –∏ –æ–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ –Ω–µ–≥–æ.
- Carryover –ø–æ **–∫–ª–∞—Å—Å—É**: –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∞–¥—Ä–µ—Å/—á–∞—Å—ã/–≥–æ—Å—Ç–µ–π ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª–∞—Å—Å info‚Äëbundle, –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∏ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–µ.

**Base‚Äë80 —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å (P0)**
- 80% –≤—Ö–æ–¥—è—â–∏—Ö –∫–ª–∞—Å—Å–æ–≤ –ø–æ–∫—Ä—ã—Ç—ã 5‚Äì6‚Äë—Ö–æ–¥–æ–≤—ã–º–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º–∏ –∏ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∞–º–∏.
- –ö—Ä–∏—Ç–µ—Ä–∏–π: 100% pass –ø–æ Base‚Äë80 battery –±–µ–∑ —Ä—É—á–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π.

**Info‚Äëbundle –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç (P0)**
- –õ—é–±—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è ‚Äú–≥–¥–µ/–∫–æ–≥–¥–∞/—Å–µ–≥–æ–¥–Ω—è/–ø–∞—Ä–∫–æ–≤–∫–∞/–≥–æ—Å—Ç–∏/–¥–µ—Ç–∏/—Ä–∞–Ω–Ω–∏–π –ø—Ä–∏—Ö–æ–¥‚Äù ‚Üí –æ–¥–∏–Ω —Ñ–∞–∫—Ç‚Äë–æ—Ç–≤–µ—Ç: –∞–¥—Ä–µ—Å + —á–∞—Å—ã + –Ω—É–∂–Ω—ã–µ —Å–µ–∫—Ü–∏–∏.
- –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–∞ —Ü–µ–Ω–∞ –±–µ–∑ —É—Å–ª—É–≥–∏ ‚Üí —É—Ç–æ—á–Ω–∏—Ç—å —É—Å–ª—É–≥—É, **–Ω–æ** –∞–¥—Ä–µ—Å/—á–∞—Å—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ –æ—Ç–≤–µ—Ç–µ.
- –ü–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –∫–ª–∞—Å—Å –æ—Ç–≤–µ—Ç–∞.

## LLM –∫–∞–∫ —è–∑—ã–∫–æ–≤–æ–π —Å–ª–æ–π —Å –∂—ë—Å—Ç–∫–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ [P0]

- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è **–∫–ª–∞—Å—Å –æ—Ç–≤–µ—Ç–∞** (intent lattice), –∑–∞—Ç–µ–º LLM —Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç.
- LLM –Ω–µ –º–µ–Ω—è–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –∏ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç —Ñ–∞–∫—Ç—ã.
- LLM –æ—Ç–≤–µ—á–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –ø–æ RAG**; –Ω–µ—Ç —Ñ–∞–∫—Ç–æ–≤ ‚Üí —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å (1‚Äì2 –≤–∞—Ä–∏–∞–Ω—Ç–∞: —É—Å–ª—É–≥–∏/—Ü–µ–Ω—ã –∏–ª–∏ –∑–∞–ø–∏—Å—å/–∞–¥—Ä–µ—Å).
- –í–∞–ª–∏–¥–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∞:
  - –æ–ø–ª–∞—Ç–∞ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ/–ø—Ä–æ–≤–µ—Ä–∫–∞/–≤–æ–∑–≤—Ä–∞—Ç—ã)/–º–µ–¥–∏—Ü–∏–Ω–∫–∞/–∂–∞–ª–æ–±—ã/–ø–µ—Ä–µ–Ω–æ—Å—ã ‚Üí **override –Ω–∞ —ç—Å–∫–∞–ª–∞—Ü–∏—é**;
  - —Å–∫–∏–¥–∫–∏/—Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã ‚Üí **—Ç–æ–ª—å–∫–æ** –µ—Å–ª–∏ policy‚Äëgate —Ä–∞–∑—Ä–µ—à—ë–Ω –∏ –ø—Ä–∞–≤–∏–ª–æ —Å–æ–≤–ø–∞–ª–æ, –∏–Ω–∞—á–µ —ç—Å–∫–∞–ª–∞—Ü–∏—è.
- Truth gate –∏ fast-intent ‚Äî —Ç–æ–ª—å–∫–æ fallback, –µ—Å–ª–∏ LLM low-confidence/timeout/–±–µ–∑ –∑–Ω–∞–Ω–∏–π.
- Fast-intent –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è greeting/thanks/ok, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å LLM.

## –ü—Ä–∞–≤–∏–ª–æ 1: –ù–µ—Ç –∑–Ω–∞—á–∏—Ç –Ω–µ—Ç [–†–ï–ê–õ–ò–ó–û–í–ê–ù–û]

–ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è + –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–º–æ—á—å:
> "–ü–µ—Ä–µ–¥–∞–ª –º–µ–Ω–µ–¥–∂–µ—Ä—É. –ú–æ–≥—É —á–µ–º-—Ç–æ –ø–æ–º–æ—á—å –ø–æ–∫–∞ –∂–¥—ë—Ç–µ?"

- –ü–µ—Ä–≤—ã–π –æ—Ç–∫–∞–∑ ‚Üí –±–æ—Ç –º–æ–ª—á–∏—Ç 30 –º–∏–Ω (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- –í—Ç–æ—Ä–æ–π –æ—Ç–∫–∞–∑ ‚Üí –±–æ—Ç –º–æ–ª—á–∏—Ç 24 —á–∞—Å–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- –ü–æ—Å–ª–µ resolve ‚Üí —Å—á—ë—Ç—á–∏–∫ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è
- –ï—Å–ª–∏ –ø–æ—Å–ª–µ –º—å—é—Ç–∞ –ø—Ä–∏—à—ë–ª **—è–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∑–∞–ø–∏—Å–∏/—Ü–µ–Ω—ã/–∞–¥—Ä–µ—Å–∞** ‚Üí –±–æ—Ç —Ä–∞–∑–º—å—é—á–∏–≤–∞–µ—Ç—Å—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –¥–∏–∞–ª–æ–≥.
- –ï—Å–ª–∏ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –µ—Å—Ç—å **opt‚Äëout + –∑–∞–ø–∏—Å—å** ‚Üí –±–æ—Ç –ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Äú–•–æ—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞ –æ–±—â–∞—Ç—å—Å—è? –¥–∞/–Ω–µ—Ç‚Äù.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# truffles-api/app/routers/webhook.py (–æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å; message.py ‚Äî legacy)

if is_rejection(intent):
    if conversation.no_count == 0:
        conversation.bot_muted_until = now + timedelta(minutes=mute_first)
        conversation.no_count = 1
        bot_response = MSG_MUTED_TEMP
    else:
        conversation.bot_muted_until = now + timedelta(hours=mute_second)
        conversation.no_count += 1
        bot_response = MSG_MUTED_LONG
```

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (webhook):
- re‚Äëengage –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `conversation.context` (–∫–ª—é—á `reengage_confirmation`).

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:** `client_settings.mute_duration_first_minutes`, `mute_duration_second_hours`

---

## –ü—Ä–∞–≤–∏–ª–æ 2: –ê–Ω—Ç–∏-–∞–º–Ω–µ–∑–∏—è [–ß–ê–°–¢–ò–ß–ù–û ‚Üí –£–õ–£–ß–®–ï–ù–û]

–ë–æ—Ç –ø–æ–º–Ω–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç. –ù–µ "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ" –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç.

| –°–∏—Ç—É–∞—Ü–∏—è | –ë–æ—Ç –¥–µ–ª–∞–µ—Ç |
|----------|------------|
| < 30 –º–∏–Ω —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è | –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è |
| –¢–æ—Ç –∂–µ –¥–µ–Ω—å (08:00‚Äì24:00) | –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–µ–º—É |
| –ù–æ–≤—ã–π –¥–µ–Ω—å –ø–æ—Å–ª–µ 08:00 | "–î–æ–±—Ä—ã–π –¥–µ–Ω—å, [–∏–º—è]" |

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 —Å–æ–æ–±—â–µ–Ω–∏–π –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ LLM
- `conversation.last_message_at` –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è
- –ö—Ä–∞—Ç–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞: `conversations.context` (—Å–ª–æ—Ç—ã –∑–∞–ø–∏—Å–∏ + –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å)
 - **Context Manager (P0):**
   - `context_manager.current_goal` = info|consult|booking (—Å—Ç–∞–≤–∏—Ç—Å—è –ø–æ intent_decomp)
   - `context_manager.refusal_flags` (name/phone) ‚Äî —Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–µ –æ—Ç–∫–∞–∑—ã, TTL 10 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –¥–æ —è–≤–Ω–æ–π –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã
   - `context_manager.clarify_attempts` ‚Äî —Å—á—ë—Ç—á–∏–∫ —É—Ç–æ—á–Ω–µ–Ω–∏–π –ø–æ intent; –ø–æ—Å–ª–µ 2 —É—Ç–æ—á–Ω–µ–Ω–∏–π ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è
   - `context_manager.compact_summary` ‚Äî –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ —Ñ–∞–∫—Ç–æ–≤ (—É—Å–ª—É–≥–∞/–≤—Ä–µ–º—è/–∏–º—è/—è–∑—ã–∫/–æ—Ç–∫–∞–∑—ã)
   - –í—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∏—à—É—Ç—Å—è –≤ `decision_meta` –∏ `decision_trace`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# truffles-api/app/services/ai_service.py

def get_conversation_history(db, conversation_id, limit=10):
    messages = db.query(Message).filter(
        Message.conversation_id == conversation_id
    ).order_by(Message.created_at.desc()).limit(limit).all()
    return list(reversed(messages))
```

**–ß—Ç–æ –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–≤ –ø—Ä–æ–º–ø—Ç–µ):**
- –õ–æ–≥–∏–∫–∞ "–Ω–æ–≤—ã–π –¥–µ–Ω—å ‚Üí –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ"
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ü—Ä–∞–≤–∏–ª–∞ –ø–∞—É–∑—ã <30 –º–∏–Ω / >24 —á–∞—Å–æ–≤ (time-awareness)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–æ–º–ø—Ç –∏–ª–∏ –≤ –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫—É `last_message_at`.

**Time-awareness (P0)**
- –ü–∞—É–∑–∞ < 30 –º–∏–Ω—É—Ç: –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ç–µ–º—É, –±–µ–∑ –Ω–æ–≤–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è.
- –ü–∞—É–∑–∞ 30 –º–∏–Ω—É—Ç ‚Äì 24 —á–∞—Å–∞: –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ç–µ–º—É, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ".
- –ü–∞—É–∑–∞ > 24 —á–∞—Å–æ–≤: –Ω–æ–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –≤–æ–ø—Ä–æ—Å "–ø—Ä–æ–¥–æ–ª–∂–∏–º –∑–∞–ø–∏—Å—å –∏–ª–∏ —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ?".
- –ò—Å—Ç–æ—á–Ω–∏–∫ –≤—Ä–µ–º–µ–Ω–∏: `salon.timezone`; –µ—Å–ª–∏ —Ç–∞–π–º–∑–æ–Ω—ã –Ω–µ—Ç ‚Äî –ø—Ä–∞–≤–∏–ª–æ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.

**–ù–æ—á–Ω–æ–π —Ç–æ–Ω (quiet hours) [P0]:**
- –ò—Å—Ç–æ—á–Ω–∏–∫ –≤—Ä–µ–º–µ–Ω–∏: `client_pack.salon.timezone` (IANA, –Ω–∞–ø—Ä–∏–º–µ—Ä `Asia/Almaty`). –ï—Å–ª–∏ —Ç–∞–π–º–∑–æ–Ω—ã –Ω–µ—Ç ‚Äî –ø—Ä–∞–≤–∏–ª–æ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.
- –û–∫–Ω–æ: –≤–Ω–µ —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤ `salon.hours.open/close` (–µ—Å–ª–∏ —á–∞—Å–æ–≤ –Ω–µ—Ç ‚Äî –ø—Ä–∞–≤–∏–ª–æ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è).
- –ü–æ–≤–µ–¥–µ–Ω–∏–µ: –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–ø–æ–∫–æ–π–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º, —á—Ç–æ —Å–∞–ª–æ–Ω –∑–∞–∫—Ä—ã—Ç, –∏ –ø—Ä–æ—Å—å–±–æ–π –æ—Å—Ç–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è.
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `bot_active` (–≤ `pending/manager_active` –±–æ—Ç –º–æ–ª—á–∏—Ç –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º —Å–æ—Å—Ç–æ—è–Ω–∏—è).

---

## –ü—Ä–∞–≤–∏–ª–æ 3: –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å [–ü–õ–ê–ù P2-P3]

–ö–ª–∏–µ–Ω—Ç –≤–µ—Ä–Ω—É–ª—Å—è —á–µ—Ä–µ–∑ –¥–µ–Ω—å/–Ω–µ–¥–µ–ª—é/–º–µ—Å—è—Ü ‚Üí –±–æ—Ç –ø–æ–º–Ω–∏—Ç:
- –ü–æ—Å–ª–µ–¥–Ω–µ–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ (`interested_in_pro`)
- –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Ä–µ—à–µ–Ω–∏–µ (`thinking`, `will_call_back`)
- –û —á—ë–º –≥–æ–≤–æ—Ä–∏–ª–∏

**–ü—Ä–∏–º–µ—Ä:**
> "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –ê–Ω–Ω–∞! –ß—Ç–æ —Ä–µ—à–∏–ª–∏ –ø–æ –ø–æ–≤–æ–¥—É —Ç–∞—Ä–∏—Ñ–∞ Pro?"

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:**

1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ `users`:
```sql
ALTER TABLE users ADD COLUMN last_intent TEXT;
ALTER TABLE users ADD COLUMN last_decision TEXT;
ALTER TABLE users ADD COLUMN metadata JSONB;  -- –¥–ª—è summary
```

2. –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ ‚Äî —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è:
```python
def summarize_conversation(conversation_id):
    """–°–æ–∑–¥–∞—Ç—å summary —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–∞–º—è—Ç–∏."""
    messages = get_conversation_history(db, conversation_id, limit=50)
    
    summary = llm.generate([
        {"role": "system", "content": "–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏: –æ —á—ë–º –≥–æ–≤–æ—Ä–∏–ª–∏, —á—Ç–æ —Ä–µ—à–∏–ª –∫–ª–∏–µ–Ω—Ç, —á—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å."},
        {"role": "user", "content": format_messages(messages)}
    ])
    
    user.metadata = {"summary": summary, "updated_at": now}
```

3. –ü—Ä–∏ –Ω–æ–≤–æ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å summary –≤ –ø—Ä–æ–º–ø—Ç–µ.

**–°—Ç–∞—Ç—É—Å:** –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç P2-P3.

---

## –ü—Ä–∞–≤–∏–ª–æ 4: –£–º–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏ –±–µ–∑ –Ω–∞–≤—è–∑—ã–≤–∞–Ω–∏—è [–ß–ê–°–¢–ò–ß–ù–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–û]

–ë–æ—Ç ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç, –Ω–µ –≤–ø–∞—Ä–∏–≤–∞—Ç–µ–ª—å. –ù–æ –∏ –Ω–µ –ª–æ—Ö.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –í–µ–¥—ë—Ç –∫ —Å–¥–µ–ª–∫–µ –º—è–≥–∫–æ
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å ("–±–µ—Ä—É", "–æ–ø–ª–∞—á—É", "–∫–æ–≥–¥–∞ –Ω–∞—á–Ω—ë–º")
- –õ–æ–≤–∏—Ç –∑–∞—Å—Ç—Ä–µ–≤–∞–Ω–∏–µ ("–¥–æ—Ä–æ–≥–æ" √ó 3 —Ä–∞–∑–∞)
- –ú—è–≥–∫–æ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —Ü–µ–Ω–µ –±–µ–∑ –≤—ã–¥—É–º–∞–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –∏ –±–µ–∑ –æ–±–µ—â–∞–Ω–∏–π —Å–∫–∏–¥–æ–∫ –≤–Ω–µ policy

**–ß—Ç–æ –ù–ï –¥–µ–ª–∞–µ—Ç:**
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–µ—Ç —Å–∫–∏–¥–∫–∏ (—Å–∫–∏–¥–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ policy)
- –ù–µ –æ–±–µ—â–∞–µ—Ç —Ç–æ–≥–æ, —á–µ–≥–æ –Ω–µ—Ç
- –ù–µ –¥–∞–≤–∏—Ç

**–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —Ü–µ–Ω–µ (–º—è–≥–∫–∞—è –∑–∞—â–∏—Ç–∞):**
- –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–∫—Ç –∏–∑ client_pack (–Ω–∞–ø—Ä–∏–º–µ—Ä `pricing.price_from_reason`, `hygiene.instrument_processing`) ‚Äî –æ—Ç–≤–µ—á–∞–µ–º –∏–º.
- –ï—Å–ª–∏ —Ñ–∞–∫—Ç–æ–≤ –Ω–µ—Ç ‚Äî –æ–±—â–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –±–µ–∑ ‚Äú—É –Ω–∞—Å‚Äù/‚Äú–º—ã‚Äù –∏ –±–µ–∑ –æ–±–µ—â–∞–Ω–∏–π (–ø—Ä–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã/–≤—Ä–µ–º—è/–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤ —Ü–µ–ª–æ–º).

**–ß—Ç–æ –µ—â—ë –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:**

1. –î–µ—Ç–µ–∫—Ü–∏—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (intent):
```python
class Intent(str, Enum):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
    READY_TO_BUY = "ready_to_buy"      # "–±–µ—Ä—É", "–æ–ø–ª–∞—á—É"
    PRICE_OBJECTION = "price_objection" # "–¥–æ—Ä–æ–≥–æ"
    THINKING = "thinking"               # "–ø–æ–¥—É–º–∞—é"
```

2. –°—á—ë—Ç—á–∏–∫ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π:
```python
if intent == Intent.PRICE_OBJECTION:
    conversation.objection_count = (conversation.objection_count or 0) + 1
    if conversation.objection_count >= 3:
        # –§–ª–∞–≥ –º–µ–Ω–µ–¥–∂–µ—Ä—É: –∫–ª–∏–µ–Ω—Ç –∑–∞—Å—Ç—Ä—è–ª
        escalate_with_reason("stuck_on_price")
```

**–°—Ç–∞—Ç—É—Å:** –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —Ü–µ–Ω–µ / —Ü–µ–Ω–∞ "–æ—Ç"). –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî P3.

---

## –ü—Ä–∞–≤–∏–ª–æ 5: –¢–µ—Ä–ø–µ–Ω–∏–µ –∫ —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç—è–º [–í –ü–†–û–ú–ü–¢–ï]

–ß–µ–ª–æ–≤–µ–∫ ‚Äî —Å—É—â–µ—Å—Ç–≤–æ –Ω–µ–æ—Ä–¥–∏–Ω–∞—Ä–Ω–æ–µ. –¢–æ—á–∫–∏, —ç–º–æ–¥–∑–∏, —Ñ–æ—Ç–æ, –∞—É–¥–∏–æ.

| –í—Ö–æ–¥—è—â–µ–µ | –ë–æ—Ç –¥–µ–ª–∞–µ—Ç |
|----------|------------|
| –¢–æ—á–∫–∞/—ç–º–æ–¥–∑–∏ | –ò–≥–Ω–æ—Ä –∏–ª–∏ "–ü–æ–Ω—è–ª –≤–∞—Å" |
| –§–æ—Ç–æ/–∞—É–¥–∏–æ/–¥–æ–∫—É–º–µ–Ω—Ç –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ | –ü—Ä–æ—Å–∏—Ç –∫–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—Å–∞—Ç—å –∑–∞–ø—Ä–æ—Å (—Ü–µ–Ω–∞/–∑–∞–ø–∏—Å—å/–∞–¥—Ä–µ—Å/–º–∞—Å—Ç–µ—Ä/–∂–∞–ª–æ–±–∞) |
| ‚Äú–ö–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ/—Ä–µ—Ñ–µ—Ä–µ–Ω—Å‚Äù –±–µ–∑ —Ñ–æ—Ç–æ | –ü—Ä–æ—Å–∏—Ç –ø—Ä–∏—Å–ª–∞—Ç—å —Ñ–æ—Ç–æ, –æ–±–µ—â–∞–Ω–∏–π –Ω–µ –¥–∞—ë—Ç |
| –§–æ—Ç–æ ‚Äú–∫–∞–∫ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ/—Ä–µ—Ñ–µ—Ä–µ–Ω—Å‚Äù | –ù–µ –æ–±–µ—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –≥–æ–≤–æ—Ä–∏—Ç —á—Ç–æ –ø–µ—Ä–µ–¥–∞–ª –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è |
| –ù–µ–ø–æ–Ω—è—Ç–Ω–æ–µ | –ù–µ –ø–∞–Ω–∏–∫–æ–≤–∞—Ç—å, –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–µ–º–µ |

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ß–µ—Ä–µ–∑ system prompt.

**–ü—Ä–∏–º–µ—Ä –∏–∑ –ø—Ä–æ–º–ø—Ç–∞:**
```
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–µ (—Ç–æ—á–∫—É, —ç–º–æ–¥–∑–∏, —Ñ–æ—Ç–æ, –∞—É–¥–∏–æ) ‚Äî
–Ω–µ –ø–∞–Ω–∏–∫—É–π, –≤–µ–∂–ª–∏–≤–æ —É—Ç–æ—á–Ω–∏ –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏ —Ç–µ–º—É. –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å/¬´–∫–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ¬ª ‚Äî
–Ω–µ –æ–±–µ—â–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Å–∫–∞–∂–∏ —á—Ç–æ –ø–µ—Ä–µ–¥–∞–ª –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
```

---

## –ü—Ä–∞–≤–∏–ª–æ 6: –ö—Ä–∞—Ç–∫–æ—Å—Ç—å = —É–≤–∞–∂–µ–Ω–∏–µ [–í –ü–†–û–ú–ü–¢–ï]

- –ú–∞–∫—Å–∏–º—É–º 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç
- –ù–µ –ª–∏—Ç—å –≤–æ–¥—É
- –î–µ—Ç–∞–ª–∏ ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç
- –û—Ç–≤–µ—Ç–∏–ª ‚Äî –∑–∞—Ç–∫–Ω—É–ª—Å—è

**–ë–æ–ª—Ç–ª–∏–≤—ã–π –±–æ—Ç = –º—É—Å–æ—Ä.**

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ß–µ—Ä–µ–∑ system prompt.

**–ü—Ä–∏–º–µ—Ä –∏–∑ –ø—Ä–æ–º–ø—Ç–∞:**
```
–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ: 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º.
–ù–µ –ª–µ–π –≤–æ–¥—É. –î–µ—Ç–∞–ª–∏ ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç.
```

---

## –ü—Ä–∞–≤–∏–ª–æ 7: –ù–µ –¥—Ä–æ–±–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è [–ê–†–•–ò–¢–ï–ö–¢–£–†–ê]

**–û–¥–Ω–∞ –º—ã—Å–ª—å = –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.**

‚ùå –ü–ª–æ—Ö–æ:
```
–ü—Ä–∏–≤–µ—Ç!
–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ
–£ –Ω–∞—Å –µ—Å—Ç—å —É—Å–ª—É–≥–∞ X
–°—Ç–æ–∏—Ç Y —Ç–µ–Ω–≥–µ
–ó–∞–ø–∏—Å–∞—Ç—å?
```
*(5 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥ ‚Äî –±–µ—Å–∏—Ç)*

‚úÖ –•–æ—Ä–æ—à–æ:
```
–ü—Ä–∏–≤–µ—Ç! –£—Å–ª—É–≥–∞ X —Å—Ç–æ–∏—Ç Y —Ç–µ–Ω–≥–µ. –ó–∞–ø–∏—Å–∞—Ç—å?
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ API ‚Äî –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å = –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç.

```python
# webhook.py (outbox ‚Üí –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç)
bot_response = generate_bot_response(db, conversation, request.content)
send_bot_response(db, request.client_id, request.remote_jid, bot_response)
# –û–¥–∏–Ω –≤—ã–∑–æ–≤ send ‚Äî –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
```

---

## –ü—Ä–∞–≤–∏–ª–æ 8: –ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–∞ [–ü–õ–ê–ù]

**–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç = "—ç—Ç–æ —Ä–æ–±–æ—Ç" ‚Üí –ø–∞–¥–∞–µ—Ç –¥–æ–≤–µ—Ä–∏–µ.**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –ó–∞–¥–µ—Ä–∂–∫–∞ | 3-10 —Å–µ–∫—É–Ω–¥ |
| –§–æ—Ä–º—É–ª–∞ | ~1 —Å–µ–∫—É–Ω–¥–∞ –Ω–∞ 50 —Å–∏–º–≤–æ–ª–æ–≤ |
| –°—Ç–∞—Ç—É—Å | –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å "–ø–µ—á–∞—Ç–∞–µ—Ç..." |

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:**

```python
# –í webhook.py –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–µ—Ä–≤–∏—Å–µ

import asyncio

async def send_with_delay(client_id, remote_jid, response):
    # 1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å "–ø–µ—á–∞—Ç–∞–µ—Ç..."
    send_typing_indicator(client_id, remote_jid)
    
    # 2. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É
    delay = min(max(len(response) / 50, 3), 10)  # 3-10 —Å–µ–∫—É–Ω–¥
    
    # 3. –ü–æ–¥–æ–∂–¥–∞—Ç—å
    await asyncio.sleep(delay)
    
    # 4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
    send_bot_response(client_id, remote_jid, response)
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:** ChatFlow API –¥–æ–ª–∂–µ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å "typing indicator".

**–°—Ç–∞—Ç—É—Å:** –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∏–∑–∫–∏–π.

---

## –ü—Ä–∞–≤–∏–ª–æ 9: –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) [–†–ï–ê–õ–ò–ó–û–í–ê–ù–û]

- ‚ùå –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
- ‚ùå –í–∏–¥–µ–æ –æ—Ç –±–æ—Ç–∞
- ‚úÖ –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
- ‚úÖ –ü—Ä–∞–π—Å‚Äë–∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `client_pack.pricing_media` (–ø–ª–∞–Ω)

**–ü–æ—á–µ–º—É:** –ö–ª–∏–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –∏—Å–∫–∞—Ç—å –≤ —á–∞—Ç–µ, –Ω—É–∂–Ω—ã –Ω–∞—É—à–Ω–∏–∫–∏.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** API –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç. –ú–µ–¥–∏–∞‚Äë—Ä–µ–∂–∏–º –¥–ª—è –ø—Ä–∞–π—Å‚Äë–∫–∞—Ä—Ç–∏–Ω–æ–∫ ‚Äî –ø–ª–∞–Ω.

```python
# chatflow_service.py
def send_bot_response(db, client_id, remote_jid, text):
    # –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    payload = {
        "remoteJid": remote_jid,
        "message": text,  # –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
    }
```

---

## –ü—Ä–∞–≤–∏–ª–æ 10: –†–∞—Å–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞ [–†–ï–ê–õ–ò–ó–û–í–ê–ù–û]

**–ó–∞–∫–æ–Ω –†–ö "–û–± –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–µ" (—Å–µ–Ω—Ç—è–±—Ä—å 2025)** —Ç—Ä–µ–±—É–µ—Ç —É–≤–µ–¥–æ–º–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ —Ç–æ–º, —á—Ç–æ –æ–Ω–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç —Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π.

| –°–∏—Ç—É–∞—Ü–∏—è | –ë–æ—Ç –¥–µ–ª–∞–µ—Ç |
|----------|------------|
| –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ | –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å—Å—è –∫–∞–∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ |
| –í–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–ª–µ –¥–æ–ª–≥–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞ (>24—á) | –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å—Å—è —Å–Ω–æ–≤–∞ (–ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º time-awareness) |
| –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ (—Ç–æ—Ç –∂–µ –¥–µ–Ω—å) | –ù–µ –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å |

**–ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:**
> "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å–∞–ª–æ–Ω–∞ –ú–∏—Ä–∞. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ß–µ—Ä–µ–∑ system prompt.

```
–ü–ï–†–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï:
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –≤–ø–µ—Ä–≤—ã–µ –∏–ª–∏ –ø–æ—Å–ª–µ –¥–æ–ª–≥–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞ ‚Äî –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è:
"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ [–∫–æ–º–ø–∞–Ω–∏—è]. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –ø—Ä–æ–º–ø—Ç–µ (2025-12-10).

---

## –ü—Ä–∞–≤–∏–ª–æ 11: –§–∏–ª–∏–∞–ª –ø–µ—Ä–µ–¥ —Ü–µ–Ω–∞–º–∏ [–ü–õ–ê–ù]

–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ñ–∏–ª–∏–∞–ª–∞ (—Ü–µ–Ω—ã/—Å–∫–∏–¥–∫–∏/—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ), –±–æ—Ç –æ–±—è–∑–∞–Ω –∑–Ω–∞—Ç—å `branch_id`.

**–ï—Å–ª–∏ branch_id –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω:**
- –°–ø—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª–∏–∞–ª (–∫—Ä–∞—Ç–∫–æ, 1 –≤–æ–ø—Ä–æ—Å)
- –ù–µ –æ–∑–≤—É—á–∏–≤–∞—Ç—å —Ü–µ–Ω—ã/—Å–∫–∏–¥–∫–∏ –¥–æ –≤—ã–±–æ—Ä–∞ —Ñ–∏–ª–∏–∞–ª–∞

**–ï—Å–ª–∏ branch_id –∏–∑–≤–µ—Å—Ç–µ–Ω:**
- –û—Ç–≤–µ—á–∞—Ç—å —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –∑–Ω–∞–Ω–∏–π –ø–æ —Ñ–∏–ª–∏–∞–ª—É

**–ö–æ–Ω—Ñ–∏–≥:**
- `branch_resolution_mode`: `by_instance` / `ask_user` / `hybrid`
- `require_branch_for_pricing`: true/false
- `remember_branch_preference`: true/false

---

# –ß–ê–°–¢–¨ 3: –ì–†–ê–ù–ò–¶–´

## –ó–Ω–∞–µ—Ç (–±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π)
- –ü—Ä–æ–¥—É–∫—Ç—ã/—É—Å–ª—É–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏
- –¶–µ–Ω—ã –∏ —Ç–∞—Ä–∏—Ñ—ã
- –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ—Ä–≤–∏—Å
- FAQ
- –¢–∏–ø–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** RAG –ø–æ–∏—Å–∫ –≤ Qdrant –ø–æ `client_slug`.

## –ù–ï –∑–Ω–∞–µ—Ç (—ç—Å–∫–∞–ª–∞—Ü–∏—è)
- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏
- –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–±–æ–∏
- –ñ–∞–ª–æ–±—ã —Ç—Ä–µ–±—É—é—â–∏–µ —Ä–µ—à–µ–Ω–∏—è
- –í–æ–∑–≤—Ä–∞—Ç—ã –¥–µ–Ω–µ–≥

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** Intent classification ‚Üí `should_escalate(intent)`.

## –ù–ï –¥–µ–ª–∞–µ—Ç (–∑–∞–ø—Ä–µ—â–µ–Ω–æ)
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–µ—Ç —Å–∫–∏–¥–∫–∏ (—Å–∫–∏–¥–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ policy)
- –ù–µ –æ–±–µ—â–∞–µ—Ç —Ç–æ —á–µ–≥–æ –Ω–µ—Ç –≤ –±–∞–∑–µ
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏
- –ù–µ —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è —Å –Ω–µ–≥–∞—Ç–∏–≤–æ–º –æ –∫–æ–º–ø–∞–Ω–∏–∏
- –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –ù–µ –æ—Ç–≤–µ—á–∞–µ—Ç –≤–Ω–µ —Ç–µ–º—ã –∫–æ–º–ø–∞–Ω–∏–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ß–µ—Ä–µ–∑ system prompt + RAG (–æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –±–∞–∑—ã).

---

# –ß–ê–°–¢–¨ 4: –≠–°–ö–ê–õ–ê–¶–ò–Ø

> –ü–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: `SPECS/ESCALATION.md`

## –ö–æ–≥–¥–∞ —ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å [–†–ï–ê–õ–ò–ó–û–í–ê–ù–û]

| –¢—Ä–∏–≥–≥–µ—Ä | Intent | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|---------|--------|------------|
| –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ | `human_request` | ‚úÖ intent_service.py |
| –ö–ª–∏–µ–Ω—Ç —Ä–∞–∑–¥—Ä–∞–∂—ë–Ω | `frustration` | ‚úÖ intent_service.py |
| –ù–∏–∑–∫–∏–π RAG score | ‚Äî | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ (threshold –≤ knowledge_service) |

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# intent_service.py
ESCALATION_INTENTS = {Intent.HUMAN_REQUEST, Intent.FRUSTRATION}

def should_escalate(intent: Intent) -> bool:
    return intent in ESCALATION_INTENTS
```

## –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—É–ø–∏–∫–∞ [–ü–õ–ê–ù]

**–¢–£–ü–ò–ö** = –∫–ª–∏–µ–Ω—Ç –∑–∞—Å—Ç—Ä—è–ª, –±–æ—Ç –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç, –¥–∏–∞–ª–æ–≥ –∏–¥—ë—Ç –ø–æ –∫—Ä—É–≥—É.

### –ü—Ä–∏–∑–Ω–∞–∫–∏ —Ç—É–ø–∏–∫–∞ (–ª—é–±–æ–π –∏–∑):

1. **–ü–æ–≤—Ç–æ—Ä–Ω—ã–π complaint** ‚Äî intent=`frustration` –ø–æ—è–≤–ª—è–µ—Ç—Å—è 2+ —Ä–∞–∑–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
2. **–ú–∞—Ä–∫–µ—Ä—ã –ø–æ–≤—Ç–æ—Ä–∞** ‚Äî –∫–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç: "–æ–ø—è—Ç—å", "—Å–Ω–æ–≤–∞", "—É–∂–µ –≥–æ–≤–æ—Ä–∏–ª"
3. **–Ø–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å —á–µ–ª–æ–≤–µ–∫–∞** ‚Äî intent=`human_request`

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:**
```python
def detect_stuck(db, conversation_id) -> bool:
    """–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–∞—Å—Ç—Ä—è–ª –ª–∏ –∫–ª–∏–µ–Ω—Ç."""
    recent_messages = get_recent_messages(db, conversation_id, limit=5)
    
    # –°—á–∏—Ç–∞–µ–º frustration intents
    frustration_count = sum(1 for m in recent_messages if m.intent == 'frustration')
    if frustration_count >= 2:
        return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –ø–æ–≤—Ç–æ—Ä–∞
    repeat_markers = ["–æ–ø—è—Ç—å", "—Å–Ω–æ–≤–∞", "—É–∂–µ –≥–æ–≤–æ—Ä–∏–ª", "–≤ –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑", "–ø–æ–≤—Ç–æ—Ä—è—é"]
    last_message = recent_messages[-1].content.lower()
    if any(marker in last_message for marker in repeat_markers):
        return True
    
    return False
```

**–°—Ç–∞—Ç—É—Å:** –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ.

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ –±–æ—Ç–∞ –ø—Ä–∏ —Ç—É–ø–∏–∫–µ:

1. **–ü—Ä–∏–∑–Ω–∞—Ç—å —á–µ—Å—Ç–Ω–æ:**
   > "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ø–æ–º–æ—á—å —Å —ç—Ç–∏–º –≤–æ–ø—Ä–æ—Å–æ–º. –ü–µ—Ä–µ–¥–∞—é –º–µ–Ω–µ–¥–∂–µ—Ä—É ‚Äî —Å–≤—è–∂–µ—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."

2. **–≠—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å** —Å trigger_type='stuck'

3. **–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É:**
   > "–ï—Å–ª–∏ –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å, –ø–æ–∫–∞ –∂–¥—ë–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞."

---

# –ß–ê–°–¢–¨ 5: –û–ë–£–ß–ï–ù–ò–ï (Active Learning)

> –ü–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: `SPECS/ACTIVE_LEARNING.md`

## –¶–∏–∫–ª –æ–±—É—á–µ–Ω–∏—è [–ü–õ–ê–ù P2]

```
–í–æ–ø—Ä–æ—Å ‚Üí –ë–æ—Ç –Ω–µ –∑–Ω–∞–µ—Ç ‚Üí –≠—Å–∫–∞–ª–∞—Ü–∏—è
                            ‚Üì
                    –ú–µ–Ω–µ–¥–∂–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç
                            ‚Üì
                    Owner: —Å—Ä–∞–∑—É –≤ –±–∞–∑—É
                    –û—Å—Ç–∞–ª—å–Ω—ã–µ: –º–æ–¥–µ—Ä–∞—Ü–∏—è owner
                            ‚Üì
                    –î–æ–±–∞–≤–∏—Ç—å –≤ Qdrant
                            ‚Üì
                    –ë–æ—Ç –≤—ã—É—á–∏–ª
```

## –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–Ω–∞–Ω–∏–π

| –ò—Å—Ç–æ—á–Ω–∏–∫ | –°—Ç–∞—Ç—É—Å |
|----------|--------|
| –î–æ–∫—É–º–µ–Ω—Ç—ã (knowledge/*.md) | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| –û—Ç–≤–µ—Ç—ã –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ | üìã –ü–ª–∞–Ω (P2) |
| –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ | üìã –ü–ª–∞–Ω (P2) |

---

# –ß–ê–°–¢–¨ 6: –ü–£–¢–¨ –†–ê–ó–í–ò–¢–ò–Ø

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (v1.0) [–†–ï–ê–õ–ò–ó–û–í–ê–ù–û]

**–£–º–µ–µ—Ç:**
- ‚úÖ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è intent (LLM)
- ‚úÖ RAG –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (Qdrant + BGE-M3)
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ (GPT)
- ‚úÖ –≠—Å–∫–∞–ª–∞—Ü–∏—è –≤ Telegram
- ‚úÖ –ú—å—é—Ç –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è 10 —Å–æ–æ–±—â–µ–Ω–∏–π

**–ù–µ —É–º–µ–µ—Ç:**
- –°–º. "–ò–¥–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫" –Ω–∏–∂–µ.

---

## –ò–¥–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ (single source)

**P0 (–∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤, –±–µ–∑ –ª–æ–∂–Ω—ã—Ö –æ–±–µ—â–∞–Ω–∏–π):**
- –ü–æ–ª–Ω—ã–π truth‚Äëpack –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ + –±–∞–∑–æ–≤—ã–π eval‚Äëgate (–∞–¥—Ä–µ—Å/–≥—Ä–∞—Ñ–∏–∫/—É—Å–ª—É–≥–∏/—Ü–µ–Ω—ã/–∑–∞–ø–∏—Å—å/–ø—Ä–∞–≤–∏–ª–∞).
- –û–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –¥–∏–∞–ª–æ–≥: –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–¥—É—Ç –≤ —Ç–µ–∫—É—â–∏–π —Ç–æ–ø–∏–∫, –∞ –Ω–µ —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É.
- –ë–∞–∑–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –±–µ–∑ LLM‚Äë–¥–æ–≥–∞–¥–æ–∫: –æ—Ç–≤–µ—Ç—ã —Ç–æ–ª—å–∫–æ –∏–∑ truth/FAQ.

**P1 (—É—Å—Ç–æ–π—á–∏–≤—ã–π –¥–∏–∞–ª–æ–≥ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å):**
- –ü—Ä–∞–≤–∏–ª–æ 2: –∞–Ω—Ç–∏‚Äë–∞–º–Ω–µ–∑–∏—è –≤ –∫–æ–¥–µ (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ —Ç–∞–π–º‚Äë–æ–∫–Ω—É).
- –ü—Ä–∞–≤–∏–ª–æ 11: branch‚Äëgate –ø–µ—Ä–µ–¥ —Ü–µ–Ω–∞–º–∏ + —Ä–æ—É—Ç–∏–Ω–≥ –ø–æ branch_id.
- –î–µ—Ç–µ–∫—Ü–∏—è —Ç—É–ø–∏–∫–∞ –∏ —á–µ—Å—Ç–Ω–∞—è —ç—Å–∫–∞–ª–∞—Ü–∏—è (—Å–º. –ß–∞—Å—Ç—å 4).
- Auto‚Äëlearning —Å –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π (—Å–º. `SPECS/ACTIVE_LEARNING.md`).

**P2 (—É–º–Ω–µ–µ –∏ –¥–µ—à–µ–≤–ª–µ –≤ –º–∞—Å—à—Ç–∞–±–µ):**
- –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å (summary –≤ user.metadata).
- –£–º–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏ –±–µ–∑ –Ω–∞–≤—è–∑—ã–≤–∞–Ω–∏—è (Rule 4).
- –ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–∞ + typing indicator (Rule 8).
- RU/KZ –ø–∞—Ä–∏—Ç–µ—Ç: —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Ç–æ–º –∂–µ —è–∑—ã–∫–µ (truth + intents + prompt).

---

# –ß–ê–°–¢–¨ 7: –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê [–†–ï–ê–õ–ò–ó–û–í–ê–ù–û]

## –ü–æ—Ç–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏—è

```
WhatsApp (ChatFlow)
        ‚Üì
   POST /webhook/{client_slug} (Python API)
        ‚Üì
   intent_service.classify_intent()
        ‚Üì
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ should_escalate? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ escalation_service
   ‚îÇ        ‚îÇ                            ‚îÇ ‚Üí Telegram
   ‚îÇ        ‚ñº                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   ‚îÇ is_rejection? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ mute bot
   ‚îÇ        ‚îÇ
   ‚îÇ        ‚ñº
   ‚îÇ ai_service.generate_ai_response()
   ‚îÇ   ‚îú‚îÄ‚îÄ get_system_prompt()
   ‚îÇ   ‚îú‚îÄ‚îÄ search_knowledge() (RAG)
   ‚îÇ   ‚îú‚îÄ‚îÄ get_conversation_history()
   ‚îÇ   ‚îî‚îÄ‚îÄ llm.generate()
   ‚îÇ        ‚îÇ
   ‚îÇ        ‚ñº
   ‚îÇ chatflow_service.send_bot_response()
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `routers/webhook.py` | –í—Ö–æ–¥–Ω–∞—è —Ç–æ—á–∫–∞, –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ (message.py ‚Äî legacy) |
| `services/intent_service.py` | –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è intent |
| `services/ai_service.py` | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞, RAG |
| `services/knowledge_service.py` | –ü–æ–∏—Å–∫ –≤ Qdrant |
| `services/escalation_service.py` | –≠—Å–∫–∞–ª–∞—Ü–∏—è –≤ Telegram |
| `services/chatflow_service.py` | –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ WhatsApp |

---

# –ß–ê–°–¢–¨ 8: –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ö –ó–ê–ö–ê–ó–ß–ò–ö–ê–ú

## –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞

–õ–æ–≥–∏–∫–∞ –±–æ—Ç–∞ **–æ–¥–∏–Ω–∞–∫–æ–≤–∞—è** –¥–ª—è –≤—Å–µ—Ö –∑–∞–∫–∞–∑—á–∏–∫–æ–≤. –û—Ç–ª–∏—á–∞–µ—Ç—Å—è:

| –ß—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è | –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è |
|----------------|--------------|
| –ò–º—è –±–æ—Ç–∞ | –í –ø—Ä–æ–º–ø—Ç–µ (prompts) |
| –¢–æ–Ω –æ–±—â–µ–Ω–∏—è | –í –ø—Ä–æ–º–ø—Ç–µ |
| –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π | –í Qdrant (–ø–æ client_slug) |
| –ö–æ–Ω—Ç–∞–∫—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ | –í client_settings |
| –¢–∞–π–º–∞—É—Ç—ã | –í client_settings |

## –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### Truffles (–º—ã —Å–∞–º–∏)
- **–†–æ–ª—å:** –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è + –ø—Ä–æ–¥–∞–∂–∏
- **–¢–µ–º–∞:** AI-–±–æ—Ç—ã –¥–ª—è –±–∏–∑–Ω–µ—Å–∞
- **–¶–µ–ª—å:** –£–±—Ä–∞—Ç—å —Å–æ–º–Ω–µ–Ω–∏—è, –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑—É

### –°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã
- **–†–æ–ª—å:** –ó–∞–ø–∏—Å—å + –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- **–¢–µ–º–∞:** –£—Å–ª—É–≥–∏, —Ü–µ–Ω—ã, –º–∞—Å—Ç–µ—Ä–∞
- **–¶–µ–ª—å:** –ó–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞

### –õ—é–±–æ–π –∑–∞–∫–∞–∑—á–∏–∫
```python
# –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑—á–∏–∫–∞:
1. INSERT INTO clients (name, slug, ...)
2. INSERT INTO client_settings (telegram_chat_id, ...)
3. INSERT INTO prompts (client_id, name='system', text=...)
4. –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ Qdrant —Å client_slug
```

---

# –ß–ê–°–¢–¨ 9: –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å | –°—Ç–∞—Ç—É—Å |
|----------|---------------|--------|
| –û—Ç–≤–µ—á–∞–µ—Ç –ø–æ —Ç–µ–º–µ | –í–æ–ø—Ä–æ—Å –ø—Ä–æ —Å–æ–±–∞–∫ ‚Üí "–Ø –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç [–∫–æ–º–ø–∞–Ω–∏—è]..." | ‚úÖ –í –ø—Ä–æ–º–ø—Ç–µ |
| –ù–µ –≥–∞–ª–ª—é—Ü–∏–Ω–∏—Ä—É–µ—Ç | –ù–µ—Ç –≤ –±–∞–∑–µ ‚Üí "—É—Ç–æ—á–Ω—é" –∏–ª–∏ —ç—Å–∫–∞–ª–∞—Ü–∏—è | ‚úÖ RAG + –ø—Ä–æ–º–ø—Ç |
| –≠—Å–∫–∞–ª–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç | –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –≤–æ–ø—Ä–æ—Å —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| –ö—Ä–∞—Ç–∫–æ—Å—Ç—å | 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è | ‚úÖ –í –ø—Ä–æ–º–ø—Ç–µ |
| –ù–µ –Ω–∞–≤—è–∑—ã–≤–∞–µ—Ç—Å—è | –ü–æ—Å–ª–µ "–Ω–µ—Ç" ‚Äî –º–æ–ª—á–∏—Ç | ‚úÖ –ú—å—é—Ç –ª–æ–≥–∏–∫–∞ |
| –û–±—É—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | –û—Ç–≤–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ‚Üí –≤ –±–∞–∑—É ‚Üí –±–æ—Ç –∑–Ω–∞–µ—Ç | üìã –ü–ª–∞–Ω P2 |

---

# –ß–ê–°–¢–¨ 10: –ü–†–û–ú–ü–¢

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–ø—Ç–∞

```
[System prompt –∏–∑ –ë–î]
  ‚Üì
+ [–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∏–∑ RAG]
  ‚Üì
+ [–ò—Å—Ç–æ—Ä–∏—è 10 —Å–æ–æ–±—â–µ–Ω–∏–π]
  ‚Üì
+ [–¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `ai_service.py` ‚Üí `generate_ai_response()`

## –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ system prompt

```markdown
–¢—ã ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ [–ù–ê–ó–í–ê–ù–ò–ï].

–ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ: 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º
2. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –Ω–∏–∂–µ
3. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî —Å–∫–∞–∂–∏ "–£—Ç–æ—á–Ω—é —É –∫–æ–ª–ª–µ–≥"
4. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ñ—É–Ω–∫—Ü–∏–∏, —Ü–µ–Ω—ã, —Å—Ä–æ–∫–∏
5. –°–∫–∏–¥–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º —Å–∞–ª–æ–Ω–∞ (policy), –±–µ–∑ –≤—ã–¥—É–º–æ–∫
6. –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º —Å–∞–ª–æ–Ω–∞ (policy)
7. –ù–µ —Å–ø–æ—Ä—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º

–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô:
[–ü–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ RAG]

–ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê:
[–ü–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ –ë–î]
```

---

# –ß–ê–°–¢–¨ 11: 5 –≠–¢–ê–ü–û–í –ü–†–û–î–ê–ñ [–°–ü–†–ê–í–û–ß–ù–ò–ö]

> *–ë–æ—Ç –ø–æ–∫–∞ –ù–ï –≤–µ–¥—ë—Ç –ø–æ —ç—Ç–∞–ø–∞–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü–ª–∞–Ω –Ω–∞ P3.*

| –≠—Ç–∞–ø | –¶–µ–ª—å | –î–µ–π—Å—Ç–≤–∏—è –±–æ—Ç–∞ | –¢–∏–ø–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ |
|------|------|---------------|-----------------|
| **1. –ö–æ–Ω—Ç–∞–∫—Ç** | –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é | –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç, –∏–º—è, –∫–æ–Ω—Ç–µ–∫—Å—Ç | –°—É—Ö–æ–µ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ" |
| **2. –ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏** | –ü–æ–Ω—è—Ç—å "–±–æ–ª—å" | –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã: "–ö–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–∂–∏–¥–∞–µ—Ç–µ?" | –°—Ä–∞–∑—É –∫–∏–¥–∞—Ç—å –ø—Ä–∞–π—Å |
| **3. –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è** | –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ | –ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å ‚Üí –°–≤–æ–π—Å—Ç–≤–æ ‚Üí –í—ã–≥–æ–¥–∞ | "–ì–æ–ª–∞—è" —Ü–µ–Ω–∞ –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è |
| **4. –í–æ–∑—Ä–∞–∂–µ–Ω–∏—è** | –°–Ω—è—Ç—å —Å—Ç—Ä–∞—Ö–∏ | –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ + –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è | –°–ø–æ—Ä—ã, –∏–≥–Ω–æ—Ä |
| **5. –ó–∞–∫—Ä—ã—Ç–∏–µ** | –ü–æ–ª—É—á–∏—Ç—å –±—Ä–æ–Ω—å/–¥–µ–Ω—å–≥–∏ | "–í–∞–º —É–¥–æ–±–Ω–µ–µ –≤ 15:00 –∏–ª–∏ 17:00?" | "–ù—É —á—Ç–æ, –±—É–¥–µ—Ç–µ –±—Ä–∞—Ç—å?" |

**–ö–ª—é—á–µ–≤–æ–π –∏–Ω—Å–∞–π—Ç:**
> "–ò–¥–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –≤–µ–¥—ë—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —á—ë—Ç–∫–æ–π –≤–æ—Ä–æ–Ω–∫–µ, –Ω–µ –∏–º–ø—Ä–æ–≤–∏–∑–∏—Ä—É–µ—Ç —Ö–∞–æ—Ç–∏—á–Ω–æ."

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
1. State machine —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø—Ä–æ–¥–∞–∂–∏
2. –î–µ—Ç–µ–∫—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏
3. –ü–æ–¥—Å–∫–∞–∑–∫–∏ –±–æ—Ç—É –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

**–°—Ç–∞—Ç—É—Å:** –ü–ª–∞–Ω –Ω–∞ P3.

---

# –ß–ê–°–¢–¨ 12: CONFIDENCE –ò –≠–°–ö–ê–õ–ê–¶–ò–Ø [–†–ï–ê–õ–ò–ó–û–í–ê–ù–û –ß–ê–°–¢–ò–ß–ù–û]

> *–û–±—Å—É–∂–¥–µ–Ω–æ 2025-12-11. –ö–ª—é—á–µ–≤–æ–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.*

## –ü—Ä–æ–±–ª–µ–º–∞

–ë–æ—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –≤—Ä–∞—Ç—å. "–£—Ç–æ—á–Ω—é —É –∫–æ–ª–ª–µ–≥" –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π —ç—Å–∫–∞–ª–∞—Ü–∏–∏ = –≤—Ä–∞–Ω—å—ë.

## –†–µ—à–µ–Ω–∏–µ: Confidence-based routing

```
RAG score >= 0.85  ‚Üí  AUTO RESPONSE (–±–æ—Ç —Å–∞–º, —É–≤–µ—Ä–µ–Ω)
RAG score 0.6-0.85 ‚Üí  AUTO + FLAG FOR REVIEW (–±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ —Ñ–ª–∞–≥ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É)
RAG score < 0.6    ‚Üí  ESCALATION (–ø–µ—Ä–µ–¥–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É)
RAG score = 0      ‚Üí  ESCALATION + "–ø—Ä–æ–±–µ–ª –≤ –±–∞–∑–µ"
```

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (v1):**
- –û–¥–∏–Ω threshold: 0.7
- score >= 0.7 ‚Üí –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∏–∑ RAG
- score < 0.7 ‚Üí –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è "—Å–∫–∞–∂–∏ —á—Ç–æ —É—Ç–æ—á–Ω–∏—à—å" (‚ö†Ô∏è –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —ç—Å–∫–∞–ª–∞—Ü–∏—é)

**–¶–µ–ª–µ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (v2):**
- Multi-level confidence
- –†–µ–∞–ª—å–Ω–∞—è —ç—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–∏ –Ω–∏–∑–∫–æ–º score
- Feedback loop –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è threshold

## –ö–∞–∫ –¥–µ–ª–∞—é—Ç –≤ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏

| –ö–æ–º–ø–∞–Ω–∏—è | –ü–æ–¥—Ö–æ–¥ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|----------|--------|-----------|
| **Intercom Fin** | Multi-level confidence + human review | 60-70% auto-resolution |
| **Zendesk AI** | RAG + Intent + Sentiment ‚Üí routing | 50-60% deflection |
| **Drift** | Confidence threshold + fallback booking | 40% qualified leads auto |

## –ò–¥–µ–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ (–ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –í–•–û–î–Ø–©–ï–ï –°–û–û–ë–©–ï–ù–ò–ï                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. INTENT CLASSIFICATION                                    ‚îÇ
‚îÇ     ‚Üí greeting, question, complaint, booking, human_request  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. RAG SEARCH                                               ‚îÇ
‚îÇ     ‚Üí score + matched documents                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. CONFIDENCE ROUTER                                        ‚îÇ
‚îÇ     HIGH (>=0.85)   ‚Üí AUTO RESPONSE                         ‚îÇ
‚îÇ     MEDIUM (0.6-0.85) ‚Üí AUTO + REVIEW FLAG                  ‚îÇ
‚îÇ     LOW (<0.6)      ‚Üí ESCALATION                            ‚îÇ
‚îÇ     ZERO            ‚Üí ESCALATION + "–ø—Ä–æ–±–µ–ª –≤ –±–∞–∑–µ"          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  4. RESPONSE / ESCALATION                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  5. FEEDBACK LOOP (–ø–ª–∞–Ω)                                     ‚îÇ
‚îÇ     –ö–ª–∏–µ–Ω—Ç –¥–æ–≤–æ–ª–µ–Ω? ‚Üí ‚úÖ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å / ‚ùå —ç—Å–∫–∞–ª–∞—Ü–∏—è + —Ñ–ª–∞–≥    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  6. ACTIVE LEARNING                                          ‚îÇ
‚îÇ     –ú–µ–Ω–µ–¥–∂–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª ‚Üí Owner: –≤ –±–∞–∑—É / –î—Ä—É–≥–æ–π: –º–æ–¥–µ—Ä–∞—Ü–∏—è    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –§–æ—Ä–º—É–ª–∞ | –¶–µ–ª—å |
|---------|---------|------|
| **Auto-resolution rate** | –ë–µ–∑ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ / –í—Å–µ–≥–æ | >70% —á–µ—Ä–µ–∑ 3 –º–µ—Å |
| **Escalation rate** | –≠—Å–∫–∞–ª–∞—Ü–∏–π / –°–æ–æ–±—â–µ–Ω–∏–π | <15% |
| **Knowledge gap rate** | RAG score=0 / –ó–∞–ø—Ä–æ—Å–æ–≤ | <10% |
| **Learning rate** | –ù–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π / –Ω–µ–¥–µ–ª—è | –†–∞—Å—Ç—ë—Ç |

---

## TODO: –®–∞–≥–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –®–∞–≥ 1: Low confidence ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è [‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û]

**–ì–¥–µ:** `truffles-api/app/services/ai_service.py`, `truffles-api/app/routers/webhook.py`

**–ö–∞–∫ —Å–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ñ–∞–∫—Ç):**
- RAG max_score ‚â• 0.85 ‚Üí `high`
- 0.5 ‚â§ max_score < 0.85 ‚Üí `medium`
- max_score < 0.5 ‚Üí `low_confidence` ‚Üí —Å–æ–∑–¥–∞—ë–º handover (`pending`) + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
- –ò—Å–∫–ª—é—á–µ–Ω–∏—è —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –∑–∞—è–≤–∫–∞–º–∏: whitelist/guardrails (greeting/thanks/–æ–∫/??? –∏ —Ç.–ø.)

### –®–∞–≥ 2: –°–æ—Ö—Ä–∞–Ω—è—Ç—å –æ—Ç–≤–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ [‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û]

**–ì–¥–µ:** `truffles-api/app/services/manager_message_service.py`

**–§–∞–∫—Ç:** –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º `handover.manager_response` (–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è).

### –®–∞–≥ 3: Active Learning [‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û]

**–ì–¥–µ:** `truffles-api/app/services/learning_service.py`

**–õ–æ–≥–∏–∫–∞:**
1. –ï—Å–ª–∏ owner –æ—Ç–≤–µ—Ç–∏–ª ‚Üí auto-upsert –≤ Qdrant (–µ—Å—Ç—å –≤ –∫–æ–¥–µ)
2. –î–ª—è –Ω–µ-owner: –º–æ–¥–µ—Ä–∞—Ü–∏—è/approval flow ‚Äî –ø–ª–∞–Ω

### –®–∞–≥ 4: Multi-level confidence [P2]

**–ì–¥–µ:** `truffles-api/app/services/ai_service.py`

**–¢–µ–∫—É—â–µ–µ (–≤ –∫–æ–¥–µ):** HIGH=0.85, MID=0.5, –∏–Ω–∞—á–µ `low_confidence`.

**–°–ª–µ–¥—É—é—â–µ–µ —É–ª—É—á—à–µ–Ω–∏–µ (P0):** ¬´—É—Ç–æ—á–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞—è–≤–∫–æ–π¬ª ‚Äî –ø—Ä–∏ –ø–µ—Ä–≤–æ–º `low_confidence` –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å, –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–Ω–æ–≤–∞ `low_confidence` ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è.

---

# –ß–ê–°–¢–¨ 13: –†–ò–°–ö–ò –ò –ú–ò–¢–ò–ì–ê–¶–ò–ò

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏

| –†–∏—Å–∫ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-----------|
| RAG –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ | –ñ—ë—Å—Ç–∫–∏–π –ø—Ä–æ–º–ø—Ç + confidence check |
| Threshold –Ω–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª–µ–Ω | Multi-level confidence |
| Cold start (–ø—É—Å—Ç–∞—è –±–∞–∑–∞) | –®–∞–±–ª–æ–Ω–Ω–∞—è –±–∞–∑–∞ + —á–µ—Å—Ç–Ω–æ—Å—Ç—å —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º |

## –†–∏—Å–∫–∏ Active Learning

| –†–∏—Å–∫ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-----------|
| –ú—É—Å–æ—Ä –≤ –±–∞–∑—É | –¢–æ–ª—å–∫–æ owner –Ω–∞–ø—Ä—è–º—É—é, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —á–µ—Ä–µ–∑ –º–æ–¥–µ—Ä–∞—Ü–∏—é |
| –î—É–±–ª–∏–∫–∞—Ç—ã | –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ |
| –£—Å—Ç–∞—Ä–µ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö | TTL –Ω–∞ –∑–∞–ø–∏—Å–∏ + –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ |

## –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏

| –†–∏—Å–∫ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-----------|
| –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ –æ—Ç–≤–µ—á–∞—é—Ç | –¶–µ–ø–æ—á–∫–∞ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ + fallback |
| –ú–Ω–æ–≥–æ —ç—Å–∫–∞–ª–∞—Ü–∏–π –Ω–∞ —Å—Ç–∞—Ä—Ç–µ | –ë—ã—Å—Ç—Ä–æ –Ω–∞–ø–æ–ª–Ω–∏—Ç—å –±–∞–∑—É, –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –∑–∞–∫–∞–∑—á–∏–∫–∞ |
| –ö–ª–∏–µ–Ω—Ç –∂–¥—ë—Ç –¥–æ–ª–≥–æ | SLA + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ 2—á |

## –¢–û–ü-3 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ä–∏—Å–∫–∞

1. **–ú—É—Å–æ—Ä –≤ –±–∞–∑—É** ‚Üí –ú–æ–¥–µ—Ä–∞—Ü–∏—è owner
2. **Cold start** ‚Üí –®–∞–±–ª–æ–Ω–Ω–∞—è –±–∞–∑–∞ + —Ä–µ–∂–∏–º "–æ–±—É—á–µ–Ω–∏—è"
3. **–ö–ª–∏–µ–Ω—Ç –∂–¥—ë—Ç** ‚Üí –¶–µ–ø–æ—á–∫–∞ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ + fallback

---

## –°–í–Ø–ó–¨ –° –î–†–£–ì–ò–ú–ò –î–û–ö–£–ú–ï–ù–¢–ê–ú–ò

| –î–æ–∫—É–º–µ–Ω—Ç | –ß—Ç–æ —Ç–∞–º |
|----------|---------|
| `SPECS/ESCALATION.md` | –î–µ—Ç–∞–ª–∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏, —Å–æ—Å—Ç–æ—è–Ω–∏—è, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è |
| `SPECS/ACTIVE_LEARNING.md` | –ê–≤—Ç–æ–æ–±—É—á–µ–Ω–∏–µ |
| `STRATEGY/REQUIREMENTS.md` | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã, —Å—Ç—Ä–∞—Ö–∏, —Ü–µ–Ω–Ω–æ—Å—Ç–∏ |
| `knowledge/*.md` | –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –±–æ—Ç–∞ |

---

*–°–æ–∑–¥–∞–Ω–æ: 2025-12-06*
*–û–±–Ω–æ–≤–ª–µ–Ω–æ: 2025-12-11 ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã –ß–ê–°–¢–¨ 12 (Confidence) –∏ –ß–ê–°–¢–¨ 13 (–†–∏—Å–∫–∏)*
