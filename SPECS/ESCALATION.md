# ะกะะะฆะะคะะะะฆะะฏ ะญะกะะะะะฆะะ TRUFFLES

**ะะฐัะฐ:** 2025-12-06
**ะะฑะฝะพะฒะปะตะฝะพ:** 2025-12-25
**ะกัะฐััั:** ะะะะขะะงะะกะะะ ะะะะฃะะะะข
**ะะฒัะพั:** ะะฐะฝะฑะพะป + Droid

> โ๏ธ **ะญัะบะฐะปะฐัะธั โ ะฒัะพัะพะน ััะพะปะฟ ะฟัะพะตะบัะฐ ะฟะพัะปะต ะผะพะทะณะพะฒ ะฑะพัะฐ.**
> ะะตะท ััะพะณะพ Active Learning ะฝะต ัะฐะฑะพัะฐะตั. ะะพั ะฝะต ััะธััั. ะัะพะดัะบั ะผัััะฒ.

---

## ะกะขะะขะฃะก ะะะะะะะะฆะะ

| ะะฐะทะดะตะป | ะกัะฐััั |
|--------|--------|
| ะกะพััะพัะฝะธั ะดะธะฐะปะพะณะฐ | โ ะะะะะะะะะะะ |
| ะฆะตะฟะพัะบะฐ ััะบะฐะปะฐัะธะธ (multi-level) | ๐ ะะะะ |
| ะะพะปะธ ะธ ะธะดะตะฝัะธัะฝะพััะธ | โ๏ธ ะงะะกะขะะงะะ (ััะตะผะฐ/ะผะพะดะตะปะธ ะตััั, wiring pending) |
| ะะตะฝะตะดะถะตั ะพัะฒะตัะฐะตั ัะตัะตะท Telegram | โ ะะะะะะะะะะะ |
| ะัะตัะตะดั ะพะฑััะตะฝะธั + ะผะพะดะตัะฐัะธั | โ๏ธ ะงะะกะขะะงะะ (ััะตะผะฐ ะตััั, ัะปะพั/moderation pending) |
| Telegram per branch (ัะพััะผ) | ๐ ะะะะ |
| ะะตััะธะบะธ | โ๏ธ ะงะะกะขะะงะะ |
| ะะฐะทะฐ ะดะฐะฝะฝัั | โ ะะะะะะะะะะะ (handovers + agents/agent_identities/learned_responses) |
| ะะพะฝัะธะณััะฐัะธั | โ๏ธ ะงะะกะขะะงะะ |

---

## ะะะงะะ ะญะขะะข ะะะะฃะะะะข

ะญัะบะฐะปะฐัะธั โ ััะพ **ะฟัะพะดัะบั ะฒะฝัััะธ ะฟัะพะดัะบัะฐ**:
- ะกะธััะตะผะฐ ัะฒะตะดะพะผะปะตะฝะธะน
- ะะฝัะตััะตะนั ะผะตะฝะตะดะถะตัะฐ
- ะะฝัะตััะตะนั ะผะพะดะตัะฐัะธะธ
- Pipeline ะพะฑััะตะฝะธั
- ะะตััะธะบะธ

**ะฆะตะปั:** ะะฐะถะดะฐั ััะบะฐะปะฐัะธั = ะฒะพะทะผะพะถะฝะพััั ะฝะฐััะธัั ะฑะพัะฐ. Escalation Rate ะฟะฐะดะฐะตั ัะพ ะฒัะตะผะตะฝะตะผ.

---

# ะะะจะะะะ (2025-12-24): ะะะะ + ะะงะะะะะฌ ะะะฃะงะะะะฏ + TELEGRAM ะะะ UI

**ะะพะปะธ, ะพั ะบะพัะพััั ััะพะดะธะผ:**
- ะะพะปั ะฒะปะฐะดะตะปััะฐ ะทะฐะฒัะทะฐะฝะฐ ะฝะฐ Telegram ID โ ะปะพะผะฐะตั ะพะผะฝะธะบะฐะฝะฐะปัะฝะพััั ะธ ะผะฐัััะฐะฑ.
- ะะตั ัะฒะฝะพะน ะพัะตัะตะดะธ ะพะฑััะตะฝะธั โ ะฝะตั ะบะพะฝััะพะปั, ะฝะตั ะพัะบะฐัะฐ, ะฝะตั ะผะตััะธะบ.
- ะะดะธะฝ ัะฐั ะฝะฐ ะบะปะธะตะฝัะฐ โ ะฝะต ะฟะพะดะดะตัะถะธะฒะฐะตั ัะธะปะธะฐะปั.
- ะะฑััะตะฝะธะต ะฟัะพะธััะพะดะธั โัะธัะพโ โ ะฒะปะฐะดะตะปะตั ะฝะต ะฒะธะดะธั, ััะพ ะฟะพะฟะฐะดะฐะตั ะฒ KB.

**ะงัะพ ะผะตะฝัะตะผ:**
- ะะฒะพะดะธะผ ัะพะปะธ ะธ ะธะดะตะฝัะธัะฝะพััะธ (agent + agent_identity). ะะฐะฝะฐะป โ ัะพะปั.
- ะัะตัะตะดั ะพะฑััะตะฝะธั ะฒ ะะ: pending โ approved/rejected. Owner auto-approve.
- Telegram = ะพะฟะตัะฐัะธะพะฝะฝัะน UI. ะััะพัะฝะธะบ ะธััะธะฝั โ ะะ/ัะตัะฒะธั.
- Telegram-ะณััะฟะฟะฐ ะฝะฐ ะบะฐะถะดัะน ัะธะปะธะฐะป (branch.telegram_chat_id).

**ะะพัะตะผั ััะพ ััะฐะฑะธะปัะฝะพ:**
- ะฏะดัะพ ััะฐะฝะพะฒะธััั channel-agnostic โ ะปะตะณะบะพ ะดะพะฑะฐะฒะปััั ะฝะพะฒัะต ะบะฐะฝะฐะปั.
- Owner ะบะพะฝััะพะปะธััะตั ะบะฐัะตััะฒะพ โ ะผะตะฝััะต โััะนะฝั ะฒ KBโ.
- ะคะธะปะธะฐะปั ะผะฐัััะฐะฑะธัััััั ะปะธะฝะตะนะฝะพ โ ะผะตะฝััะต ะฟััะฐะฝะธัั ั ะผะตะฝะตะดะถะตัะพะฒ.

---

# ะงะะกะขะฌ 1: ะกะะกะขะะฏะะะฏ ะะะะะะะ [ะะะะะะะะะะะ]

## ะะพะณะดะฐ ะณะพะฒะพัะธั ะฑะพั, ะบะพะณะดะฐ ัะตะปะพะฒะตะบ?

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ะกะะกะขะะฏะะะฏ ะะะะะะะ                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                 โ
โ  BOT_ACTIVE โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ      โ                                                    โ     โ
โ      โ ะะพั ะฝะต ะทะฝะฐะตั / ะบะปะธะตะฝั ะฟัะพัะธั ะผะตะฝะตะดะถะตัะฐ             โ     โ
โ      โผ                                                    โ     โ
โ  PENDING โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ     โ
โ      โ                                                โ   โ     โ
โ      โ ะะตะฝะตะดะถะตั ะฝะฐะถะฐะป [ะะตัั]                          โ   โ     โ
โ      โผ                                                โ   โ     โ
โ  MANAGER_ACTIVE โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ     โ
โ      โ                                                โ   โ     โ
โ      โ ะะตะฝะตะดะถะตั ะฝะฐะถะฐะป [ะะตัะตะฝะพ]                        โ   โ     โ
โ      โผ                                                โ   โ     โ
โ  BOT_ACTIVE โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ     โ
โ                                                           โ     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
```

**ะะตะฐะปะธะทะฐัะธั:** `truffles-api/app/services/state_machine.py`

---

## ะขะฐะฑะปะธัะฐ ัะพััะพัะฝะธะน

| ะกะพััะพัะฝะธะต | ะัะพ ะพัะฒะตัะฐะตั | ะะพั ะดะตะปะฐะตั | ะขัะธะณะณะตั ะฒััะพะดะฐ |
|-----------|--------------|------------|----------------|
| `bot_active` | ะะพั | ะัะฒะตัะฐะตั ะฝะฐ ะฒัั | โ |
| `pending` | ะะดัะผ ะผะตะฝะตะดะถะตัะฐ | ะะพะผะพะณะฐะตั ะฟะพะบะฐ ะถะดัั | ะะตะฝะตะดะถะตั [ะะตัั] ะธะปะธ ะบะปะธะตะฝั ะพัะผะตะฝะธะป |
| `manager_active` | ะะตะฝะตะดะถะตั | **ะะะะงะะข** | ะะตะฝะตะดะถะตั [ะะตัะตะฝะพ] |

**ะะตะฐะปะธะทะฐัะธั:** `truffles-api/app/models/conversation.py` โ ะฟะพะปะต `state`

---

## ะัะฐะฒะธะปะฐ ะฟะพะฒะตะดะตะฝะธั ะฑะพัะฐ [ะะะะะะะะะะะ]

### ะะพะณะดะฐ `bot_active`:
- ะะพั ะพัะฒะตัะฐะตั ะฝะฐ ะฒัะต ัะพะพะฑัะตะฝะธั
- ะะพัะผะฐะปัะฝะฐั ัะฐะฑะพัะฐ

**ะะตะฐะปะธะทะฐัะธั:** `truffles-api/app/routers/webhook.py` (ะพัะฝะพะฒะฝะพะน ะฟััั), `truffles-api/app/routers/message.py` (legacy)

### ะะพะณะดะฐ `pending`:
- ะะพั ะฃะะ ะพัะฒะตัะธะป ะบะปะธะตะฝัั ("ะะตัะตะดะฐะป ะผะตะฝะตะดะถะตัั")
- ะกะพะทะดะฐะฝ handover ะฒ ะะ
- ะฃะฒะตะดะพะผะปะตะฝะธะต ะฒ Telegram ั ะบะฝะพะฟะบะฐะผะธ [ะะตัั] [ะะตัะฝััั ะฑะพัั] [ะะต ะผะพะณั]
- ะะพั ะฟัะพะดะพะปะถะฐะตั ะฟะพะผะพะณะฐัั ะตัะปะธ ะบะปะธะตะฝั ะฟะธัะตั

**ะะตะฐะปะธะทะฐัะธั:** `truffles-api/app/services/state_service.py` (`escalate_to_pending`) + `truffles-api/app/services/escalation_service.py` (`send_telegram_notification`)

### ะะพะณะดะฐ `manager_active`:
- **ะะะข ะะะะะะกะขะฌะฎ ะะะะงะะข**
- ะัะต ัะพะพะฑัะตะฝะธั ะบะปะธะตะฝัะฐ ัะพัะฒะฐัะดัััั ะผะตะฝะตะดะถะตัั ะฒ Telegram
- ะะตะฝะตะดะถะตั ะพัะฒะตัะฐะตั โ ะพัะฒะตั ะธะดัั ะฒ WhatsApp ะบะปะธะตะฝัั
- ะััะพะด: ะผะตะฝะตะดะถะตั ะฝะฐะถะธะผะฐะตั [ะะตัะตะฝะพ]

**ะะตะฐะปะธะทะฐัะธั:** 
- `telegram_webhook.py` โ `handle_manager_message()`
- `manager_message_service.py` โ `process_manager_message()`

### ะะตะดะธะฐ (ัะพัะพ/ะฐัะดะธะพ/ะดะพะบัะผะตะฝัั)
- ะคะพัะพ/ะฐัะดะธะพ/ะดะพะบัะผะตะฝัั ะฟัะธะฝะธะผะฐะตะผ, ะฒะธะดะตะพ ะทะฐะฟัะตัะตะฝะพ.
- ะ `bot_active`: 
  - ะตัะปะธ ะตััั ัะตะบัั/ััะฐะฝัะบัะธะฟั โ ะพะฑัะฐะฑะฐััะฒะฐะตะผ ะบะฐะบ ะพะฑััะฝะพะต ัะพะพะฑัะตะฝะธะต (intent/RAG), ะทะฐัะฒะบะธ ะฝะต ะพัะบััะฒะฐะตะผ ะฐะฒัะพะผะฐัะธัะตัะบะธ.
  - ะตัะปะธ ะฝะตั ัะตะบััะฐ โ ะฑะพั ะฟัะพัะธั ะพะฟะธัะฐัั ะทะฐะฟัะพั ัะตะบััะพะผ, ะทะฐัะฒะบะธ ะฝะต ะพัะบััะฒะฐะตั.
  - ะตัะปะธ ะทะฐะฟัะพั โะบะฐะบ ะฝะฐ ัะพัะพ/ัะตัะตัะตะฝั/ะฒ ััะธะปะตโ โ ััะบะฐะปะฐัะธั + ัะพัะฒะฐัะด ะฒ Telegram.
- ะตัะปะธ ะทะฐะฟัะพั โะบะฐะบ ะฝะฐ ัะพัะพ/ัะตัะตัะตะฝัโ ะฑะตะท ัะพัะพ โ ะฟัะพัะธะผ ะฟัะธัะปะฐัั ัะพัะพ, ะฑะตะท ััะบะฐะปะฐัะธะธ.
- ะ `pending`: ะผะตะดะธะฐ ัะพัะฒะฐัะดะธััั ะฒ Telegram; ะฑะพั ะผะพะถะตั ััะพัะฝััั ะดะตัะฐะปะธ ะฟะพ ัะตะบััั/ััะฐะฝัะบัะธะฟัั, ะฝะพ ะฑะตะท ัะธะฝะฐะปัะฝัั ัะตัะตะฝะธะน.
- ะ `manager_active`: ะฑะพั ะฟะพะปะฝะพัััั ะผะพะปัะธั.
- ะะพะปะพัะพะฒัะต: ััะฐะฝัะบัะธะฑะธััะตะผ ัะพะปัะบะพ ะบะพัะพัะบะธะต PTT; ะดะปะธะฝะฝัะต ะฐัะดะธะพ/ะฒะธะดะตะพ โ ะฟัะพัะธะผ ัะตะบัั.
- ะะพะบัะผะตะฝัั: ัะพะปัะบะพ ะฟะตัะตััะปะบะฐ (ะพะฑัะฐะฑะพัะบะฐ ะฟะพะทะถะต).
- ะะณัะฐะฝะธัะตะฝะธั ะฟะพ ัะฐะทะผะตัั ะธ rateโlimit ะดะพ ะพะฑัะฐะฑะพัะบะธ.

**ะะตะฐะปะธะทะฐัะธั:** `truffles-api/app/routers/webhook.py` (media guardrails + forward), `truffles-api/app/services/telegram_service.py` (sendPhoto/sendAudio/sendDocument/sendVoice).

---

## ะะพะฝััะฐะบั ะฟะพะฒะตะดะตะฝะธั (ะฟัะธะพัะธัะตัั ะธ ะผะฐััะธัะฐ) [P0]

ะัะปะธ ะฒ ะพะดะฝะพะผ ัะพะพะฑัะตะฝะธะธ ะฝะตัะบะพะปัะบะพ ัะธะณะฝะฐะปะพะฒ/ะธะฝัะตะฝัะพะฒ, ะฟัะธะผะตะฝัะตััั ัะฐะผัะน ัะธะปัะฝัะน ะฟะพ ะฟัะธะพัะธัะตัั.
ะญัะพ ะฟัะฐะฒะธะปะพ ัะธะปัะฝะตะต ะปัะฑัั ะปะพะบะฐะปัะฝัั ัะฒัะธััะธะบ.

**ะัะธะพัะธัะตัั (ัะธะปัะฝะตะต โ ัะปะฐะฑะตะต):**
1. **HardโLAW** (ะพะฟะปะฐัะฐ: ะฟะพะดัะฒะตัะถะดะตะฝะธะต/ะฟัะพะฒะตัะบะฐ/ะฒะพะทะฒัะฐัั, ะผะตะดะธัะธะฝะบะฐ, ะถะฐะปะพะฑั, ะฟะตัะตะฝะพัั, ัะตั. ัะฑะพะธ) โ ััะบะฐะปะฐัะธั.
2. **Policyโgates (ัะบะธะดะบะธ/ัะฟะพัะพะฑั ะพะฟะปะฐัั)** โ ะพัะฒะตั **ัะพะปัะบะพ** ะฟะพ ะฟัะฐะฒะธะปะฐะผ ะธะท client_pack; ะตัะปะธ ะฟัะฐะฒะธะป ะฝะตั โ ััะบะฐะปะฐัะธั.
3. **Opt-out / rejection** โ ะผััั. ะัะปะธ ะฒ ัะพะพะฑัะตะฝะธะธ ะตััั ะทะฐะฟะธัั/ัะตะฝะฐ/ะฐะดัะตั/ะฒัะตะผั โ ะทะฐะฟัะพัะธัั re-engage ะธ ะฝะต ะฒัะฟะพะปะฝััั ะดะตะนััะฒะธะต ะดะพ ะพัะฒะตัะฐ.
4. **Human request / frustration** โ ััะบะฐะปะฐัะธั.
5. **Booking flow** โ ัะฑะพั ัะปะพัะพะฒ ะทะฐะฟะธัะธ (ะฒะฐะถะฝะตะต ัะตะฝั/ะพะฑัะธั ะฒะพะฟัะพัะพะฒ).
6. **Question (in-domain)** โ ะพัะฒะตั ัะตัะตะท truth/RAG, ะฟัะธ ะฝะธะทะบะพะน ัะฒะตัะตะฝะฝะพััะธ โ ััะพัะฝะตะฝะธะต/ััะบะฐะปะฐัะธั.
7. **Greeting / thanks** โ ะบะพัะพัะบะธะน ะพัะฒะตั, ะฑะตะท ะทะฐัะฒะบะธ.
8. **Out-of-domain / other** โ ะฒะตะถะปะธะฒัะน ะพัะบะฐะท/ะฟะตัะตะฝะฐะฟัะฐะฒะปะตะฝะธะต.

**Re-engage:**
- `reengage_confirmation` ะฒ `conversation.context` ััะฐะฒะธััั, ะตัะปะธ ะตััั opt-out + ะฑะธะทะฝะตั-ะทะฐะฟัะพั.
- ะะพะบะฐ ะถะดัะผ ะฟะพะดัะฒะตัะถะดะตะฝะธั, ะพััะฐะปัะฝัะต ะธะฝัะตะฝัั ะธะณะฝะพัะธัััััั.
- "ะะฐ" โ ัะฝััั ะผััั ะธ ะฟัะพะดะพะปะถะธัั; "ะะตั" โ ะพััะฐะฒะธัั ะผััั.
- ะ `pending/manager_active` opt-out = ะพัะผะตะฝะฐ ะทะฐัะฒะบะธ, ะฝะต ะผััั.

**Booking interrupt (expected_reply_type ะฐะบัะธะฒะตะฝ):**
- In-domain ะฒะพะฟัะพั ะฒะพ ะฒัะตะผั ัะฑะพัะฐ ัะปะพัะฐ โ ะดะฐัั ัะฐะบัโะพัะฒะตั ะธ ะฒ ัะพะผ ะถะต ัะพะพะฑัะตะฝะธะธ ะฒะตัะฝััั bookingโprompt (ะฑะตะท ััะบะฐะปะฐัะธะธ).
- ะัะปะธ ัะพะพะฑัะตะฝะธะต ะฝะต ะพัะฝะพัะธััั ะบ ะทะฐะฟะธัะธ ะธ ะฝะตั bookingโัะธะณะฝะฐะปะฐ โ booking ััะฐะฒะธััั ะฝะฐ ะฟะฐัะทั ะดะพ ัะฒะฝะพะณะพ ะทะฐะฟัะพัะฐ ะทะฐะฟะธัะธ.

**Infoโbundle (ะธะฝะฒะฐัะธะฐะฝั):**
- ะะพะผะฑะธะฝะฐัะธะธ โะณะดะต/ะบะพะณะดะฐ/ะฟะฐัะบะพะฒะบะฐ/ะณะพััะธ/ะดะตัะธ/ัะฐะฝะฝะธะน ะฟัะธัะพะดโ ะฝะต ะดะพะปะถะฝั ััะบะฐะปะธัะพะฒะฐัั โ ะดะฐัั ัะฐะบัโะพัะฒะตั (ะฐะดัะตั+ัะฐัั+ะฝัะถะฝัะต ัะตะบัะธะธ).
- ะญัะบะฐะปะฐัะธั ะดะพะฟัััะธะผะฐ ัะพะปัะบะพ ะฟัะธ ัะฒะฝัั HardโLAW/policyโััะธะณะณะตัะฐั, ะฝะต ะธะทโะทะฐ ะฟะพััะดะบะฐ ัะปะพะฒ.

**Policyโgates: ัะบะธะดะบะธ**
- ะกะบะธะดะบะธ โ **ะฝะต HardโLAW**. ะัะฒะตัะฐะตะผ **ัะพะปัะบะพ** ะฟะพ ัะฒะฝัะผ ะฟัะฐะฒะธะปะฐะผ ะฒ `client_pack.discounts`.
- ะัะปะธ ะฟัะฐะฒะธะป ะฝะตั/ะฝะต ัะพะฒะฟะฐะปะธ โ ััะบะฐะปะฐัะธั (ะฑะตะท ะฟะพะฟััะบะธ ัะพัะณะฐ/ะพะฑะตัะฐะฝะธะน).

**Policyโgates: ัะฟะพัะพะฑั ะพะฟะปะฐัั (info)**
- ะะตัะตัะธัะปะตะฝะธะต ัะฟะพัะพะฑะพะฒ ะพะฟะปะฐัั ัะฐะทัะตัะตะฝะพ **ัะพะปัะบะพ** ะฟัะธ `client_pack.payment.allow_payment_info=true`.
- ะัะปะธ ะฟัะฐะฒะธะป/ัะฟะธัะบะฐ ะฝะตั โ ััะบะฐะปะฐัะธั.
- ะะพะดัะฒะตัะถะดะตะฝะธะต ะพะฟะปะฐัั/ะฒะพะทะฒัะฐัั/ะฟัะพะฒะตัะบะฐ ััะฐะฝะทะฐะบัะธะธ โ ะฒัะตะณะดะฐ HardโLAW.

### ะะฐััะธัะฐ state ร intent โ action

| State | human_request / frustration | rejection / opt_out | booking (slots) | question (in-domain) | greeting / thanks | out_of_domain / other |
|-------|-----------------------------|--------------------|-----------------|----------------------|-------------------|-----------------------|
| bot_active | ะญัะบะฐะปะฐัะธั (handover) + ะพัะฒะตั ัะฐะฑะปะพะฝะพะผ | ะััั + re-engage ะฟัะธ ัะผะตัะตะฝะธะธ | ะกะฑะพั ัะปะพัะพะฒ, 1 ะฒะพะฟัะพั ะทะฐ ัะฐะท | ะัะฒะตั ัะตัะตะท truth/LLM; low โ ััะพัะฝะตะฝะธะต/ััะบะฐะปะฐัะธั | ะะพัะพัะบะพ, ะฑะตะท ะทะฐัะฒะบะธ | ะะตะถะปะธะฒัะน ะพัะบะฐะท |
| pending | ะะตะท ะฝะพะฒะพะณะพ handover, ะฟะพะดัะฒะตัะดะธัั ััะพ ะผะตะฝะตะดะถะตั ะฟะพะดะบะปัััะฝ | ะัะผะตะฝะธัั ะทะฐัะฒะบั, ะฑะตะท ะผัััะฐ | ะกะฑะพั ัะปะพัะพะฒ, ะฑะตะท ะฝะพะฒะพะณะพ handover | ะะพัะพัะบะธะน ะพัะฒะตั, ะฑะตะท handover | ะะพัะพัะบะพ | ะะตะถะปะธะฒัะน ะพัะบะฐะท |
| manager_active | ะะพั ะผะพะปัะธั, ัะพัะฒะฐัะด ะผะตะฝะตะดะถะตัั | ะัะผะตะฝะธัั ะทะฐัะฒะบั, ะฑะตะท ะผัััะฐ | ะะพั ะผะพะปัะธั, ัะพัะฒะฐัะด ะผะตะฝะตะดะถะตัั | ะะพั ะผะพะปัะธั, ัะพัะฒะฐัะด ะผะตะฝะตะดะถะตัั | ะะพั ะผะพะปัะธั, ัะพัะฒะฐัะด ะผะตะฝะตะดะถะตัั | ะะพั ะผะพะปัะธั, ัะพัะฒะฐัะด ะผะตะฝะตะดะถะตัั |

---

## ะััั ะฑะพัะฐ [ะะะะะะะะะะะ]

| ะกะธััะฐัะธั | ะะตะนััะฒะธะต |
|----------|----------|
| ะะตัะฒัะน "ะฝะตั" ะฒ bot_active | ะััั 30 ะผะธะฝ (ะฝะฐัััะฐะธะฒะฐะตััั) |
| ะัะพัะพะน "ะฝะตั" ะฒ bot_active | ะััั 24 ัะฐัะฐ (ะฝะฐัััะฐะธะฒะฐะตััั) |
| 24 ัะฐัะฐ ะฑะตะท ัะพะพะฑัะตะฝะธะน | ะกะฑัะพั ัััััะธะบะฐ |
| ะฏะฒะฝัะน ะทะฐะฟัะพั ะทะฐะฟะธัะธ/ัะตะฝั/ะฐะดัะตัะฐ ะฟะพัะปะต ะผัััะฐ | ะะฐะทะผัััะธัั ะธ ะฟัะพะดะพะปะถะธัั ะดะธะฐะปะพะณ |
| Optโout + ะทะฐะฟะธัั ะฒ ะพะดะฝะพะผ ัะพะพะฑัะตะฝะธะธ | ะะฐะฟัะพัะธัั ะฟะพะดัะฒะตัะถะดะตะฝะธะต โะดะฐ/ะฝะตัโ |

**ะะตะฐะปะธะทะฐัะธั:** 
- `truffles-api/app/routers/webhook.py` / `truffles-api/app/routers/message.py` โ `is_rejection(intent)`
- `conversation.bot_muted_until`, `conversation.no_count`
- `client_settings.mute_duration_first_minutes`, `mute_duration_second_hours`

**ะะะะะ:** "ะฝะตั" ะฟัะธ ะพัะบัััะพะน ะทะฐัะฒะบะต (pending/manager_active) โ ััะพ ะพัะผะตะฝะฐ ะทะฐัะฒะบะธ, ะะ ะผััั.
**ะะะะะ:** reโengage ะฟะพะดัะฒะตัะถะดะตะฝะธะต ััะฐะฝะธััั ะฒ `conversation.context` (ะบะปัั `reengage_confirmation`).

---

# ะงะะกะขะฌ 2: ะฆะะะะงะะ ะญะกะะะะะฆะะ [ะะะะ]

> โ๏ธ **ะญัะพั ัะฐะทะดะตะป ะะ ัะตะฐะปะธะทะพะฒะฐะฝ. ะกะตะนัะฐั ัะพะปัะบะพ ะพะดะธะฝ ััะพะฒะตะฝั ัะฒะตะดะพะผะปะตะฝะธั.**

## ะัะพ ะพัะฒะตัะฐะตั ะธ ะบะพะณะดะฐ (ะฟะปะฐะฝ)

```
ะญะกะะะะะฆะะฏ ะะะงะะะะกะฌ
        โ
        โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. PRIMARY MANAGER                    โ
โ    ะฃะฒะตะดะพะผะปะตะฝะธะต ะฒ Telegram             โ
โ    ะขะฐะนะผะฐัั: 5 ะผะธะฝัั                   โ
โโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
                โ ะะต ะพัะฒะตัะธะป
                โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2. OTHER MANAGERS (ะฒัะต ะฒ ัะฟะธัะบะต)      โ
โ    ะฃะฒะตะดะพะผะปะตะฝะธะต ะฒัะตะผ                   โ
โ    ะขะฐะนะผะฐัั: 5 ะผะธะฝัั                   โ
โโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
                โ ะะธะบัะพ ะฝะต ะพัะฒะตัะธะป
                โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3. LEADERSHIP (ะฒะปะฐะดะตะปะตั/ะดะธัะตะบัะพั)     โ
โ    ะัะฐัะฝัะน ะฐะปะตัั                      โ
โ    ะขะฐะนะผะฐัั: 10 ะผะธะฝัั                  โ
โโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
                โ ะะธะบัะพ ะฝะต ะพัะฒะตัะธะป
                โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 4. BOT FALLBACK                       โ
โ    "ะขัะตะฑัะตััั ะฒัะตะผั, ะฒะตัะฝััั"         โ
โ    ะกะพะทะดะฐัั ะทะฐะดะฐัั ะฒ ัะธััะตะผะต           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะขะตะบััะฐั ัะตะฐะปะธะทะฐัะธั:** ะขะพะปัะบะพ ะพะดะธะฝ ััะพะฒะตะฝั โ ัะฒะตะดะพะผะปะตะฝะธะต ะฒ Telegram ะณััะฟะฟั. ะะฐะฟะพะผะธะฝะฐะฝะธั ัะตัะตะท 30 ะธ 60 ะผะธะฝัั.

---

## ะขะฐะนะผะฐััั

| ะฃัะพะฒะตะฝั | ะะปะฐะฝ | ะขะตะบััะฐั ัะตะฐะปะธะทะฐัะธั |
|---------|------|-------------------|
| Primary Manager | 5 ะผะธะฝ | โ ะะตั |
| Other Managers | 5 ะผะธะฝ | โ ะะตั |
| Leadership | 10 ะผะธะฝ | โ ะะตั |
| Reminder 1 | โ | โ 30 ะผะธะฝ (ะฝะฐัััะฐะธะฒะฐะตััั) |
| Reminder 2 | โ | โ 60 ะผะธะฝ + ัะตะณ owner (ะฝะฐัััะฐะธะฒะฐะตััั) |

**ะะตะฐะปะธะทะฐัะธั ะฝะฐะฟะพะผะธะฝะฐะฝะธะน:** `reminder_service.py`

---

# ะงะะกะขะฌ 3: ะะะะ, ะะะะะขะะงะะะกะขะ, ะะะฃะงะะะะ [ะะะจะะะะ]

## ะะพะปะธ ะฒ ัะธััะตะผะต

| ะะพะปั | ะัะพ | ะัะฐะฒะฐ | ะะฑััะตะฝะธะต |
|------|-----|-------|----------|
| `owner` | ะะปะฐะดะตะปะตั ะฑะธะทะฝะตัะฐ | ะัั | ะะฒัะพ-approve ะฒ KB |
| `admin` | ะฃะฟัะฐะฒะปัััะธะน | ะะพััะธ ะฒัั | ะ ะพัะตัะตะดั ะฝะฐ ะผะพะดะตัะฐัะธั owner |
| `manager` | ะะตะฝะตะดะถะตั | ะัะฒะตัะฐัั, ะฒะธะดะตัั ะดะธะฐะปะพะณะธ | ะ ะพัะตัะตะดั ะฝะฐ ะผะพะดะตัะฐัะธั |
| `support` | ะะพะดะดะตัะถะบะฐ | ะขะพะปัะบะพ ะพัะฒะตัะฐัั | ะ ะพัะตัะตะดั ะฝะฐ ะผะพะดะตัะฐัะธั |

**ะขะตะบััะฐั ัะตะฐะปะธะทะฐัะธั:** ะขะฐะฑะปะธัั ัะพะปะตะน/ะธะดะตะฝัะธัะฝะพััะตะน ัััะตััะฒััั, ะฝะพ wiring ะฝะต ะฟะพะดะบะปัััะฝ. ะัะฟะพะปัะทัะตััั `client_settings.owner_telegram_id` ะบะฐะบ ะฒัะตะผะตะฝะฝัะน ะบะพัััะปั.

---

## ะะดะตะฝัะธัะฝะพััะธ (agent_identities)

**ะัะธะฝัะธะฟ:** ะพะดะธะฝ ัะตะปะพะฒะตะบ = ะพะดะธะฝ `agent`, ั ะฝะตะณะพ ะผะพะถะตั ะฑััั ะฝะตัะบะพะปัะบะพ ะธะดะตะฝัะธัะฝะพััะตะน ะฒ ัะฐะทะฝัั ะบะฐะฝะฐะปะฐั.

ะัะธะผะตัั ะธะดะตะฝัะธัะฝะพััะตะน:
- `channel=telegram`, `external_id=123456789`, `username=owner_user`
- `channel=email`, `external_id=owner@company.kz`

**ะะฐัะตะผ:** ัะพะปั ะพะฟัะตะดะตะปัะตััั ะฒ ะะ, ะฐ ะฝะต โะฟะพ Telegramโ. ะญัะพ ัะฝะธะผะฐะตั ะฟัะธะฒัะทะบั ะบ ะพะดะฝะพะผั ะบะฐะฝะฐะปั.

---

## ะกะบะพัะฟ ัะพะปะตะน (ัะธะปะธะฐะป vs ะณะปะพะฑะฐะปัะฝะพ)

- `branch_id = NULL` โ ัะพะปั ะดะตะนััะฒัะตั ะฝะฐ ะฒัะต ัะธะปะธะฐะปั ะบะปะธะตะฝัะฐ
- `branch_id = <branch>` โ ัะพะปั ะดะตะนััะฒัะตั ัะพะปัะบะพ ะฒ ััะพะผ ัะธะปะธะฐะปะต

**ะัะธะผะตั:** ะฐะดะผะธะฝั ะฟะพ ัะธะปะธะฐะปะฐะผ, owner ะณะปะพะฑะฐะปัะฝัะน.

---

## ะงะตะน ะพัะฒะตั โ ะทะพะปะพัะพ? (ัะตัะตะฝะธะต)

```
Owner ะพัะฒะตัะธะป โ ััะฐะทั ะฒ KB (auto-approve)
Admin ะพัะฒะตัะธะป โ pending โ approve owner (ะธะปะธ auto-approve, ะตัะปะธ ะฒะบะปััะตะฝะพ)
Manager/Support ะพัะฒะตัะธะป โ pending โ approve owner
```

**ะะพะฝัะธะณ:** `auto_approve_roles` (ะฟะพ ัะผะพะปัะฐะฝะธั `owner,admin`). ะัะธ ะฒะบะปััะตะฝะธะธ `admin` โ ะพะณัะฐะฝะธัะธัั ัะธะปะธะฐะปะพะผ.

**ะขะตะบััะฐั ัะตะฐะปะธะทะฐัะธั:** โ๏ธ ะงะฐััะธัะฝะพ. ะัะฒะตั ะผะตะฝะตะดะถะตัะฐ ัะพััะฐะฝัะตััั ะฒ `handover.manager_response`. ะัะปะธ ะพัะฒะตัะฐะตั owner (ะฟะพ `client_settings.owner_telegram_id`) โ ะพัะฒะตั ะผะพะถะตั ะฐะฒัะพ-ะดะพะฑะฐะฒะปััััั ะฒ KB (Qdrant).

---

## ะัะตัะตะดั ะพะฑััะตะฝะธั (learned_responses)

**ะะฐะดะฐัะฐ:** ั owner ะฒัะตะณะดะฐ ะตััั ะบะพะฝััะพะปั ะธ ะพัะบะฐั.

ะกัะฐัััั:
- `pending` โ ะถะดัะผ ัะตัะตะฝะธั owner
- `approved` โ ะดะพะฑะฐะฒะปะตะฝะพ ะฒ KB
- `rejected` โ ะพัะบะปะพะฝะตะฝะพ

**Auto-approve:** ัะพะปัะบะพ ะตัะปะธ ัะพะปั `owner`.

---

## ะะพััะดะพะบ ััะบะฐะปะฐัะธะธ (ะฟะปะฐะฝ)

```sql
-- ะขะฐะฑะปะธัะฐ: escalation_chain (ะะ ะกะะะะะะ)
client_id | priority | role      | user_id | contact
----------|----------|-----------|---------|------------------
1         | 1        | manager   | 101     | @manager_tg
1         | 2        | manager   | 102     | @manager2_tg
1         | 3        | admin     | 103     | @admin_tg
1         | 4        | owner     | 104     | @owner_tg
```

---

# ะงะะกะขะฌ 4: ะะะ ะะะะะะะะ ะะขะะะงะะะข [ะงะะกะขะะงะะ ะะะะะะะะะะะ]

## ะะฐัะธะฐะฝัั

### ะะฐัะธะฐะฝั A: Telegram ะฑะพั [ะะะะะะะะะะะ]
```
ะะตะฝะตะดะถะตั ะฟะพะปััะฐะตั ะฒ Telegram:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐จ ะะะะะฏ ะะะฏะะะ                     โ
โ                                     โ
โ ๐ฑ ะะปะธะตะฝั: +7 701 570 5555          โ
โ ๐ค ะะผั: ะะฝะฝะฐ                        โ
โ ๐ฌ ะกะพะพะฑัะตะฝะธะต: "ะฅะพัั ัะทะฝะฐัั ัะตะฝั"    โ
โ                                     โ
โ [ะะตัั] [ะัะพะฟัััะธัั] [ะ ะฑะฐะทั]*       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ะะตะฝะตะดะถะตั ะฟะธัะตั ะพัะฒะตั ะฒ ัะพะฟะธะบ:
โ ะัะฒะตั ะฟะตัะตััะปะฐะตััั ะฒ WhatsApp ะบะปะธะตะฝัั
โ ะะฝะพะฟะบะธ ะผะตะฝััััั ะฝะฐ [ะะตัะตะฝะพ]
```

*`[ะ ะฑะฐะทั]` ะฒะธะดะธั ัะพะปัะบะพ owner; ะดะปั ะพััะฐะปัะฝัั โ `[ะะฐ ะผะพะดะตัะฐัะธั]`.*

**ะะตัะตะฝะธะต ะฟะพ ะณััะฟะฟะฐะผ:**
- **ะะดะฝะฐ Telegram-ะณััะฟะฟะฐ ะฝะฐ ัะธะปะธะฐะป** (`branches.telegram_chat_id`)
- **ะะดะธะฝ ัะพะฟะธะบ ะฝะฐ ะบะปะธะตะฝัะฐ** (`users.telegram_topic_id` โ ะบะฐะฝะพะฝ; `conversations.telegram_topic_id` โ ะบะพะฟะธั ะดะปั ะฐะบัะธะฒะฝะพะณะพ ะดะธะฐะปะพะณะฐ)

**ะะตะฐะปะธะทะฐัะธั:**
- `escalation_service.py` โ ะพัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธั
- `telegram_webhook.py` โ ะพะฑัะฐะฑะพัะบะฐ ะบะฝะพะฟะพะบ ะธ ัะพะพะฑัะตะฝะธะน
- `manager_message_service.py` โ ะฟะตัะตััะปะบะฐ ะฒ WhatsApp

### ะะฐัะธะฐะฝั B: ะะตะฑ-ะธะฝัะตััะตะนั [ะะะะ]
```
ะะตะฝะตะดะถะตั ะทะฐัะพะดะธั ะฝะฐ dashboard.truffles.kz:
- ะะธะดะธั ัะฟะธัะพะบ ััะบะฐะปะฐัะธะน
- ะะธะดะธั ะฟะพะปะฝัั ะธััะพัะธั ะดะธะฐะปะพะณะฐ
- ะัะฒะตัะฐะตั ะฒ ัะพัะผะต
- ะัะฒะตั ััะพะดะธั ะบะปะธะตะฝัั
```

**ะกัะฐััั:** ะะต ัะตะฐะปะธะทะพะฒะฐะฝะพ.

### ะะฐัะธะฐะฝั C: ะััะผะพะน WhatsApp [ะะ ะะะะะะะฃะะขะกะฏ]

---

## ะะพะฒะตะดะตะฝะธะต ะฑะพัะฐ ะบะพะณะดะฐ ะผะตะฝะตะดะถะตั ะฒ ะดะธะฐะปะพะณะต [ะะะะะะะะะะะ]

### ะะตะฝะตะดะถะตั ะฝะฐะถะฐะป [ะะตัั]:
1. `handover.status = 'active'`
2. `conversation.state = 'manager_active'`
3. ะะพั ะฟะพะปะฝะพัััั ะผะพะปัะธั
4. ะะฝะพะฟะบะธ ะผะตะฝััััั ะฝะฐ [ะะตัะตะฝะพ]

**ะะตะฐะปะธะทะฐัะธั:** `telegram_webhook.py` โ `handle_callback_query()`, action="take"

### ะะตะฝะตะดะถะตั ะฝะฐะถะฐะป [ะะตัะตะฝะพ]:
1. `handover.status = 'resolved'`
2. `conversation.state = 'bot_active'`
3. `conversation.bot_muted_until = None`
4. `conversation.no_count = 0`
5. ะะพั ัะฝะพะฒะฐ ะฐะบัะธะฒะตะฝ

**ะะตะฐะปะธะทะฐัะธั:** `telegram_webhook.py` โ `handle_callback_query()`, action="resolve"

### ะะตะฝะตะดะถะตั ะฟัะพััะพ ะฝะฐะฟะธัะฐะป (ะฝะต ะฑัะฐะป ัะฒะฝะพ):
1. ะกะพะพะฑัะตะฝะธะต ะฟัะธะฝะธะผะฐะตััั ัะพะปัะบะพ ะฒ ัะพะฟะธะบะต ะบะปะธะตะฝัะฐ
2. ะัะปะธ ะตััั ะฐะบัะธะฒะฝะฐั ะทะฐัะฒะบะฐ (pending/active) โ ะพัะฒะตั ััะพะดะธั ะบะปะธะตะฝัั ะธ ะทะฐัะฒะบะฐ ััะฐะฝะพะฒะธััั active
3. ะัะปะธ ะฐะบัะธะฒะฝะพะน ะทะฐัะฒะบะธ ะฝะตั โ ะพัะฒะตั ะฝะต ััะพะดะธั, ะผะตะฝะตะดะถะตั ะฒะธะดะธั ะพัะบะฐะท

**ะะตะฐะปะธะทะฐัะธั:** `manager_message_service.py` โ `process_manager_message()`

---

# ะงะะกะขะฌ 5: ะะะะะะะฆะะฏ ะ ะะะฃะงะะะะ [ะะะะ]

> โ๏ธ **ะญัะพั ัะฐะทะดะตะป ะะ ัะตะฐะปะธะทะพะฒะฐะฝ.**

## ะัะพ ะผะพะดะตัะธััะตั? (ะฟะปะฐะฝ)

**ะะฐะบะฐะทัะธะบ ัะฐะผ**, ั ะฟะพะผะพััั Truffles ะฝะฐ ััะฐััะต.

### ะะตัะฒัะน ะผะตััั:
- Truffles ะฟะพะผะพะณะฐะตั ะฝะฐัััะพะธัั
- ะะพะบะฐะทัะฒะฐะตั ะบะฐะบ ะผะพะดะตัะธัะพะฒะฐัั
- ะัะพะฒะตััะตั ะบะฐัะตััะฒะพ

### ะะพัะปะต:
- ะะฐะบะฐะทัะธะบ ะผะพะดะตัะธััะตั ัะฐะผ
- Owner/Admin ะธะผะตัั ะดะพัััะฟ ะบ ะธะฝัะตััะตะนัั ะผะพะดะตัะฐัะธะธ

---

## ะะฝัะตััะตะนั ะผะพะดะตัะฐัะธะธ (ะฟะปะฐะฝ)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะะะะะะะฆะะฏ ะะขะะะขะะ                              [ะกะตะณะพะดะฝั โผ]  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ ะะพะฟัะพั ะบะปะธะตะฝัะฐ:                                         โ โ
โ โ "ะกะบะพะปัะบะพ ััะพะธั ะฟะพะดะบะปััะธัั 3 ะฝะพะผะตัะฐ ั Kaspi?"            โ โ
โ โ                                                         โ โ
โ โ ะัะฒะตั ะผะตะฝะตะดะถะตัะฐ (ะะนะณัะปั):                               โ โ
โ โ "ะะปั 3 ะฝะพะผะตัะพะฒ ะฟะพะดะพะนะดัั ัะฐัะธั Pro ะทะฐ 150,000 ัะณ.        โ โ
โ โ  Kaspi Pay ะฒะบะปัััะฝ. ะฅะพัะธัะต ะพัะพัะผะธัั?"                   โ โ
โ โ                                                         โ โ
โ โ [โ ะะพะฑะฐะฒะธัั ะฒ ะฑะฐะทั] [โ๏ธ ะะตะดะฐะบัะธัะพะฒะฐัั] [โ ะัะบะปะพะฝะธัั]  โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                             โ
โ ะกัะฐัะธััะธะบะฐ:                                                 โ
โ โข ะะถะธะดะฐัั ะผะพะดะตัะฐัะธะธ: 5                                      โ
โ โข ะะพะฑะฐะฒะปะตะฝะพ ัะตะณะพะดะฝั: 12                                     โ
โ โข ะัะบะปะพะฝะตะฝะพ: 2                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะกัะฐััั:** ะะต ัะตะฐะปะธะทะพะฒะฐะฝะพ.

---

## ะะฒัะพะผะพะดะตัะฐัะธั (ะฟะปะฐะฝ)

ะัะปะธ ะพัะฒะตัะธะป ัะตะปะพะฒะตะบ ั ัะพะปัั `owner`:
```
โ ะัะฒะตั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะดะพะฑะฐะฒะปัะตััั ะฒ KB
โ ะะตะท ัััะฝะพะน ะผะพะดะตัะฐัะธะธ
โ ะะพะณะธััะตััั: "ะะพะฑะฐะฒะปะตะฝะพ ะฐะฒัะพะผะฐัะธัะตัะบะธ (owner)"
```

**ะกัะฐััั:** ะะต ัะตะฐะปะธะทะพะฒะฐะฝะพ.

---

## ะคะพัะผะฐั ะทะฝะฐะฝะธะน ะธะท ััะบะฐะปะฐัะธะธ (ะฟะปะฐะฝ)

```json
{
  "type": "escalation_learning",
  "question": "ะกะบะพะปัะบะพ ััะพะธั ะฝะฐ 3 ะฝะพะผะตัะฐ ั Kaspi?",
  "answer": "ะะปั 3 ะฝะพะผะตัะพะฒ ะฟะพะดะพะนะดัั ัะฐัะธั Pro ะทะฐ 150,000 ัะณ. Kaspi Pay ะฒะบะปัััะฝ.",
  "context": {
    "client_intent": "pricing_custom",
    "conversation_history": ["...", "..."],
    "escalation_reason": "ะะตั ัะพัะฝะพะณะพ ะพัะฒะตัะฐ ะฒ ะฑะฐะทะต"
  },
  "metadata": {
    "answered_by": "ะะนะณัะปั",
    "answered_by_role": "manager",
    "moderated_by": "Owner",
    "moderated_at": "2025-12-06T10:30:00Z",
    "source": "escalation"
  }
}
```

**ะกัะฐััั:** ะะต ัะตะฐะปะธะทะพะฒะฐะฝะพ.

---

## ะะตะดัะฟะปะธะบะฐัะธั (ะฟะปะฐะฝ)

ะะตัะตะด ะดะพะฑะฐะฒะปะตะฝะธะตะผ ะฒ KB:
1. Semantic search ะฟะพ ะฒะพะฟัะพัั
2. ะัะปะธ similarity > 0.9 โ ะฟะพะบะฐะทะฐัั: "ะะพัะพะถะธะน ะฒะพะฟัะพั ัะถะต ะตััั. ะะฑะฝะพะฒะธัั?"
3. ะะฐัะธะฐะฝัั: [ะะพะฑะฐะฒะธัั ะบะฐะบ ะฝะพะฒัะน] [ะะฑะฝะพะฒะธัั ัััะตััะฒัััะธะน] [ะัะพะฟัััะธัั]

**ะกัะฐััั:** ะะต ัะตะฐะปะธะทะพะฒะฐะฝะพ.

---

# ะงะะกะขะฌ 6: ะะะขะะะะ [ะงะะกะขะะงะะ]

## Dashboard ะดะปั ะทะฐะบะฐะทัะธะบะฐ (ะฟะปะฐะฝ)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะญะกะะะะะฆะะ                                    ะะตะบะฐะฑัั 2025   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ  Escalation Rate     โโโโโโโโโโโโโโโโ  32%                 โ
โ  (ัะตะปั: <20%)        โ ะฑัะปะพ 45% ะผะตััั ะฝะฐะทะฐะด                โ
โ                                                             โ
โ  ะกัะตะดะฝะตะต ะฒัะตะผั ะพัะฒะตัะฐ ะผะตะฝะตะดะถะตัะฐ: 4.2 ะผะธะฝ                   โ
โ  (ัะตะปั: <5 ะผะธะฝ)                                            โ
โ                                                             โ
โ  ะะพะฑะฐะฒะปะตะฝะพ ะฒ ะฑะฐะทั ะทะฝะฐะฝะธะน: 47 ะพัะฒะตัะพะฒ                       โ
โ  ะะถะธะดะฐัั ะผะพะดะตัะฐัะธะธ: 3                                       โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ะขะะ ะฟัะธัะธะฝ ััะบะฐะปะฐัะธะธ:                                      โ
โ  1. ะะฐััะพะผะฝัะต ัะฐัะธัั (34%)                                  โ
โ  2. ะขะตัะฝะธัะตัะบะธะต ะฒะพะฟัะพัั (28%)                               โ
โ  3. ะะฐะปะพะฑั (18%)                                            โ
โ  4. ะะพะทะฒัะฐัั (12%)                                          โ
โ  5. ะัะพัะตะต (8%)                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะกัะฐััั:** ะะต ัะตะฐะปะธะทะพะฒะฐะฝะพ.

---

## ะะปะฐะฒะฝัะต ะผะตััะธะบะธ (North Star)

> ะััะพัะฝะธะบ: `STRATEGY/MARKET.md`

| ะะตััะธะบะฐ | ะคะพัะผัะปะฐ | ะฆะตะปั | ะกัะฐััั |
|---------|---------|------|--------|
| **Quality Deflection** | Deflection ร CSAT ร (1 - Repeat Rate) | >40% | ๐ ะะปะฐะฝ |
| **Goal Completion** | ะะฐะฒะตัััะฝะฝัะต ัะตะปะธ / ะัะต ะดะธะฐะปะพะณะธ | >60% | ๐ ะะปะฐะฝ |
| **CSAT** | ะกัะตะดะฝัั ะพัะตะฝะบะฐ 1-5 | >4.0 | ๐ ะะปะฐะฝ |

**ะะพัะตะผั ััะธ ะผะตััะธะบะธ:**
- Deflection Rate ัะฐะผ ะฟะพ ัะตะฑะต ะฒััั โ 80% deflection ะผะพะถะตั ัะบััะฒะฐัั 30% ััััััะธัะพะฒะฐะฝะฝัั
- Quality Deflection ััะธััะฒะฐะตั ัะดะพะฒะปะตัะฒะพััะฝะฝะพััั ะ ะฟะพะฒัะพัะฝัะต ะพะฑัะฐัะตะฝะธั

---

## ะะฟะตัะฐัะธะพะฝะฝัะต ะผะตััะธะบะธ

| ะะตััะธะบะฐ | ะคะพัะผัะปะฐ | ะฆะตะปั | ะกัะฐััั |
|---------|---------|------|--------|
| Escalation Rate | ะญัะบะฐะปะฐัะธะธ / ะัะต ะดะธะฐะปะพะณะธ | <20% ัะตัะตะท 2 ะผะตั | โ ะะต ััะธัะฐะตััั |
| Response Time | ะัะตะผั ะดะพ ะพัะฒะตัะฐ ะผะตะฝะตะดะถะตัะฐ | <5 ะผะธะฝ | โ ะััั ะฒ ะะ |
| Resolution Rate | ะะตััะฝะฝัะต / ะัะต ััะบะฐะปะฐัะธะธ | >95% | โ๏ธ ะะพะถะฝะพ ะฟะพััะธัะฐัั |
| Repeat Contact Rate | ะะพะฒัะพัะฝัะต ะพะฑัะฐัะตะฝะธั / ะัะต | <15% | โ ะะต ััะธัะฐะตััั |
| Learning Rate | ะะพะฑะฐะฒะปะตะฝะพ ะฒ KB / ะญัะบะฐะปะฐัะธะธ | >50% | โ ะะตั ะฐะฒัะพะพะฑััะตะฝะธั |
| False Escalation | ะัะฒะตั ะฑัะป ะฒ KB / ะญัะบะฐะปะฐัะธะธ | <10% | โ ะะต ััะธัะฐะตััั |

**ะะฐะฝะฝัะต ะบะพัะพััะต ัะถะต ัะพะฑะธัะฐัััั:**
- `handover.first_response_at` โ ะฒัะตะผั ะฟะตัะฒะพะณะพ ะพัะฒะตัะฐ
- `handover.resolved_at` โ ะฒัะตะผั ัะตัะตะฝะธั
- `handover.resolution_time_seconds` โ ะดะปะธัะตะปัะฝะพััั
- `handover.resolved_by_name` โ ะบัะพ ัะตัะธะป
- `handover.trigger_type`, `trigger_value` โ ะฟัะธัะธะฝะฐ ััะบะฐะปะฐัะธะธ

---

# ะงะะกะขะฌ 7: ะะะะ ะะะะะซะฅ [ะะะะะะะะะะะ]

## ะขะฐะฑะปะธัั

### handovers (ัััะตััะฒัะตั)
```sql
-- ะะตะฐะปะธะทะฐัะธั: truffles-api/app/models/handover.py

id                      UUID PRIMARY KEY
conversation_id         UUID (FK โ conversations)
client_id               UUID

-- ะขัะธะณะณะตั
trigger_type            TEXT  -- intent, keyword, manual, timeout
trigger_value           TEXT  -- ะบะพะฝะบัะตัะฝัะน intent ะธะปะธ keyword
user_message            TEXT  -- ัะพะพะฑัะตะฝะธะต ะบะปะธะตะฝัะฐ

-- ะกัะฐััั
status                  TEXT  -- pending, active, resolved, bot_handling, timeout

-- ะะฐะทะฝะฐัะตะฝะธะต
assigned_to             TEXT  -- telegram user id
assigned_to_name        TEXT  -- ะธะผั ะผะตะฝะตะดะถะตัะฐ
first_response_at       TIMESTAMP

-- ะะตัะตะฝะธะต
resolved_at             TIMESTAMP
resolved_by_id          TEXT
resolved_by_name        TEXT
resolution_type         TEXT  -- solved, transferred, spam, other
resolution_time_seconds INTEGER

-- Telegram
telegram_message_id     BIGINT
channel_ref             TEXT  -- WhatsApp remote_jid (ะบัะดะฐ ะพัะฟัะฐะฒะปััั ะพัะฒะตั ะผะตะฝะตะดะถะตัะฐ ะบะปะธะตะฝัั)
-- topic_id ะดะปั Telegram ััะฐะฝะธััั ะฒ users.telegram_topic_id (ะบะฐะฝะพะฝ), ะฒ conversations.telegram_topic_id โ ะบะพะฟะธั

-- ะะฐะฟะพะผะธะฝะฐะฝะธั
reminder_1_sent_at      TIMESTAMP
reminder_2_sent_at      TIMESTAMP

-- ะะตัะฐ
created_at              TIMESTAMP
notified_at             TIMESTAMP
skipped_by              JSONB  -- ัะฟะธัะพะบ ะบัะพ ะฟัะพะฟัััะธะป
```

### conversations (ัััะตััะฒัะตั)
```sql
-- ะะตะฐะปะธะทะฐัะธั: truffles-api/app/models/conversation.py

id                  UUID PRIMARY KEY
client_id           UUID
branch_id           UUID  -- ะตััั; ะธัะฟะพะปัะทัะตััั ะฒ webhook ะดะปั ะฒัะฑะพัะฐ ัะธะปะธะฐะปะฐ (ะฝะต ะฒะตะทะดะต wired)
user_id             UUID (FK โ users)
channel             TEXT  -- whatsapp, telegram

-- ะกะพััะพัะฝะธะต
state               TEXT  -- bot_active, pending, manager_active
bot_status          TEXT  -- active, muted
bot_muted_until     TIMESTAMP
no_count            INTEGER  -- ัััััะธะบ ะพัะบะฐะทะพะฒ

-- Telegram
telegram_topic_id   BIGINT  -- ะบะพะฟะธั users.telegram_topic_id ะดะปั ะฐะบัะธะฒะฝะพะณะพ ะดะธะฐะปะพะณะฐ

-- ะะตัะฐ
started_at          TIMESTAMP
last_message_at     TIMESTAMP
escalated_at        TIMESTAMP
```

### users (ัััะตััะฒัะตั)
```sql
-- ะะตะฐะปะธะทะฐัะธั: truffles-api/app/models/user.py

id                  UUID PRIMARY KEY
client_id           UUID
remote_jid          TEXT
telegram_topic_id   BIGINT  -- ะบะฐะฝะพะฝ: ะพะดะธะฝ ัะพะฟะธะบ ะฝะฐ ะบะปะธะตะฝัะฐ
```

### branches (ัััะตััะฒัะตั)
```sql
-- ะะตะฐะปะธะทะฐัะธั: truffles-api/app/models/branch.py

id                  UUID PRIMARY KEY
client_id           UUID
slug                TEXT
name                TEXT
instance_id         TEXT
phone               TEXT
telegram_chat_id    TEXT  -- Telegram-ะณััะฟะฟะฐ ะดะปั ัะธะปะธะฐะปะฐ
knowledge_tag       TEXT
is_active           BOOLEAN
```

### client_settings (ัััะตััะฒัะตั)
```sql
-- ะะตะฐะปะธะทะฐัะธั: truffles-api/app/models/client_settings.py

client_id                   UUID PRIMARY KEY

-- Telegram
telegram_bot_token          TEXT
telegram_chat_id            TEXT  -- LEGACY: ะฟะตัะตะฝะพัะธะผ ะฝะฐ branches.telegram_chat_id
owner_telegram_id           TEXT  -- LEGACY: ะทะฐะผะตะฝัะตััั roles/agent_identities

-- ะขะฐะนะผะฐััั
reminder_timeout_1          INTEGER DEFAULT 30  -- ะผะธะฝััั
reminder_timeout_2          INTEGER DEFAULT 60  -- ะผะธะฝััั
auto_close_timeout          INTEGER DEFAULT 120 -- ะะ ะะกะะะะฌะะฃะะขะกะฏ, ะฝะต ะฟะปะฐะฝะธััะตััั

-- ะััั
mute_duration_first_minutes INTEGER DEFAULT 30
mute_duration_second_hours  INTEGER DEFAULT 24

-- ะคะปะฐะณะธ
enable_reminders            BOOLEAN DEFAULT TRUE
enable_owner_escalation     BOOLEAN DEFAULT TRUE
```

### agents (ัััะตััะฒัะตั, wiring pending)
```sql
-- ะะพะปัะทะพะฒะฐัะตะปะธ ัะพ ััะพัะพะฝั ะฑะธะทะฝะตัะฐ (owner/admin/manager/support)

id          UUID PRIMARY KEY
client_id   UUID
branch_id   UUID  -- NULL = ะณะปะพะฑะฐะปัะฝัะน ะดะพัััะฟ, ะธะฝะฐัะต ัะธะปะธะฐะป
role        TEXT  -- owner, admin, manager, support
name        TEXT
is_active   BOOLEAN DEFAULT TRUE
created_at  TIMESTAMP
```

### agent_identities (ัััะตััะฒัะตั, wiring pending)
```sql
-- ะะดะตะฝัะธัะฝะพััะธ ะฒ ัะฐะทะฝัั ะบะฐะฝะฐะปะฐั

id           UUID PRIMARY KEY
agent_id     UUID REFERENCES agents(id)
channel      TEXT  -- telegram, email, crm
external_id  TEXT  -- telegram user id / email / etc
username     TEXT
metadata     JSONB
created_at   TIMESTAMP
```

### escalation_chain (ะฟะปะฐะฝ, ะะ ัะพะทะดะฐะฝะฐ)
```sql
-- ะะปั ัะตะฐะปะธะทะฐัะธะธ ัะตะฟะพัะบะธ ััะบะฐะปะฐัะธะธ

client_id   UUID
priority    INTEGER
user_id     TEXT
role        TEXT  -- owner, admin, manager, support
contact     TEXT  -- @telegram_username
timeout_min INTEGER DEFAULT 5
is_active   BOOLEAN DEFAULT TRUE
```

### learned_responses (ัััะตััะฒัะตั, ัะฐััะธััะตะผ)
```sql
-- ะะปั ะฐะฒัะพะพะฑััะตะฝะธั

id              UUID PRIMARY KEY
client_id       UUID
branch_id       UUID  -- ัะธะปะธะฐะป, ะตัะปะธ ะฟัะธะผะตะฝะธะผะพ
handover_id     UUID  -- FK โ handovers
question_text   TEXT
response_text   TEXT
source          TEXT  -- manager, owner
source_role     TEXT  -- owner, admin, manager, support
source_channel  TEXT  -- telegram, email, crm
agent_id        UUID  -- FK โ agents
status          TEXT  -- pending, approved, rejected
approved_by     UUID  -- FK โ agents
approved_at     TIMESTAMP
rejected_at     TIMESTAMP
is_active       BOOLEAN DEFAULT TRUE
qdrant_point_id TEXT  -- ID ะฒ Qdrant
question_normalized TEXT
source_name     TEXT
use_count       INTEGER
last_used_at    TIMESTAMP
created_at      TIMESTAMP
updated_at      TIMESTAMP
```

---

# ะงะะกะขะฌ 8: EDGE CASES

## ะงัะพ ะตัะปะธ...

| ะกะธััะฐัะธั | ะงัะพ ะดะตะปะฐะตะผ | ะกัะฐััั |
|----------|------------|--------|
| ะะปะธะตะฝั ะฟะธัะตั ะฟะพะบะฐ ะถะดัะผ ะผะตะฝะตะดะถะตัะฐ | ะะพั ะฟะพะผะพะณะฐะตั (state=pending) | โ |
| ะะปะธะตะฝั ะฟะธัะตั ะบะพะณะดะฐ ะผะตะฝะตะดะถะตั ะฒ ะดะธะฐะปะพะณะต | ะคะพัะฒะฐัะด ะฒ Telegram | โ |
| ะะตะฝะตะดะถะตั ะพัะฒะตัะธะป ะฟะพัะปะต ัะฐะนะผะฐััะฐ | ะัะฒะตั ะฒัั ัะฐะฒะฝะพ ะพัะฟัะฐะฒะปัะตััั | โ |
| ะะฒะฐ ะผะตะฝะตะดะถะตัะฐ ะพัะฒะตัะธะปะธ ะพะดะฝะพะฒัะตะผะตะฝะฝะพ | ะะตัะฒัะน ะฑะตััั, ะฒัะพัะพะน ะฒะธะดะธั "ัะถะต ะฒะทััะพ" | โ |
| ะะปะธะตะฝั ัััะป (ะฝะต ะพัะฒะตัะฐะตั) | ะะดัะผ, ะฝะฐะฟะพะผะธะฝะฐะฝะธั, ะผะตะฝะตะดะถะตั ะทะฐะบััะฒะฐะตั ะฒัััะฝัั | โ |
| ะัะฒะตั ะผะตะฝะตะดะถะตัะฐ โ ััะนะฝั | ะะพะดะตัะฐัะธั ะพัะบะปะพะฝัะตั | โ ะะตั ะผะพะดะตัะฐัะธะธ |
| ะะพั ััะบะฐะปะธัะพะฒะฐะป ะทัั (ะพัะฒะตั ะฑัะป ะฒ KB) | ะะพะผะตัะธัั ะบะฐะบ false_escalation | โ ะะต ัะตะฐะปะธะทะพะฒะฐะฝะพ |
| ะะปะธะตะฝั ะฒะตัะฝัะปัั ัะตัะตะท ะดะตะฝั | ะะพั ะฐะบัะธะฒะตะฝ (state ัะฑัะฐััะฒะฐะตััั ะฟัะธ resolve) | โ |
| ะขะพะฟะธะบ ัะดะฐะปัะฝ ะฒ Telegram | ะกะพะทะดะฐัััั ะฝะพะฒัะน ะฟัะธ ััะบะฐะปะฐัะธะธ | โ๏ธ ะงะฐััะธัะฝะพ (ัะพะปัะบะพ ะฒ escalation_service) |
| **state=manager_active ะฝะพ ัะพะฟะธะบะฐ ะฝะตั** | ะกะฑัะพัะธัั state โ bot_active | โ ะะตะฐะปะธะทะพะฒะฐะฝะพ 2025-12-11 |
| ะะฝะพะณะพ ัะธะปะธะฐะปะพะฒ/ะบะฐะฝะฐะปะพะฒ | ะะพััะธะฝะณ ะฟะพ branch_id + Telegram-ะณััะฟะฟะฐ ะฝะฐ ัะธะปะธะฐะป | ๐ ะะะะ |
| ะะฝะพะณะพ ะทะฐัะฒะพะบ ะฒ ะดะตะฝั | ะัะถะฝั ัะธะปัััั/ะฟัะธะพัะธัะตัั + batched-ัะฒะตะดะพะผะปะตะฝะธั owner | ๐ ะะะะ |

---

## Fallback ัะพะพะฑัะตะฝะธั [ะะะะะะะะะะะ]

```python
# ะะตะฐะปะธะทะฐัะธั: truffles-api/app/routers/webhook.py (ะธ legacy: truffles-api/app/routers/message.py)

MSG_ESCALATED = "ะะตัะตะดะฐะป ะผะตะฝะตะดะถะตัั. ะะพะณั ัะตะผ-ัะพ ะฟะพะผะพัั ะฟะพะบะฐ ะถะดััะต?"
MSG_MUTED_TEMP = "ะฅะพัะพัะพ, ะฝะฐะฟะธัะธัะต ะตัะปะธ ะฟะพะฝะฐะดะพะฑะปััั."
MSG_MUTED_LONG = "ะะพะฝัะป! ะัะปะธ ะพัะฒะตัะฐ ะพั ะผะตะฝะตะดะถะตัะพะฒ ะดะพะปะณะพ ะฝะตั โ ะปัััะต ะทะฒะพะฝะธัะต ะฝะฐะฟััะผัั: +7 775 984 19 26"
```

---

# ะงะะกะขะฌ 9: ะะะะ ะะะะะะะะฆะะ

## ะงัะพ ัะดะตะปะฐะฝะพ โ

- [x] ะขะฐะฑะปะธัะฐ `handovers` ะฒ ะะ
- [x] State machine (bot_active โ pending โ manager_active)
- [x] Telegram ัะฒะตะดะพะผะปะตะฝะธั ั ะบะฝะพะฟะบะฐะผะธ
- [x] ะะฝะพะฟะบะฐ [ะะตัั] โ status='active'
- [x] ะะฝะพะฟะบะฐ [ะะตัะตะฝะพ] โ status='resolved', unmute bot
- [x] ะัะฒะตั ะผะตะฝะตะดะถะตัะฐ โ WhatsApp ะบะปะธะตะฝัั
- [x] ะะฐะฟะพะผะธะฝะฐะฝะธั (30 ะผะธะฝ, 60 ะผะธะฝ + owner tag)
- [x] ะััั ะฑะพัะฐ (30 ะผะธะฝ / 24ั)
- [x] ะะฒัะพัะพะทะดะฐะฝะธะต ัะพะฟะธะบะฐ ะตัะปะธ ัะดะฐะปัะฝ

## ะงัะพ ะพััะฐะปะพัั ๐

### P1 (ัะปะตะดัััะตะต):
- [ ] ะััะพัะธั ะฟะตัะตะฟะธัะบะธ ะฒ ะทะฐัะฒะบะต ะดะปั ะผะตะฝะตะดะถะตัะฐ
- [ ] ะะฒัะพะฟัะธะฒะตัััะฒะธะต ะผะตะฝะตะดะถะตัะฐ ะฟัะธ ะฒะทััะธะธ
- [ ] "ะะตะฝะตะดะถะตั ัะถะต ะทะฐะฝะธะผะฐะตััั" ะฟัะธ ะฟะพะฒัะพัะฝะพะผ ะฒะพะฟัะพัะต ะพ ัะพะน ะถะต ัะตะผะต
- [ ] "ะฝะตั" ะฟัะธ pending/active โ ะทะฐะบัััั ะทะฐัะฒะบั, ะฑะพั ะฐะบัะธะฒะตะฝ
- [ ] Reminder 3 (2 ัะฐัะฐ) โ ัะฒะตะดะพะผะธัั ะบะปะธะตะฝัะฐ

### P2 (ะฟะพัะพะผ):
- [ ] Owner vs ะพััะฐะปัะฝัะต (ะดะปั ะฐะฒัะพะพะฑััะตะฝะธั: owner โ ััะฐะทั ะฒ ะฑะฐะทั, ะพััะฐะปัะฝัะต โ ะผะพะดะตัะฐัะธั)
- [ ] Quiet hours ะดะปั ะฝะฐะฟะพะผะธะฝะฐะฝะธะน (ะฝะพััั ะฝะต ะฑัะดะธัั, ะบะพะฟะธัั ะดะพ ัััะฐ)
- [ ] ะะพะดะตัะฐัะธั ะพัะฒะตัะพะฒ ะผะตะฝะตะดะถะตัะพะฒ
- [ ] ะะฒัะพะพะฑััะตะฝะธะต (ะพัะฒะตั โ ะฒ Qdrant)
- [ ] Dashboard ััะบะฐะปะฐัะธะน

### P3 (ะฑัะดััะตะต):
- [ ] ะะพะปะฝะฐั ัะธััะตะผะฐ ัะพะปะตะน (owner, admin, manager, support)
- [ ] ะฆะตะฟะพัะบะฐ ััะบะฐะปะฐัะธะธ (primary โ others โ leadership) โ ะบะพะณะดะฐ 50+ ะบะปะธะตะฝัะพะฒ
- [ ] ะะตะฑ-ะธะฝัะตััะตะนั ะดะปั ะผะตะฝะตะดะถะตัะพะฒ
- [ ] ะะตััะธะบะธ ะธ ะฐะฝะฐะปะธัะธะบะฐ

---

# ะงะะกะขะฌ 10: ะะะคะะะขะซ ะ ะะะะคะะะฃะะะฆะะฏ [ะงะะกะขะะงะะ]

## ะะะะคะะะฃะะะะฃะะะซะ ะะะะะะะขะะซ

### ะะตะฐะปะธะทะพะฒะฐะฝะพ ะฒ client_settings:

| ะะฐัะฐะผะตัั | ะะตัะพะปั | ะะดะต |
|----------|--------|-----|
| `reminder_timeout_1` | 30 ะผะธะฝ | client_settings |
| `reminder_timeout_2` | 60 ะผะธะฝ | client_settings |
| `mute_duration_first_minutes` | 30 ะผะธะฝ | client_settings |
| `mute_duration_second_hours` | 24 ั | client_settings |
| `enable_reminders` | true | client_settings |
| `enable_owner_escalation` | true | client_settings |
| `owner_telegram_id` | โ | client_settings (LEGACY: ะทะฐะผะตะฝัะตััั agents/agent_identities) |
| `branch_resolution_mode` | `hybrid` | client_settings |
| `remember_branch_preference` | true | client_settings |
| `auto_approve_roles` | `owner,admin` | client_settings |
| `manager_scope` | `branch` | client_settings |
| `require_branch_for_pricing` | true | client_settings |

### ะะปะฐะฝ (ะฝะต ัะตะฐะปะธะทะพะฒะฐะฝะพ):

| ะะฐัะฐะผะตัั | ะะตัะพะปั | ะะฟะธัะฐะฝะธะต |
|----------|--------|----------|
| `primary_timeout` | 5 ะผะธะฝ | ะขะฐะนะผะฐัั ะฟะตัะฒะพะณะพ ะผะตะฝะตะดะถะตัะฐ |
| `others_timeout` | 5 ะผะธะฝ | ะขะฐะนะผะฐัั ะพััะฐะปัะฝัั |
| `leadership_timeout` | 10 ะผะธะฝ | ะขะฐะนะผะฐัั ััะบะพะฒะพะดััะฒะฐ |
| `quiet_hours_enabled` | true | ะะพัะฝะพะน ัะตะถะธะผ |
| `quiet_hours_start` | 23:00 | ะะฐัะฐะปะพ ัะธัะธั ัะฐัะพะฒ |
| `quiet_hours_end` | 08:00 | ะะพะฝะตั ัะธัะธั ัะฐัะพะฒ |
| `owner_auto_approve` | true | ะะฒัะพะผะพะดะตัะฐัะธั ะดะปั owner |
| `max_escalations_per_hour` | 50 | ะะธะผะธั ะทะฐัะธัั ะพั ัะฟะฐะผะฐ |

---

**ะะฐะบ ะผะตะฝััั:** ัะตัะตะท `/admin/settings/{client_slug}` (ะฝัะถะฝะพ ัะฐััะธัะธัั API ะฟะพะด ะฝะพะฒัะต ะฟะพะปั).

## ะะะะะฆะะ ะะะะะะะะะ

```
ะะฐะบะฐะทัะธะบ ัะบะฐะทะฐะป "30 ะผะธะฝัั ะผะฐะปะพ, ะบะปะธะตะฝัั ััะพะดัั"
     โ
UPDATE client_settings SET reminder_timeout_1 = 15 WHERE client_id = '...'
     โ
ะัะธะผะตะฝัะตััั ะฝะฐ ัะปะตะดััััั ััะบะฐะปะฐัะธั
```

**ะกะตะนัะฐั:** ะะทะผะตะฝะตะฝะธั ัะตัะตะท SQL.
**ะะปะฐะฝ:** ะะฝัะตััะตะนั ะฝะฐัััะพะตะบ ะดะปั ะทะฐะบะฐะทัะธะบะฐ.

---

## ะะะคะะะขะซ ะะ ะะะจะะ (ะฟะปะฐะฝ)

| ะะธัะฐ | Reminder 1 | Reminder 2 | ะัะพะฑะตะฝะฝะพััะธ |
|------|------------|------------|-------------|
| **ะกะฐะปะพะฝ ะบัะฐัะพัั** | 30 ะผะธะฝ | 60 ะผะธะฝ | ะกัะฐะฝะดะฐัั |
| **ะะพััะฐะฒะบะฐ ะตะดั** | 5 ะผะธะฝ | 15 ะผะธะฝ | ะัะธัะธัะฝะพ ะฑััััะพ |
| **ะะตะดะธัะธะฝะฐ** | 10 ะผะธะฝ | 30 ะผะธะฝ | ะัะธัะธัะฝะพ ะฒัะตะณะดะฐ |
| **ะะฐะณะฐะทะธะฝ ะพะดะตะถะดั** | 60 ะผะธะฝ | 120 ะผะธะฝ | ะะตะฝะตะต ััะพัะฝะพ |

**ะัะธ ะพะฝะฑะพัะดะธะฝะณะต:** "ะั ัะฐะปะพะฝ ะบัะฐัะพัั? ะะพั ัะตะบะพะผะตะฝะดัะตะผัะต ะฝะฐัััะพะนะบะธ."

---

*ะกะพะทะดะฐะฝะพ: 2025-12-06*
*ะะฑะฝะพะฒะปะตะฝะพ: 2025-12-24 โ ัะพะปะธ/ะธะดะตะฝัะธัะฝะพััะธ + ะพัะตัะตะดั ะพะฑััะตะฝะธั + branch routing*
*ะญัะพ ะถะธะฒะพะน ะดะพะบัะผะตะฝั โ ะดะพะฟะพะปะฝััั ะฟะพ ะผะตัะต ัะตะฐะปะธะทะฐัะธะธ*
