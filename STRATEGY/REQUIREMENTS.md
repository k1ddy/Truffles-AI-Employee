# ТРЕБОВАНИЯ ЖАНБОЛА

**Это не обсуждается. Это закон.**

---

## СТРАХИ (что НЕ должно случиться)

1. **Обосраться из-за спешки** — делать быстро но плохо
2. **Переделывать потом** — "сейчас так, потом нормально" = нет
3. **Идиотские ответы бота** — бот говорит хуйню клиенту
4. **Сломанная эскалация** — зависает, не уведомляет, теряет заявки
5. **Не спать спокойно** — ночью что-то ломается, заказчик страдает
6. **Продукт изначально говно** — если плохо с начала, потом всё равно чинить
7. **Подгон под тесты/хардкод** — логика «под кейсы», факты/списки в коде вместо Client Pack

---

## ЦЕННОСТИ (как делать)

1. **Качество > скорость** — лучше медленно и правильно
2. **Делать правильно сразу** — архитектура которая не переделывается
3. **Думать перед тем как делать** — не бросаться в код
4. **Система сама восстанавливается** — упало → поднялось
5. **Знать когда сломалось** — мониторинг, алерты, детекция ошибок
6. **Единая логика, данные отдельно** — правила в SPECS, факты/списки в Client Pack/Domain Pack, без client‑specific if

---

## ТРЕБОВАНИЯ К СИСТЕМЕ

1. **Омниканальность** — WhatsApp сейчас, Instagram/Telegram потом
2. **Масштабируемость до 10000 заказчиков** — архитектура должна выдержать
3. **Быстрое исправление багов** — найти проблему за минуты, не часы
4. **Автовосстановление** — healthchecks, restart, retry
5. **Детекция ошибок** — логи, трейсинг, метрики
6. **Мониторинг** — дашборд, алерты в Telegram

---

## DEFINITION OF DONE — ENTERPRISE (1 страница)

### Безопасность и контроль (LAW)
- [ ] **Hard‑LAW:** оплата (подтверждение/проверка/возвраты), медицинка, жалобы, переносы → только эскалация, без “советов”.
- [ ] **Policy‑gates:** скидки и способы оплаты разрешены только при явных правилах в client_pack; иначе — эскалация.
- [ ] OOD никогда не отвечает “полезно”, только мягко возвращает в домен.
- [ ] LLM не принимает решений и не создаёт факты — только формулирует.

### Точность фактов
- [ ] Факты только из Client Pack (адрес, цены, услуги, правила).
- [ ] RAG‑confidence < порога → уточнение/эскалация, не фантазия.
- [ ] Misses пишутся в backlog и проходят валидацию перед публикацией.

### Надёжность и SLA
- [ ] Outbox без зависаний, idempotency, retries.
- [ ] SLA ответов стабильный (p50/p90), без внезапных деградаций.
- [ ] Автовосстановление и alerting работают.

### Мультитенант и данные
- [ ] Жёсткая изоляция tenants (DB/Qdrant/кэш).
- [ ] Логи без утечек чужих данных.
- [ ] Чёткий контракт конфигов и валидатор Client Pack.
- [ ] Data sharing только по opt-in: по умолчанию данные остаются внутри салона; агрегаты без PII — только с согласием.

### UX уровня бизнеса
- [ ] Нет бесконечных “не понял”: clarify‑loop 1–2 шага.
- [ ] Длинные сообщения/аудио → split + подтверждение.
- [ ] Переход в booking/lead плавный и понятный пользователю.
- [ ] Длинные диалоги (10-15 сообщений) держат цель и контекст: booking не теряется, OOD/Law не ломают сценарий (EVAL pack).
- [ ] **Классовая устойчивость:** один и тот же смысл (перестановки слов/перефраз) ведёт к одному классу ответа без смены ветки.
- [ ] **Info‑bundle инвариант:** “где/когда/парковка/гости/ранний приход” всегда даёт единый факт‑ответ (адрес+часы+нужные секции).
- [ ] **Info‑bundle carryover:** класс `info_bundle` сохраняется; follow‑up “по времени/по часам” остаётся в `hours`, без `duration`, если услуга не названа.

### Наблюдаемость и доказуемость
- [ ] decision_trace/decision_meta на каждый user‑message.
- [ ] Метрики + регресс‑кейсы + smoke‑check перед релизом.
- [ ] Никакого container drift — деплой только из образа/коммита.

---

## КАК РАБОТАТЬ

1. **Не торопиться** — думать, потом делать
2. **Не говорить про 5 клиентов/MVP/Starter** — это триггер
3. **Давать рекомендации** — не ждать что скажут, предлагать
4. **Фиксировать всё** — планы, решения, страхи — в документы
5. **Не лизать очко** — честно говорить если что-то плохо

---

## ФУНКЦИОНАЛ (приоритеты)

### Сейчас (P0)
- [x] Бот отвечает на сообщения
- [x] Эскалация в Telegram
- [x] Кнопки take/resolve
- [x] Менеджер → WhatsApp
- [x] Напоминания
- [ ] Надёжность (healthchecks, алерты)

### Следующее (P1)
- [ ] История переписки в заявке для менеджера
- [ ] Автоприветствие менеджера
- [ ] "Менеджер уже занимается" при повторном вопросе

### Потом (P2)
- [ ] Dashboard для заказчиков
- [ ] Аналитика (время ответа, кто решил)
- [ ] Обучение вручную

### Будущее (P3)
- [ ] Instagram Direct
- [ ] Автообучение
- [ ] CRM интеграции

### Мозги бота (P2-P3)
- [ ] **Долгосрочная память** — User.metadata.summary после каждого разговора
- [ ] **Контекст при возврате** — бот помнит клиента через 90 дней
- [ ] **Продажи** — не только консультация, но закрытие записи/сделки
- [ ] **Upsell** — предложение дополнительных услуг

---

## АНАЛИТИКА (данные собираются)

Уже в БД:
- `handovers.resolved_by_name` — кто решил
- `handovers.resolved_at` — когда решил
- `handovers.first_response_at` — время первого ответа
- `handovers.assigned_to_name` — кто взял

---

*Создано: 2025-12-10*
*Это документ-закон. Читать каждую сессию.*
