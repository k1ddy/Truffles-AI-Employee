# TRUFFLES CHATBOT â€” ĞŸĞĞ›ĞĞ«Ğ™ ĞŸĞ›ĞĞ Ğ Ğ•Ğ¤ĞĞšĞ¢ĞĞ Ğ˜ĞĞ“Ğ

**Ğ’ĞµÑ€ÑĞ¸Ñ:** 2.1  
**Ğ”Ğ°Ñ‚Ğ°:** 2025-11-30  
**ĞĞ²Ñ‚Ğ¾Ñ€:** ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ ÑĞµÑÑĞ¸Ñ Ñ Droid  
**ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾:** Handover Adapters, Billing, Documents tracking  

---

## 1. ĞŸĞ Ğ˜ĞĞ¦Ğ˜ĞŸĞ«

1. **ĞĞ´Ğ¸Ğ½ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ = Ğ¾Ğ´Ğ¸Ğ½ config** â€” Ğ²ÑÑ‘ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ¼ĞµÑÑ‚Ğµ
2. **ĞĞ´Ğ¸Ğ½ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹** â€” Ğ½Ğ¸ĞºĞ°ĞºĞ¸Ñ… Ğ´ÑƒĞ±Ğ»ĞµĞ¹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
3. **Graceful degradation** â€” ĞµÑĞ»Ğ¸ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚, Ğ±Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ
4. **Audit trail** â€” Ğ²ÑÑ‘ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ, Ğ²ÑÑ‘ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ
5. **GDPR/Compliance ready** â€” Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ·Ğ° 1 ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ

---

## 2. LIFECYCLE ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ONBOARDING â”‚ â†’  â”‚   ACTIVE    â”‚ â†’  â”‚   SUSPEND   â”‚ â†’  â”‚   DELETE    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                  â”‚                  â”‚                  â”‚
      â–¼                  â–¼                  â–¼                  â–¼
  - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ config   - Ğ‘Ğ¾Ñ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚    - Webhook off     - Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
  - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ tables   - Ğ›Ğ¾Ğ³Ğ¸ Ğ¿Ğ¸ÑˆÑƒÑ‚ÑÑ    - Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑÑ - Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ config
  - Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ docs   - Backup daily    - Billing stop    - ĞÑ€Ñ…Ğ¸Ğ² Ğ»Ğ¾Ğ³Ğ¾Ğ²
  - ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ webhook                                    - Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ
```

### 2.1. Onboarding (Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚)

**Ğ’Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:**
- ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
- Credentials (ChatFlow token, instance_id)
- Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ´Ğ»Ñ RAG (Google Drive folder Ğ¸Ğ»Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ñ‹)
- ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° Ğ´Ğ»Ñ handover

**Ğ§Ñ‚Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ:**
1. Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² `clients` (status: onboarding)
2. Schema Ğ² PostgreSQL: `client_{name}` Ğ¸Ğ»Ğ¸ prefix Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ñ…
3. Collection Ğ² Qdrant: `{name}_knowledge`
4. ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ¸Ğ· ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ° Ğ² `prompts`
5. Webhook Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ² ChatFlow

**Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:**
- Client ID
- Webhook URL
- Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: active

### 2.2. Active (Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‰Ğ¸Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚)

**ĞŸÑ€Ğ¾Ñ†ĞµÑÑÑ‹:**
- Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ
- Ğ˜ÑÑ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑÑ‚ÑÑ
- Ğ›Ğ¾Ğ³Ğ¸ Ğ¿Ğ¸ÑˆÑƒÑ‚ÑÑ
- RAG Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ¿Ğ¾ cron
- Daily backup

**ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³:**
- ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹/Ğ´ĞµĞ½ÑŒ
- Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
- ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ handover
- ĞÑˆĞ¸Ğ±ĞºĞ¸

### 2.3. Suspend (Ğ¿Ñ€Ğ¸Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°)

**Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹:**
- ĞĞµĞ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°
- Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
- ĞĞ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»

**Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚:**
- Webhook Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ (Ğ±Ğ¾Ñ‚ Ğ½Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚)
- Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ĞĞ• ÑƒĞ´Ğ°Ğ»ÑÑÑ‚ÑÑ
- ĞœĞ¾Ğ¶Ğ½Ğ¾ Ñ€ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ

### 2.4. Delete (ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ)

**Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹:**
- Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° (GDPR)
- 90 Ğ´Ğ½ĞµĞ¹ Ğ¿Ğ¾ÑĞ»Ğµ suspend Ğ±ĞµĞ· Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹
- Compliance Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

**Ğ§Ñ‚Ğ¾ ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ÑÑ:**
1. Ğ’ÑĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
2. Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
3. Collection Ğ² Qdrant
4. Config
5. Credentials

**Ğ§Ñ‚Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ (Ğ°Ñ€Ñ…Ğ¸Ğ²):**
- ĞĞ³Ñ€ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° (Ğ±ĞµĞ· PII)
- Ğ›Ğ¾Ğ³Ğ¸ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº (anonymized)
- Billing Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ

---

## 3. ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ Ğ”ĞĞĞĞ«Ğ¥

### 3.1. PostgreSQL Schema

```
DATABASE: truffles_platform

TABLES:
â”œâ”€â”€ clients                 # Ğ’ÑĞµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹
â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”œâ”€â”€ name
â”‚   â”œâ”€â”€ status (onboarding|active|suspended|deleted)
â”‚   â”œâ”€â”€ config (JSONB)      # Credentials, settings
â”‚   â”œâ”€â”€ created_at
â”‚   â”œâ”€â”€ updated_at
â”‚   â””â”€â”€ deleted_at          # Soft delete
â”‚
â”œâ”€â”€ users                   # ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ (Ñ‡Ğ°Ñ‚Ğ°)
â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”œâ”€â”€ client_id (FK)
â”‚   â”œâ”€â”€ phone
â”‚   â”œâ”€â”€ remote_jid
â”‚   â”œâ”€â”€ name
â”‚   â”œâ”€â”€ metadata (JSONB)
â”‚   â”œâ”€â”€ created_at
â”‚   â””â”€â”€ last_active_at
â”‚
â”œâ”€â”€ conversations           # Ğ¡ĞµÑÑĞ¸Ğ¸ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²
â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”œâ”€â”€ client_id (FK)
â”‚   â”œâ”€â”€ user_id (FK)
â”‚   â”œâ”€â”€ channel (whatsapp|telegram|instagram)
â”‚   â”œâ”€â”€ status (active|closed|handover)
â”‚   â”œâ”€â”€ started_at
â”‚   â”œâ”€â”€ last_message_at
â”‚   â””â”€â”€ closed_at
â”‚
â”œâ”€â”€ messages                # Ğ’ÑĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”œâ”€â”€ conversation_id (FK)
â”‚   â”œâ”€â”€ role (user|assistant|system)
â”‚   â”œâ”€â”€ content
â”‚   â”œâ”€â”€ intent
â”‚   â”œâ”€â”€ confidence
â”‚   â”œâ”€â”€ metadata (JSONB)    # attachments, etc.
â”‚   â”œâ”€â”€ created_at
â”‚   â””â”€â”€ processed_at
â”‚
â”œâ”€â”€ prompts                 # ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ Ğ¿Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°Ğ¼
â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”œâ”€â”€ client_id (FK)      # NULL = global template
â”‚   â”œâ”€â”€ name
â”‚   â”œâ”€â”€ text
â”‚   â”œâ”€â”€ model
â”‚   â”œâ”€â”€ temperature
â”‚   â”œâ”€â”€ version
â”‚   â””â”€â”€ is_active
â”‚
â”œâ”€â”€ handovers               # ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñƒ
â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”œâ”€â”€ conversation_id (FK)
â”‚   â”œâ”€â”€ client_id (FK)
â”‚   â”œâ”€â”€ trigger_type (intent|keyword|manual|timeout)
â”‚   â”œâ”€â”€ trigger_value
â”‚   â”œâ”€â”€ context_summary (TEXT)
â”‚   â”œâ”€â”€ adapter_type (telegram|webhook|bitrix|email|whatsapp_web)
â”‚   â”œâ”€â”€ adapter_response (JSONB)
â”‚   â”œâ”€â”€ status (pending|notified|active|resolved|timeout)
â”‚   â”œâ”€â”€ manager_id
â”‚   â”œâ”€â”€ created_at
â”‚   â”œâ”€â”€ notified_at
â”‚   â”œâ”€â”€ first_response_at
â”‚   â”œâ”€â”€ resolved_at
â”‚   â”œâ”€â”€ resolution_type (solved|transferred|spam|other)
â”‚   â””â”€â”€ resolution_notes
â”‚
â”œâ”€â”€ subscriptions           # ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²
â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”œâ”€â”€ client_id (FK)
â”‚   â”œâ”€â”€ plan (trial|starter|pro|enterprise)
â”‚   â”œâ”€â”€ price_monthly
â”‚   â”œâ”€â”€ status (trial|active|past_due|cancelled)
â”‚   â”œâ”€â”€ trial_ends_at
â”‚   â”œâ”€â”€ current_period_start
â”‚   â”œâ”€â”€ current_period_end
â”‚   â”œâ”€â”€ reminder_sent_at
â”‚   â”œâ”€â”€ auto_renew (boolean)
â”‚   â”œâ”€â”€ created_at
â”‚   â””â”€â”€ cancelled_at
â”‚
â”œâ”€â”€ billing_reminders       # Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğ¹
â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”œâ”€â”€ client_id (FK)
â”‚   â”œâ”€â”€ type (trial_ending|payment_due|past_due|final_warning)
â”‚   â”œâ”€â”€ sent_at
â”‚   â”œâ”€â”€ sent_via (email|telegram|whatsapp)
â”‚   â””â”€â”€ response (paid|ignored|cancelled)
â”‚
â”œâ”€â”€ documents               # Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ´Ğ»Ñ RAG
â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”œâ”€â”€ client_id (FK)
â”‚   â”œâ”€â”€ source (google_drive|upload|api)
â”‚   â”œâ”€â”€ source_id
â”‚   â”œâ”€â”€ filename
â”‚   â”œâ”€â”€ content_hash (MD5)
â”‚   â”œâ”€â”€ qdrant_point_ids (ARRAY)
â”‚   â”œâ”€â”€ status (active|deleted)
â”‚   â”œâ”€â”€ created_at
â”‚   â”œâ”€â”€ updated_at
â”‚   â””â”€â”€ deleted_at
â”‚
â”œâ”€â”€ error_logs              # ĞÑˆĞ¸Ğ±ĞºĞ¸
â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”œâ”€â”€ client_id (FK)
â”‚   â”œâ”€â”€ workflow_id
â”‚   â”œâ”€â”€ node_name
â”‚   â”œâ”€â”€ error_type
â”‚   â”œâ”€â”€ error_message
â”‚   â”œâ”€â”€ stack_trace
â”‚   â”œâ”€â”€ input_data (JSONB)  # Ğ”Ğ»Ñ Ğ²Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ
â”‚   â”œâ”€â”€ created_at
â”‚   â””â”€â”€ resolved_at
â”‚
â”œâ”€â”€ audit_log               # Ğ’ÑĞµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
â”‚   â”œâ”€â”€ id (UUID)
â”‚   â”œâ”€â”€ client_id (FK)
â”‚   â”œâ”€â”€ action (message_in|message_out|handover|error|config_change)
â”‚   â”œâ”€â”€ actor (system|user|admin)
â”‚   â”œâ”€â”€ details (JSONB)
â”‚   â””â”€â”€ created_at
â”‚
â””â”€â”€ backups                 # ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±ÑĞºĞ°Ğ¿Ğ¾Ğ²
    â”œâ”€â”€ id (UUID)
    â”œâ”€â”€ client_id (FK)
    â”œâ”€â”€ type (daily|weekly|manual)
    â”œâ”€â”€ storage_path
    â”œâ”€â”€ size_bytes
    â”œâ”€â”€ created_at
    â””â”€â”€ expires_at
```

### 3.2. Redis Structure

```
KEYS:
â”œâ”€â”€ config:{client_id}              # ĞšÑÑˆ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ° (TTL: 1h)
â”œâ”€â”€ conversation:{conversation_id}  # ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 10 ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ (TTL: 24h)
â”œâ”€â”€ dedup:{message_id}              # Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ (TTL: 24h)
â”œâ”€â”€ rate_limit:{user_id}            # Rate limiting (TTL: 1min)
â””â”€â”€ circuit:{client_id}:{service}   # Circuit breaker state
```

### 3.3. Qdrant Collections

```
COLLECTIONS:
â”œâ”€â”€ {client_name}_knowledge     # Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
â”‚   â”œâ”€â”€ vectors: OpenAI embeddings
â”‚   â””â”€â”€ payload:
â”‚       â”œâ”€â”€ type (faq|case|policy|pricing|custom)
â”‚       â”œâ”€â”€ content
â”‚       â”œâ”€â”€ source (google_drive|manual|api)
â”‚       â”œâ”€â”€ source_id
â”‚       â””â”€â”€ updated_at
â”‚
â””â”€â”€ global_templates            # Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²
```

---

## 4. ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ WORKFLOWS

### 4.1. ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Flow

```
                    INTERNET
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     1_WEBHOOK_GATEWAY                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Validate   â”‚â†’ â”‚  Dedupe     â”‚â†’ â”‚  Route by   â”‚              â”‚
â”‚  â”‚  Signature  â”‚  â”‚  (Redis)    â”‚  â”‚  Client     â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                                  â”‚                     â”‚
â”‚         â–¼ (invalid)                        â–¼                     â”‚
â”‚    [Log & Drop]                    [Call 2_Parse]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     2_PARSE_NORMALIZE                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Load       â”‚â†’ â”‚  Normalize  â”‚â†’ â”‚  Upsert     â”‚              â”‚
â”‚  â”‚  Config     â”‚  â”‚  Event      â”‚  â”‚  User       â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                           â”‚                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                    â–¼                                         â–¼  â”‚
â”‚           [Get/Create Conversation]              [Save Inbound] â”‚
â”‚                    â”‚                                            â”‚
â”‚                    â–¼                                            â”‚
â”‚           [Route by Channel]                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3_WHATSAPP   â”‚ â”‚ 3_TELEGRAM   â”‚ â”‚ 3_INSTAGRAM  â”‚
â”‚   ADAPTER    â”‚ â”‚   ADAPTER    â”‚ â”‚   ADAPTER    â”‚
â”‚              â”‚ â”‚              â”‚ â”‚              â”‚
â”‚ - Media STT  â”‚ â”‚ - Media STT  â”‚ â”‚ - Media STT  â”‚
â”‚ - Format     â”‚ â”‚ - Format     â”‚ â”‚ - Format     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     5_CLASSIFY_INTENT                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Get        â”‚â†’ â”‚  Get        â”‚â†’ â”‚  LLM        â”‚              â”‚
â”‚  â”‚  Context    â”‚  â”‚  Prompt     â”‚  â”‚  Classify   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                           â”‚                      â”‚
â”‚                                           â–¼                      â”‚
â”‚                                   {intent, confidence,           â”‚
â”‚                                    language, entities}           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     6_GENERATE_RESPONSE                          â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    INTENT ROUTER                         â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚  greeting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [Get Greeting Prompt]  â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚  question_* â”€â”€â”€â”€â†’ [RAG Lookup] â”€â”€â†’ [LLM Generate]        â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚  complaint/ready_to_buy â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [Call 7_Handover]     â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚  unclear â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [Clarification Prompt] â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚  off_topic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [Polite Decline]       â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â”‚                                     â”‚
â”‚                            â–¼                                     â”‚
â”‚                    [Format Response]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     8_SEND_RESPONSE                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Save       â”‚â†’ â”‚  Get        â”‚â†’ â”‚  Send via   â”‚              â”‚
â”‚  â”‚  Outbound   â”‚  â”‚  Credentialsâ”‚  â”‚  Channel    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                           â”‚                      â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚                           â–¼               â–¼               â–¼     â”‚
â”‚                     [WhatsApp]      [Telegram]      [Instagram] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2. Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Workflows

```
SUPPORT WORKFLOWS:
â”œâ”€â”€ 7_Handover
â”‚   â”œâ”€â”€ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² handovers
â”‚   â”œâ”€â”€ Ğ¡Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°
â”‚   â”œâ”€â”€ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ (Telegram/Email/SMS)
â”‚   â””â”€â”€ Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
â”‚
â”œâ”€â”€ 9_Error_Handler (Global)
â”‚   â”œâ”€â”€ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ
â”‚   â”œâ”€â”€ ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ (critical|warning|info)
â”‚   â”œâ”€â”€ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² error_logs
â”‚   â”œâ”€â”€ Ğ•ÑĞ»Ğ¸ critical â†’ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°
â”‚   â””â”€â”€ Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ fallback Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
â”‚
â”œâ”€â”€ 10_RAG_Update (Cron: 1h)
â”‚   â”œâ”€â”€ Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ active ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°:
â”‚   â”‚   â”œâ”€â”€ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ/Ğ¸Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ· Google Drive
â”‚   â”‚   â”œâ”€â”€ Chunking (500 tokens, 50 overlap)
â”‚   â”‚   â”œâ”€â”€ Embedding (OpenAI)
â”‚   â”‚   â””â”€â”€ Upsert Ğ² Qdrant
â”‚   â””â”€â”€ Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
â”‚
â”œâ”€â”€ 11_Daily_Backup (Cron: 03:00 UTC)
â”‚   â”œâ”€â”€ Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ active ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°:
â”‚   â”‚   â”œâ”€â”€ Export messages Ğ·Ğ° Ğ²Ñ‡ĞµÑ€Ğ°
â”‚   â”‚   â”œâ”€â”€ Export conversations
â”‚   â”‚   â”œâ”€â”€ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² S3/local storage
â”‚   â”‚   â””â”€â”€ Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ² backups Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ
â”‚   â””â”€â”€ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ backups ÑÑ‚Ğ°Ñ€ÑˆĞµ 30 Ğ´Ğ½ĞµĞ¹
â”‚
â”œâ”€â”€ 12_Client_Onboard (Manual trigger)
â”‚   â”œâ”€â”€ Input: client config JSON
â”‚   â”œâ”€â”€ Validate config
â”‚   â”œâ”€â”€ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ² clients, prompts
â”‚   â”œâ”€â”€ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Qdrant collection
â”‚   â”œâ”€â”€ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹
â”‚   â”œâ”€â”€ Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ webhook
â”‚   â””â”€â”€ Output: client_id, webhook_url
â”‚
â”œâ”€â”€ 13_Client_Suspend (Manual trigger)
â”‚   â”œâ”€â”€ Input: client_id, reason
â”‚   â”œâ”€â”€ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ status â†’ suspended
â”‚   â”œâ”€â”€ ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ webhook
â”‚   â””â”€â”€ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
â”‚
â”œâ”€â”€ 14_Client_Delete (Manual trigger)
â”‚   â”œâ”€â”€ Input: client_id, confirmation_code
â”‚   â”œâ”€â”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ confirmation
â”‚   â”œâ”€â”€ ĞÑ€Ñ…Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
â”‚   â”œâ”€â”€ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ: messages, users, conversations
â”‚   â”œâ”€â”€ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Qdrant collection
â”‚   â”œâ”€â”€ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ config
â”‚   â”œâ”€â”€ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ status â†’ deleted
â”‚   â””â”€â”€ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ¾Ğ± ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸
â”‚
â””â”€â”€ 15_Health_Check (Cron: 5min)
    â”œâ”€â”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ PostgreSQL
    â”œâ”€â”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Redis
    â”œâ”€â”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Qdrant
    â”œâ”€â”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ OpenAI API
    â”œâ”€â”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ChatFlow API
    â”œâ”€â”€ Ğ•ÑĞ»Ğ¸ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ down â†’ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°
    â””â”€â”€ Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
```

---

## 5. ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ ĞĞ¨Ğ˜Ğ‘ĞĞš

### 5.1. Ğ£Ñ€Ğ¾Ğ²Ğ½Ğ¸ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº

| Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ | ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ | Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ |
|---------|--------|----------|
| **CRITICAL** | DB down, OpenAI 500 | Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾, fallback Ğ¾Ñ‚Ğ²ĞµÑ‚ |
| **WARNING** | RAG Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹, timeout | Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ, Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ñ fallback |
| **INFO** | ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ intent | Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ, clarification |

### 5.2. Fallback ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ

```
1. ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ LLM (gpt-4.1-mini) â†’ FAIL
   â†“
2. Fallback LLM (gpt-3.5-turbo) â†’ FAIL
   â†“
3. Static response Ğ¸Ğ· prompts.fallback_critical â†’ FAIL
   â†“
4. Hardcoded: "Ğ˜Ğ·Ğ²Ğ¸Ğ½Ğ¸Ñ‚Ğµ, Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹. ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ ÑĞ²ÑĞ¶ĞµÑ‚ÑÑ Ñ Ğ²Ğ°Ğ¼Ğ¸."
   + ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Handover
```

### 5.3. Circuit Breaker

Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ²Ğ½ĞµÑˆĞ½ĞµĞ³Ğ¾ ÑĞµÑ€Ğ²Ğ¸ÑĞ°:
- **Closed:** Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾
- **Open:** 3+ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ·Ğ° 1 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ â†’ Ğ½Ğµ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼, ÑÑ€Ğ°Ğ·Ñƒ fallback
- **Half-open:** Ğ§ĞµÑ€ĞµĞ· 30 ÑĞµĞº Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ 1 Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ

```
Redis key: circuit:{client_id}:{service}
Value: {state, failures, last_failure, last_success}
```

---

## 6. Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¡Ğ¢Ğ¬

### 6.1. Credentials

**Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ:**
- PostgreSQL `clients.config` (encrypted at rest)
- ĞĞ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ² ĞºĞ¾Ğ´Ğµ workflows
- ĞĞ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…

**Ğ”Ğ¾ÑÑ‚ÑƒĞ¿:**
- Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ workflow 2_Parse Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ config
- ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‘Ñ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ°Ğ»ÑŒÑˆĞµ

### 6.2. Webhook Security

- ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¸Ğ¼ĞµĞµÑ‚ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ webhook URL: `/webhook/{client_secret}`
- Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ signature Ğ¾Ñ‚ ChatFlow
- Rate limiting: 100 req/min per client
- IP whitelist (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)

### 6.3. Data Encryption

- PostgreSQL: encryption at rest
- Backups: encrypted
- Transit: HTTPS only

### 6.4. PII Handling

- Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½Ñ‹ Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑÑ hashed Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ° + encrypted Ğ´Ğ»Ñ display
- ĞŸÑ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° â€” Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°
- Ğ›Ğ¾Ğ³Ğ¸ anonymized Ñ‡ĞµÑ€ĞµĞ· 7 Ğ´Ğ½ĞµĞ¹

---

## 7. ĞœĞĞĞ˜Ğ¢ĞĞ Ğ˜ĞĞ“ Ğ˜ ĞĞ›Ğ•Ğ Ğ¢Ğ«

### 7.1. ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸

| ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ° | ĞšĞ°Ğº ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ | Alert threshold |
|---------|-------------|-----------------|
| Messages/hour | COUNT Ğ·Ğ° Ñ‡Ğ°Ñ | < 1 (ĞµÑĞ»Ğ¸ Ğ±Ñ‹Ğ»Ğ¾ > 10 Ğ²Ñ‡ĞµÑ€Ğ°) |
| Response time | AVG Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ | > 10 ÑĞµĞº |
| Error rate | Errors / Total | > 5% |
| Handover rate | Handovers / Conversations | > 30% |
| RAG hit rate | RAG found / RAG queries | < 50% |

### 7.2. ĞĞ»ĞµÑ€Ñ‚Ñ‹

**ĞĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğµ (Telegram/SMS):**
- Ğ¡ĞµÑ€Ğ²Ğ¸Ñ down > 1 Ğ¼Ğ¸Ğ½
- Error rate > 10%
- Disk space < 10%

**Ğ•Ğ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğµ (Email):**
- Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°Ğ¼
- ĞĞ¾Ğ²Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
- Backup ÑÑ‚Ğ°Ñ‚ÑƒÑ

---

## 8. BACKUP Ğ˜ RECOVERY

### 8.1. Backup ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ

| Ğ§Ñ‚Ğ¾ | ĞšĞ°Ğº Ñ‡Ğ°ÑÑ‚Ğ¾ | Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ | Ğ“Ğ´Ğµ |
|-----|-----------|---------|-----|
| PostgreSQL full | Weekly | 4 Ğ½ĞµĞ´ĞµĞ»Ğ¸ | S3 |
| PostgreSQL incremental | Daily | 7 Ğ´Ğ½ĞµĞ¹ | S3 |
| Messages | Daily per client | 30 Ğ´Ğ½ĞµĞ¹ | S3 |
| Qdrant | Weekly | 4 Ğ½ĞµĞ´ĞµĞ»Ğ¸ | S3 |
| n8n workflows | On change | Forever | GitHub |
| Configs | On change | Forever | GitHub (encrypted) |

### 8.2. Recovery Ğ¿Ñ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ñ‹

**Scenario: PostgreSQL corruption**
1. Stop n8n
2. Restore from latest backup
3. Apply incremental backups
4. Verify data
5. Start n8n
6. Notify affected clients

**Scenario: Qdrant data loss**
1. Re-run 10_RAG_Update Ğ´Ğ»Ñ affected ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²
2. Source: Google Drive (Ğ²ÑĞµĞ³Ğ´Ğ° Ğ°ĞºÑ‚ÑƒĞ°Ğ»ĞµĞ½)

**Scenario: Client requests data recovery**
1. Identify backup date
2. Restore to temp tables
3. Export requested data
4. Deliver to client

---

## 9. DEPLOYMENT

### 9.1. Environments

| Env | URL | Database | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|-----|-----|----------|------------|
| prod | n8n.truffles.kz | truffles_platform | Production |
| staging | staging.n8n.truffles.kz | truffles_staging | Testing before deploy |
| dev | local | truffles_dev | Development |

### 9.2. Deploy Ğ¿Ñ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ğ°

```
1. Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² workflows
   â†“
2. Export JSON â†’ commit to GitHub
   â†“
3. Deploy to staging
   â†“
4. Run test scenarios (automated)
   â†“
5. Manual review
   â†“
6. Deploy to prod (off-peak hours)
   â†“
7. Monitor 30 min
   â†“
8. Done / Rollback if issues
```

### 9.3. Rollback

- Ğ’ÑĞµ workflows Ğ²ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ² GitHub
- Rollback = import previous version
- Ğ’Ñ€ĞµĞ¼Ñ: < 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚

---

## 10. ĞœĞĞ¡Ğ¨Ğ¢ĞĞ‘Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ• (Ğ‘ÑƒĞ´ÑƒÑ‰ĞµĞµ)

### 10.1. Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚

- 5 ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ¸Ğ½ÑÑ‚Ğ°Ğ½ÑĞµ n8n
- ~100 ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹/Ñ‡Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ½Ğ¾
- ĞĞ´Ğ¸Ğ½ ÑĞµÑ€Ğ²ĞµÑ€

### 10.2. ĞšĞ¾Ğ³Ğ´Ğ° Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ

- > 10 ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²
- > 500 ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹/Ñ‡Ğ°Ñ
- Response time > 5 ÑĞµĞº consistently

### 10.3. ĞšĞ°Ğº Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ

**Phase 1: Vertical**
- Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ RAM/CPU Ğ´Ğ»Ñ VM
- PostgreSQL Ğ½Ğ° Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€

**Phase 2: Horizontal**
- n8n Ğ² queue mode (Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ workers)
- Redis cluster
- PostgreSQL read replicas

**Phase 3: Multi-region**
- ĞÑ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¸Ğ½ÑÑ‚Ğ°Ğ½ÑÑ‹ Ğ¿Ğ¾ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½Ğ°Ğ¼
- Shared database Ğ¸Ğ»Ğ¸ federation

---

## 11. TIMELINE Ğ Ğ•Ğ¤ĞĞšĞ¢ĞĞ Ğ˜ĞĞ“Ğ

### ĞĞµĞ´ĞµĞ»Ñ 1: Foundation
- [ ] Ğ”ĞµĞ½ÑŒ 1-2: Ğ¡Ñ…ĞµĞ¼Ğ° Ğ‘Ğ” (clients, conversations, audit_log)
- [ ] Ğ”ĞµĞ½ÑŒ 3: Config ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° (clients.config JSONB)
- [ ] Ğ”ĞµĞ½ÑŒ 4: 1_Webhook_Gateway Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹
- [ ] Ğ”ĞµĞ½ÑŒ 5: 2_Parse_Normalize Ğ½Ğ¾Ğ²Ñ‹Ğ¹
- [ ] Ğ”ĞµĞ½ÑŒ 6-7: Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ foundation

### ĞĞµĞ´ĞµĞ»Ñ 2: Core Logic
- [ ] Ğ”ĞµĞ½ÑŒ 1: 5_ClassifyIntent (Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¹, Ğ¸Ğ· Ğ‘Ğ”)
- [ ] Ğ”ĞµĞ½ÑŒ 2-3: 6_GenerateResponse (Ñ RAG)
- [ ] Ğ”ĞµĞ½ÑŒ 4: 8_Send_Response (credentials Ğ¸Ğ· config)
- [ ] Ğ”ĞµĞ½ÑŒ 5: Memory ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° (ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº)
- [ ] Ğ”ĞµĞ½ÑŒ 6-7: Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### ĞĞµĞ´ĞµĞ»Ñ 3: Operations
- [ ] Ğ”ĞµĞ½ÑŒ 1: 9_Error_Handler
- [ ] Ğ”ĞµĞ½ÑŒ 2: 7_Handover (Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹)
- [ ] Ğ”ĞµĞ½ÑŒ 3: 10_RAG_Update
- [ ] Ğ”ĞµĞ½ÑŒ 4: 11_Daily_Backup
- [ ] Ğ”ĞµĞ½ÑŒ 5: 15_Health_Check
- [ ] Ğ”ĞµĞ½ÑŒ 6-7: ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹

### ĞĞµĞ´ĞµĞ»Ñ 4: Client Lifecycle
- [ ] Ğ”ĞµĞ½ÑŒ 1-2: 12_Client_Onboard
- [ ] Ğ”ĞµĞ½ÑŒ 3: 13_Client_Suspend
- [ ] Ğ”ĞµĞ½ÑŒ 4: 14_Client_Delete (GDPR)
- [ ] Ğ”ĞµĞ½ÑŒ 5: Deploy ÑĞºÑ€Ğ¸Ğ¿Ñ‚
- [ ] Ğ”ĞµĞ½ÑŒ 6-7: End-to-end Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### ĞĞµĞ´ĞµĞ»Ñ 5: Polish
- [ ] Ğ”ĞµĞ½ÑŒ 1-2: Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ
- [ ] Ğ”ĞµĞ½ÑŒ 3-4: Staging environment
- [ ] Ğ”ĞµĞ½ÑŒ 5: Production deploy
- [ ] Ğ”ĞµĞ½ÑŒ 6-7: Buffer / fixes

---

## 12. ĞšĞ Ğ˜Ğ¢Ğ•Ğ Ğ˜Ğ˜ Ğ“ĞĞ¢ĞĞ’ĞĞĞ¡Ğ¢Ğ˜

**Ğ“Ğ¾Ñ‚Ğ¾Ğ² Ğº ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ ĞºĞ¾Ğ³Ğ´Ğ°:**

- [ ] ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ Ğ·Ğ° < 1 Ñ‡Ğ°Ñ
- [ ] Ğ‘Ğ¾Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ñ RAG
- [ ] Memory Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ (Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ñ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚)
- [ ] Handover Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
- [ ] ĞÑˆĞ¸Ğ±ĞºĞ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ¸ Ğ½Ğµ Ğ»Ğ¾Ğ¼Ğ°ÑÑ‚ Ğ±Ğ¾Ñ‚Ğ°
- [ ] Backup Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
- [ ] ĞœĞ¾Ğ¶Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ·Ğ° 1 ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ
- [ ] Ğ•ÑÑ‚ÑŒ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹

---

## 13. HANDOVER ADAPTERS

### 13.1. ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°

ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ»Ğ¸Ğ´Ğ°Ğ¼Ğ¸:
- Bitrix24
- AmoCRM
- HubSpot
- WhatsApp Web Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
- Telegram Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²
- Email
- Ğ¡Ğ²Ğ¾Ñ CRM

### 13.2. Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: Adapter Pattern

```
7_Handover (Core)
      â”‚
      â–¼
[Handover Adapter Router]
      â”‚
      â”œâ”€â”€ webhook â”€â”€â”€â”€â†’ POST to client's URL (ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹)
      â”œâ”€â”€ telegram â”€â”€â”€â†’ Send to manager's Telegram
      â”œâ”€â”€ email â”€â”€â”€â”€â”€â”€â†’ Send email with context
      â”œâ”€â”€ bitrix â”€â”€â”€â”€â”€â†’ Create lead/deal + activity
      â”œâ”€â”€ whatsapp_web â†’ Just mark, manager uses same WhatsApp
      â””â”€â”€ custom â”€â”€â”€â”€â”€â†’ Call client's n8n webhook
```

### 13.3. Config ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°

```json
{
  "client_id": "example",
  "handover": {
    "type": "telegram",
    "config": {
      "chat_id": "-100123456789",
      "notify_template": "ğŸ”” ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ñ‚ {user_name}\n\nĞ¢ĞµĞ¼Ğ°: {intent}\n\nĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ:\n{context}"
    },
    "fallback": {
      "type": "email",
      "config": { "to": "manager@company.kz" }
    },
    "keywords": ["Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€", "Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº", "Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€", "Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ½Ğ¸Ñ‚ÑŒ", "Ğ¶Ğ¸Ğ²Ğ¾Ğ¹"],
    "auto_return_hours": 24
  }
}
```

### 13.4. Ğ ĞµĞ¶Ğ¸Ğ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ±Ğ¾Ñ‚Ğ°

**Ğ‘Ğ¾Ñ‚ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ + ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ°:**
```
Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚
      â†“
ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ conversation.status
      â†“
Ğ•ÑĞ»Ğ¸ human_active â†’ Ğ±Ğ¾Ñ‚ Ğ¼Ğ¾Ğ»Ñ‡Ğ¸Ñ‚, ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
      â†“
Ğ•ÑĞ»Ğ¸ bot_active:
  â”œâ”€â”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ keywords â†’ ĞµÑĞ»Ğ¸ match â†’ handover
  â””â”€â”€ Classify intent â†’ ĞµÑĞ»Ğ¸ complaint/ready_to_buy â†’ handover
      â†“
Ğ˜Ğ½Ğ°Ñ‡Ğµ â†’ Ğ±Ğ¾Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚
```

### 13.5. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğº Ğ±Ğ¾Ñ‚Ñƒ

**Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹:**
- ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ·Ğ°ĞºÑ€Ñ‹Ğ» Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ (ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° `/close`)
- Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ (`auto_return_hours`)
- ĞĞ¾Ğ²Ğ°Ñ ÑĞµÑÑĞ¸Ñ (ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ» Ñ‡ĞµÑ€ĞµĞ· X Ñ‡Ğ°ÑĞ¾Ğ²)

---

## 14. BILLING Ğ˜ ĞĞĞŸĞĞœĞ˜ĞĞĞĞ˜Ğ¯

### 14.1. ĞŸĞ¾Ğ´Ñ…Ğ¾Ğ´

- ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ñ€ÑƒÑ‡Ğ½Ğ°Ñ (Ñ‚Ñ‹ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ¸Ñ€ÑƒĞµÑˆÑŒ)
- ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Telegram Ñ‚ĞµĞ±Ğµ
- ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ suspend Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ

### 14.2. Flow Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸

```
Trial (7 Ğ´Ğ½ĞµĞ¹)
      â†“
[Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ° 3 Ğ´Ğ½Ñ, Ğ·Ğ° 1 Ğ´ĞµĞ½ÑŒ]
      â†“
Trial Ğ¸ÑÑ‚Ñ‘Ğº â†’ ĞĞ¿Ğ»Ğ°Ñ‚Ğ°?
      â”œâ”€â”€ Ğ”Ğ° â†’ status = active
      â””â”€â”€ ĞĞµÑ‚ â†’ status = past_due
            â†“
      [Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ 3 Ğ´Ğ½Ñ]
            â†“
      7 Ğ´Ğ½ĞµĞ¹ Ğ±ĞµĞ· Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹ â†’ status = suspended, Ğ±Ğ¾Ñ‚ Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½
            â†“
      [Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ]
            â†“
      30 Ğ´Ğ½ĞµĞ¹ â†’ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ/ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
```

### 14.3. Workflow: 17_Billing_Reminder (Cron: daily)

```
1. ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ³Ğ´Ğµ:
   - trial_ends_at Ñ‡ĞµÑ€ĞµĞ· 3 Ğ´Ğ½Ñ
   - trial_ends_at Ñ‡ĞµÑ€ĞµĞ· 1 Ğ´ĞµĞ½ÑŒ
   - current_period_end Ñ‡ĞµÑ€ĞµĞ· 7 Ğ´Ğ½ĞµĞ¹
   - current_period_end Ñ‡ĞµÑ€ĞµĞ· 3 Ğ´Ğ½Ñ
   - current_period_end < today (past_due)
   - past_due > 7 Ğ´Ğ½ĞµĞ¹ (suspend)

2. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Telegram ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞ±Ğµ
3. Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ² billing_reminders
4. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ subscription.reminder_sent_at
```

---

## 15. DOCUMENTS MANAGEMENT

### 15.1. Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²

- Google Drive (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²)
- Ğ ÑƒÑ‡Ğ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° (API)
- Ğ‘ÑƒĞ´ÑƒÑ‰ĞµĞµ: Web UI drag-drop

### 15.2. Sync Flow

```
10_RAG_Update (Cron: 1h)
      â†“
Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ active ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°:
      â†“
ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¸Ğ· Google Drive
      â†“
Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°:
  â”œâ”€â”€ ĞĞ¾Ğ²Ñ‹Ğ¹ (Ğ½ĞµÑ‚ Ğ² documents)? 
  â”‚   â†’ Chunk â†’ Embed â†’ Insert Qdrant â†’ Insert documents
  â”‚
  â”œâ”€â”€ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ (hash Ñ€Ğ°Ğ·Ğ½Ñ‹Ğ¹)?
  â”‚   â†’ Delete old chunks â†’ Insert new â†’ Update documents
  â”‚
  â””â”€â”€ Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½ Ğ¸Ğ· Drive?
      â†’ Delete chunks from Qdrant â†’ documents.status = deleted
      â†“
Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² audit_log
```

---

## 16. ĞŸĞĞ›ĞĞ«Ğ™ Ğ¡ĞŸĞ˜Ğ¡ĞĞš WORKFLOWS

### Core (MVP)
| # | Workflow | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|---|----------|------------|
| 1 | 1_Webhook_Gateway | Ğ’Ñ…Ğ¾Ğ´Ğ½Ğ°Ñ Ñ‚Ğ¾Ñ‡ĞºĞ°, Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ, Ğ´ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ |
| 2 | 2_Parse_Normalize | ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ, user upsert, save inbound |
| 3 | 3_WhatsApp_Adapter | WhatsApp ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°, media processing |
| 5 | 5_ClassifyIntent | Intent + keywords classification |
| 6 | 6_GenerateResponse | RAG + LLM response generation |
| 7 | 7_Handover | ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñƒ Ñ‡ĞµÑ€ĞµĞ· adapters |
| 8 | 8_Send_Response | Save outbound + send via channel |
| 9 | 9_Error_Handler | Global error handling |

### Operations
| # | Workflow | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|---|----------|------------|
| 10 | 10_RAG_Update | Sync documents to Qdrant |
| 11 | 11_Daily_Backup | Backup messages, configs |
| 15 | 15_Health_Check | Monitor all services |
| 17 | 17_Billing_Reminder | Subscription reminders |

### Client Lifecycle
| # | Workflow | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|---|----------|------------|
| 12 | 12_Client_Onboard | New client setup |
| 13 | 13_Client_Suspend | Pause client |
| 14 | 14_Client_Delete | GDPR delete |

### Manager Interface (Phase 2)
| # | Workflow | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|---|----------|------------|
| 16 | 16_Telegram_Manager_Bot | Manager receives/replies via Telegram |
| 18 | 18_Manager_Reply_Webhook | CRM sends reply back |

---

## 17. Ğ§Ğ•Ğ“Ğ ĞĞ•Ğ¢ Ğ’ Ğ­Ğ¢ĞĞœ ĞŸĞ›ĞĞĞ• (Phase 2+)

- Telegram adapter (ĞºĞ°Ğ½Ğ°Ğ» Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²)
- Instagram adapter
- Web UI Ğ´Ğ»Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°
- Multi-language (kk, en)
- Lead scoring
- Analytics dashboard
- Kaspi Pay Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ
- Voice messages (advanced)
- Image recognition
- On-premise deployment

Ğ­Ñ‚Ğ¾ Ğ²ÑÑ‘ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ·Ğ¶Ğµ, ĞºĞ¾Ğ³Ğ´Ğ° core Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚.

---

## 18. DECISIONS LOG

| Ğ”Ğ°Ñ‚Ğ° | Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ | ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° |
|------|---------|---------|
| 2025-11-30 | On-premise â€” Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ | ĞĞµÑ‚ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ Ğ±ÑĞ´Ğ¶ĞµÑ‚Ğ¾Ğ¼ ÑĞµĞ¹Ñ‡Ğ°Ñ |
| 2025-11-30 | Billing â€” Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ | ĞŸÑ€Ğ¾Ñ‰Ğµ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ñ‚Ğµ |
| 2025-11-30 | Manager UI â€” Telegram ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° | Ğ‘Ñ‹ÑÑ‚Ñ€ĞµĞµ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ web |
| 2025-11-30 | Handover adapters | ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ CRM |
| 2025-11-30 | Ğ‘Ğ¾Ñ‚ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ + keywords | ĞšĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ |

---

**Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑˆĞ°Ğ³:** ĞĞµĞ´ĞµĞ»Ñ 1, Ğ”ĞµĞ½ÑŒ 1 â€” ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑÑ…ĞµĞ¼Ñƒ Ğ‘Ğ” Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ğ¼Ğ¸.
