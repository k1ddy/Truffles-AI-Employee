{"data":[{"updatedAt":"2025-11-29T13:24:38.185Z","createdAt":"2025-11-29T11:20:43.217Z","id":"e94jQCRIneXDLZfe","name":"2_1_CheckUser","active":false,"isArchived":false,"nodes":[{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"users","mode":"list","cachedResultName":"users"},"where":{"values":[{"column":"phone","value":"={{ $json.phone }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[48,352],"id":"61a75125-77df-4b40-ace6-2baa80889bc8","name":"CheckUser","alwaysOutputData":true,"credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"431d0d6b-37d9-4f30-9208-636e12464fbc","leftValue":"={{ $json }}","rightValue":"","operator":{"type":"object","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[272,352],"id":"8f8452fc-a103-4749-9b7d-14f6e09e0015","name":"If"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO public.users (phone, remote_jid, name, locale, last_active, source)\nVALUES ($1, $2, $3, COALESCE($4,'ru'), now(), 'whatsapp')\nON CONFLICT (phone) DO UPDATE\nSET remote_jid = EXCLUDED.remote_jid,\nname = COALESCE(EXCLUDED.name, public.users.name),\nlocale = COALESCE(EXCLUDED.locale, public.users.locale),\nlast_active= now()\nRETURNING id, remote_jid;","options":{"queryReplacement":"={{ $('Start').item.json.phone }}\n, {{ $('Start').item.json.remote_jid }}, {{ $('Start').item.json.sender }}, {{ locale || 'ru' }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[496,560],"id":"e9ed0402-f133-4f87-9cbc-d6dd523a11c3","name":"CreateUser","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"operation":"upsert","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"users","mode":"list","cachedResultName":"users"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $json.id }}","last_active":"={{ $now.toLocal()}}","phone":"={{ $json.phone }}","remote_jid":"={{ $json.remote_jid }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"phone","displayName":"phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"remote_jid","displayName":"remote_jid","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"name","displayName":"name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":true},{"id":"business_type","displayName":"business_type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":true},{"id":"business_details","displayName":"business_details","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":true},{"id":"budget_mention","displayName":"budget_mention","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":false,"removed":true},{"id":"locale","displayName":"locale","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":true},{"id":"source","displayName":"source","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false,"removed":true},{"id":"last_active","displayName":"last_active","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false},{"id":"gdpr_consent","displayName":"gdpr_consent","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":false,"removed":true},{"id":"consent_timestamp","displayName":"consent_timestamp","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[512,224],"id":"8e672c35-2767-4c85-80be-5231f095b5b5","name":"UpdateLastSeen","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"workflowInputs":{"values":[{"name":"remote_jid"},{"name":"phone"},{"name":"last_active"},{"name":"sender"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-160,352],"id":"55a71211-7ce6-481d-a6b5-f3a42275d71b","name":"Start"},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.myNewField = 1;\n}\n\nreturn $input.all();"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[720,208],"id":"3f824c98-bb78-4102-a945-6c98c5388024","name":"Code"},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.myNewField = 1;\n}\n\nreturn $input.all();"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[688,528],"id":"0cca40d9-0529-4ad3-856b-dd51699d99d2","name":"Code1"}],"connections":{"CheckUser":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"UpdateLastSeen","type":"main","index":0}],[{"node":"CreateUser","type":"main","index":0}]]},"CreateUser":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Start":{"main":[[{"node":"CheckUser","type":"main","index":0}]]},"UpdateLastSeen":{"main":[[{"node":"Code","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"Start":[{"json":{"remote_jid":"77015705555@s.whatsapp.net","phone":"77015705555","last_active":null,"sender":"Zh."}}]},"versionId":"297b6ae5-0d7b-478e-b772-88e33cdf9dc5","triggerCount":0,"shared":[{"updatedAt":"2025-11-29T11:20:43.217Z","createdAt":"2025-11-29T11:20:43.217Z","role":"workflow:owner","workflowId":"e94jQCRIneXDLZfe","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-11-27T06:22:27.418Z","createdAt":"2025-11-24T15:59:35.000Z","id":"truffles-chatbot-tag","name":"truffles-chatbot"}]},{"updatedAt":"2025-11-30T07:18:50.821Z","createdAt":"2025-11-29T11:22:49.379Z","id":"58WFmPNitSNIwbes","name":"4_NormalizeWhatsapp","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-240,-224],"id":"c0dce727-320a-4225-a1cb-c57ab2f14555","name":"Start"},{"parameters":{"jsCode":"const ev = $json.event ?? {}\nconst attachments = Array.isArray(ev.attachments) ? ev.attachments : []\nconst source = attachments[0] ?? {\n  data: ev.content,\n  mimetype: ev.metadata?.providerMimetype || 'audio/ogg',\n  filename: ev.metadata?.filename || 'voice_message.ogg',\n}\n\nconst base64 = source?.data || ''\nif (!base64) {\n  return items\n}\n\nconst mimeType = source.mimetype || 'audio/ogg'\nconst fileName = source.filename || 'voice_message.ogg'\nconst buffer = Buffer.from(base64, 'base64')\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    event: {\n      ...(item.json.event ?? ev),\n      attachments: [{ ...source, data: base64, mimetype: mimeType, filename: fileName }],\n    },\n  },\n  binary: {\n    ...(item.binary ?? {}),\n    audio: {\n      data: buffer,\n      mimeType,\n      fileName,\n    },\n  },\n}))\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[640,-112],"id":"8474408c-1d85-46c0-ac03-ddb3b2a60a2e","name":"Prepare Audio Binary"},{"parameters":{"method":"POST","url":"https://api.elevenlabs.io/v1/speech-to-text","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"file","inputDataFieldName":"audio"},{"name":"model_id","value":"scribe_v2"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[896,-128],"id":"a5e6e740-6dfb-4db3-afba-89601a1fc174","name":"ElevenLabs STT","credentials":{"httpHeaderAuth":{"id":"lAIfrKkpaC6WZwvB","name":"ElevenLabs"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ad1c7565-d39f-4900-b1d0-87654ec271b9","leftValue":"={{ $json.event.metadata.providerMessageType }}","rightValue":"=audio","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[224,-224],"id":"50996689-214c-4faa-a5cc-f538a76b4fd8","name":"If1"},{"parameters":{"assignments":{"assignments":[{"id":"0cbb5487-c950-49ca-9449-7da21b73c34b","name":"event.message","value":"={{ $json.event.content }}","type":"string"},{"id":"714c354f-e008-4bf9-b484-dfddcca0b246","name":"event.metadata","value":"={{ $json.event.metadata }}","type":"object"},{"id":"dd66c36f-2e29-4d49-885d-7b9663a82f1a","name":"event.user_id","value":"={{ $json.event.user_id }}","type":"string"},{"id":"fd43cbd0-12db-455a-9784-e144a4d9c099","name":"event.session_id","value":"={{ $json.event.session_id }}","type":"string"},{"id":"14118a10-0560-4071-a476-3492eb0d1260","name":"event.channel","value":"={{ $json.event.channel }}","type":"string"},{"id":"fb1b3a24-ae71-44e8-9243-dcd14e772498","name":"event.message_type","value":"={{ $json.content.type }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[448,-320],"id":"f99cdd8b-eeb0-41af-bf3c-6e5fe6e97c36","name":"Return2"},{"parameters":{"jsCode":"const ev = $json.event || $json;\n\n// Проверяем, что прилетело аудио\nconst providerType = ev.metadata?.providerMessageType;\nconst hasAudioAttachment = Array.isArray(ev.attachments)\n  && ev.attachments.length > 0\n  && typeof ev.attachments[0]?.mimetype === 'string'\n  && ev.attachments[0].mimetype.startsWith('audio/');\n\nconst isAudio = providerType === 'audio' || ev.message_type === 'audio' || hasAudioAttachment;\n\nreturn [{\n  json: {\n    event: ev,\n    content: {\n      type: isAudio ? 'audio' : 'text',\n      text: isAudio ? null : (ev.message || ''),\n    },\n  },\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[0,-224],"id":"e56ac2c1-f3f0-44c4-82ec-b563e0f0a181","name":"Code1"},{"parameters":{"assignments":{"assignments":[{"id":"a125f358-6efd-4d14-be3a-d3df77c34274","name":"sender","value":"={{ $json.event.session_id }}","type":"string"},{"id":"19b2a85e-9877-47e2-b82c-8d995b2183c0","name":"event.attachments","value":"={{ [ { data: $json.event.content, mimetype: $json.event.metadata?.providerMimetype || 'audio/ogg', filename: $json.event.metadata?.filename || 'voice_message.ogg' } ] }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[448,-128],"id":"e73284fb-0f62-4165-878a-6af6e15a5bd9","name":"SetAudio1"},{"parameters":{"assignments":{"assignments":[{"id":"0cbb5487-c950-49ca-9449-7da21b73c34b","name":"event.message","value":"={{ $json.text || $json.transcript || $json.output || '' }}","type":"string"},{"id":"714c354f-e008-4bf9-b484-dfddcca0b246","name":"event.metadata","value":"={{ $node['Code1'].json.event.metadata || {} }}","type":"object"},{"id":"30ef8374-4c83-4434-95da-240d2fade367","name":"event.metadata.type","value":"text","type":"string"},{"id":"b16b7d89-6a3f-4a9b-98a9-2da52ae41c7c","name":"event.user_id","value":"={{ $node['Code1'].json.event.user_id }}","type":"string"},{"id":"ac00641f-99d6-4b59-978e-97712574d8d3","name":"event.session_id","value":"={{ $node['Code1'].json.event.session_id }}","type":"string"},{"id":"df4f1e5e-2af7-4b4b-8c16-9ad5312b67d7","name":"event.channel","value":"={{ $node['Code1'].json.event.channel }}","type":"string"},{"id":"3cf1b65e-d35c-4b4c-8a1c-ef78b1e12ae5","name":"event.message_type","value":"text","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1136,-128],"id":"9843384c-e78d-4115-b57a-23c2024f9ce8","name":"Return3"}],"connections":{"Start":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Prepare Audio Binary":{"main":[[{"node":"ElevenLabs STT","type":"main","index":0}]]},"ElevenLabs STT":{"main":[[{"node":"Return3","type":"main","index":0}]]},"If1":{"main":[[{"node":"Return2","type":"main","index":0}],[{"node":"SetAudio1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"If1","type":"main","index":0}]]},"SetAudio1":{"main":[[{"node":"Prepare Audio Binary","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Start":[{"json":{"id":"53","user_id":"16834089-a4ee-41f6-9fd7-1f8ff52da50a","session_id":"77015705555@s.whatsapp.net","role":"user","content":"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","intent":null,"confidence":null,"timestamp":"2025-11-29T18:19:31.725Z","metadata":{"sender":"Zh.","caption":null,"headers":{"host":"n8n.truffles.kz","accept":"application/json, text/plain, */*","x-real-ip":"144.91.105.72","user-agent":"axios/1.11.0","content-type":"application/json","content-length":"7371","accept-encoding":"gzip, compress, deflate, br","x-forwarded-for":"144.91.105.72","x-forwarded-host":"n8n.truffles.kz","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"68926a3e1a32"},"messageId":"3F02854B390AC5D3BBCC","remoteJid":"77015705555@s.whatsapp.net","webhookUrl":"https://n8n.truffles.kz/webhook/flow","executionMode":"production","providerMessageType":"audio"},"channel":"whatsapp"}}]},"versionId":"7801568f-0c36-4c90-b609-df36339f0e0f","triggerCount":0,"shared":[{"updatedAt":"2025-11-29T11:22:49.379Z","createdAt":"2025-11-29T11:22:49.379Z","role":"workflow:owner","workflowId":"58WFmPNitSNIwbes","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-11-27T06:22:27.418Z","createdAt":"2025-11-24T15:59:35.000Z","id":"truffles-chatbot-tag","name":"truffles-chatbot"}]},{"updatedAt":"2025-11-30T09:47:31.842Z","createdAt":"2025-07-27T09:56:17.060Z","id":"WYTuwxwHUxwdzsSQ","name":"cronUpdateDocs","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"hours"}]}},"id":"195c935c-1e47-436b-b105-949f5d7f9f1e","name":"Schedule Trigger (1s)","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1,"position":[16,-256],"disabled":true},{"parameters":{"options":{}},"id":"fd685794-1430-4d6d-a4b2-091fe692bc99","name":"Embeddings OpenAI1","type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","position":[1136,-208],"typeVersion":1.1,"credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}},"disabled":true},{"parameters":{"dataType":"binary","binaryMode":"specificField","options":{"metadata":{"metadataValues":[{"name":"file_id","value":"={{ $('Download files').item.json.id }}"},{"name":"file_name","value":"={{ $('Download files').item.json.name }}"}]}}},"id":"8d44e5d4-405d-4696-9120-ca419f8afdc5","name":"Default Data Loader1","type":"@n8n/n8n-nodes-langchain.documentDefaultDataLoader","position":[1264,-208],"typeVersion":1,"disabled":true},{"parameters":{"mode":"insert","qdrantCollection":{"__rl":true,"value":"ocr_mistral_test","mode":"list","cachedResultName":"ocr_mistral_test"},"options":{}},"id":"3ecd5742-86ac-49d8-8c1f-2984233dcf25","name":"Qdrant Vector Store","type":"@n8n/n8n-nodes-langchain.vectorStoreQdrant","position":[1152,-432],"typeVersion":1,"credentials":{"qdrantApi":{"id":"opEHEfSi8yMB5dqA","name":"QdrantApi account"}},"disabled":true},{"parameters":{"chunkSize":500,"chunkOverlap":50,"options":{}},"id":"b73221ca-a829-4bb7-b179-06fc0c3e5774","name":"Recursive Character Text Splitter","type":"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter","position":[1360,0],"typeVersion":1,"disabled":true},{"parameters":{"options":{}},"id":"11170301-b1e9-4023-82f8-ca5acb272dfa","name":"Loop Over Items","type":"n8n-nodes-base.splitInBatches","position":[688,-256],"typeVersion":3,"disabled":true},{"parameters":{},"id":"6da991b1-9bb8-4d73-9e89-82b8631a7fa2","name":"Wait","type":"n8n-nodes-base.wait","position":[1664,-256],"webhookId":"3d477cc3-8182-43e9-ae61-23e8ce308887","typeVersion":1.1,"disabled":true},{"parameters":{"resource":"fileFolder","filter":{"driveId":{"__rl":true,"mode":"list","value":"My Drive","cachedResultUrl":"https://drive.google.com/drive/my-drive","cachedResultName":"My Drive"},"folderId":{"__rl":true,"value":"1ZFC01Dr78rdKoSvXRXEQr1H8pvSvaHrb","mode":"list","cachedResultName":"Truffles.kz","cachedResultUrl":"https://drive.google.com/drive/folders/1ZFC01Dr78rdKoSvXRXEQr1H8pvSvaHrb"}},"options":{}},"id":"54ad1052-98f1-46c8-9c90-b7c84cb033bd","name":"Get files","type":"n8n-nodes-base.googleDrive","position":[464,-256],"typeVersion":3,"credentials":{"googleDriveOAuth2Api":{"id":"3W8cfc75QTk2gt72","name":"Google Drive account"}},"disabled":true},{"parameters":{"operation":"download","fileId":{"__rl":true,"mode":"id","value":"={{ $json.id }}"},"options":{"googleFileConversion":{"conversion":{"docsToFormat":"application/vnd.openxmlformats-officedocument.wordprocessingml.document","sheetsToFormat":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}}}},"id":"163c8c76-d887-4345-8dde-f4d234da08a0","name":"Download files","type":"n8n-nodes-base.googleDrive","position":[-80,-688],"typeVersion":3,"credentials":{"googleDriveOAuth2Api":{"id":"3W8cfc75QTk2gt72","name":"Google Drive account"}}},{"parameters":{"operation":"deleteCollection","collectionName":{"__rl":true,"value":"ocr_mistral_test","mode":"list","cachedResultName":"ocr_mistral_test"},"requestOptions":{}},"type":"CUSTOM.qdrant","typeVersion":1,"position":[240,-256],"id":"059a113a-78ec-48a9-a384-1e3d9fa49b10","name":"Delete Collection","credentials":{"qdrantRestApi":{"id":"oS8bZ0yQAPvYHZxw","name":"qdrant"}},"disabled":true},{"parameters":{"options":{}},"id":"1e557c89-1f43-4515-b6ed-c53bf2d32d68","name":"Embeddings OpenAI2","type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","position":[1232,496],"typeVersion":1.1,"credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}},"disabled":true},{"parameters":{"dataType":"binary","binaryMode":"specificField","options":{"metadata":{"metadataValues":[{"name":"file_id","value":"={{ $('Download file').item.json.file_id }}"},{"name":"file_name","value":"={{ $binary.data.fileName}}"}]}}},"id":"15912ae9-ae0e-427b-8249-42d44bb339bc","name":"Default Data Loader","type":"@n8n/n8n-nodes-langchain.documentDefaultDataLoader","position":[1440,544],"typeVersion":1,"disabled":true},{"parameters":{"chunkSize":500,"chunkOverlap":50,"options":{}},"id":"c05414e0-c8b2-41e0-8536-e0932c8a76c9","name":"Recursive Character Text Splitter1","type":"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter","position":[1472,736],"typeVersion":1,"disabled":true},{"parameters":{"method":"POST","url":"http://QDRANTURL/collections/COLLECTION/points/delete","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"filter\": {\n    \"must\": [\n      {\n          \"key\": \"metadata.file_id\",\n          \"match\": { \"value\": \"{{$json.file_id}}\" }\n        }\n    ]\n  }\n}","options":{}},"id":"3ea63b14-dcbb-4eb6-b861-3fbe18443862","name":"Delete single file","type":"n8n-nodes-base.httpRequest","position":[976,0],"typeVersion":4.2,"disabled":true},{"parameters":{"operation":"download","fileId":{"__rl":true,"mode":"id","value":"={{ $json.file_id }}"},"options":{"googleFileConversion":{"conversion":{"docsToFormat":"application/vnd.openxmlformats-officedocument.wordprocessingml.document","sheetsToFormat":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}}}},"id":"51f6b1d8-b3ce-44d5-8f73-44a0cedd977f","name":"Download file","type":"n8n-nodes-base.googleDrive","position":[976,256],"typeVersion":3,"credentials":{"googleDriveOAuth2Api":{"id":"3W8cfc75QTk2gt72","name":"Google Drive account"}},"disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"b413a226-0641-4ed8-9951-d17b6a6a9a4b","name":"file_id","type":"string","value":"DRIVEFILE_ID"}]},"options":{}},"id":"139d1ef2-efd7-42ff-a799-45b1cc39a462","name":"Edit Fields3","type":"n8n-nodes-base.set","position":[304,160],"typeVersion":3.4,"disabled":true},{"parameters":{"mode":"insert","qdrantCollection":{"__rl":true,"mode":"list","value":"negozio-emporio-verde","cachedResultName":"negozio-emporio-verde"},"options":{}},"id":"e0ac043c-6a52-4fea-8ec8-0ce4c62217a3","name":"Update single file","type":"@n8n/n8n-nodes-langchain.vectorStoreQdrant","position":[1312,256],"typeVersion":1,"credentials":{"qdrantApi":{"id":"opEHEfSi8yMB5dqA","name":"QdrantApi account"}},"disabled":true},{"parameters":{"resource":"point","operation":"deletePoints","collectionName":{"__rl":true,"value":"ocr_mistral_test","mode":"list","cachedResultName":"ocr_mistral_test"},"requestOptions":{}},"type":"CUSTOM.qdrant","typeVersion":1,"position":[672,64],"id":"3f9904be-72ec-4012-b675-3e1f0392033f","name":"Delete Points","credentials":{"qdrantRestApi":{"id":"bTwdkYLKIdl7kODN","name":"Qdrant account"}},"disabled":true},{"parameters":{"operation":"executeQuery","query":"SELECT id, question, answer, language, category, priority, updated_at\nFROM faq_items\nWHERE active = TRUE\nAND language = 'ru'\nAND (qdrant_point_id IS NULL OR updated_at > NOW() - INTERVAL '1 day')\nORDER BY priority DESC, updated_at DESC\nLIMIT {{ $json.limit || 500 }}; ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[208,-880],"id":"e56d9095-0074-43f9-a9e5-1e0588f7cb21","name":"Execute a SQL query","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"jsCode":"/**\n * n8n Code node: Build chunks/documents for embeddings from Postgres rows (faq_items).\n * Input: items[].json must contain { id, question, answer, language, category, priority, updated_at }\n * Output: one item per chunk with:\n *   json: {\n *     document: \"<chunk text>\",\n *     metadata: {\n *       faq_id, language, category, priority, updated_at_iso, version_hint, source, doc_id, chunk_index, chunk_count\n *     }\n *   }\n *\n * Notes:\n * - Chunking: fixed length 600 chars, overlap 80 chars (good for RU long-form).\n * - doc_id is stable per chunk: `faq-{id}-v{version}-{chunkIndex}`\n * - version_hint derived from updated_at (ISO date) to invalidate old points.\n * - Keep only ASCII keys in metadata for portability across vector DBs.\n */\n\nfunction normalizeLang(lang) {\n  const s = String(lang || '').trim().toLowerCase();\n  if (s.startsWith('ru')) return 'ru';\n  if (s.startsWith('en')) return 'en';\n  if (s.startsWith('kz') || s.startsWith('kk')) return 'kk';\n  return 'ru'; // default\n}\n\nfunction ensureString(x) {\n  if (x == null) return '';\n  return typeof x === 'string' ? x : String(x);\n}\n\nfunction toIso(dt) {\n  try {\n    if (!dt) return null;\n    const d = new Date(dt);\n    if (isNaN(d.getTime())) return null;\n    return d.toISOString();\n  } catch {\n    return null;\n  }\n}\n\nfunction buildPassport(row) {\n  const q = (ensureString(row.question) || '').trim();\n  const a = (ensureString(row.answer) || '').trim();\n\n  // Header + body: keep both Q and A to improve retrieval\n  // The separators help LLM/vectorizer distinguish fields.\n  let blocks = [];\n  if (q) blocks.push(`Q: ${q}`);\n  if (a) blocks.push(`A: ${a}`);\n  const text = blocks.join('\\n\\n---\\n\\n');\n\n  return text.replace(/\\s+\\n/g, '\\n').replace(/\\n{3,}/g, '\\n\\n').trim();\n}\n\nfunction chunkText(text, chunkSize = 600, overlap = 80) {\n  const chunks = [];\n  const len = text.length;\n  if (len <= chunkSize) return [text];\n\n  let start = 0;\n  while (start < len) {\n    const end = Math.min(start + chunkSize, len);\n    const cut = text.slice(start, end);\n    chunks.push(cut);\n    if (end === len) break;\n    start = end - overlap;\n    if (start < 0) start = 0;\n  }\n  return chunks;\n}\n\nconst out = [];\nfor (const item of items) {\n  const row = item.json || {};\n  const id = row.id;\n  // Validate essentials\n  if (id == null) continue;\n\n  const language = normalizeLang(row.language);\n  const category = ensureString(row.category || 'general');\n  const priority = Number.isFinite(Number(row.priority)) ? Number(row.priority) : 0;\n  const updatedIso = toIso(row.updated_at) || new Date().toISOString();\n\n  // Build full text passport\n  const text = buildPassport(row);\n  if (!text) continue;\n\n  // Chunking\n  const CHUNK_SIZE = 600;\n  const OVERLAP = 80;\n  const chunks = chunkText(text, CHUNK_SIZE, OVERLAP);\n  const chunkCount = chunks.length;\n\n  // Version hint to bust old vectors (derived from date only for stability)\n  const versionHint = updatedIso.slice(0, 19); // YYYY-MM-DDTHH:mm:ss\n\n  // Emit per-chunk items\n  for (let i = 0; i < chunkCount; i++) {\n    const docId = `faq-${id}-v${versionHint}-c${i + 1}`;\n    out.push({\n      json: {\n        document: chunks[i],\n        metadata: {\n          source: 'faq_items',\n          faq_id: id,\n          language,\n          category,\n          priority,\n          updated_at_iso: updatedIso,\n          version_hint: versionHint,\n          doc_id: docId,\n          chunk_index: i + 1,\n          chunk_count: chunkCount,\n        },\n      },\n    });\n  }\n}\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[416,-896],"id":"28f43be9-a574-48e5-b428-878efc928550","name":"Code"},{"parameters":{"mode":"insert","qdrantCollection":{"__rl":true,"value":"FAQ_ru","mode":"list","cachedResultName":"FAQ_ru"},"options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStoreQdrant","typeVersion":1.3,"position":[704,-928],"id":"25906ee3-fb48-468f-8726-6e308e856d79","name":"Qdrant Vector Store1","credentials":{"qdrantApi":{"id":"fNPgHKKlwuj3CF1q","name":"QdrantLocal"}}},{"parameters":{"jsonMode":"expressionData","jsonData":"={{ $json.document }}","options":{"metadata":{"metadataValues":[{"name":"=source","value":"={{ $json.metadata.source }}"},{"name":"=faq_id","value":"={{ $json.metadata.faq_id }}"},{"name":"language","value":"={{ $json.metadata.language }}"},{"name":"category","value":"={{ $json.metadata.category }}"},{"name":"priority","value":"={{ $json.metadata.priority }}"},{"name":"updated_at_iso","value":"={{ $json.metadata.updated_at_iso }}"},{"name":"version_hint","value":"={{ $json.metadata.version_hint }}"},{"name":"doc_id","value":"={{ $json.metadata.doc_id }}"},{"name":"chunk_index","value":"={{ $json.metadata.chunk_index }}"},{"name":"chunk_count","value":"={{ $json.metadata.chunk_count }}"}]}}},"type":"@n8n/n8n-nodes-langchain.documentDefaultDataLoader","typeVersion":1.1,"position":[864,-736],"id":"b8f8547e-0717-411b-9ce7-6ae0ba9d631c","name":"Default Data Loader2"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[688,-704],"id":"68efc53c-363e-4142-83f6-6ad08e3efd5f","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[0,-880],"id":"c42bf041-58f5-4c4c-95ea-dd82389103b1","name":"When clicking ‘Execute workflow’"},{"parameters":{"options":{"systemMessage":"Отвечай на вопросы о созданий ботов и их возражения строго из векторной БД."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[368,-1584],"id":"62fefbad-d166-4127-8808-8a5ffb5e69dc","name":"AI Agent"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.3,"position":[128,-1584],"id":"f7422576-9adc-4094-b27d-5adfc0c5db2c","name":"When chat message received","webhookId":"d02c3df1-7d91-42c6-9e68-8d35485e9c7d"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[368,-1360],"id":"4e8caec0-804a-44b2-b2ca-66fd03170126","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"Для ответов на вопросы по Truffles","qdrantCollection":{"__rl":true,"value":"FAQ","mode":"list","cachedResultName":"FAQ"},"useReranker":true,"options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStoreQdrant","typeVersion":1.3,"position":[576,-1360],"id":"e9673fb3-c8a6-47fd-b1eb-06c18b83ed5a","name":"Qdrant Vector Store2","credentials":{"qdrantApi":{"id":"fNPgHKKlwuj3CF1q","name":"QdrantLocal"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[560,-1168],"id":"46cbe4d8-da01-46a9-b79e-7eaa762233b3","name":"Embeddings OpenAI3","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.rerankerCohere","typeVersion":1,"position":[720,-1152],"id":"fcaf5b77-265d-464c-a386-1dfbc96e5f9c","name":"Reranker Cohere","credentials":{"cohereApi":{"id":"UEi74BtUiaLhFbqj","name":"CohereApi account"}}},{"parameters":{"resource":"payload","operation":"payloadFacets","collectionName":{"__rl":true,"mode":"list","value":null},"requestOptions":{}},"type":"CUSTOM.qdrant","typeVersion":1,"position":[64,-480],"id":"b5cb0eb9-ee4d-4e59-b56a-dfd1f514cddd","name":"Get Payload Facets","credentials":{"qdrantRestApi":{"id":"oS8bZ0yQAPvYHZxw","name":"qdrant"}},"disabled":true},{"parameters":{"operation":"executeQuery","query":"UPDATE faq_items\nSET qdrant_indexed = TRUE,\n    embedding_version = COALESCE(embedding_version, 0) + 1,\n    updated_at = NOW()\nWHERE id = $1;","options":{"queryBatching":"independently","queryReplacement":"={{ $json.metadata.faq_id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1088,-928],"id":"d9dd5e04-5e21-4d43-a14d-0c1ba813a690","name":"Execute a SQL query1","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}}],"connections":{"Schedule Trigger (1s)":{"main":[[]]},"Embeddings OpenAI1":{"ai_embedding":[[]]},"Default Data Loader1":{"ai_document":[[]]},"Qdrant Vector Store":{"main":[[]]},"Recursive Character Text Splitter":{"ai_textSplitter":[[]]},"Loop Over Items":{"main":[[],[]]},"Wait":{"main":[[]]},"Get files":{"main":[[]]},"Download files":{"main":[[]]},"Delete Collection":{"main":[[]]},"Embeddings OpenAI2":{"ai_embedding":[[]]},"Default Data Loader":{"ai_document":[[]]},"Recursive Character Text Splitter1":{"ai_textSplitter":[[]]},"Download file":{"main":[[]]},"Edit Fields3":{"main":[[]]},"Delete Points":{"main":[[]]},"Execute a SQL query":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Qdrant Vector Store1","type":"main","index":0}]]},"Default Data Loader2":{"ai_document":[[{"node":"Qdrant Vector Store1","type":"ai_document","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Qdrant Vector Store1","type":"ai_embedding","index":0}]]},"When clicking ‘Execute workflow’":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"When chat message received":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Qdrant Vector Store2":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Embeddings OpenAI3":{"ai_embedding":[[{"node":"Qdrant Vector Store2","type":"ai_embedding","index":0}]]},"Reranker Cohere":{"ai_reranker":[[{"node":"Qdrant Vector Store2","type":"ai_reranker","index":0}]]},"Qdrant Vector Store1":{"main":[[{"node":"Execute a SQL query1","type":"main","index":0}]]},"Execute a SQL query1":{"main":[[]]}},"settings":{"executionOrder":"v1","timezone":"Asia/Almaty","callerPolicy":"workflowsFromSameOwner"},"staticData":{"node:Schedule Trigger (1s)":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Schedule Trigger (1s)":[{"json":{"timestamp":"2025-08-12T11:00:07.015+06:00","Readable date":"August 12th 2025, 11:00:07 am","Readable time":"11:00:07 am","Day of week":"Tuesday","Year":"2025","Month":"August","Day of month":"12","Hour":"11","Minute":"00","Second":"07","Timezone":"Asia/Almaty (UTC+06:00)"}}],"Code":[{"json":{"document":"Q: Это, наверное, будет дорого. У нас нет лишнего бюджета на автоматизацию. Окупится ли быстро?\n---\nA: Короткий ответ: Понимается важность бюджета: автоматизация снижает ручную нагрузку, повышает конверсию и окупает себя за счёт роста выручки и снижения издержек.\nРасширенный ответ: Это инвестиция в продажи и операционную эффективность: бот закрывает до 40–70% повторяющихся вопросов и заявок, освобождая менеджеров для «горячих» лидов и обеспечивая мгновенный ответ 24/7 без смен и простоев. Пилот за 1–2 недели покажет ваш фактический ROI: фиксируем базовые метрики, запускаем, сравниваем конверси","metadata":{"source":"faq_items","faq_id":10,"language":"ru","category":"objections","priority":100,"updated_at_iso":"2025-08-13T12:31:24.549Z","version_hint":"2025-08-13T12:31:24","doc_id":"faq-10-v2025-08-13T12:31:24-c1","chunk_index":1,"chunk_count":2}}},{"json":{"document":"т ваш фактический ROI: фиксируем базовые метрики, запускаем, сравниваем конверсию и долю автоответов — затем масштабируем.","metadata":{"source":"faq_items","faq_id":10,"language":"ru","category":"objections","priority":100,"updated_at_iso":"2025-08-13T12:31:24.549Z","version_hint":"2025-08-13T12:31:24","doc_id":"faq-10-v2025-08-13T12:31:24-c2","chunk_index":2,"chunk_count":2}}},{"json":{"document":"Q: У нас чувствительные данные. Как соблюдается конфиденциальность и требования платформ?\n---\nA: Короткий ответ: Храним минимально необходимые данные, работаем по согласию, соблюдаем конфиденциальность и политику WhatsApp.\nРасширенный ответ: Источник истины — PostgreSQL с разграничением прав и аудитом; есть экспорт данных по запросу и политика ретеншна. Qdrant хранит эмбеддинги корпоративных ответов, без избыточных персональных данных. Шаблоны WhatsApp проходят модерацию; секреты изолированы, трафик — по TLS.","metadata":{"source":"faq_items","faq_id":13,"language":"ru","category":"objections","priority":95,"updated_at_iso":"2025-08-13T12:31:24.549Z","version_hint":"2025-08-13T12:31:24","doc_id":"faq-13-v2025-08-13T12:31:24-c1","chunk_index":1,"chunk_count":1}}},{"json":{"document":"Q: Наши клиенты всё равно звонят — WhatsApp нам не нужен. Мы и так отвечаем быстро. Зачем бот?\n---\nA: Короткий ответ: Канал WhatsApp предпочитают для быстрого контакта — бот обеспечивает мгновенный ответ 24/7 и не мешает «живому» общению.\nРасширенный ответ: Даже при хорошей скорости операторов бот снимает 40–70% типовых обращений (цены, наличие, статусы, запись), сокращая очереди и потери конверсии в пике. Бот работает параллельно с людьми и передает «нестандартные» запросы менеджеру (handover); итоги — меньше пропусков и стабильная первичная обработка без роста штата.","metadata":{"source":"faq_items","faq_id":11,"language":"ru","category":"objections","priority":90,"updated_at_iso":"2025-08-13T12:31:24.549Z","version_hint":"2025-08-13T12:31:24","doc_id":"faq-11-v2025-08-13T12:31:24-c1","chunk_index":1,"chunk_count":1}}},{"json":{"document":"Q: Клиенты хотят разговаривать с человеком. Если бот не поймёт вопрос, потеряем заказ?\n---\nA: Короткий ответ: Бот следует сценариям и корпоративным ответам; если вопрос нестандартен — мгновенный перевод на человека.\nРасширенный ответ: Настраивается под ваши процессы и тон бренда; отвечает по утвержденной базе знаний (FAQ/Qdrant) и промптам с версионированием. При срабатывании порога/интента включается менеджер (handover), поэтому риск потерь минимизируется; диалоги и метрики сохраняются для улучшения качества.","metadata":{"source":"faq_items","faq_id":12,"language":"ru","category":"objections","priority":85,"updated_at_iso":"2025-08-13T12:31:24.549Z","version_hint":"2025-08-13T12:31:24","doc_id":"faq-12-v2025-08-13T12:31:24-c1","chunk_index":1,"chunk_count":1}}},{"json":{"document":"Q: Кто будет вести бота после запуска? Нас интересуют обновления и скорость реакции.\n---\nA: Короткий ответ: Поддержка возможна вашей командой или нашей — гибкая модель обслуживания.\nРасширенный ответ: SLA включает обновления FAQ и промптов без редеплоя (через БД), мониторинг метрик, быстрые исправления и адаптацию под акции/сезонность. Эмбеддинги пересчитываются и загружаются в Qdrant автоматически, что ускоряет внедрение изменений.","metadata":{"source":"faq_items","faq_id":14,"language":"ru","category":"objections","priority":80,"updated_at_iso":"2025-08-13T12:31:24.549Z","version_hint":"2025-08-13T12:31:24","doc_id":"faq-14-v2025-08-13T12:31:24-c1","chunk_index":1,"chunk_count":1}}}]},"versionId":"fdbf408e-bf75-4299-bba6-56eae9f56e44","triggerCount":1,"shared":[{"updatedAt":"2025-11-27T21:18:18.259Z","createdAt":"2025-11-27T21:18:18.259Z","role":"workflow:owner","workflowId":"WYTuwxwHUxwdzsSQ","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-07-26T06:32:19.344Z","createdAt":"2025-07-26T06:32:19.344Z","id":"f9pxFf0ryND9GzXC","name":"dev"}]},{"updatedAt":"2025-11-30T10:05:12.549Z","createdAt":"2025-08-14T11:06:55.815Z","id":"OZpin9I5JiKP1oon","name":"cronUpdateDocs","active":false,"isArchived":false,"nodes":[{"parameters":{"operation":"executeQuery","query":"SELECT id, question, answer, language, category, priority, updated_at\nFROM faq_items\nWHERE active = TRUE\nAND language = 'ru'\nAND (qdrant_point_id IS NULL OR updated_at > NOW() - INTERVAL '1 day')\nORDER BY priority DESC, updated_at DESC\nLIMIT {{ $json.limit || 500 }}; ","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[208,-880],"id":"8ff7393c-a4fe-47da-9413-c1aceb58164e","name":"Execute a SQL query","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"jsCode":"/**\n * n8n Code node: Build chunks/documents for embeddings from Postgres rows (faq_items).\n * Input: items[].json must contain { id, question, answer, language, category, priority, updated_at }\n * Output: one item per chunk with:\n *   json: {\n *     document: \"<chunk text>\",\n *     metadata: {\n *       faq_id, language, category, priority, updated_at_iso, version_hint, source, doc_id, chunk_index, chunk_count\n *     }\n *   }\n *\n * Notes:\n * - Chunking: fixed length 600 chars, overlap 80 chars (good for RU long-form).\n * - doc_id is stable per chunk: `faq-{id}-v{version}-{chunkIndex}`\n * - version_hint derived from updated_at (ISO date) to invalidate old points.\n * - Keep only ASCII keys in metadata for portability across vector DBs.\n */\n\nfunction normalizeLang(lang) {\n  const s = String(lang || '').trim().toLowerCase();\n  if (s.startsWith('ru')) return 'ru';\n  if (s.startsWith('en')) return 'en';\n  if (s.startsWith('kz') || s.startsWith('kk')) return 'kk';\n  return 'ru'; // default\n}\n\nfunction ensureString(x) {\n  if (x == null) return '';\n  return typeof x === 'string' ? x : String(x);\n}\n\nfunction toIso(dt) {\n  try {\n    if (!dt) return null;\n    const d = new Date(dt);\n    if (isNaN(d.getTime())) return null;\n    return d.toISOString();\n  } catch {\n    return null;\n  }\n}\n\nfunction buildPassport(row) {\n  const q = (ensureString(row.question) || '').trim();\n  const a = (ensureString(row.answer) || '').trim();\n\n  // Header + body: keep both Q and A to improve retrieval\n  // The separators help LLM/vectorizer distinguish fields.\n  let blocks = [];\n  if (q) blocks.push(`Q: ${q}`);\n  if (a) blocks.push(`A: ${a}`);\n  const text = blocks.join('\\n\\n---\\n\\n');\n\n  return text.replace(/\\s+\\n/g, '\\n').replace(/\\n{3,}/g, '\\n\\n').trim();\n}\n\nfunction chunkText(text, chunkSize = 600, overlap = 80) {\n  const chunks = [];\n  const len = text.length;\n  if (len <= chunkSize) return [text];\n\n  let start = 0;\n  while (start < len) {\n    const end = Math.min(start + chunkSize, len);\n    const cut = text.slice(start, end);\n    chunks.push(cut);\n    if (end === len) break;\n    start = end - overlap;\n    if (start < 0) start = 0;\n  }\n  return chunks;\n}\n\nconst out = [];\nfor (const item of items) {\n  const row = item.json || {};\n  const id = row.id;\n  // Validate essentials\n  if (id == null) continue;\n\n  const language = normalizeLang(row.language);\n  const category = ensureString(row.category || 'general');\n  const priority = Number.isFinite(Number(row.priority)) ? Number(row.priority) : 0;\n  const updatedIso = toIso(row.updated_at) || new Date().toISOString();\n\n  // Build full text passport\n  const text = buildPassport(row);\n  if (!text) continue;\n\n  // Chunking\n  const CHUNK_SIZE = 600;\n  const OVERLAP = 80;\n  const chunks = chunkText(text, CHUNK_SIZE, OVERLAP);\n  const chunkCount = chunks.length;\n\n  // Version hint to bust old vectors (derived from date only for stability)\n  const versionHint = updatedIso.slice(0, 19); // YYYY-MM-DDTHH:mm:ss\n\n  // Emit per-chunk items\n  for (let i = 0; i < chunkCount; i++) {\n    const docId = `faq-${id}-v${versionHint}-c${i + 1}`;\n    out.push({\n      json: {\n        document: chunks[i],\n        metadata: {\n          source: 'faq_items',\n          faq_id: id,\n          language,\n          category,\n          priority,\n          updated_at_iso: updatedIso,\n          version_hint: versionHint,\n          doc_id: docId,\n          chunk_index: i + 1,\n          chunk_count: chunkCount,\n        },\n      },\n    });\n  }\n}\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[416,-896],"id":"f04f2037-553d-4e5e-9bba-0ae4bb1151dc","name":"Code"},{"parameters":{"mode":"insert","qdrantCollection":{"__rl":true,"value":"truffles_knowledge","mode":"list","cachedResultName":"truffles_knowledge"},"options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStoreQdrant","typeVersion":1.3,"position":[704,-928],"id":"4898ab96-86c2-41cf-868d-9fbce1d00d57","name":"Qdrant Vector Store1","credentials":{"qdrantApi":{"id":"fNPgHKKlwuj3CF1q","name":"QdrantLocal"}}},{"parameters":{"jsonMode":"expressionData","jsonData":"={{ $json.document }}","options":{"metadata":{"metadataValues":[{"name":"=source","value":"={{ $json.metadata.source }}"},{"name":"=faq_id","value":"={{ $json.metadata.faq_id }}"},{"name":"language","value":"={{ $json.metadata.language }}"},{"name":"category","value":"={{ $json.metadata.category }}"},{"name":"priority","value":"={{ $json.metadata.priority }}"},{"name":"updated_at_iso","value":"={{ $json.metadata.updated_at_iso }}"},{"name":"version_hint","value":"={{ $json.metadata.version_hint }}"},{"name":"doc_id","value":"={{ $json.metadata.doc_id }}"},{"name":"chunk_index","value":"={{ $json.metadata.chunk_index }}"},{"name":"chunk_count","value":"={{ $json.metadata.chunk_count }}"}]}}},"type":"@n8n/n8n-nodes-langchain.documentDefaultDataLoader","typeVersion":1.1,"position":[864,-736],"id":"7e243b00-12f0-4929-a967-c2adabff6f48","name":"Default Data Loader2"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[688,-704],"id":"9032339c-c4bd-4b17-abc9-4cb9576856fa","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[0,-880],"id":"4f3ae70f-39d1-497d-8c6c-f2f047a5f7b3","name":"When clicking ‘Execute workflow’"},{"parameters":{"operation":"executeQuery","query":"UPDATE faq_items\nSET qdrant_indexed = TRUE,\n    embedding_version = COALESCE(embedding_version, 0) + 1,\n    updated_at = NOW()\nWHERE id = $1;","options":{"queryBatching":"independently","queryReplacement":"={{ $json.metadata.faq_id }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1088,-928],"id":"6b395faa-547b-4f28-b2ad-d1756e9aa988","name":"Execute a SQL query1","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}}],"connections":{"Execute a SQL query":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Qdrant Vector Store1","type":"main","index":0}]]},"Default Data Loader2":{"ai_document":[[{"node":"Qdrant Vector Store1","type":"ai_document","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Qdrant Vector Store1","type":"ai_embedding","index":0}]]},"When clicking ‘Execute workflow’":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}]]},"Qdrant Vector Store1":{"main":[[{"node":"Execute a SQL query1","type":"main","index":0}]]},"Execute a SQL query1":{"main":[[]]}},"settings":{"executionOrder":"v1","timezone":"Asia/Almaty","callerPolicy":"workflowsFromSameOwner"},"staticData":{"node:Schedule Trigger (1s)":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"8b5edac7-c6b4-4e76-b056-52ecd60de916","triggerCount":1,"shared":[{"updatedAt":"2025-11-27T21:18:18.259Z","createdAt":"2025-11-27T21:18:18.259Z","role":"workflow:owner","workflowId":"OZpin9I5JiKP1oon","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-11-27T06:22:27.418Z","createdAt":"2025-11-24T15:59:35.000Z","id":"truffles-chatbot-tag","name":"truffles-chatbot"}]},{"updatedAt":"2025-11-29T14:48:00.709Z","createdAt":"2025-11-29T11:19:56.823Z","id":"VhlJJVJ2VOcySALy","name":"1_Webhook","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"flow","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1200,160],"id":"8f365249-8ecd-4a88-a149-84b2cf2ad093","name":"Webhook","webhookId":"a29b2ad2-9485-476c-897d-34799c3f940b"},{"parameters":{"workflowId":{"__rl":true,"value":"EbIsyt4wKVyij9Hl","mode":"list","cachedResultUrl":"/workflow/EbIsyt4wKVyij9Hl","cachedResultName":"2_Parse/ChannelRouter"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-80,64],"name":"Call Parse/Router","id":"a578209b-068c-42bc-804b-0d2240a3de7f"},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot7730378933:AAHG1lZY6u6AmvNDF7DT29veuXUDu8EeqIc/setWebhook?url=https://n8n.truffles.kz/webhook/flow","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1200,-160],"id":"e22013ff-0fac-4624-a137-da798853155e","name":"HTTP Request1","disabled":true},{"parameters":{"operation":"get","propertyName":"messageID","key":"=msg:{{ $json.body.metadata.messageId }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-976,160],"id":"7d763d9b-0019-416a-9686-6732a2d661a6","name":"Redis","credentials":{"redis":{"id":"xMdLG7kqWMMoPY0M","name":"Local"}}},{"parameters":{"options":{"responseCode":200,"responseKey":"Duplicate"}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[-528,256],"id":"62708c9e-d401-46eb-9f26-7cc17e602a70","name":"Respond to Webhook","disabled":true},{"parameters":{"operation":"set","key":"=msg:{{ $('Webhook').item.json.body.metadata.messageId }}","value":"1","expire":true,"ttl":86400},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-528,64],"id":"fd507571-06ba-4965-9b23-2090cf0b4fd3","name":"setMessageID","credentials":{"redis":{"id":"xMdLG7kqWMMoPY0M","name":"Local"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a91adacb-32e0-4398-acc4-66b486edea73","leftValue":"={{ $json.messageID }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-752,160],"id":"0a544ba0-208a-4dd4-82d9-238e5f2645d1","name":"MessageIDisEmpty"},{"parameters":{"assignments":{"assignments":[{"id":"24b85b43-45a5-455a-b4d8-5db297815e14","name":"headers","value":"={{ $('Webhook').item.json.headers }}","type":"object"},{"id":"39fc38c1-5b33-46e7-8be4-b3e55d8969a0","name":"body","value":"={{ $('Webhook').item.json.body }}","type":"object"},{"id":"dc5273eb-e768-429f-a66a-a7eb34cb2a10","name":"query","value":"={{ $('Webhook').item.json.query }}","type":"object"},{"id":"9850b125-6bf9-4d51-bba5-ecbe4b7618a5","name":"params","value":"={{ $('Webhook').item.json.params }}","type":"object"},{"id":"cd435e83-70ac-43f4-b379-565904bed2f5","name":"webhookUrl","value":"={{ $('Webhook').item.json.webhookUrl }}","type":"string"},{"id":"35959873-cc8f-4e48-bf20-a788b65f838f","name":"executionMode","value":"={{ $('Webhook').item.json.executionMode }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-304,64],"id":"9a8c93e9-b930-4394-badb-cf16a813d2e2","name":"Restore Webhook Data"}],"connections":{"Webhook":{"main":[[{"node":"Redis","type":"main","index":0}]]},"Redis":{"main":[[{"node":"MessageIDisEmpty","type":"main","index":0}]]},"setMessageID":{"main":[[{"node":"Restore Webhook Data","type":"main","index":0}]]},"MessageIDisEmpty":{"main":[[{"node":"setMessageID","type":"main","index":0}],[{"node":"Respond to Webhook","type":"main","index":0}]]},"Restore Webhook Data":{"main":[[{"node":"Call Parse/Router","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":true},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"n8n.truffles.kz","user-agent":"axios/1.11.0","content-length":"268","accept":"application/json, text/plain, */*","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","x-forwarded-for":"144.91.105.72","x-forwarded-host":"n8n.truffles.kz","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"68926a3e1a32","x-real-ip":"144.91.105.72"},"params":{},"query":{},"body":{"messageType":"text","message":"Go","metadata":{"sender":"Zh.","timestamp":1764425276,"messageId":"3F121F3E5B2F0A1FF2AC","remoteJid":"77015705555@s.whatsapp.net"},"mediaData":null,"nodeData":{"webHook":{"text":"https://n8n.truffles.kz/webhook/flow","method":"POST"}}},"webhookUrl":"https://n8n.truffles.kz/webhook/flow","executionMode":"production"}}]},"versionId":"59fccadc-efbd-4674-90b5-01d2a86e12f8","triggerCount":1,"shared":[{"updatedAt":"2025-11-29T11:19:56.823Z","createdAt":"2025-11-29T11:19:56.823Z","role":"workflow:owner","workflowId":"VhlJJVJ2VOcySALy","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-11-27T06:22:27.418Z","createdAt":"2025-11-24T15:59:35.000Z","id":"truffles-chatbot-tag","name":"truffles-chatbot"}]},{"updatedAt":"2025-11-30T13:42:33.936Z","createdAt":"2025-11-29T11:19:15.942Z","id":"YvEadsCd8Rg5yxu8","name":"3_WhatsApp Adapter","active":false,"isArchived":false,"nodes":[{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\":\"object\",\n  \"properties\":{\n    \"offers\":{\n      \"type\":\"array\",\n      \"items\":{\n        \"type\":\"object\",\n        \"properties\":{\n          \"name\":{\"type\":\"string\"},\n          \"who_for\":{\"type\":\"string\"},\n          \"scope\":{\"type\":\"string\"},\n          \"stack\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n          \"integrations\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n          \"timeline_range\":{\"type\":\"string\"},\n          \"budget_range\":{\"type\":\"string\"},\n          \"risks\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n          \"requirements\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n          \"cta\":{\"type\":\"string\"}\n        },\n        \"required\":[\"name\",\"scope\",\"cta\"]\n      }\n    },\n    \"summary_for_manager\":{\"type\":[\"string\",\"null\"]}\n  },\n  \"required\":[\"offers\"]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-4064,656],"id":"28e5ec52-7b4d-4c45-bd63-530f9532c7d6","name":"Structured Output Parser1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Start/NormalizeMedia').item.json.event.channel }}","rightValue":"whatsapp","operator":{"type":"string","operation":"equals"},"id":"whatsapp-out-cond"}],"combinator":"and"},"renameOutput":true,"outputKey":"whatsapp"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Start/NormalizeMedia').item.json.event.channel }}","rightValue":"telegram","operator":{"type":"string","operation":"equals"},"id":"telegram-out-cond"}],"combinator":"and"},"renameOutput":true,"outputKey":"telegram"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-3472,224],"id":"f8c66e6e-cab3-475a-84de-a2f079bb0712","name":"Output Router"},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6InRydWZmbGVzLWNoYXRib3QifQ=="},{"name":"jid","value":"={{ $('Start/NormalizeMedia').item.json.event.metadata.remoteJid }}"},{"name":"msg","value":"={{ $json.content }}"}]},"options":{}},"name":"Send WhatsApp","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3024,128],"id":"1519e8e8-2645-4ea6-be33-eacda9adfcbd"},{"parameters":{"method":"POST","url":"https://api.telegram.org/botYOUR_TELEGRAM_BOT_TOKEN/sendMessage","sendBody":true,"bodyParameters":{"parameters":[{"name":"chat_id","value":"={{ $json.event.metadata.chat_id }}"},{"name":"text","value":"={{ $json.output }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3248,320],"id":"6292c936-5631-4183-bd07-bf0f8ac38cb9","name":"Send Telegram"},{"parameters":{"description":"Передаю менеджеру полный контекст и возвращаю handover_id/status; триггеры: просьба менеджера, готовность к пилоту, ≥3 уточнений без прогресса, серьёзная жалоба","workflowId":{"__rl":true,"value":"EHa0JpHbLxvErT9y","mode":"list","cachedResultUrl":"/workflow/EHa0JpHbLxvErT9y","cachedResultName":"tool_Handover"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[{"id":"event_message","displayName":"event_message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"output_intention","displayName":"output_intention","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"body_metadata_remoteJid","displayName":"body_metadata_remoteJid","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-5120,448],"id":"6d166306-ffd2-4e1f-908d-a9519ac7b7c1","name":"Handover"},{"parameters":{"promptType":"define","text":"={{ $json.event.message }}","options":{"systemMessage":"Ты Sales Orchestrator компании Truffles. Цель: вести диалог от первого сообщения до передачи менеджеру, отвечать по фактам о Truffles, консультировать по созданию/внедрению/оптимизации чат‑ботов, считать поверхностный ROI, отрабатывать возражения, допродавать и всегда завершать конкретным CTA.\nПравила:\n- Факт‑чек: всё о Truffles (услуги, кейсы, процессы, политики) — только через инструмент Facts RAG; при низкой уверенности — честный отказ и предложение менеджера/пилота.\n- Язык: автоопределение ru/kk/en; по умолчанию ru; отвечай на языке клиента.\n- Discovery: BANT+контекст (use_case, features, integrations, volume, platforms). За ход — 1 точечный вопрос, без повторов. Остановись, когда данных достаточно для оффера/ROI или клиент готов к пилоту/менеджеру.\n- Next Best Action: на каждом шаге выбери одно: 1) Facts RAG, 2) уточняющий вопрос, 3) ROI Estimator, 4) Offer Builder, 5) Objection Handler, 6) Handover.\n- ROI: только с консервативными допущениями и явными формулами; без точных обещаний без метрик; если не хватает данных — 1 ключевой вопрос.\n- Продажи: при неопределённости предлагай упрощённый пакет/пилот/рассрочку/скидку в рамках политики; всегда CTA (созвон 15 мин / пилот X недель / бесплатный аудит).\n- Стоп‑критерии: явная просьба менеджера, готовность к пилоту, ≥3 уточнений подряд без прогресса, серьёзная жалоба → Handover с полным контекстом.\nФормат ответа клиенту: кратко, по делу, без воды. Не выдумывай факты о Truffles — используй только то, что пришло из Facts RAG."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-5104,224],"id":"cd684ec9-576b-4dc9-8dfc-ed00b7aaf296","name":"Sales Orchestrator"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-4784,656],"id":"edea9c59-8435-4ac0-9812-fd9bb3cd1319","name":"OpenAI Chat Model3","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.rerankerCohere","typeVersion":1,"position":[-4272,656],"id":"c96f873d-f84d-4d85-89c0-d6e890080cde","name":"Reranker Cohere2","credentials":{"cohereApi":{"id":"UEi74BtUiaLhFbqj","name":"CohereApi account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[-4448,656],"id":"fb665b23-d9ef-407c-8cc8-9848386ce44a","name":"Embeddings OpenAI1","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Start/NormalizeMedia').item.json.event.metadata.remoteJid }}"},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[-5248,448],"id":"3b3f04d8-ce3a-4f5e-912f-0c0f7abbda14","name":"Redis Chat Memory3","credentials":{"redis":{"id":"xMdLG7kqWMMoPY0M","name":"Local"}}},{"parameters":{"toolDescription":"Извлекаю из последней реплики и контекста профиль лида: business_type, use_case, features[], integrations[], budget_number, currency (KZT по умолчанию при отсутствии знака), urgency, timeline, volume, platforms[], language_hint, sentiment, objection_type; возвращаю только явно сказанное; формат — строгий JSON","text":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}","hasOutputParser":true,"options":{}},"type":"@n8n/n8n-nodes-langchain.agentTool","typeVersion":2.2,"position":[-4992,448],"id":"881f83d6-838d-41d3-b39f-a66777cd59c7","name":"Business Extractor"},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"Документы о компании Truffles: услуги, процессы, политики, публичные факты, кейсы и оффер‑шаблоны с источниками; использовать для любых фактологических ответов о Truffles","qdrantCollection":{"__rl":true,"value":"FAQ_ru","mode":"list","cachedResultName":"FAQ_ru"},"useReranker":true,"options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStoreQdrant","typeVersion":1.3,"position":[-4704,448],"id":"b505fe2f-6e73-4c16-a9eb-d83191fb34db","name":"Facts RAG (Truffles)","credentials":{"qdrantApi":{"id":"fNPgHKKlwuj3CF1q","name":"QdrantLocal"}}},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"business_type\": {\"type\": [\"string\",\"null\"]},\n    \"use_case\": {\"type\": [\"string\",\"null\"]},\n    \"features\": {\"type\": \"array\",\"items\":{\"type\":\"string\"}},\n    \"integrations\": {\"type\": \"array\",\"items\":{\"type\":\"string\"}},\n    \"budget_number\": {\"type\": [\"number\",\"null\"]},\n    \"currency\": {\"type\": [\"string\",\"null\"], \"enum\": [\"KZT\",\"RUB\",\"USD\",\"EUR\",null]},\n    \"urgency\": {\"type\": [\"string\",\"null\"], \"enum\": [\"low\",\"medium\",\"high\",null]},\n    \"timeline\": {\"type\": [\"string\",\"null\"]},\n    \"volume\": {\"type\": [\"string\",\"null\"]},\n    \"platforms\": {\"type\": \"array\",\"items\":{\"type\":\"string\"}},\n    \"language_hint\": {\"type\": [\"string\",\"null\"], \"enum\": [\"ru\",\"kk\",\"en\",null]},\n    \"sentiment\": {\"type\": [\"string\",\"null\"], \"enum\": [\"positive\",\"neutral\",\"negative\",null]},\n    \"objection_type\": {\"type\": [\"string\",\"null\"], \"enum\": [\"price\",\"timing\",\"quality\",\"other\",null]}\n  },\n  \"required\": [\"features\",\"integrations\",\"platforms\"]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-4576,656],"id":"fb84d25e-b3ae-41fa-a16b-3f4c4fb613ea","name":"Structured Output Parser"},{"parameters":{"text":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}","hasOutputParser":true,"options":{"systemMessage":"Формирую 2–3 варианта решения (Lite/Standard/Advanced) по данным профиля: этапы Discovery→MVP→Production, стек, интеграции, диапазоны сроков/бюджета, риски, требования, CTA; при недостатке данных — предлагаю Lite/пилот и 1 ключевой вопрос"}},"type":"@n8n/n8n-nodes-langchain.agentTool","typeVersion":2.2,"position":[-4416,448],"id":"c3316e8b-d7a8-41ca-8cfa-a94d0e1aa6e4","name":"Offer Builder"},{"parameters":{"toolDescription":"Считаю ориентир ROI и срок окупаемости чат‑бота из входных метрик; использую консервативные допущения; если ключевых метрик нет — возвращаю 1 понятный вопрос для уточнения","text":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}","hasOutputParser":true,"options":{}},"type":"@n8n/n8n-nodes-langchain.agentTool","typeVersion":2.2,"position":[-4128,448],"id":"6fb91afc-b1ab-4b13-a45a-4ecd8465253c","name":"ROI Estimator"},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\":\"object\",\n  \"properties\":{\n    \"assumptions\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n    \"formulas\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n    \"roi_point_estimate\":{\"type\":[\"number\",\"null\"]},\n    \"roi_range\":{\"type\":\"array\",\"items\":{\"type\":\"number\"}},\n    \"payback_weeks\":{\"type\":[\"number\",\"null\"]},\n    \"missing_inputs\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n    \"next_question\":{\"type\":[\"string\",\"null\"]}\n  },\n  \"required\":[\"assumptions\",\"formulas\",\"missing_inputs\"]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-3872,656],"id":"c7e031cc-a9b7-43c8-a419-b4a8e6fb52be","name":"Structured Output Parser2"},{"parameters":{"toolDescription":"Классифицирую возражение и выдаю пошаговый ответ: эмпатия → факт/сравнение → перефрейминг → микро‑оффер (пилот/POC/модуль/скидка в политике) → CTA; при токсичности — мягкая деэскалация","text":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}","hasOutputParser":true,"options":{}},"type":"@n8n/n8n-nodes-langchain.agentTool","typeVersion":2.2,"position":[-3840,448],"id":"a173274a-36f2-410b-9291-39e576ce4236","name":"Objection Handler"},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\":\"object\",\n  \"properties\":{\n    \"objection_type\":{\"type\":\"string\",\"enum\":[\"price\",\"timing\",\"quality\",\"other\"]},\n    \"response_steps\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n    \"needs_manager\":{\"type\":[\"boolean\",\"null\"]}\n  },\n  \"required\":[\"objection_type\",\"response_steps\"]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-3744,656],"id":"56fcaff3-52c7-4bad-9422-01682abeac15","name":"Structured Output Parser3"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"messages","mode":"list","cachedResultName":"messages"},"columns":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('Start').item.json.user_id }}","session_id":"={{ $('Start/NormalizeMedia').item.json.event.session_id}}","role":"assistant","content":"={{ $json.output }}","channel":"whatsapp"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_id","displayName":"user_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"role","displayName":"role","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"content","displayName":"content","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"intent","displayName":"intent","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"confidence","displayName":"confidence","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"timestamp","displayName":"timestamp","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"metadata","displayName":"metadata","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true},{"id":"channel","displayName":"channel","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3248,128],"id":"4127ce17-285d-4e78-92ed-13ffeb225de1","name":"SaveOutboundMessage","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"prompts","mode":"list","cachedResultName":"prompts"},"where":{"values":[{"column":"name","value":"greeting_initial"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4144,-1184],"id":"697caa3b-b965-4a5d-8ae0-26f90d250e25","name":"GetGreetingPrompt","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.intent }}","rightValue":"greeting","operator":{"type":"string","operation":"equals"},"id":"14b13864-8b3e-4557-94f1-525ed654608d"}],"combinator":"and"},"renameOutput":true,"outputKey":"greeting"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eaeab4fe-a22d-4431-8d2e-377a62782123","leftValue":"={{ $json.intent }}","rightValue":"=^(question_service|question_pricing|question_technical)$","operator":{"type":"string","operation":"regex"}}],"combinator":"and"},"renameOutput":true,"outputKey":"question_service"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"083f36a2-a26b-48df-8e5c-13575759da2c","leftValue":"={{ $json.intent }}","rightValue":"^(complaint|ready_to_buy|request_manager)$","operator":{"type":"string","operation":"regex"}}],"combinator":"and"},"renameOutput":true,"outputKey":"complaint"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2a0d1e7d-8517-4a83-8254-b3db7de23454","leftValue":"={{ $json.intent }}","rightValue":"^off_topic$","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"off_topic"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[-4768,-832],"id":"8d46933c-71a8-4ebc-a7f5-4679ea0c9e28","name":"Intent Switch"},{"parameters":{"workflowId":{"__rl":true,"value":"Z25LwErPnfzIIDb4","mode":"list","cachedResultUrl":"/workflow/Z25LwErPnfzIIDb4","cachedResultName":"5_ClassifyIntent"},"workflowInputs":{"mappingMode":"defineBelow","value":{"message":"={{ $json.event.message }}","session_id":"={{ $json.event.session_id }}","user_id":"={{ $json.event.user_id }}"},"matchingColumns":[],"schema":[{"id":"message","displayName":"message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"session_id","displayName":"session_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"user_id","displayName":"user_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-5328,-784],"id":"af53c7e1-2df6-4ab9-ac46-8ee4711fa518","name":"Call ClassifyIntent"},{"parameters":{"workflowId":{"__rl":true,"value":"58WFmPNitSNIwbes","mode":"list","cachedResultUrl":"/workflow/58WFmPNitSNIwbes","cachedResultName":"4_NormalizeWhatsapp"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-5520,-800],"name":"Start/NormalizeMedia","id":"b23ab226-9d1e-4cd6-9675-e77947195b5f"},{"parameters":{"assignments":{"assignments":[{"id":"020aa299-5b56-48bb-8acc-1ce7c8ec4ad3","name":"output","value":"={{ $json.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3856,-1184],"id":"b424bda1-c66d-4ec9-9e21-2c53f5aee191","name":"Edit Fields"},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6InRydWZmbGVzLWNoYXRib3QifQ=="},{"name":"jid","value":"={{ $('Merge').item.json.metadata.remoteJid }}"},{"name":"msg","value":"={{ $json.content }}"}]},"options":{}},"name":"Send WhatsApp1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3248,-1184],"id":"6efe0aaf-3834-4584-a0e9-d667181e90b1"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"messages","mode":"list","cachedResultName":"messages"},"columns":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('Merge').item.json.user_id }}","session_id":"={{ $('Merge').item.json.session_id }}","role":"assistant","content":"={{ $json.output }}","channel":"whatsapp","intent":"={{ $('Intent Switch').item.json.intent }}","confidence":"={{ $('Intent Switch').item.json.confidence }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_id","displayName":"user_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"role","displayName":"role","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"content","displayName":"content","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"intent","displayName":"intent","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"confidence","displayName":"confidence","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"timestamp","displayName":"timestamp","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"metadata","displayName":"metadata","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true},{"id":"channel","displayName":"channel","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3552,-1184],"id":"59908a8c-11e4-484f-ab9c-f5efd42bb2a5","name":"SaveOutboundMessage1","executeOnce":true,"credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-5744,-800],"id":"12d23074-6404-4c56-b776-c4a5b477c57a","name":"Start"},{"parameters":{"workflowId":{"__rl":true,"value":"EHa0JpHbLxvErT9y","mode":"list","cachedResultUrl":"/workflow/EHa0JpHbLxvErT9y","cachedResultName":"tool_Handover"},"workflowInputs":{"mappingMode":"defineBelow","value":{"event_message":"={{ $('Start/NormalizeMedia').item.json.event.message }}","output_intention":"={{ $('Call ClassifyIntent').item.json.intent }}","body_metadata_remoteJid":"={{ $('Start/NormalizeMedia').item.json.event.session_id }}"},"matchingColumns":[],"schema":[{"id":"event_message","displayName":"event_message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"output_intention","displayName":"output_intention","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"body_metadata_remoteJid","displayName":"body_metadata_remoteJid","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-4144,-992],"id":"e29a16db-4042-45f4-8be5-e49b999c7d96","name":"Call 'tool_Handover'"},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6InRydWZmbGVzLWNoYXRib3QifQ=="},{"name":"jid","value":"={{ $('Start/NormalizeMedia').item.json.event.metadata.remoteJid }}"},{"name":"msg","value":"={{ $json.content }}"}]},"options":{}},"name":"Send WhatsApp2","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3504,-992],"id":"25e1bc12-6fc1-443a-96a9-aa0d111871c2"},{"parameters":{"assignments":{"assignments":[{"id":"020aa299-5b56-48bb-8acc-1ce7c8ec4ad3","name":"output","value":"={{ $json.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3856,-800],"id":"2b5362f9-c29c-4b6f-86e6-d921a30209a9","name":"Edit Fields1"},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6InRydWZmbGVzLWNoYXRib3QifQ=="},{"name":"jid","value":"={{ $('Start/NormalizeMedia').item.json.event.metadata.remoteJid }}"},{"name":"msg","value":"={{ $json.content }}"}]},"options":{}},"name":"Send WhatsApp4","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3216,-800],"id":"16b8e8d8-c665-4318-a4d9-633310cde437"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"messages","mode":"list","cachedResultName":"messages"},"columns":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('Start/NormalizeMedia').item.json.event.user_id }}","session_id":"={{ $('Start/NormalizeMedia').item.json.event.session_id }}","role":"assistant","content":"={{ $json.output }}","channel":"whatsapp","intent":"={{ $('Intent Switch').item.json.intent }}","confidence":"={{ $('Intent Switch').item.json.confidence }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_id","displayName":"user_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"role","displayName":"role","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"content","displayName":"content","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"intent","displayName":"intent","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"confidence","displayName":"confidence","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"timestamp","displayName":"timestamp","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"metadata","displayName":"metadata","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true},{"id":"channel","displayName":"channel","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3504,-800],"id":"93d3df20-36b5-40ed-ba53-8dde2e5c10ef","name":"SaveOutboundMessage3","executeOnce":true,"credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"assignments":{"assignments":[{"id":"020aa299-5b56-48bb-8acc-1ce7c8ec4ad3","name":"output","value":"={{ $json.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3856,-608],"id":"636e6e0a-fb73-482c-a5ce-bc294340f358","name":"Edit Fields2"},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6InRydWZmbGVzLWNoYXRib3QifQ=="},{"name":"jid","value":"={{ $('Start/NormalizeMedia').item.json.event.metadata.remoteJid }}"},{"name":"msg","value":"={{ $json.content }}"}]},"options":{}},"name":"Send WhatsApp5","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3216,-608],"id":"41b78804-7957-42b2-ab8e-8dfe61cd0fe3"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"messages","mode":"list","cachedResultName":"messages"},"columns":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('Start/NormalizeMedia').item.json.event.user_id }}","session_id":"={{ $('Start/NormalizeMedia').item.json.event.session_id }}","role":"assistant","content":"={{ $json.output }}","channel":"whatsapp","intent":"={{ $('Intent Switch').item.json.intent }}","confidence":"={{ $('Intent Switch').item.json.confidence }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_id","displayName":"user_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"role","displayName":"role","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"content","displayName":"content","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"intent","displayName":"intent","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"confidence","displayName":"confidence","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"timestamp","displayName":"timestamp","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"metadata","displayName":"metadata","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true},{"id":"channel","displayName":"channel","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3504,-608],"id":"6a700030-782f-475e-bde9-ba868f794010","name":"SaveOutboundMessage4","executeOnce":true,"credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"model":"text-embedding-ada-002","options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[-3856,-96],"id":"152cdcdd-2ac2-4495-a8d6-860f368f5f25","name":"Embeddings OpenAI2","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{"mode":"load","qdrantCollection":{"__rl":true,"value":"FAQ_ru","mode":"list","cachedResultName":"FAQ_ru"},"prompt":"={{ $('Start/NormalizeMedia').item.json.event.message }}","topK":5,"options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStoreQdrant","typeVersion":1.3,"position":[-3920,-320],"id":"e557d44d-9ace-4abb-9017-f43ef570c21d","name":"Qdrant Vector Store","credentials":{"qdrantApi":{"id":"fNPgHKKlwuj3CF1q","name":"QdrantLocal"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"prompts","mode":"list","cachedResultName":"prompts"},"where":{"values":[{"column":"name","value":"response_generator"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4144,-320],"id":"27b35214-7e29-4920-a9b7-f3a040124131","name":"GetResponsePrompt","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"prompts","mode":"list","cachedResultName":"prompts"},"where":{"values":[{"column":"name","value":"fallback_default"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4144,-800],"id":"90e53400-0281-4c24-8b21-4a9c4c05e9be","name":"GetFallbackPrompt","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"prompts","mode":"list","cachedResultName":"prompts"},"where":{"values":[{"column":"name","value":"clarification_needed"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-4144,-608],"id":"18ceff7c-805a-4184-96ca-0bea45c90d3c","name":"GetClarificationPrompt","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"messages","mode":"list","cachedResultName":"messages"},"columns":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('Start/NormalizeMedia').item.json.event.user_id }}","session_id":"={{ $('Start/NormalizeMedia').item.json.event.session_id }}","role":"assistant","content":"={{ $('Start/NormalizeMedia').item.json.event.message }}","channel":"whatsapp","confidence":"={{ $('Intent Switch').item.json.confidence }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_id","displayName":"user_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"role","displayName":"role","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"content","displayName":"content","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"intent","displayName":"intent","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"confidence","displayName":"confidence","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"timestamp","displayName":"timestamp","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"metadata","displayName":"metadata","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true},{"id":"channel","displayName":"channel","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3856,-992],"id":"fa3d76bc-1ed2-4af8-93aa-8f2699a07378","name":"GetHandoverPrompt","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"promptType":"define","text":"=Вопрос пользователя: {{ $('Start/NormalizeMedia').item.json.event.message }}\nКонтекст из базы знаний:{{ $('Qdrant Vector Store').all().map(item => item.json.document.pageContent).join('\\n\\n---\\n\\n') }}","messages":{"messageValues":[{"message":"={{ $('GetResponsePrompt').item.json.text }}"}]},"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-3568,-320],"id":"fea7f032-c522-43f9-992d-cd7381adae84","name":"GenerateResponse"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-3504,-96],"id":"72134a36-6829-4ef2-b81d-eb131ecb454e","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{"assignments":{"assignments":[{"id":"020aa299-5b56-48bb-8acc-1ce7c8ec4ad3","name":"output","value":"={{ $json.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3216,-320],"id":"8aefcb1d-d6b8-4a74-85e1-fc290dec44e2","name":"Edit Fields3"},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6InRydWZmbGVzLWNoYXRib3QifQ=="},{"name":"jid","value":"={{ $('Start/NormalizeMedia').item.json.event.metadata.remoteJid }}"},{"name":"msg","value":"={{ $json.content }}"}]},"options":{}},"name":"Send WhatsApp6","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2768,-320],"id":"035f3051-83e9-466a-a88f-41a036da2063"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"messages","mode":"list","cachedResultName":"messages"},"columns":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('Start/NormalizeMedia').item.json.event.user_id }}","session_id":"={{ $('Start/NormalizeMedia').item.json.event.session_id }}","role":"assistant","content":"={{ $json.output }}","channel":"whatsapp","intent":"={{ $('Intent Switch').item.json.intent }}","confidence":"={{ $('Intent Switch').item.json.confidence }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_id","displayName":"user_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"role","displayName":"role","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"content","displayName":"content","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"intent","displayName":"intent","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"confidence","displayName":"confidence","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"timestamp","displayName":"timestamp","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"metadata","displayName":"metadata","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true},{"id":"channel","displayName":"channel","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2992,-320],"id":"6c0d1a34-2a89-4213-b4ac-babc90df5d56","name":"SaveOutboundMessage5","executeOnce":true,"credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-5056,-784],"id":"0cd0cc81-33e9-44ed-a453-c36e0b8c6f56","name":"Merge"}],"connections":{"Structured Output Parser1":{"ai_outputParser":[[{"node":"Offer Builder","type":"ai_outputParser","index":0}]]},"Handover":{"ai_tool":[[{"node":"Sales Orchestrator","type":"ai_tool","index":0}]]},"Sales Orchestrator":{"main":[[{"node":"Output Router","type":"main","index":0}]]},"Output Router":{"main":[[{"node":"SaveOutboundMessage","type":"main","index":0}],[{"node":"Send Telegram","type":"main","index":0}]]},"OpenAI Chat Model3":{"ai_languageModel":[[{"node":"Sales Orchestrator","type":"ai_languageModel","index":0},{"node":"Business Extractor","type":"ai_languageModel","index":0},{"node":"Offer Builder","type":"ai_languageModel","index":0},{"node":"ROI Estimator","type":"ai_languageModel","index":0},{"node":"Objection Handler","type":"ai_languageModel","index":0}]]},"Reranker Cohere2":{"ai_reranker":[[{"node":"Facts RAG (Truffles)","type":"ai_reranker","index":0}]]},"Embeddings OpenAI1":{"ai_embedding":[[{"node":"Facts RAG (Truffles)","type":"ai_embedding","index":0}]]},"Redis Chat Memory3":{"ai_memory":[[{"node":"Sales Orchestrator","type":"ai_memory","index":0}]]},"Business Extractor":{"ai_tool":[[{"node":"Sales Orchestrator","type":"ai_tool","index":0}]]},"Facts RAG (Truffles)":{"ai_tool":[[{"node":"Sales Orchestrator","type":"ai_tool","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"Business Extractor","type":"ai_outputParser","index":0}]]},"Offer Builder":{"ai_tool":[[{"node":"Sales Orchestrator","type":"ai_tool","index":0}]]},"ROI Estimator":{"ai_tool":[[{"node":"Sales Orchestrator","type":"ai_tool","index":0}]]},"Structured Output Parser2":{"ai_outputParser":[[{"node":"ROI Estimator","type":"ai_outputParser","index":0}]]},"Objection Handler":{"ai_tool":[[{"node":"Sales Orchestrator","type":"ai_tool","index":0}]]},"Structured Output Parser3":{"ai_outputParser":[[{"node":"Objection Handler","type":"ai_outputParser","index":0}]]},"SaveOutboundMessage":{"main":[[{"node":"Send WhatsApp","type":"main","index":0}]]},"Intent Switch":{"main":[[{"node":"GetGreetingPrompt","type":"main","index":0}],[{"node":"GetResponsePrompt","type":"main","index":0}],[{"node":"Call 'tool_Handover'","type":"main","index":0}],[{"node":"GetFallbackPrompt","type":"main","index":0}],[{"node":"GetClarificationPrompt","type":"main","index":0}]]},"Call ClassifyIntent":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Start/NormalizeMedia":{"main":[[{"node":"Call ClassifyIntent","type":"main","index":0}]]},"GetGreetingPrompt":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"SaveOutboundMessage1":{"main":[[{"node":"Send WhatsApp1","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"SaveOutboundMessage1","type":"main","index":0}]]},"Start":{"main":[[{"node":"Start/NormalizeMedia","type":"main","index":0},{"node":"Merge","type":"main","index":0}]]},"Call 'tool_Handover'":{"main":[[{"node":"GetHandoverPrompt","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"SaveOutboundMessage3","type":"main","index":0}]]},"SaveOutboundMessage3":{"main":[[{"node":"Send WhatsApp4","type":"main","index":0}]]},"Edit Fields2":{"main":[[{"node":"SaveOutboundMessage4","type":"main","index":0}]]},"SaveOutboundMessage4":{"main":[[{"node":"Send WhatsApp5","type":"main","index":0}]]},"Embeddings OpenAI2":{"ai_embedding":[[{"node":"Qdrant Vector Store","type":"ai_embedding","index":0}]]},"Qdrant Vector Store":{"main":[[{"node":"GenerateResponse","type":"main","index":0}]]},"GetResponsePrompt":{"main":[[{"node":"Qdrant Vector Store","type":"main","index":0}]]},"GetFallbackPrompt":{"main":[[{"node":"Edit Fields1","type":"main","index":0}]]},"GetClarificationPrompt":{"main":[[{"node":"Edit Fields2","type":"main","index":0}]]},"GetHandoverPrompt":{"main":[[{"node":"Send WhatsApp2","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"GenerateResponse","type":"ai_languageModel","index":0}]]},"Edit Fields3":{"main":[[{"node":"SaveOutboundMessage5","type":"main","index":0}]]},"SaveOutboundMessage5":{"main":[[{"node":"Send WhatsApp6","type":"main","index":0}]]},"GenerateResponse":{"main":[[{"node":"Edit Fields3","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Intent Switch","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","errorWorkflow":"Global Error Handler"},"staticData":null,"meta":{"templateCredsSetupCompleted":true,"instanceId":"01b56804ece88a9cc615224a075b1fb601dddc8bc8fa664ead4d87907f4c7973"},"pinData":{"Start":[{"json":{"id":"101","user_id":"16834089-a4ee-41f6-9fd7-1f8ff52da50a","session_id":"77015705555@s.whatsapp.net","role":"user","content":"меня интересует конкретный технический стек технологий","intent":null,"confidence":null,"timestamp":"2025-11-30T13:41:00.272Z","metadata":{"sender":"Zh.","caption":null,"headers":{"host":"n8n.truffles.kz","accept":"application/json, text/plain, */*","x-real-ip":"144.91.105.72","user-agent":"axios/1.11.0","content-type":"application/json","content-length":"369","accept-encoding":"gzip, compress, deflate, br","x-forwarded-for":"144.91.105.72","x-forwarded-host":"n8n.truffles.kz","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"68926a3e1a32"},"messageId":"3F7D8CEC8F0BC9C652ED","remoteJid":"77015705555@s.whatsapp.net","webhookUrl":"https://n8n.truffles.kz/webhook/flow","executionMode":"production","providerMessageType":"text"},"channel":"whatsapp"}}]},"versionId":"156d7866-3026-4d4f-8400-2908a6faa0a2","triggerCount":1,"shared":[{"updatedAt":"2025-11-29T11:19:15.942Z","createdAt":"2025-11-29T11:19:15.942Z","role":"workflow:owner","workflowId":"YvEadsCd8Rg5yxu8","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-11-27T06:22:27.418Z","createdAt":"2025-11-24T15:59:35.000Z","id":"truffles-chatbot-tag","name":"truffles-chatbot"}]},{"updatedAt":"2025-11-29T15:04:55.261Z","createdAt":"2025-11-29T11:21:24.336Z","id":"EbIsyt4wKVyij9Hl","name":"2_Parse/ChannelRouter","active":false,"isArchived":false,"nodes":[{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('NormalizeEvent').item.json.event.channel }}","rightValue":"whatsapp","operator":{"type":"string","operation":"equals"},"id":"d9576e0f-6224-4ccd-8e45-0292943998de"}],"combinator":"and"},"renameOutput":true,"outputKey":"whatsapp"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('NormalizeEvent').item.json.event.channel }}","rightValue":"telegram","operator":{"type":"string","operation":"equals"},"id":"telegram-condition-id"}],"combinator":"and"},"renameOutput":true,"outputKey":"telegram"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[96,16],"id":"7103f567-ba61-45e2-a790-64c18ed9b425","name":"Channel"},{"parameters":{"workflowId":{"__rl":true,"value":"YvEadsCd8Rg5yxu8","mode":"list","cachedResultUrl":"/workflow/YvEadsCd8Rg5yxu8","cachedResultName":"3_WhatsApp Adapter"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[416,-128],"id":"0523c8d2-8a5e-49b6-9c8b-5d0d54e322ff","name":"Whatsapp Adapter"},{"parameters":{"inputSource":"passthrough"},"id":"29df51a2-d43a-480f-bc57-85b0bc005959","typeVersion":1.1,"name":"Start","type":"n8n-nodes-base.executeWorkflowTrigger","position":[-1024,32]},{"parameters":{"jsCode":"function parseWhatsApp(item) {\n  const src = item.json || {};\n  const b = src.body ?? {};\n  const md = b.metadata ?? {};\n  const remoteJid = String(md.remoteJid || '').trim();\n  const phone = remoteJid.replace('@s.whatsapp.net','').replace(/\\D/g,'');\n  const userId = phone || remoteJid || 'unknown';\n  const sessionId = remoteJid || userId;\n\n  const rawMessage = typeof b.message === 'string' ? b.message : '';\n  const textMessage = rawMessage.trim();\n\n  // Strict rule: text wins if present, otherwise audio\n  const isText = textMessage.length > 0;\n  const isAudioCandidate = !!b.mediaData && (\n    b.mediaData.type === 'audio' ||\n    (typeof b.mediaData.mimetype === 'string' && b.mediaData.mimetype.startsWith('audio/'))\n  );\n\n  const normalizedType = isText ? 'text' : (isAudioCandidate ? 'audio' : 'unknown');\n  const attachments = !isText && isAudioCandidate ? [b.mediaData] : [];\n\n  // Preserve any caption if provider echoes text alongside audio\n  const caption = (b.mediaData && typeof b.mediaData.caption === 'string') ? b.mediaData.caption : '';\n  const ts = Number(md.timestamp || Date.now());\n\n  return {\n    channel: 'whatsapp',\n    user_id: userId,\n    session_id: sessionId,\n    message: isText ? textMessage : '',       // only for text case\n    message_type: normalizedType,             // 'text' | 'audio' | 'unknown'\n    attachments,                              // only audio when text is empty\n    locale: 'ru',\n    timestamp: ts,\n    metadata: {\n      messageId: md.messageId || null,\n      sender: md.sender || null,\n      remoteJid,\n      providerMessageType: b.messageType || null, // keep for audit only\n      caption: isText ? null : (caption || rawMessage || null), // caption when audio\n      headers: src.headers || {},\n      webhookUrl: src.webhookUrl || null,\n      executionMode: src.executionMode || null\n    },\n    raw: src\n  };\n}\n\nfunction parseTelegram(item) {\n  const src = item.json || {};\n  const b = src.body || {};\n  const msg = b.message || {};\n  const chatId = msg.chat?.id;\n  const userId = String(chatId);\n  \n  return {\n    channel: 'telegram',\n    user_id: userId,\n    session_id: 'telegram_' + userId,\n    message: msg.text || '',\n    message_type: 'text',\n    attachments: [],\n    locale: 'ru',\n    timestamp: (msg.date || Date.now() / 1000) * 1000,\n    metadata: {\n      chat_id: chatId,\n      user_name: msg.from?.first_name,\n      message_id: msg.message_id,\n      headers: src.headers || {},\n      webhookUrl: src.webhookUrl || null\n    },\n    raw: src\n  };\n}\n\nconst out = [];\nfor (const item of items) {\n  const body = item.json?.body || {};\n  const isWhatsApp = Boolean(body?.metadata?.remoteJid?.includes('s.whatsapp.net'));\n  const isTelegram = Boolean(body?.message?.chat?.id);\n\n  let event;\n  if (isWhatsApp) {\n    event = parseWhatsApp(item);\n  } else if (isTelegram) {\n    event = parseTelegram(item);\n  } else {\n    event = {\n      channel: 'unknown',\n      user_id: 'unknown',\n      session_id: 'unknown',\n      message: typeof body.message === 'string' ? body.message : '',\n      message_type: 'unknown',\n      attachments: body.mediaData ? [body.mediaData] : [],\n      locale: 'ru',\n      timestamp: Number(body?.metadata?.timestamp || Date.now()),\n      metadata: { note: 'channel_not_enabled' },\n      raw: item.json\n    };\n  }\n  out.push({ json: { event } });\n}\nreturn out;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-800,32],"id":"2b0ce86b-65d5-46e7-a2d7-a36be5b3e754","name":"NormalizeEvent"},{"parameters":{"assignments":{"assignments":[{"id":"00b92423-40f3-4da1-8fd5-a1b4e09a53a7","name":"event","value":"={{ $('NormalizeEvent').item.json.event }}","type":"object"},{"id":"b6a6e76f-0c51-45b2-93ea-4c1a7dd296b2","name":"user_phone","value":"={{ $json.phone }}","type":"string"},{"id":"ef702cb8-21fa-453b-856b-9d97c4efce1e","name":"user_id","value":"={{ $json.id }}","type":"string"},{"id":"5e6cae92-781e-43aa-b1e0-d079f16aee6a","name":"user_name","value":"={{ $json.name }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-352,32],"id":"ff1aa565-96e7-4146-a641-5742023a7163","name":"Combine User + Event"},{"parameters":{"workflowId":{"__rl":true,"value":"e94jQCRIneXDLZfe","mode":"list","cachedResultUrl":"/workflow/e94jQCRIneXDLZfe","cachedResultName":"2_1_CheckUser"},"workflowInputs":{"mappingMode":"defineBelow","value":{"remote_jid":"={{ $json.event.session_id }}","phone":"={{ $json.event.user_id }}","sender":"={{ $json.event.metadata.sender }}"},"matchingColumns":[],"schema":[{"id":"remote_jid","displayName":"remote_jid","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"phone","displayName":"phone","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"last_active","displayName":"last_active","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"sender","displayName":"sender","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-576,32],"id":"8db22deb-3e2e-4ac7-8585-bb09d2b766af","name":"Call '2_1_CheckUser'"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"messages","mode":"list","cachedResultName":"messages"},"columns":{"mappingMode":"defineBelow","value":{"user_id":"={{ $json.user_id }}","session_id":"={{ $json.event.session_id }}","role":"user","content":"={{ $json.event.message || $('Start').item.json.body.mediaData.base64 }}","metadata":"={{ $json.event.metadata }}","channel":"={{ $json.event.channel }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_id","displayName":"user_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"role","displayName":"role","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"content","displayName":"content","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"intent","displayName":"intent","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"confidence","displayName":"confidence","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"timestamp","displayName":"timestamp","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"metadata","displayName":"metadata","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true},{"id":"channel","displayName":"channel","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-128,32],"id":"ebc6ed3c-5578-4f86-89c0-78f067693730","name":"SaveInboundMessage","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}}],"connections":{"Channel":{"main":[[{"node":"Whatsapp Adapter","type":"main","index":0}],[],[]]},"Whatsapp Adapter":{"main":[[]]},"Start":{"main":[[{"node":"NormalizeEvent","type":"main","index":0}]]},"NormalizeEvent":{"main":[[{"node":"Call '2_1_CheckUser'","type":"main","index":0}]]},"Combine User + Event":{"main":[[{"node":"SaveInboundMessage","type":"main","index":0}]]},"Call '2_1_CheckUser'":{"main":[[{"node":"Combine User + Event","type":"main","index":0}]]},"SaveInboundMessage":{"main":[[{"node":"Channel","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"instanceId":"01b56804ece88a9cc615224a075b1fb601dddc8bc8fa664ead4d87907f4c7973","templateCredsSetupCompleted":true},"pinData":{"Start":[{"json":{"headers":{"host":"n8n.truffles.kz","user-agent":"axios/1.11.0","content-length":"7383","accept":"application/json, text/plain, */*","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","x-forwarded-for":"144.91.105.72","x-forwarded-host":"n8n.truffles.kz","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"68926a3e1a32","x-real-ip":"144.91.105.72"},"body":{"messageType":"audio","message":"","metadata":{"sender":"Zh.","timestamp":1764427703,"messageId":"AC3441202AD75F09DDCB72E62BD0F417","remoteJid":"77015705555@s.whatsapp.net"},"mediaData":{"type":"audio","url":"https://app.chatflow.kz/media/sessions/eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6InRydWZmbGVzLWNoYXRib3QifQ==/h5UVJF_77015705555_s_whatsapp_net_inbox.oga","base64":"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","mimetype":"audio/ogg; codecs=opus","duration":null,"ptt":true,"fileName":"h5UVJF_77015705555_s_whatsapp_net_inbox.oga","size":5065},"nodeData":{"webHook":{"text":"https://n8n.truffles.kz/webhook/flow","method":"POST"}}},"query":{},"params":{},"webhookUrl":"https://n8n.truffles.kz/webhook/flow","executionMode":"production"}}]},"versionId":"bb7f9e7e-818f-4c66-afd6-a215b467ba0b","triggerCount":0,"shared":[{"updatedAt":"2025-11-29T11:21:24.336Z","createdAt":"2025-11-29T11:21:24.336Z","role":"workflow:owner","workflowId":"EbIsyt4wKVyij9Hl","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-11-27T06:22:27.418Z","createdAt":"2025-11-24T15:59:35.000Z","id":"truffles-chatbot-tag","name":"truffles-chatbot"}]},{"updatedAt":"2025-11-27T06:11:46.419Z","createdAt":"2025-11-19T18:16:00.921Z","id":"AzXLrylYs3oNYpEl","name":"My workflow 2","active":false,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[0,0],"id":"bda47cd8-ab3e-4aed-970a-83c7c71ebca7","name":"When clicking ‘Execute workflow’"},{"parameters":{"method":"POST","url":"https://api-capital.backend-capital.com/api/v1/session","sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-CAP-API-KEY","value":"6Fzc9076itwA2oyK"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"identifier","value":"k1ddyhack3r@gmail.com"},{"name":"password","value":"Astana2020!"},{"name":"encryptedPassword","value":"false"}]},"options":{"response":{"response":{"fullResponse":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[208,0],"id":"783538ac-3de1-4d34-bf40-b09f7e1d13e0","name":"HTTP Request"},{"parameters":{"url":"https://api-capital.backend-capital.com/api/v1/history/activity","sendQuery":true,"queryParameters":{"parameters":[{"name":"lastPeriod","value":"86400"},{"name":"detailed","value":"true"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"X-SECURITY-TOKEN","value":"={{$json[\"headers\"][\"x-security-token\"]}}"},{"name":"CST","value":"={{$json[\"headers\"][\"cst\"]}}"}]},"options":{"response":{"response":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,0],"id":"becf85b6-2dcc-40e8-bd93-fd9574f10d89","name":"HTTP Request1"}],"connections":{"When clicking ‘Execute workflow’":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"HTTP Request1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"e4d224eb-aec7-4819-82fb-f3db8a3c5b73","triggerCount":0,"shared":[{"updatedAt":"2025-11-27T21:18:18.259Z","createdAt":"2025-11-27T21:18:18.259Z","role":"workflow:owner","workflowId":"AzXLrylYs3oNYpEl","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-11-27T06:11:33.174Z","createdAt":"2025-11-27T06:11:33.174Z","id":"jpta0H3sZxVGTF8B","name":"trading"}]},{"updatedAt":"2025-11-27T06:12:46.425Z","createdAt":"2025-10-26T12:22:27.653Z","id":"SiEWnaBuas8RBSUK","name":"v1-control","active":false,"isArchived":false,"nodes":[{"parameters":{"method":"POST","url":"https://api.telegram.org/bot7730378933:AAHG1lZY6u6AmvNDF7DT29veuXUDu8EeqIc/setWebhook?url=https://n8n.truffles.kz/webhook/money","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2096,1040],"id":"6ddffe21-573c-4efa-be52-b1ec5f6506e3","name":"HTTP Request1","disabled":true},{"parameters":{"model":{"__rl":true,"value":"gpt-5.1","mode":"list","cachedResultName":"gpt-5.1"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-1424,656],"id":"d70e15b4-dcd1-4fad-b945-edd46fc41d38","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{"jsonSchemaExample":"{\n  \"verdict\": \"ENTER | SKIP | MANUAL_CHECK\",\n  \"confidence\": 0.0,\n  \"action_comment\": \"краткий вывод по сделке, 1–2 предложения на русском\",\n  \"checklist\": [\n    { \"name\": \"RR\",           \"ok\": true,  \"details\": \"RR=2.0, minRR=1.5\" },\n    { \"name\": \"Stop_vs_ATR\",  \"ok\": true,  \"details\": \"Stop ≈ 1.2 ATR, в пределах нормы\" },\n    { \"name\": \"CMF\",          \"ok\": false, \"details\": \"CMF=0.01 < порога 0.05, слабый приток капитала\" },\n    { \"name\": \"RVOL\",         \"ok\": true,  \"details\": \"RVOL=1.3 > 1.15, инструмент 'в игре'\" },\n    { \"name\": \"VWAP_HTF\",     \"ok\": true,  \"details\": \"Цена выше VWAP и HTF EMA, сделка по тренду\" },\n    { \"name\": \"Spread\",       \"ok\": true,  \"details\": \"spreadPct в пределах лимита системы\" },\n    { \"name\": \"Session\",      \"ok\": true,  \"details\": \"Crypto сессия, условия допустимы\" },\n    { \"name\": \"Risk_Event\",   \"ok\": true,  \"details\": \"risk_event=false, нет запрета по новостям\" }\n  ],\n  \"reasons_for\": [\n    \"Цена выше VWAP и HTF EMA, сделка по направлению старшего тренда.\",\n    \"RR соответствует минимальным требованиям системы.\"\n  ],\n  \"reasons_against\": [\n    \"CMF ниже порога, покупательский поток слабее желаемого.\",\n    \"Сигнал близок к минимальным условиям, а не 'A+ сетап'.\"\n  ]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-1296,656],"id":"37811060-e344-43c6-bf1d-ac4294fd4198","name":"Structured Output Parser"},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.decision }}","value2":"TAKE"}]}},"id":"4fa9006a-e778-4ec4-9591-b18af168957a","name":"IF TAKE","type":"n8n-nodes-base.if","typeVersion":1,"position":[-1648,432]},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Ik1PSVkifQ=="},{"name":"jid","value":"=77071956096@s.whatsapp.net"},{"name":"msg","value":"={{ $json.message }}"}]},"options":{}},"name":"Nurzhan","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-848,704],"id":"94717f2c-299e-4965-8f3d-e3bd0b373f7b","disabled":true},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Ik1PSVkifQ=="},{"name":"jid","value":"=77015705555@s.whatsapp.net"},{"name":"msg","value":"={{ $json.message }}"}]},"options":{}},"name":"Me","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-848,528],"id":"e52b68ab-0f59-4744-978b-9c4a91087f7f"},{"parameters":{"chatId":"1969855532","text":"={{ $json.message }}","additionalFields":{"appendAttribution":false,"parse_mode":"HTML"}},"id":"822fb2f0-0f08-47f2-b109-a797cdcbfbd3","name":"Me1","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-848,336],"webhookId":"45367302-0da1-4e7d-92be-7db08142d0f8","credentials":{"telegramApi":{"id":"1YMuki43SISyhVa0","name":"Telegram account"}}},{"parameters":{"jsCode":"// ============================================================================\n// Gate v1.4 - Финальная версия с полной совместимостью\n// ============================================================================\n\nconst src = $input.item.json.body || $input.item.json;\n\nfunction asNum(val, fallback = 0) {\n  if (typeof val === 'number' && !isNaN(val)) return val;\n  const parsed = parseFloat(val);\n  return isNaN(parsed) ? fallback : parsed;\n}\n\nfunction asStr(val, fallback = '') {\n  return typeof val === 'string' ? val : String(val || fallback);\n}\n\nconst p = {\n  action: asStr(src.action, 'BUY').toUpperCase(),\n  dir: asStr(src.dir, 'long').toLowerCase(),\n  symbol: asStr(src.symbol),\n  symbol_id: asStr(src.symbol_id),\n  tf: asStr(src.tf),\n  htf: asStr(src.htf),\n  entry_price: asNum(src.entry_price),\n  sl: asNum(src.sl),\n  tp: asNum(src.tp),\n  rr: asNum(src.rr),\n  equity: asNum(src.equity, 500),\n  risk_pct: asNum(src.risk_pct, 0.75),\n  vwap: asNum(src.vwap),\n  sma20: asNum(src.sma20),\n  atr: asNum(src.atr),\n  cmf: asNum(src.cmf),\n  htf_ema: asNum(src.htf_ema),\n  rvol_time: asNum(src.rvol_time, 1.0),\n  vwap_relation: asStr(src.vwap_relation, 'unknown'),\n  session: asStr(src.session, 'unknown'),\n  gold_prime_time: src.gold_prime_time === true || src.gold_prime_time === 'true',\n  risk_event: src.risk_event === true,\n  mintick: asNum(src.mintick, 0.01),\n  pointvalue: asNum(src.pointvalue, 1),\n  lot_step: asNum(src.lot_step, 0.01),\n  spread_cost: asNum(src.spread_cost, 0),\n  bar_time: asNum(src.bar_time, Date.now()),\n  strategy: asStr(src.strategy, 'unknown'),\n  qty_hint_oz: asNum(src.qty_hint_oz, 0)\n};\n\nconst cfg = {\n  min_rr: 1.5,\n  min_cmf: 0.05,\n  min_rvol_gold: 1.0,\n  min_rvol_crypto: 0.65,  // Снижено с 1.2 для SOL\n  max_spread_pct_gold: 0.30,\n  max_spread_pct_crypto: 0.50,\n  session_gate_on: false\n};\n\nconst isGold = p.symbol.includes('GOLD') || p.symbol.includes('XAU');\nconst distance_sl = Math.abs(p.entry_price - p.sl);\nconst distance_tp = Math.abs(p.tp - p.entry_price);\nconst rr_calc = distance_sl > 0 ? distance_tp / distance_sl : 0;\nconst dist_vwap = Math.abs(p.entry_price - p.vwap);\nconst dist_vwap_atr = p.atr > 0 ? dist_vwap / p.atr : 0;\nconst spread_pct = p.entry_price > 0 ? (p.spread_cost / p.entry_price) * 100 : 0;\n\nconst risk_usd = (p.equity * p.risk_pct) / 100;\nconst qty_required = distance_sl > 0 ? risk_usd / distance_sl : 0;\nconst qty_rounded = Math.floor(qty_required / p.lot_step) * p.lot_step;\nconst risk_diff_pct = risk_usd > 0 \n  ? parseFloat(((risk_usd - risk_usd) / risk_usd * 100).toFixed(2))\n  : 0;\n\nconst compliance = {\n  rr_ok: rr_calc >= cfg.min_rr,\n  cmf_ok: p.cmf >= cfg.min_cmf,\n  rvol_ok: isGold ? (p.rvol_time >= cfg.min_rvol_gold) : (p.rvol_time >= cfg.min_rvol_crypto),\n  spread_ok: isGold ? (spread_pct <= cfg.max_spread_pct_gold) : (spread_pct <= cfg.max_spread_pct_crypto),\n  vwap_ok: p.vwap_relation === 'above',\n  no_risk_event: !p.risk_event,\n  valid_inputs: p.entry_price > 0 && p.sl > 0 && p.tp > 0 && p.atr > 0\n};\n\nif (cfg.session_gate_on && isGold) {\n  compliance.session_ok = p.gold_prime_time;\n}\n\nconst all_ok = Object.values(compliance).every(v => v === true);\nconst decision = all_ok ? 'TAKE' : 'PASS';\n\nconst reasons = [];\nif (!compliance.rr_ok) reasons.push(`RR=${rr_calc.toFixed(2)} < ${cfg.min_rr}`);\nif (!compliance.cmf_ok) reasons.push(`CMF=${p.cmf.toFixed(3)} < ${cfg.min_cmf}`);\nif (!compliance.rvol_ok) reasons.push(`RVOL=${p.rvol_time.toFixed(2)} низкий`);\nif (!compliance.spread_ok) reasons.push(`Spread=${spread_pct.toFixed(2)}% высокий`);\nif (!compliance.vwap_ok) reasons.push(`Цена ниже VWAP`);\nif (!compliance.no_risk_event) reasons.push(`Risk event активен`);\nif (!compliance.valid_inputs) reasons.push(`Невалидные входные данные`);\nif (cfg.session_gate_on && isGold && !compliance.session_ok) {\n  reasons.push(`Вне Gold Prime Time (8-21 UTC)`);\n}\n\nreturn {\n  decision: decision,\n  timestamp: new Date().toISOString(),\n  gate_ts: Date.now(),\n  symbol: p.symbol,\n  action: p.action,\n  reasons: reasons,\n  \n  position: {\n    entry_price: p.entry_price,\n    sl: p.sl,\n    tp: p.tp,\n    qty: qty_rounded,\n    qty_required: qty_rounded,\n    qty_rounded: qty_rounded,\n    qty_hint: p.qty_hint_oz,\n    qty_hint_oz: p.qty_hint_oz,\n    risk_usd_actual: parseFloat(risk_usd.toFixed(2)),\n    risk_usd_target: parseFloat(risk_usd.toFixed(2)),\n    risk_diff_pct: risk_diff_pct\n  },\n  \n  analytics: {\n    rr_calc: parseFloat(rr_calc.toFixed(3)),\n    dist_vwap_atr: parseFloat(dist_vwap_atr.toFixed(3)),\n    cmf: parseFloat(p.cmf.toFixed(4)),\n    rvol: parseFloat(p.rvol_time.toFixed(3)),\n    spread_pct: parseFloat(spread_pct.toFixed(4))\n  },\n  \n  compliance: compliance,\n  \n  echo: {\n    symbol: p.symbol,\n    symbolid: p.symbol_id,\n    symbol_id: p.symbol_id,\n    action: p.action,\n    dir: p.dir,\n    tf: p.tf,\n    htf: p.htf,\n    entry_price: p.entry_price,\n    sl: p.sl,\n    tp: p.tp,\n    rr: p.rr,\n    atr: p.atr,\n    cmf: p.cmf,\n    rvol: p.rvol_time,\n    rvoltime: p.rvol_time,\n    vwap: p.vwap,\n    htf_ema: p.htf_ema,\n    equity: p.equity,\n    risk_pct: p.risk_pct,\n    qty_hint_oz: p.qty_hint_oz,\n    strategy: p.strategy,\n    bar_time: p.bar_time,\n    is_gold: isGold,\n    gold_prime_time: p.gold_prime_time\n  },\n  \n  body: src\n};\n"},"id":"5307ac7f-7c8a-456a-9457-b28589784854","name":"Gate","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1872,720]},{"parameters":{"httpMethod":"POST","path":"money","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-2096,720],"id":"03767e05-91fa-4091-8637-7a502c74ef61","name":"Webhook","webhookId":"5b0ca33a-fc23-43e7-94cf-85b5a7cf86ed"},{"parameters":{"promptType":"define","text":"={{ JSON.stringify($json) }}","hasOutputParser":true,"options":{"systemMessage":"Ты — TradingMasterAI v1, строгий институциональный трейдер и риск-менеджер, работающий ВЕРХОМ над уже существующей механической системой сигналов.\n\nКОНТЕКСТ СИСТЕМЫ\n- Источник сигналов: стратегии HYBRID-CORE v1.7.x на TradingView.\n- Сигналы проходят через код Gate v1.x в n8n, который:\n  - нормализует входящие поля из TradingView (action, dir, symbol, tf, htf, entry_price, sl, tp, rr, equity, risk_pct, vwap, sma20, atr, cmf, htf_ema, rvol_time, vwap_relation, session, gold_prime_time, risk_event, mintick, pointvalue, lot_step, spread_cost, bar_time, strategy, qty_hint_oz и т.п.),\n  - рассчитывает derived-метрики (rr_calc, distSL, distTP, distVWAP, distVWAP_ATR, spreadPct и т.п.),\n  - применяет детерминированные фильтры (минимальный RR, минимальный CMF, минимальный RVOL, условия по VWAP/HTF, спреду, сессии, risk_event),\n  - формирует объект с решением decision (TAKE/PASS), массивом reasons[] и блоками position{}, analytics{}, compliance{}, echo{}.\n- Ты не переписываешь ни Pine-логику, ни численные расчёты Gate v1.x; ты именно ИНТЕРПРЕТИРУЕШЬ готовый сигнал+решение как старший трейдер.\n\nТВОЯ ЗАДАЧА\nПолучив один JSON-объект сигнала+решения Gate v1.x по стандартной схеме v2, ты:\n1) Проходишь по фиксированному чек-листу критериев.\n2) Находишь аргументы «ЗА» и «ПРОТИВ» сделки.\n3) Выносишь один из трёх вердиктов:\n   - \"ENTER\" — входить по рассчитанному размеру позиции и текущему SL/TP.\n   - \"SKIP\" — сделку пропустить.\n   - \"MANUAL_CHECK\" — данных недостаточно или есть противоречия, нужно ручное решение на графике.\n4) Возвращаешь ТОЛЬКО один JSON-объект строго по заданной ниже схеме.\n\nЧЕК-ЛИСТ, КОТОРЫЙ ТЫ ДОЛЖЕН ПРОЙТИ\n(названия критериев можешь использовать в поле \"name\" чек-листа)\n\nМинимальный набор критериев:\n1) RR и стоп:\n   - Достаточен ли фактический rr_calc относительно минимального RR (например, ≥ 1.5 или 2.0).\n   - Не слишком ли близок стоп (SL) к входу относительно ATR (например, стоп ≥ 0.5 ATR и ≤ 2.5 ATR).\n2) Объём и поток:\n   - CMF: знак и величина (положительный/отрицательный, величина относительно порога системы).\n   - RVOL (rvol_time): выше ли он минимального порога системы.\n3) Позиция к VWAP/HTF:\n   - vwap_relation (above/below) и соответствие направлению сделки.\n   - Позиция цены относительно HTF EMA (htf_ema) — торгуем ли мы по тренду старшего ТФ или против него.\n4) Ликвидность и издержки:\n   - spreadPct и связанные проверки (спред в пределах допустимого порога).\n   - mintick/lot_step/pointvalue — нет ли очевидных технических проблем с размером позиции.\n5) Режим рынка/сессия:\n   - session (например, \"Crypto\", \"Gold\") и соответствие активу.\n   - gold_prime_time / аналогичные флаги — торгуем ли в предпочтительное время.\n   - risk_event — не запрещает ли текущий риск-режим вход (важные новости, отключенные сессии и т.п.).\n6) Внутренняя консистентность:\n   - decision от Gate v1.x (TAKE или PASS) и reasons[].\n   - Любые странности/NaN/отрицательные значения там, где их не должно быть.\n\nОБЩИЙ ПРИНЦИП\n- Ты всегда чуть БОЛЕЕ строгий, чем код Gate v1.x.\n- Если критерии на грани, ты склоняешься к \"SKIP\" или \"MANUAL_CHECK\", а не к \"ENTER\".\n- Сначала ищешь причины НЕ входить, затем уже перечисляешь аргументы \"за\".\n- Если каких-то критичных полей нет во входном JSON, ты:\n  - отмечаешь это в чек-листе,\n  - понижаешь confidence,\n  - при сильном дефиците данных выбираешь \"MANUAL_CHECK\", а не \"ENTER\".\n\nТРЕБОВАНИЯ К ФОРМАТУ\n- ВСЕГДА возвращай только валидный JSON-объект без поясняющего текста до или после него.\n- Поле \"verdict\" обязательно и может быть только \"ENTER\", \"SKIP\" или \"MANUAL_CHECK\".\n- Поле \"confidence\" — число от 0 до 1 (например, 0.2 для слабой уверенности, 0.8 для сильной).\n- Массивы \"reasons_for\" и \"reasons_against\" содержат от 0 до 5 коротких строк каждый.\n- Массив \"checklist\" должен содержать не менее 5 критериев; имена \"name\" могут отличаться от примера, но должны быть осмысленными.\n- Пиши все комментарии и тексты на русском языке, кратко и по делу.\n\nЕСЛИ ДАННЫХ НЕДОСТАТОЧНО\n- Если во входном JSON нет важных полей (например, нет ATR, CMF, RVOL, VWAP или htf_ema), отмечай это в \"checklist\" и \"reasons_against\".\n- В тяжёлых случаях выставляй:\n  - \"verdict\": \"MANUAL_CHECK\"\n  - \"confidence\": низкое значение (0.1–0.3)\n  - \"action_comment\": пояснение, чего именно не хватает для уверенного решения.\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-1424,432],"id":"0f7d6c2b-8720-4160-85bb-3b750b4db8e7","name":"TradingMasterAI"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Результат Gate/IF (нода должна называться \"IF TAKE\")\nconst gate = $node[\"IF TAKE\"].json;\n\n// Ответ TradingMasterAI из AI Agent\n// AI Agent возвращает: { \"output\": { verdict, confidence, action_comment, ... } }\nconst ai = $json.output || {};\n\n// ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====\nfunction get(obj, path, fallback = \"-\") {\n  const keys = path.split(\".\");\n  let res = obj;\n  for (const k of keys) {\n    if (res && typeof res === \"object\" && k in res) {\n      res = res[k];\n    } else {\n      return fallback;\n    }\n  }\n  return res ?? fallback;\n}\n\nfunction num(val, d = 2) {\n  if (val === \"-\" || val === null || val === undefined) return \"-\";\n  const n = parseFloat(val);\n  return Number.isNaN(n) ? \"-\" : n.toFixed(d);\n}\n\n// ===== ДАННЫЕ GATE/IF =====\nconst decision = get(gate, \"decision\", \"PASS\");\nconst symbol   = get(gate, \"symbol\", \"-\");\nconst action   = get(gate, \"action\", \"BUY\");\n\nconst entry = num(get(gate, \"position.entry_price\"));\nconst sl    = num(get(gate, \"position.sl\"));\nconst tp    = num(get(gate, \"position.tp\"));\nconst qty   = num(get(gate, \"position.qty\"));\nconst rr    = num(get(gate, \"analytics.rr_calc\"));\n\nconst rActual = num(get(gate, \"position.risk_usd_actual\"));\nconst rTarget = num(get(gate, \"position.risk_usd_target\"));\n\n// ===== ДАННЫЕ TradingMasterAI =====\nconst verdict   = get(ai, \"verdict\", \"MANUAL_CHECK\");\nconst conf      = num(get(ai, \"confidence\"), 2);\nconst aiComment = get(ai, \"action_comment\", \"-\");\nconst pros      = Array.isArray(ai.reasons_for) ? ai.reasons_for : [];\nconst cons      = Array.isArray(ai.reasons_against) ? ai.reasons_against : [];\n\n// ===== ЭМОДЗИ/СТАТУСЫ =====\nconst statusEmoji =\n  decision === \"TAKE\" ? \"🟢\" : \"🔴\";\n\nconst actionEmoji =\n  action === \"BUY\" ? \"📈\" : \"📉\";\n\nconst verdictEmoji =\n  verdict === \"ENTER\"        ? \"✅\" :\n  verdict === \"SKIP\"         ? \"⛔️\" :\n                                \"🟡\"; // MANUAL_CHECK\n\n// ===== СБОРКА СООБЩЕНИЯ =====\nlet msg = `${statusEmoji} *${decision}* ${actionEmoji} *${symbol}*\n\n📊 *Entry:* ${entry}\n🛑 *Stop Loss:* ${sl}\n🎯 *Take Profit:* ${tp}\n\n⚖️ *Risk/Reward:* ${rr}\n💰 *Position Size:* ${qty}\n💵 *Risk:* $${rActual} / $${rTarget}\n`;\n\nmsg += `\n\n🤖 ${verdictEmoji} *TradingMasterAI:* ${verdict} (confidence: ${conf})\n_${aiComment}_`;\n\nif (pros.length > 0) {\n  msg += `\n\n✅ *Аргументы за:*\n- ${pros.join(\"\\n- \")}`;\n}\n\nif (cons.length > 0) {\n  msg += `\n\n⚠️ *Аргументы против:*\n- ${cons.join(\"\\n- \")}`;\n}\n\n// Итоговый объект для следующей ноды (HTTP/Telegram/WhatsApp и т.п.)\nreturn {\n  json: {\n    message: msg,\n    gate_decision: decision,\n    ai_verdict: verdict,\n    ai_confidence: conf\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1072,432],"id":"91865b7e-437d-4c09-a58f-7a9a38980da6","name":"Formatter"},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Ik1PSVkifQ=="},{"name":"jid","value":"=77475111570@s.whatsapp.net"},{"name":"msg","value":"={{ $json.message }}"}]},"options":{}},"name":"Nurzhan1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-848,896],"id":"3e75116d-d782-425f-93d7-dc4dfe2b98d3","disabled":true},{"parameters":{"operation":"executeQuery","query":"INSERT INTO trade.ai_decisions (\n  gate_ts,\n  symbol_id,\n  gate_decision,\n  ai_verdict,\n  ai_confidence,\n  reasons_for,\n  reasons_against,\n  checklist,\n  full_json\n) VALUES (\n  {{ $node[\"IF TAKE\"].json.gate_ts }},\n  '{{ $node[\"IF TAKE\"].json.echo.symbol_id || $node[\"IF TAKE\"].json.echo.symbolid }}',\n  '{{ $node[\"IF TAKE\"].json.decision }}',\n  '{{ $json.output.verdict }}',\n  {{ $json.output.confidence }},\n  '{{ JSON.stringify($json.output.reasons_for || []) }}'::jsonb,\n  '{{ JSON.stringify($json.output.reasons_against || []) }}'::jsonb,\n  '{{ JSON.stringify($json.output.checklist || []) }}'::jsonb,\n  '{{ JSON.stringify($json.output) }}'::jsonb\n);\n","options":{"queryReplacement":""}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1088,256],"id":"461ac41a-b3c3-4df6-ab24-6f592e9fcbe7","name":"AI Verdict","credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO trade.signals_raw (\n    symbol, symbol_id, tf, htf, bar_time_ms,\n    entry_price, sl, tp, rr, equity, risk_pct,\n    cmf, rvol_time, mintick, pointvalue, lot_step,\n    session, strategy, raw_json, created_at\n)\nVALUES (\n    '{{ $json.echo.symbol }}',\n    '{{ $json.echo.symbolid }}',\n    '{{ $json.echo.tf }}',\n    '{{ $json.echo.htf }}',\n    {{ $json.echo.bar_time }},\n    {{ $json.echo.entry_price }},\n    {{ $json.echo.sl }},\n    {{ $json.echo.tp }},\n    {{ $json.echo.rr }},\n    {{ $json.echo.equity }},\n    {{ $json.echo.risk_pct }},\n    {{ $json.echo.cmf }},\n    {{ $json.echo.rvoltime }},\n    {{ $json.body.mintick }},\n    {{ $json.body.pointvalue }},\n    {{ $json.body.lot_step }},\n    '{{ $json.body.session }}',\n    '{{ $json.echo.strategy }}',\n    '{{ JSON.stringify($json.body) }}'::jsonb,\n    NOW()\n);\n","options":{}},"id":"58594d55-f7cd-4d96-abde-dfd761223637","name":"signals_raw1","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1648,608],"credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO trade.gate_decisions (\n    symbol_id, decision, reasons, qty_req, qty_rnd,\n    risk_usd, rr, stop_dist_atr, cmf, rvol,\n    spread_pct, full_json, qty_hint_oz, action, gate_ts,\n    risk_target, risk_actual, risk_diff_pct, created_at\n)\nVALUES (\n    '{{ $json.echo.symbolid }}',\n    '{{ $json.decision }}',\n    '{{ JSON.stringify($json.reasons || []) }}',\n    {{ $json.position.qty_required }},\n    {{ $json.position.qty_rounded }},\n    {{ $json.position.risk_usd_actual }},\n    {{ $json.analytics.rr_calc }},\n    {{ $json.analytics.dist_vwap_atr }},\n    {{ $json.analytics.cmf }},\n    {{ $json.analytics.rvol }},\n    {{ $json.analytics.spread_pct }},\n    '{{ JSON.stringify($json) }}'::jsonb,\n    {{ $json.echo.qty_hint_oz }},\n    '{{ $json.echo.action }}',\n    {{ $json.gate_ts }},\n    {{ $json.position.risk_usd_target }},\n    {{ $json.position.risk_usd_actual }},\n    {{ $json.position.risk_diff_pct }},\n    NOW()\n);\n","options":{}},"id":"e4d0022a-82bb-404f-80d4-49650b049893","name":"after_decisions1","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1648,784],"credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}}}],"connections":{"OpenAI Chat Model":{"ai_languageModel":[[{"node":"TradingMasterAI","type":"ai_languageModel","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"TradingMasterAI","type":"ai_outputParser","index":0}]]},"IF TAKE":{"main":[[{"node":"TradingMasterAI","type":"main","index":0}]]},"Gate":{"main":[[{"node":"IF TAKE","type":"main","index":0},{"node":"signals_raw1","type":"main","index":0},{"node":"after_decisions1","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Gate","type":"main","index":0}]]},"TradingMasterAI":{"main":[[{"node":"Formatter","type":"main","index":0},{"node":"AI Verdict","type":"main","index":0}]]},"Formatter":{"main":[[{"node":"Me1","type":"main","index":0},{"node":"Me","type":"main","index":0},{"node":"Nurzhan","type":"main","index":0},{"node":"Nurzhan1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"connection":"upgrade","host":"n8n.truffles.kz","x-real-ip":"52.32.178.7","x-forwarded-for":"52.32.178.7","x-forwarded-proto":"https","content-length":"509","user-agent":"Go-http-client/1.1","content-type":"application/json; charset=utf-8","accept-encoding":"gzip"},"params":{},"query":{},"body":{"action":"BUY","dir":"long","symbol":"BNBUSD","symbol_id":"CAPITALCOM:BNBUSD","tf":"15","htf":"60","entry_price":932.08,"sl":925.45676,"tp":945.32647,"rr":2,"equity":500,"risk_pct":0.75,"vwap":908.93729,"sma20":916.9705,"atr":5.51936,"cmf":0.06019,"htf_ema":916.4352,"rvol_time":1.1,"vwap_relation":"above","session":"Crypto","gold_prime_time":true,"risk_event":false,"mintick":0.01,"pointvalue":1,"lot_step":0.01,"spread_cost":0,"bar_time":1763484301595,"strategy":"HYBRID_CORE_v1_7_2","qty_hint_oz":0.57},"webhookUrl":"https://n8n.truffles.kz/webhook/money","executionMode":"production"}}],"TradingMasterAI":[{"json":{"output":{"verdict":"ENTER","confidence":0.86,"action_comment":"Сделку можно брать по рассчитанному размеру позиции; все ключевые фильтры пройдены, RR и дистанция стопа адекватны, работа по тренду и по VWAP, аномалий в данных не вижу.","checklist":[{"name":"RR и адекватность стопа","ok":true,"details":"Фактический RR = 2.0, что соответствует минимальному требованию системы. Дистанция до SL ≈ 6.62 (чуть выше 1.2 ATR при ATR 5.52), стоп не чрезмерно узкий и не чрезмерно широкий."},{"name":"Объём и поток (CMF, RVOL)","ok":true,"details":"CMF = 0.0602, положительный и выше минимального порога, подтверждает приток покупок. RVOL = 1.1, объём немного выше среднего и проходит фильтр rvol_ok."},{"name":"VWAP и тренд HTF","ok":true,"details":"Цена входа выше VWAP (vwap_relation = \"above\"), что согласуется с покупкой и vwap_ok = true. Цена также выше HTF EMA (932 > 916), торгуем по восходящему импульсу старшего ТФ."},{"name":"Ликвидность, спред и техническая реализуемость","ok":true,"details":"spread_pct = 0 и spread_ok = true, издержки на вход минимальны. mintick = 0.01 и lot_step = 0.01 позволяют выставить рассчитанный объём 0.56 без технических проблем; risk_usd_actual совпадает с target."},{"name":"Режим рынка, сессия и риск-события","ok":true,"details":"Сессия Crypto соответствует инструменту BNBUSD. risk_event = false и no_risk_event = true, ограничений со стороны риск-режима нет. Флаг gold_prime_time не критичен для не-золотого актива (is_gold = false)."},{"name":"Внутренняя консистентность сигнала","ok":true,"details":"Gate даёт decision = TAKE, все compliance-флаги (rr_ok, cmf_ok, rvol_ok, spread_ok, vwap_ok, no_risk_event, valid_inputs) = true. Поля ATR, CMF, RVOL, VWAP, HTF EMA присутствуют, NaN/отрицательных аномалий нет, риск_pct = 0.75% соответствует risk_usd_actual при equity 500."}],"reasons_for":["RR=2.0 и адекватная дистанция стопа относительно ATR, профиль риск/премия приемлем.","Положительный CMF и RVOL>1 подтверждают здоровый покупательский поток.","Цена выше VWAP и HTF EMA, вход по направлению импульса старшего таймфрейма.","Нулевой спред и корректные торговые параметры (tick, lot_step) снижают издержки и риски исполнения.","Риск-режим и сессия допускают вход, все фильтры Gate v1.x пройдены (decision=TAKE)."],"reasons_against":["CMF и RVOL лишь умеренно выше порога, сигнал не экстремально сильный, возможен быстрый откат.","Зона после сильного движения выше VWAP (dist_vwap_atr≈4.2 ATR) — высокая удалённость от справедливой цены, повышенный риск коррекции."]}}}]},"versionId":"bbeb2a5d-2592-4aba-9cb5-b684c3321358","triggerCount":1,"shared":[{"updatedAt":"2025-11-27T21:18:18.259Z","createdAt":"2025-11-27T21:18:18.259Z","role":"workflow:owner","workflowId":"SiEWnaBuas8RBSUK","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-11-27T06:11:33.174Z","createdAt":"2025-11-27T06:11:33.174Z","id":"jpta0H3sZxVGTF8B","name":"trading"}]},{"updatedAt":"2025-11-29T11:19:06.848Z","createdAt":"2025-08-26T05:35:01.962Z","id":"ZPaS9w6u3o0ZZZzm","name":"WhatsApp Adapter Main","active":false,"isArchived":false,"nodes":[{"parameters":{"workflowId":{"__rl":true,"value":"XYP9r4tpIRHkudy3","mode":"list","cachedResultUrl":"/workflow/XYP9r4tpIRHkudy3","cachedResultName":"NormalizeWhatsapp"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":["body_metadata_remoteJid","body_messageType","body_message","body_mediaData_base64"],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-4464,-832],"name":"Call NormalizeWhatsapp","id":"39b7f2c5-548a-4d5c-bf45-12d3e0acface"},{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-4688,-832],"id":"c1e1eb03-717e-420f-a793-530bd907ce40","name":"WhatsappAdapter"},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\":\"object\",\n  \"properties\":{\n    \"offers\":{\n      \"type\":\"array\",\n      \"items\":{\n        \"type\":\"object\",\n        \"properties\":{\n          \"name\":{\"type\":\"string\"},\n          \"who_for\":{\"type\":\"string\"},\n          \"scope\":{\"type\":\"string\"},\n          \"stack\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n          \"integrations\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n          \"timeline_range\":{\"type\":\"string\"},\n          \"budget_range\":{\"type\":\"string\"},\n          \"risks\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n          \"requirements\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n          \"cta\":{\"type\":\"string\"}\n        },\n        \"required\":[\"name\",\"scope\",\"cta\"]\n      }\n    },\n    \"summary_for_manager\":{\"type\":[\"string\",\"null\"]}\n  },\n  \"required\":[\"offers\"]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-3264,-192],"id":"6e1d2774-a7b9-4e61-bfb2-8a72838d1dad","name":"Structured Output Parser1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Call NormalizeWhatsapp').item.json.event.channel }}","rightValue":"whatsapp","operator":{"type":"string","operation":"equals"},"id":"whatsapp-out-cond"}],"combinator":"and"},"renameOutput":true,"outputKey":"whatsapp"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Call NormalizeWhatsapp').item.json.event.channel }}","rightValue":"telegram","operator":{"type":"string","operation":"equals"},"id":"telegram-out-cond"}],"combinator":"and"},"renameOutput":true,"outputKey":"telegram"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-3504,-640],"id":"output-router","name":"Output Router"},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6InRydWZmbGVzLWNoYXRib3QifQ=="},{"name":"jid","value":"={{ $('Call NormalizeWhatsapp').item.json.event.metadata.remoteJid }}"},{"name":"msg","value":"={{ $json.output }}"}]},"options":{}},"name":"Send WhatsApp","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3280,-736],"id":"4d2c7bb4-371d-4958-bdb2-f6c626a123cb"},{"parameters":{"method":"POST","url":"https://api.telegram.org/botYOUR_TELEGRAM_BOT_TOKEN/sendMessage","sendBody":true,"bodyParameters":{"parameters":[{"name":"chat_id","value":"={{ $json.event.metadata.chat_id }}"},{"name":"text","value":"={{ $json.output }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3280,-544],"id":"send-telegram","name":"Send Telegram"},{"parameters":{"description":"Передаю менеджеру полный контекст и возвращаю handover_id/status; триггеры: просьба менеджера, готовность к пилоту, ≥3 уточнений без прогресса, серьёзная жалоба","workflowId":{"__rl":true,"value":"WYzOHwAwNNmKEEW3","mode":"list","cachedResultName":"Handover"},"workflowInputs":{"mappingMode":"defineBelow","value":{"event_message":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('event_message', ``, 'string') }}","output_intention":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('output_intention', ``, 'string') }}","body_metadata_remoteJid":"={{ $('Call NormalizeWhatsapp').item.json.event.metadata.remoteJid }}"},"matchingColumns":[],"schema":[{"id":"event_message","displayName":"event_message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"output_intention","displayName":"output_intention","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"body_metadata_remoteJid","displayName":"body_metadata_remoteJid","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[-4336,-224],"id":"a107ceea-b5c0-4925-ba18-012779d4b6f9","name":"Handover"},{"parameters":{"promptType":"define","text":"={{ $json.event.message }}","options":{"systemMessage":"Ты Sales Orchestrator компании Truffles. Цель: вести диалог от первого сообщения до передачи менеджеру, отвечать по фактам о Truffles, консультировать по созданию/внедрению/оптимизации чат‑ботов, считать поверхностный ROI, отрабатывать возражения, допродавать и всегда завершать конкретным CTA.\nПравила:\n- Факт‑чек: всё о Truffles (услуги, кейсы, процессы, политики) — только через инструмент Facts RAG; при низкой уверенности — честный отказ и предложение менеджера/пилота.\n- Язык: автоопределение ru/kk/en; по умолчанию ru; отвечай на языке клиента.\n- Discovery: BANT+контекст (use_case, features, integrations, volume, platforms). За ход — 1 точечный вопрос, без повторов. Остановись, когда данных достаточно для оффера/ROI или клиент готов к пилоту/менеджеру.\n- Next Best Action: на каждом шаге выбери одно: 1) Facts RAG, 2) уточняющий вопрос, 3) ROI Estimator, 4) Offer Builder, 5) Objection Handler, 6) Handover.\n- ROI: только с консервативными допущениями и явными формулами; без точных обещаний без метрик; если не хватает данных — 1 ключевой вопрос.\n- Продажи: при неопределённости предлагай упрощённый пакет/пилот/рассрочку/скидку в рамках политики; всегда CTA (созвон 15 мин / пилот X недель / бесплатный аудит).\n- Стоп‑критерии: явная просьба менеджера, готовность к пилоту, ≥3 уточнений подряд без прогресса, серьёзная жалоба → Handover с полным контекстом.\nФормат ответа клиенту: кратко, по делу, без воды. Не выдумывай факты о Truffles — используй только то, что пришло из Facts RAG."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-4016,-624],"id":"a2ff8c5e-d082-498b-ba5e-d71c22df34f4","name":"Sales Orchestrator"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-4160,-192],"id":"9279cb9c-bdd4-4581-9a6e-b585ee444f8b","name":"OpenAI Chat Model3","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.rerankerCohere","typeVersion":1,"position":[-3616,-192],"id":"5966549d-08ce-4dc2-a626-8ba70a250203","name":"Reranker Cohere2","credentials":{"cohereApi":{"id":"UEi74BtUiaLhFbqj","name":"CohereApi account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[-3744,-192],"id":"db623237-9aca-454a-9ef1-6ca9cdff03a5","name":"Embeddings OpenAI1","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Call NormalizeWhatsapp').item.json.event.metadata.remoteJid }}"},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[-4240,-400],"id":"91b0e172-8af0-428e-90a5-66c1912405de","name":"Redis Chat Memory3","credentials":{"redis":{"id":"xMdLG7kqWMMoPY0M","name":"Local"}}},{"parameters":{"toolDescription":"Извлекаю из последней реплики и контекста профиль лида: business_type, use_case, features[], integrations[], budget_number, currency (KZT по умолчанию при отсутствии знака), urgency, timeline, volume, platforms[], language_hint, sentiment, objection_type; возвращаю только явно сказанное; формат — строгий JSON","text":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}","hasOutputParser":true,"options":{}},"type":"@n8n/n8n-nodes-langchain.agentTool","typeVersion":2.2,"position":[-4112,-400],"id":"b65a92e7-6a33-4ba2-a9f8-c266447171a7","name":"Business Extractor"},{"parameters":{"mode":"retrieve-as-tool","toolDescription":"Документы о компании Truffles: услуги, процессы, политики, публичные факты, кейсы и оффер‑шаблоны с источниками; использовать для любых фактологических ответов о Truffles","qdrantCollection":{"__rl":true,"value":"FAQ_ru","mode":"list","cachedResultName":"FAQ_ru"},"useReranker":true,"options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStoreQdrant","typeVersion":1.3,"position":[-3824,-400],"id":"57639658-bb2b-4574-ac87-30e5a17e9d46","name":"Facts RAG (Truffles)","credentials":{"qdrantApi":{"id":"fNPgHKKlwuj3CF1q","name":"QdrantLocal"}}},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"business_type\": {\"type\": [\"string\",\"null\"]},\n    \"use_case\": {\"type\": [\"string\",\"null\"]},\n    \"features\": {\"type\": \"array\",\"items\":{\"type\":\"string\"}},\n    \"integrations\": {\"type\": \"array\",\"items\":{\"type\":\"string\"}},\n    \"budget_number\": {\"type\": [\"number\",\"null\"]},\n    \"currency\": {\"type\": [\"string\",\"null\"], \"enum\": [\"KZT\",\"RUB\",\"USD\",\"EUR\",null]},\n    \"urgency\": {\"type\": [\"string\",\"null\"], \"enum\": [\"low\",\"medium\",\"high\",null]},\n    \"timeline\": {\"type\": [\"string\",\"null\"]},\n    \"volume\": {\"type\": [\"string\",\"null\"]},\n    \"platforms\": {\"type\": \"array\",\"items\":{\"type\":\"string\"}},\n    \"language_hint\": {\"type\": [\"string\",\"null\"], \"enum\": [\"ru\",\"kk\",\"en\",null]},\n    \"sentiment\": {\"type\": [\"string\",\"null\"], \"enum\": [\"positive\",\"neutral\",\"negative\",null]},\n    \"objection_type\": {\"type\": [\"string\",\"null\"], \"enum\": [\"price\",\"timing\",\"quality\",\"other\",null]}\n  },\n  \"required\": [\"features\",\"integrations\",\"platforms\"]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-3872,-192],"id":"6f45fbf0-d13a-46a2-ac8b-38639709d27b","name":"Structured Output Parser"},{"parameters":{"text":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}","hasOutputParser":true,"options":{"systemMessage":"Формирую 2–3 варианта решения (Lite/Standard/Advanced) по данным профиля: этапы Discovery→MVP→Production, стек, интеграции, диапазоны сроков/бюджета, риски, требования, CTA; при недостатке данных — предлагаю Lite/пилот и 1 ключевой вопрос"}},"type":"@n8n/n8n-nodes-langchain.agentTool","typeVersion":2.2,"position":[-3536,-400],"id":"994617ca-6455-4cda-bd04-8cd8bf62497b","name":"Offer Builder"},{"parameters":{"toolDescription":"Считаю ориентир ROI и срок окупаемости чат‑бота из входных метрик; использую консервативные допущения; если ключевых метрик нет — возвращаю 1 понятный вопрос для уточнения","text":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}","hasOutputParser":true,"options":{}},"type":"@n8n/n8n-nodes-langchain.agentTool","typeVersion":2.2,"position":[-3248,-400],"id":"3911a7d9-4e6b-48c1-936e-030ad4d4a837","name":"ROI Estimator"},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\":\"object\",\n  \"properties\":{\n    \"assumptions\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n    \"formulas\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n    \"roi_point_estimate\":{\"type\":[\"number\",\"null\"]},\n    \"roi_range\":{\"type\":\"array\",\"items\":{\"type\":\"number\"}},\n    \"payback_weeks\":{\"type\":[\"number\",\"null\"]},\n    \"missing_inputs\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n    \"next_question\":{\"type\":[\"string\",\"null\"]}\n  },\n  \"required\":[\"assumptions\",\"formulas\",\"missing_inputs\"]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-3088,-192],"id":"5ec9e7e4-79d9-47b1-85f2-a83562b4e8a1","name":"Structured Output Parser2"},{"parameters":{"toolDescription":"Классифицирую возражение и выдаю пошаговый ответ: эмпатия → факт/сравнение → перефрейминг → микро‑оффер (пилот/POC/модуль/скидка в политике) → CTA; при токсичности — мягкая деэскалация","text":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}","hasOutputParser":true,"options":{}},"type":"@n8n/n8n-nodes-langchain.agentTool","typeVersion":2.2,"position":[-2960,-400],"id":"a4baff4d-afdd-4306-a78a-145e91899e3f","name":"Objection Handler"},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\":\"object\",\n  \"properties\":{\n    \"objection_type\":{\"type\":\"string\",\"enum\":[\"price\",\"timing\",\"quality\",\"other\"]},\n    \"response_steps\":{\"type\":\"array\",\"items\":{\"type\":\"string\"}},\n    \"needs_manager\":{\"type\":[\"boolean\",\"null\"]}\n  },\n  \"required\":[\"objection_type\",\"response_steps\"]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-2880,-192],"id":"519d755d-eb9b-4f91-b509-a8c0fef86cc8","name":"Structured Output Parser3"}],"connections":{"WhatsappAdapter":{"main":[[{"node":"Call NormalizeWhatsapp","type":"main","index":0}]]},"Call NormalizeWhatsapp":{"main":[[{"node":"Sales Orchestrator","type":"main","index":0}]]},"Structured Output Parser1":{"ai_outputParser":[[{"node":"Offer Builder","type":"ai_outputParser","index":0}]]},"Handover":{"ai_tool":[[{"node":"Sales Orchestrator","type":"ai_tool","index":0}]]},"Sales Orchestrator":{"main":[[{"node":"Output Router","type":"main","index":0}]]},"Output Router":{"main":[[{"node":"Send WhatsApp","type":"main","index":0}],[{"node":"Send Telegram","type":"main","index":0}]]},"OpenAI Chat Model3":{"ai_languageModel":[[{"node":"Sales Orchestrator","type":"ai_languageModel","index":0},{"node":"Business Extractor","type":"ai_languageModel","index":0},{"node":"Offer Builder","type":"ai_languageModel","index":0},{"node":"ROI Estimator","type":"ai_languageModel","index":0},{"node":"Objection Handler","type":"ai_languageModel","index":0}]]},"Reranker Cohere2":{"ai_reranker":[[{"node":"Facts RAG (Truffles)","type":"ai_reranker","index":0}]]},"Embeddings OpenAI1":{"ai_embedding":[[{"node":"Facts RAG (Truffles)","type":"ai_embedding","index":0}]]},"Redis Chat Memory3":{"ai_memory":[[{"node":"Sales Orchestrator","type":"ai_memory","index":0}]]},"Business Extractor":{"ai_tool":[[{"node":"Sales Orchestrator","type":"ai_tool","index":0}]]},"Facts RAG (Truffles)":{"ai_tool":[[{"node":"Sales Orchestrator","type":"ai_tool","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"Business Extractor","type":"ai_outputParser","index":0}]]},"Offer Builder":{"ai_tool":[[{"node":"Sales Orchestrator","type":"ai_tool","index":0}]]},"ROI Estimator":{"ai_tool":[[{"node":"Sales Orchestrator","type":"ai_tool","index":0}]]},"Structured Output Parser2":{"ai_outputParser":[[{"node":"ROI Estimator","type":"ai_outputParser","index":0}]]},"Objection Handler":{"ai_tool":[[{"node":"Sales Orchestrator","type":"ai_tool","index":0}]]},"Structured Output Parser3":{"ai_outputParser":[[{"node":"Objection Handler","type":"ai_outputParser","index":0}]]}},"settings":{"executionOrder":"v1","errorWorkflow":"Global Error Handler"},"staticData":null,"meta":{"templateCredsSetupCompleted":true,"instanceId":"01b56804ece88a9cc615224a075b1fb601dddc8bc8fa664ead4d87907f4c7973"},"pinData":{"WhatsappAdapter":[{"json":{"event":{"channel":"whatsapp","user_id":"77015705555","session_id":"77015705555@s.whatsapp.net","message":"фываыа","message_type":"text","attachments":[],"locale":"ru","timestamp":1764081975,"metadata":{"messageId":"3F5E5C7CD0D4D81995D1","sender":"Zh.","remoteJid":"77015705555@s.whatsapp.net","providerMessageType":"text","caption":null,"headers":{"connection":"upgrade","host":"n8n.truffles.kz","x-real-ip":"144.91.105.72","x-forwarded-for":"144.91.105.72","x-forwarded-proto":"https","content-length":"278","accept":"application/json, text/plain, */*","content-type":"application/json","user-agent":"axios/1.11.0","accept-encoding":"gzip, compress, deflate, br"},"webhookUrl":"https://n8n.truffles.kz/webhook/flow","executionMode":"production"},"raw":{"headers":{"connection":"upgrade","host":"n8n.truffles.kz","x-real-ip":"144.91.105.72","x-forwarded-for":"144.91.105.72","x-forwarded-proto":"https","content-length":"278","accept":"application/json, text/plain, */*","content-type":"application/json","user-agent":"axios/1.11.0","accept-encoding":"gzip, compress, deflate, br"},"params":{},"query":{},"body":{"messageType":"text","message":"фываыа","metadata":{"sender":"Zh.","timestamp":1764081975,"messageId":"3F5E5C7CD0D4D81995D1","remoteJid":"77015705555@s.whatsapp.net"},"mediaData":null,"nodeData":{"webHook":{"text":"https://n8n.truffles.kz/webhook/flow","method":"POST"}}},"webhookUrl":"https://n8n.truffles.kz/webhook/flow","executionMode":"production","body_metadata_remoteJid":"77015705555@s.whatsapp.net","":{"headers":{"connection":"upgrade","host":"n8n.truffles.kz","x-real-ip":"144.91.105.72","x-forwarded-for":"144.91.105.72","x-forwarded-proto":"https","content-length":"278","accept":"application/json, text/plain, */*","content-type":"application/json","user-agent":"axios/1.11.0","accept-encoding":"gzip, compress, deflate, br"},"params":{},"query":{},"body":{"messageType":"text","message":"фываыа","metadata":{"sender":"Zh.","timestamp":1764081975,"messageId":"3F5E5C7CD0D4D81995D1","remoteJid":"77015705555@s.whatsapp.net"},"mediaData":null,"nodeData":{"webHook":{"text":"https://n8n.truffles.kz/webhook/flow","method":"POST"}}},"webhookUrl":"https://n8n.truffles.kz/webhook/flow","executionMode":"production"}}}}}]},"versionId":"a1d31f08-f64f-44ca-9759-cc2b896dfef4","triggerCount":1,"shared":[{"updatedAt":"2025-11-27T21:18:18.259Z","createdAt":"2025-11-27T21:18:18.259Z","role":"workflow:owner","workflowId":"ZPaS9w6u3o0ZZZzm","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-07-26T06:32:19.344Z","createdAt":"2025-07-26T06:32:19.344Z","id":"f9pxFf0ryND9GzXC","name":"dev"}]},{"updatedAt":"2025-11-29T11:23:39.174Z","createdAt":"2025-08-15T11:26:42.620Z","id":"JJh1dVdNyXa7rFAS","name":"Webhook","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"flow","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-880,160],"id":"c0d8b01e-07b3-4d70-a9fc-088fd3f4cbb4","name":"Webhook","webhookId":"6b2abf67-a83b-4cb7-bc7b-81be5cf2e820"},{"parameters":{"workflowId":{"__rl":true,"value":"eGhJ4330AJQT02m2","mode":"list","cachedResultUrl":"/workflow/eGhJ4330AJQT02m2","cachedResultName":"Parse/ChannelRouter"},"workflowInputs":{"mappingMode":"defineBelow","value":{"body_metadata_remoteJid":"={{ $('Webhook').item.json.body.metadata.remoteJid }}","":"={{ $('Webhook').item.json }}"},"matchingColumns":["body_metadata_remoteJid",""],"schema":[{"id":"body_metadata_remoteJid","displayName":"body_metadata_remoteJid","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"","displayName":"","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-576,160],"name":"Call Parse/Router","id":"05868c58-2bf5-453b-bf70-b7959d9408c1"},{"parameters":{"method":"POST","url":"https://api.telegram.org/bot7730378933:AAHG1lZY6u6AmvNDF7DT29veuXUDu8EeqIc/setWebhook?url=https://n8n.truffles.kz/webhook/flow","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1024,0],"id":"83a4b45c-95ef-4d21-b558-74c307bbc50b","name":"HTTP Request1","disabled":true}],"connections":{"Webhook":{"main":[[{"node":"Call Parse/Router","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":null,"pinData":{"Webhook":[{"json":{"headers":{"connection":"upgrade","host":"n8n.truffles.kz","x-real-ip":"109.199.98.167","x-forwarded-for":"109.199.98.167","x-forwarded-proto":"https","content-length":"277","accept":"application/json, text/plain, */*","content-type":"application/json","user-agent":"axios/1.11.0","accept-encoding":"gzip, compress, deflate, br"},"params":{},"query":{},"body":{"messageType":"text","message":"lkjadsfsadf","metadata":{"sender":"Zh.","timestamp":1755254090,"messageId":"3FC262860F48C8938FD2","remoteJid":"77015705555@s.whatsapp.net"},"mediaData":null,"nodeData":{"webHook":{"text":"https://n8n.truffles.kz/webhook/flow","method":"POST"}}},"webhookUrl":"https://n8n.truffles.kz/webhook/flow","executionMode":"production"}}]},"versionId":"838dbe08-0571-4eba-aee0-7d6771480b1c","triggerCount":1,"shared":[{"updatedAt":"2025-11-27T21:18:18.259Z","createdAt":"2025-11-27T21:18:18.259Z","role":"workflow:owner","workflowId":"JJh1dVdNyXa7rFAS","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-07-26T06:32:19.344Z","createdAt":"2025-07-26T06:32:19.344Z","id":"f9pxFf0ryND9GzXC","name":"dev"}]},{"updatedAt":"2025-11-29T11:20:35.579Z","createdAt":"2025-08-22T03:46:58.530Z","id":"FGGbVJSWILC2lYMa","name":"CheckUser","active":false,"isArchived":false,"nodes":[{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"users","mode":"list","cachedResultName":"users"},"where":{"values":[{"column":"phone","value":"={{ $json.phone }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[48,352],"id":"14711d4e-366a-4780-83f4-a4385109fbca","name":"CheckUser","alwaysOutputData":true,"credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"431d0d6b-37d9-4f30-9208-636e12464fbc","leftValue":"={{ $json }}","rightValue":"","operator":{"type":"object","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[272,352],"id":"cf131d65-776e-4f39-a966-fdddefb6bfcd","name":"If"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO public.users (phone, remote_jid, name, locale, last_active, source)\nVALUES ($1, $2, $3, COALESCE($4,'ru'), now(), 'whatsapp')\nON CONFLICT (phone) DO UPDATE\nSET remote_jid = EXCLUDED.remote_jid,\nname = COALESCE(EXCLUDED.name, public.users.name),\nlocale = COALESCE(EXCLUDED.locale, public.users.locale),\nlast_active= now()\nRETURNING id, remote_jid;","options":{"queryReplacement":"={{ $('Start').item.json.phone }}\n, {{ $('Start').item.json.remote_jid }}, {{ $('Start').item.json.sender }}, {{ locale || 'ru' }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[496,560],"id":"766080d2-c280-4b37-b78b-79d88b42318b","name":"CreateUser","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"operation":"upsert","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"users","mode":"list","cachedResultName":"users"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $json.id }}","last_active":"={{ $now.toLocal()}}","phone":"={{ $json.phone }}","remote_jid":"={{ $json.remote_jid }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"phone","displayName":"phone","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"remote_jid","displayName":"remote_jid","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"name","displayName":"name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":true},{"id":"business_type","displayName":"business_type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":true},{"id":"business_details","displayName":"business_details","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":true},{"id":"budget_mention","displayName":"budget_mention","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":false,"removed":true},{"id":"locale","displayName":"locale","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":true},{"id":"source","displayName":"source","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":false,"removed":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false,"removed":true},{"id":"last_active","displayName":"last_active","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false},{"id":"gdpr_consent","displayName":"gdpr_consent","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":false,"removed":true},{"id":"consent_timestamp","displayName":"consent_timestamp","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":false,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[512,224],"id":"9aae58cb-47ac-45ba-9fa2-5984f8c10013","name":"UpdateLastSeen","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"workflowInputs":{"values":[{"name":"remote_jid"},{"name":"phone"},{"name":"last_active"},{"name":"sender"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-160,352],"id":"b9d92434-4cc6-4cd6-9be9-4cf829d76e1c","name":"Start"},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.myNewField = 1;\n}\n\nreturn $input.all();"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[720,208],"id":"728a807c-0965-4de8-b61a-faed4b6e47d7","name":"Code"},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.myNewField = 1;\n}\n\nreturn $input.all();"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[688,528],"id":"a8907b3c-6a0a-46b4-8c96-baacae66d05c","name":"Code1"}],"connections":{"CheckUser":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"UpdateLastSeen","type":"main","index":0}],[{"node":"CreateUser","type":"main","index":0}]]},"CreateUser":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Start":{"main":[[{"node":"CheckUser","type":"main","index":0}]]},"UpdateLastSeen":{"main":[[{"node":"Code","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"Start":[{"json":{"remote_jid":"77053299366@s.whatsapp.net","phone":"77053299366","last_active":"2025-08-22T09:22:27.070+05:00","sender":"Aлибек"}}]},"versionId":"c14131df-0ebe-4b11-a75a-00cb50f28d82","triggerCount":0,"shared":[{"updatedAt":"2025-11-27T21:18:18.259Z","createdAt":"2025-11-27T21:18:18.259Z","role":"workflow:owner","workflowId":"FGGbVJSWILC2lYMa","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-07-26T06:32:19.344Z","createdAt":"2025-07-26T06:32:19.344Z","id":"f9pxFf0ryND9GzXC","name":"dev"}]},{"updatedAt":"2025-11-29T11:21:58.018Z","createdAt":"2025-08-13T10:39:29.592Z","id":"WYzOHwAwNNmKEEW3","name":"Handover","active":false,"isArchived":false,"nodes":[{"parameters":{"descriptionType":"manual","toolDescription":"Send a message in Gmail","sendTo":"alibek.bekkulovqwe@gmail.com","subject":"New Customer!","message":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Message', ``, 'string') }}","options":{"appendAttribution":false,"ccList":"centr.ag3nt@gmail.com"}},"type":"n8n-nodes-base.gmailTool","typeVersion":2.1,"position":[176,736],"id":"0aa1d803-22d2-4022-af5d-8d1ff4db9c61","name":"Send a message in Gmail","webhookId":"83d76ca9-7b2b-40c6-bcaf-04b9413bf8ff","credentials":{"gmailOAuth2":{"id":"GcYat7hYpuONsoxK","name":"Gmail account"}}},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6ImNoYXQtYm90In0="},{"name":"jid","value":"={{ $('Start').item.json.body_metadata_remoteJid }}"},{"name":"msg","value":"={{ $json.output }}"}]},"options":{"queryParameterArrays":"brackets","lowercaseHeaders":true}},"name":"Send Response2","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[640,400],"id":"9232587e-4359-4137-82e2-ef78dcbb53f5"},{"parameters":{"promptType":"define","text":"=UserIntention: {{ $json.output_intention }}\nUserMessage: {{ $json.event_message }}","options":{"systemMessage":"Ты отвечаешь за отправку писем с полным контекстом. К тебе приходит сообщение, намерение клиента, который пишет к нам в чат бот и его нужно передать менеджеру. "}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[64,352],"id":"9944df81-e042-4010-823b-37a9e18b3bd5","name":"AI Agent"},{"parameters":{"workflowInputs":{"values":[{"name":"event_message","type":"any"},{"name":"output_intention","type":"any"},{"name":"body_metadata_remoteJid","type":"any"}]}},"id":"92076e4b-c362-4d61-9388-f436f98b3291","typeVersion":1.1,"name":"Start","type":"n8n-nodes-base.executeWorkflowTrigger","position":[-144,352]},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-80,560],"id":"867e1a41-db3c-46e2-aa78-5db531cccb45","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}}],"connections":{"Send a message in Gmail":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"AI Agent":{"main":[[{"node":"Send Response2","type":"main","index":0}]]},"Start":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Start":[{"json":{"event_message":"Клиент просит о передаче менеджеру.","output_intention":"передать менеджеру"}}]},"versionId":"21c1e542-6fc6-494c-9c26-42e4bcacdfae","triggerCount":0,"shared":[{"updatedAt":"2025-11-27T21:18:18.259Z","createdAt":"2025-11-27T21:18:18.259Z","role":"workflow:owner","workflowId":"WYzOHwAwNNmKEEW3","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-07-26T06:32:19.344Z","createdAt":"2025-07-26T06:32:19.344Z","id":"f9pxFf0ryND9GzXC","name":"dev"}]},{"updatedAt":"2025-11-29T11:22:39.878Z","createdAt":"2025-08-12T09:28:10.690Z","id":"XYP9r4tpIRHkudy3","name":"NormalizeWhatsapp","active":false,"isArchived":false,"nodes":[{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ad1c7565-d39f-4900-b1d0-87654ec271b9","leftValue":"={{ $json.content.type }}","rightValue":"=audio","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1312,-112],"id":"a11298ce-d798-4892-8d31-b2f5b5264fbe","name":"If"},{"parameters":{"assignments":{"assignments":[{"id":"0cbb5487-c950-49ca-9449-7da21b73c34b","name":"event.message","value":"={{ $json.event.message }}","type":"string"},{"id":"714c354f-e008-4bf9-b484-dfddcca0b246","name":"event.metadata","value":"={{ $json.event.metadata }}","type":"object"},{"id":"dd66c36f-2e29-4d49-885d-7b9663a82f1a","name":"event.user_id","value":"={{ $json.event.user_id }}","type":"string"},{"id":"fd43cbd0-12db-455a-9784-e144a4d9c099","name":"event.session_id","value":"={{ $json.event.session_id }}","type":"string"},{"id":"14118a10-0560-4071-a476-3492eb0d1260","name":"event.channel","value":"={{ $json.event.channel }}","type":"string"},{"id":"fb1b3a24-ae71-44e8-9243-dcd14e772498","name":"event.message_type","value":"={{ $json.event.message_type }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1088,-208],"id":"2a2ea474-74e9-4803-9062-5681f95bea92","name":"Return"},{"parameters":{"jsCode":"const ev = $json.event || $json;\n\n// правильная проверка аудио\nconst hasAudio = Array.isArray(ev.attachments)\n  && ev.attachments\n  && typeof ev.attachments.mimetype === 'string'\n  && ev.attachments.mimetype.startsWith('audio/');\n\nconst isAudio = (ev.message_type === 'audio') || hasAudio || !!ev.metadata?.audio_base64;\n\nreturn [{\n  json: {\n    event: ev,\n    content: {\n      type: isAudio ? 'audio' : 'text',\n      text: isAudio ? null : (ev.message || ''),\n    }\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1536,-112],"id":"fb9cab5d-22e7-4a70-b193-dfd2e9648307","name":"Code"},{"parameters":{"operation":"toBinary","sourceProperty":"event.attachments.data","binaryPropertyName":"event.attachments.data","options":{"mimeType":"audio/ogg"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[-864,-16],"id":"4ff1c961-235f-42e2-b950-4af25b46f290","name":"Convert to File"},{"parameters":{"assignments":{"assignments":[{"id":"a125f358-6efd-4d14-be3a-d3df77c34274","name":"sender","value":"={{ $json.event.session_id }}","type":"string"},{"id":"19b2a85e-9877-47e2-b82c-8d995b2183c0","name":"event.attachments.data","value":"={{ $json.event.attachments[0].base64 }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1088,-16],"id":"047ab1cf-72f6-4488-ab5c-eed30a9ad56b","name":"SetAudio"},{"parameters":{"resource":"audio","operation":"transcribe","binaryPropertyName":"event.attachments.data","options":{"language":"kk"}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-640,384],"id":"907e559c-5562-490d-83e3-9486b26b5b57","name":"Transcribe a recording1","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}},"disabled":true},{"parameters":{"resource":"audio","operation":"transcribe","binaryPropertyName":"event.attachments.data","options":{"language":"ru"}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-640,-16],"id":"1588339b-812d-4d94-a60f-241ec7d745b5","name":"Transcribe a recording","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{"promptType":"define","text":"=Оцени осмысленность следующего текста транскрибации согласно системным правилам и верни строго JSON по схеме.\nТекст:\n{{ $json.transcript || $json.text || \"\" }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=Оцени входной текст из транскрибации на глобальную и локальную связность: логический смысл, связность фраз, релевантность фрагментов друг другу, отсутствие бессмысленной мешанины и артефактов распознавания.\n\nИгнорируй орфографические/пунктуационные ошибки, если общий смысл сохраняется.\n\nСчитай “неосмысленным”, если присутствуют признаки: набор случайных слов/символов, бессвязные фразы без общей темы, повторяющийся шум (эмодзи/междометия), перемешанные языки без логики, перепутанные токены ASR.\nЕсли смысл есть — верни исходный входной текст без правок; если смысла нет — верни пустой полезной нагрузки и флаг артефактов.\n\nВывод строго в формате JSON одной строкой, без пояснений, без преамбулы.\nКритерии:\ncoherent=true, если текст выражает одну или несколько связанных мыслей, уместно реагирует на предполагаемый контекст (речь), сохраняет логический поток на уровне абзаца/фраз, даже с опечатками.\n\ncoherent=false, если это сумбур, не связанный единым топиком, нечитабелен семантически, содержит бессмысленные последовательности и/или явные артефакты распознавания (повторы фонем, “ммм эээ”, “ха ха ха” в массе, случайные символы)."}]},"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-416,384],"id":"efe66dd7-4fab-45b1-9f62-18f6c9f3f712","name":"Basic LLM Chain","disabled":true},{"parameters":{"jsonSchemaExample":"{\n\"coherent\": \"true\"\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-288,608],"id":"75c4eded-82a8-4f31-ae47-6fd3aa77d637","name":"Structured Output Parser","disabled":true},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-416,112],"id":"d0545efc-fa54-421c-b615-d09c4c1799c9","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{"promptType":"define","text":"=Оцени осмысленность следующего текста транскрибации согласно системным правилам и верни строго JSON по схеме.\nТекст:\n{{ $json.transcript || $json.text || \"\" }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=Оцени входной текст из транскрибации на глобальную и локальную связность: логический смысл, связность фраз, релевантность фрагментов друг другу, отсутствие бессмысленной мешанины и артефактов распознавания.\n\nИгнорируй орфографические/пунктуационные ошибки, если общий смысл сохраняется.\n\nСчитай “неосмысленным”, если присутствуют признаки: набор случайных слов/символов, бессвязные фразы без общей темы, повторяющийся шум (эмодзи/междометия), перемешанные языки без логики, перепутанные токены ASR.\nЕсли смысл есть — верни исходный входной текст без правок; если смысла нет — верни пустой полезной нагрузки и флаг артефактов.\n\nВывод строго в формате JSON одной строкой, без пояснений, без преамбулы.\nКритерии:\ncoherent=true, если текст выражает одну или несколько связанных мыслей, уместно реагирует на предполагаемый контекст (речь), сохраняет логический поток на уровне абзаца/фраз, даже с опечатками.\n\ncoherent=false, если это сумбур, не связанный единым топиком, нечитабелен семантически, содержит бессмысленные последовательности и/или явные артефакты распознавания (повторы фонем, “ммм эээ”, “ха ха ха” в массе, случайные символы)."}]},"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-416,-128],"id":"547755c2-5d7e-4f54-9555-dc1f158d586e","name":"Basic LLM Chain1"},{"parameters":{"jsonSchemaExample":"{\n\"coherent\": \"true\",\n\"passed_text\": \"raw text\"\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-288,112],"id":"02b8700a-8a98-48d1-8de7-fc512c84d55a","name":"Structured Output Parser1"},{"parameters":{"assignments":{"assignments":[{"id":"0cbb5487-c950-49ca-9449-7da21b73c34b","name":"event.message","value":"={{ $('Transcribe a recording').item.json.text }}","type":"string"},{"id":"714c354f-e008-4bf9-b484-dfddcca0b246","name":"event.metadata","value":"={{ $('Code').item.json.event.raw.body.metadata }}","type":"object"},{"id":"30ef8374-4c83-4434-95da-240d2fade367","name":"event.metadata.type","value":"text","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[160,192],"id":"eed0ea3d-e927-4df2-b548-c415035cf54c","name":"Return1"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-416,608],"id":"01118214-6342-4676-9c3e-345feb83b586","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4fe96f89-c475-4dca-bc94-aee628d39f94","leftValue":"={{ $json.output.coherent }}","rightValue":"true","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-64,192],"id":"cd582dc7-a1ad-46b7-a93b-db2d1240ab60","name":"Filter"},{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-1760,-112],"id":"7ac5836d-eeac-479a-9695-30e51782caab","name":"Start"},{"parameters":{"assignments":{"assignments":[{"id":"fe1c1138-fe9f-4d00-9743-5e66282d9074","name":"event.sender","value":"={{ $json.event.remote_jid }}","type":"string"},{"id":"ec2514bb-d888-4e2c-b427-617acf2295d6","name":"=event.attachments.data","value":"={{ $json.content.type }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1760,-432],"id":"727acd5c-d7ce-4622-9113-21d0e717dd01","name":"SetText","disabled":true}],"connections":{"If":{"main":[[{"node":"Return","type":"main","index":0}],[{"node":"SetAudio","type":"main","index":0}]]},"Code":{"main":[[{"node":"If","type":"main","index":0}]]},"SetAudio":{"main":[[{"node":"Convert to File","type":"main","index":0}]]},"Convert to File":{"main":[[{"node":"Transcribe a recording","type":"main","index":0}]]},"Transcribe a recording1":{"main":[[{"node":"Basic LLM Chain","type":"main","index":0}]]},"Transcribe a recording":{"main":[[{"node":"Basic LLM Chain1","type":"main","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"Basic LLM Chain","type":"ai_outputParser","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Basic LLM Chain1","type":"ai_languageModel","index":0}]]},"Structured Output Parser1":{"ai_outputParser":[[{"node":"Basic LLM Chain1","type":"ai_outputParser","index":0}]]},"Basic LLM Chain1":{"main":[[{"node":"Filter","type":"main","index":0}]]},"Basic LLM Chain":{"main":[[{"node":"Filter","type":"main","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"Basic LLM Chain","type":"ai_languageModel","index":0}]]},"Filter":{"main":[[{"node":"Return1","type":"main","index":0}]]},"Return":{"main":[[]]},"Start":{"main":[[{"node":"Code","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Start":[{"json":{"event":{"channel":"whatsapp","user_id":"77015705555","session_id":"77015705555@s.whatsapp.net","message":"мне нужно разработать бота для шлюх. и чтобы была интеграция c 1C и инстаграм. за 50 тысч\\","message_type":"text","attachments":[],"locale":"ru","timestamp":1755607236,"metadata":{"messageId":"3FC2CD4BF1A37C9FBCD7","sender":"Zh.","remoteJid":"77015705555@s.whatsapp.net","providerMessageType":"text","caption":null,"headers":{"connection":"upgrade","host":"n8n.truffles.kz","x-real-ip":"109.199.98.167","x-forwarded-for":"109.199.98.167","x-forwarded-proto":"https","content-length":"426","accept":"application/json, text/plain, */*","content-type":"application/json","user-agent":"axios/1.11.0","accept-encoding":"gzip, compress, deflate, br"},"webhookUrl":"https://n8n.truffles.kz/webhook/flow","executionMode":"production"},"raw":{"headers":{"connection":"upgrade","host":"n8n.truffles.kz","x-real-ip":"109.199.98.167","x-forwarded-for":"109.199.98.167","x-forwarded-proto":"https","content-length":"426","accept":"application/json, text/plain, */*","content-type":"application/json","user-agent":"axios/1.11.0","accept-encoding":"gzip, compress, deflate, br"},"params":{},"query":{},"body":{"messageType":"text","message":"мне нужно разработать бота для шлюх. и чтобы была интеграция c 1C и инстаграм. за 50 тысч\\","metadata":{"sender":"Zh.","timestamp":1755607236,"messageId":"3FC2CD4BF1A37C9FBCD7","remoteJid":"77015705555@s.whatsapp.net"},"mediaData":null,"nodeData":{"webHook":{"text":"https://n8n.truffles.kz/webhook/flow","method":"POST"}}},"webhookUrl":"https://n8n.truffles.kz/webhook/flow","executionMode":"production","body_metadata_remoteJid":"77015705555@s.whatsapp.net","":{"headers":{"connection":"upgrade","host":"n8n.truffles.kz","x-real-ip":"109.199.98.167","x-forwarded-for":"109.199.98.167","x-forwarded-proto":"https","content-length":"426","accept":"application/json, text/plain, */*","content-type":"application/json","user-agent":"axios/1.11.0","accept-encoding":"gzip, compress, deflate, br"},"params":{},"query":{},"body":{"messageType":"text","message":"мне нужно разработать бота для шлюх. и чтобы была интеграция c 1C и инстаграм. за 50 тысч\\","metadata":{"sender":"Zh.","timestamp":1755607236,"messageId":"3FC2CD4BF1A37C9FBCD7","remoteJid":"77015705555@s.whatsapp.net"},"mediaData":null,"nodeData":{"webHook":{"text":"https://n8n.truffles.kz/webhook/flow","method":"POST"}}},"webhookUrl":"https://n8n.truffles.kz/webhook/flow","executionMode":"production"}}}}}]},"versionId":"a58195be-9fa8-441b-bb62-d603dcff55ae","triggerCount":0,"shared":[{"updatedAt":"2025-11-27T21:18:18.259Z","createdAt":"2025-11-27T21:18:18.259Z","role":"workflow:owner","workflowId":"XYP9r4tpIRHkudy3","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-07-26T06:32:19.344Z","createdAt":"2025-07-26T06:32:19.344Z","id":"f9pxFf0ryND9GzXC","name":"dev"}]},{"updatedAt":"2025-11-29T17:23:48.522Z","createdAt":"2025-11-29T11:22:12.229Z","id":"EHa0JpHbLxvErT9y","name":"tool_Handover","active":false,"isArchived":false,"nodes":[{"parameters":{"descriptionType":"manual","toolDescription":"Send a message in Gmail","sendTo":"centr.ag3nt@gmail.com","subject":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Subject', ``, 'string') }}","message":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Message', ``, 'string') }}","options":{"appendAttribution":false}},"type":"n8n-nodes-base.gmailTool","typeVersion":2.1,"position":[272,576],"id":"05970501-56e9-4bab-bb4a-fecd75c6b3e0","name":"Send a message in Gmail","webhookId":"25343e53-8f6a-443e-9f79-2a3c093846cf","credentials":{"gmailOAuth2":{"id":"GcYat7hYpuONsoxK","name":"Gmail account"}}},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6InRydWZmbGVzLWNoYXRib3QifQ=="},{"name":"jid","value":"={{ $('Start').item.json.body_metadata_remoteJid }}"},{"name":"msg","value":"={{ $json.output }}"}]},"options":{"queryParameterArrays":"brackets","lowercaseHeaders":true}},"name":"Send Response2","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[528,368],"id":"428547a4-aced-4f17-b7fb-976bc157751d"},{"parameters":{"promptType":"define","text":"=UserIntention: {{ $json.output_intention }}\nUserMessage: {{ $json.event_message }}","options":{"systemMessage":"Ты отвечаешь за отправку писем с полным контекстом. К тебе приходит сообщение, намерение клиента, который пишет к нам в чат бот и его нужно передать менеджеру. "}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[64,352],"id":"5acd11f7-1255-403b-a630-7b85ddf0cb58","name":"AI Agent"},{"parameters":{"workflowInputs":{"values":[{"name":"event_message","type":"any"},{"name":"output_intention","type":"any"},{"name":"body_metadata_remoteJid","type":"any"}]}},"id":"3c96b08c-3be8-40b9-9201-f5acc19d38d0","typeVersion":1.1,"name":"Start","type":"n8n-nodes-base.executeWorkflowTrigger","position":[-144,352]},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-80,560],"id":"363869a5-3240-49e2-9b1a-025b99f67b51","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}}],"connections":{"Send a message in Gmail":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"AI Agent":{"main":[[{"node":"Send Response2","type":"main","index":0}]]},"Start":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Start":[{"json":{"event_message":"ты ебаная шлюха что ты дселал","output_intention":"complaint","body_metadata_remoteJid":"77015705555@s.whatsapp.net"}}]},"versionId":"255a90c1-19b7-4c46-a651-05f69e15b383","triggerCount":0,"shared":[{"updatedAt":"2025-11-29T11:22:12.229Z","createdAt":"2025-11-29T11:22:12.229Z","role":"workflow:owner","workflowId":"EHa0JpHbLxvErT9y","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-11-27T06:22:27.418Z","createdAt":"2025-11-24T15:59:35.000Z","id":"truffles-chatbot-tag","name":"truffles-chatbot"}]},{"updatedAt":"2025-11-29T11:35:02.728Z","createdAt":"2025-08-16T03:07:12.361Z","id":"eGhJ4330AJQT02m2","name":"Parse/ChannelRouter","active":false,"isArchived":false,"nodes":[{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.event.channel }}","rightValue":"whatsapp","operator":{"type":"string","operation":"equals"},"id":"d9576e0f-6224-4ccd-8e45-0292943998de"}],"combinator":"and"},"renameOutput":true,"outputKey":"whatsapp"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.event.channel }}","rightValue":"telegram","operator":{"type":"string","operation":"equals"},"id":"telegram-condition-id"}],"combinator":"and"},"renameOutput":true,"outputKey":"telegram"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-480,160],"id":"f0d83731-6d86-4178-895c-cd1d0f0bca94","name":"Channel"},{"parameters":{"workflowId":{"__rl":true,"value":"ZPaS9w6u3o0ZZZzm","mode":"list","cachedResultUrl":"/workflow/ZPaS9w6u3o0ZZZzm","cachedResultName":"WhatsApp Adapter Main"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-112,0],"id":"6679323d-117b-4b17-821e-9aaea86974b2","name":"Whatsapp Adapter"},{"parameters":{"inputSource":"passthrough"},"id":"36c33a1f-4342-4c97-9dff-b803479c68a8","typeVersion":1.1,"name":"Start","type":"n8n-nodes-base.executeWorkflowTrigger","position":[-880,160]},{"parameters":{"jsCode":"function parseWhatsApp(item) {\n  const src = item.json || {};\n  const b = src.body ?? {};\n  const md = b.metadata ?? {};\n  const remoteJid = String(md.remoteJid || '').trim();\n  const phone = remoteJid.replace('@s.whatsapp.net','').replace(/\\D/g,'');\n  const userId = phone || remoteJid || 'unknown';\n  const sessionId = remoteJid || userId;\n\n  const rawMessage = typeof b.message === 'string' ? b.message : '';\n  const textMessage = rawMessage.trim();\n\n  // Strict rule: text wins if present, otherwise audio\n  const isText = textMessage.length > 0;\n  const isAudioCandidate = !!b.mediaData && (\n    b.mediaData.type === 'audio' ||\n    (typeof b.mediaData.mimetype === 'string' && b.mediaData.mimetype.startsWith('audio/'))\n  );\n\n  const normalizedType = isText ? 'text' : (isAudioCandidate ? 'audio' : 'unknown');\n  const attachments = !isText && isAudioCandidate ? [b.mediaData] : [];\n\n  // Preserve any caption if provider echoes text alongside audio\n  const caption = (b.mediaData && typeof b.mediaData.caption === 'string') ? b.mediaData.caption : '';\n  const ts = Number(md.timestamp || Date.now());\n\n  return {\n    channel: 'whatsapp',\n    user_id: userId,\n    session_id: sessionId,\n    message: isText ? textMessage : '',       // only for text case\n    message_type: normalizedType,             // 'text' | 'audio' | 'unknown'\n    attachments,                              // only audio when text is empty\n    locale: 'ru',\n    timestamp: ts,\n    metadata: {\n      messageId: md.messageId || null,\n      sender: md.sender || null,\n      remoteJid,\n      providerMessageType: b.messageType || null, // keep for audit only\n      caption: isText ? null : (caption || rawMessage || null), // caption when audio\n      headers: src.headers || {},\n      webhookUrl: src.webhookUrl || null,\n      executionMode: src.executionMode || null\n    },\n    raw: src\n  };\n}\n\nfunction parseTelegram(item) {\n  const src = item.json || {};\n  const b = src.body || {};\n  const msg = b.message || {};\n  const chatId = msg.chat?.id;\n  const userId = String(chatId);\n  \n  return {\n    channel: 'telegram',\n    user_id: userId,\n    session_id: 'telegram_' + userId,\n    message: msg.text || '',\n    message_type: 'text',\n    attachments: [],\n    locale: 'ru',\n    timestamp: (msg.date || Date.now() / 1000) * 1000,\n    metadata: {\n      chat_id: chatId,\n      user_name: msg.from?.first_name,\n      message_id: msg.message_id,\n      headers: src.headers || {},\n      webhookUrl: src.webhookUrl || null\n    },\n    raw: src\n  };\n}\n\nconst out = [];\nfor (const item of items) {\n  const body = item.json?.body || {};\n  const isWhatsApp = Boolean(body?.metadata?.remoteJid?.includes('s.whatsapp.net'));\n  const isTelegram = Boolean(body?.message?.chat?.id);\n\n  let event;\n  if (isWhatsApp) {\n    event = parseWhatsApp(item);\n  } else if (isTelegram) {\n    event = parseTelegram(item);\n  } else {\n    event = {\n      channel: 'unknown',\n      user_id: 'unknown',\n      session_id: 'unknown',\n      message: typeof body.message === 'string' ? body.message : '',\n      message_type: 'unknown',\n      attachments: body.mediaData ? [body.mediaData] : [],\n      locale: 'ru',\n      timestamp: Number(body?.metadata?.timestamp || Date.now()),\n      metadata: { note: 'channel_not_enabled' },\n      raw: item.json\n    };\n  }\n  out.push({ json: { event } });\n}\nreturn out;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-672,160],"id":"27742216-e2ad-461c-9ecd-f4e6f523bf89","name":"NormalizeEvent"}],"connections":{"Channel":{"main":[[{"node":"Whatsapp Adapter","type":"main","index":0}],[{"node":"Whatsapp Adapter","type":"main","index":0}],[]]},"Whatsapp Adapter":{"main":[[]]},"Start":{"main":[[{"node":"NormalizeEvent","type":"main","index":0}]]},"NormalizeEvent":{"main":[[{"node":"Channel","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"instanceId":"01b56804ece88a9cc615224a075b1fb601dddc8bc8fa664ead4d87907f4c7973"},"pinData":{},"versionId":"e26587cb-df02-423b-9953-755e35cb42c3","triggerCount":0,"shared":[{"updatedAt":"2025-11-27T21:18:18.259Z","createdAt":"2025-11-27T21:18:18.259Z","role":"workflow:owner","workflowId":"eGhJ4330AJQT02m2","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-07-26T06:32:19.344Z","createdAt":"2025-07-26T06:32:19.344Z","id":"f9pxFf0ryND9GzXC","name":"dev"}]},{"updatedAt":"2025-11-30T05:42:55.010Z","createdAt":"2025-11-20T08:47:53.169Z","id":"uplsVTCuGfH9Yafv","name":"Gate Crypto v2","active":true,"isArchived":false,"nodes":[{"parameters":{"method":"POST","url":"https://api.telegram.org/bot7730378933:AAHG1lZY6u6AmvNDF7DT29veuXUDu8EeqIc/setWebhook?url=https://n8n.truffles.kz/webhook/money","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2096,1040],"id":"5de816fd-bb53-4f99-8608-9dc26ce4f9bd","name":"HTTP Request1","disabled":true},{"parameters":{"model":{"__rl":true,"value":"gpt-5.1","mode":"list","cachedResultName":"gpt-5.1"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-1008,656],"id":"baecd20e-602a-4d1b-9259-8c4366c44e30","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.decision }}","value2":"TAKE"}]}},"id":"8de34ac7-f9f2-471d-82ac-c7fd81510c83","name":"IF TAKE","type":"n8n-nodes-base.if","typeVersion":1,"position":[-1232,432]},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Im1haW4tdHJhZGluZyJ9"},{"name":"jid","value":"=77071956096@s.whatsapp.net"},{"name":"msg","value":"={{ $json.message }}"}]},"options":{}},"name":"Nurzhan","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-176,640],"id":"1ff3b98d-911b-4ae7-adef-90bc93e887d5","disabled":true},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Im1haW4tdHJhZGluZyJ9"},{"name":"jid","value":"=77015705555@s.whatsapp.net"},{"name":"msg","value":"={{ $json.message }}"}]},"options":{}},"name":"Me","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-160,480],"id":"b8355ead-a78f-4609-8501-5ad9befb59db"},{"parameters":{"chatId":"1969855532","text":"={{ $json.message }}","additionalFields":{"appendAttribution":false,"parse_mode":"HTML"}},"id":"cba0b409-9cdd-4468-b560-00af07534062","name":"Me1","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-176,336],"webhookId":"2cc848c8-10f5-4ade-9164-426d7d84dac9","credentials":{"telegramApi":{"id":"1YMuki43SISyhVa0","name":"Telegram account"}}},{"parameters":{"httpMethod":"POST","path":"money","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-2336,704],"id":"e5fd0ba9-ae1c-45ed-99ad-8d8676ad5150","name":"Webhook","webhookId":"0f1cfcb1-1e69-4da7-8451-8810c25dd178"},{"parameters":{"promptType":"define","text":"={{ JSON.stringify($json) }}","options":{"systemMessage":"Ты — Senior Risk Manager алгоритмического фонда. Твоя задача — финальная валидация торгового сигнала перед отправкой на биржу.\n\nТвои жесткие правила:\n1. Приоритет №1 — Защита капитала. Лучше пропустить 10 хороших сделок, чем взять одну убыточную \"на удачу\".\n2. Если RVOL < 1.2 — ты обязан выразить скепсис (Low Volume Warning).\n3. Если Цена ушла от VWAP более чем на 3.0 ATR — это Overextended, риск отката высок.\n4. Твой вердикт (TAKE/PASS) должен базироваться на фактах из JSON, а не на надежде.\n\nФОРМАТ ОТВЕТА (СТРОГО):\nВерни ТОЛЬКО один корректный JSON-объект без Markdown, без комментариев, без текста вокруг, вида:\n{\n  \"decision\": \"TAKE\" | \"PASS\",\n  \"confidence\": 0.0,\n  \"short_reason\": \"краткое объяснение на 1–2 предложения\",\n  \"risks\": [\"факт 1\", \"факт 2\"]\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-1008,432],"id":"f3a63690-4b92-4dad-94f1-be16e3439928","name":"TradingMasterAI"},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Im1haW4tdHJhZGluZyJ9"},{"name":"jid","value":"=77475111570@s.whatsapp.net"},{"name":"msg","value":"={{ $json.message }}"}]},"options":{}},"name":"Nurzhan1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-176,800],"id":"1c9900df-d1bb-4164-ba8c-ac544907bb76","disabled":true},{"parameters":{"operation":"executeQuery","query":"INSERT INTO trade.ai_decisions (\n  gate_ts,\n  symbol_id,\n  gate_decision,\n  ai_verdict,\n  ai_confidence,\n  reasons_for,\n  reasons_against,\n  checklist,\n  full_json\n) VALUES (\n  {{ $node[\"IF TAKE\"].json.gate_ts || $node[\"IF TAKE\"].json.bar_time }},\n  '{{ $node[\"IF TAKE\"].json.symbol_id }}',\n  '{{ $node[\"IF TAKE\"].json.decision }}',\n  '{{ $json.decision }}',\n  {{ $json.confidence }},\n  '[]'::jsonb,\n  '{{ JSON.stringify($json.risks || []) }}'::jsonb,\n  '[]'::jsonb,\n  '{{ JSON.stringify($json) }}'::jsonb\n);\n","options":{"queryReplacement":""}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-544,208],"id":"e5ddfa32-601f-4666-925c-f87a90cbd2e9","name":"AI Verdict","credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO trade.signals_raw (\n    symbol, symbol_id, tf, htf, bar_time_ms,\n    entry_price, sl, tp, rr, equity, risk_pct,\n    cmf, rvol_time, mintick, pointvalue, lot_step,\n    session, strategy, strategy_version, gate_version, experiment_id,\n    raw_json, created_at\n) VALUES (\n    '{{ $json.symbol }}',\n    '{{ $json.symbol_id }}',\n    '{{ $json.tf }}',\n    '{{ $json.htf }}',\n    {{ $json.bar_time }},\n    {{ $json.entry_price }},\n    {{ $json.sl }},\n    {{ $json.tp }},\n    {{ $json.rr }},\n    {{ $json.equity }},\n    {{ $json.risk_pct }},\n    {{ $json.cmf }},\n    {{ $json.rvol_time }},\n    {{ $json.mintick }},\n    {{ $json.pointvalue }},\n    {{ $json.lot_step }},\n    '{{ $json.session }}',\n    '{{ $json.strategy }}',\n    '{{ $json.strategy_version }}',\n    'Gate_Crypto_v2',\n    '{{ $json.experiment_id }}',\n    '{{ JSON.stringify($json) }}'::jsonb,\n    NOW()\n);\n","options":{}},"id":"f92159d3-9555-4089-97ac-4c04541b2431","name":"signals_raw1","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1232,608],"credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO trade.gate_decisions (\n    symbol_id, decision, reasons, qty_req, qty_rnd,\n    risk_usd, rr, stop_dist_atr, cmf, rvol,\n    spread_pct, full_json, qty_hint_oz, action, gate_ts,\n    risk_target, risk_actual, risk_diff_pct, created_at\n)\nVALUES (\n    '{{ $json.symbol_id }}',\n    '{{ $json.decision }}',\n    '{{ JSON.stringify($json.reasons || []) }}',\n    {{ $json.position.qty_required }},\n    {{ $json.position.qty_rounded }},\n    {{ $json.position.risk_usd_actual }},\n    {{ $json.analytics.rr_calc }},\n    {{ $json.analytics.dist_vwap_atr }},\n    {{ $json.analytics.cmf }},\n    {{ $json.analytics.rvol }},\n    {{ $json.analytics.spread_pct }},\n    '{{ JSON.stringify($json) }}'::jsonb,\n    {{ $json.qty_hint_oz }},\n    '{{ $json.action }}',\n    {{ $json.gate_ts || $json.bar_time }},\n    {{ $json.position.risk_usd_target }},\n    {{ $json.position.risk_usd_actual }},\n    {{ $json.position.risk_diff_pct }},\n    NOW()\n);\n","options":{}},"id":"5cf7f739-ccd4-42b8-9702-f283b2338981","name":"after_decisions1","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1232,784],"credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8303315a-a797-4933-9b69-d4db72c4c93c","leftValue":"={{ $json.gate_v2.passed }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1920,704],"id":"4589b373-e01d-4567-8905-49fb795e4d79","name":"If"},{"parameters":{"jsCode":"const s = items[0].json;\n\n// --- НАСТРОЙКИ РИСКА ---\nconst RISK_PARAMS = {\n  account_balance: 500,\n  risk_per_trade_usd: 5.0,\n  max_position_usd: 400,\n  leverage_limit: 5,\n};\n\n// Цены\nconst entry = parseFloat(s.entry_price);\nconst sl    = parseFloat(s.sl);\nconst tp    = parseFloat(s.tp);\n\n// Если по каким‑то причинам цен нет — просто пробрасываем сигнал дальше\nif (!entry || !sl || !tp) {\n  return [{ json: { ...s } }];\n}\n\n// Размер стопа\nconst stop_loss_dist = Math.abs(entry - sl);\n\n// Объём в монетах по риску\nlet qty_raw = RISK_PARAMS.risk_per_trade_usd / stop_loss_dist;\n\n// Хард‑лимит по размеру позиции\nlet position_value_usd = qty_raw * entry;\nif (position_value_usd > RISK_PARAMS.max_position_usd) {\n  qty_raw = RISK_PARAMS.max_position_usd / entry;\n  position_value_usd = qty_raw * entry;\n}\n\n// Округление по шагу лота\nconst lot_step = s.lot_step || 0.01;\nconst qty_final = Math.floor(qty_raw / lot_step) * lot_step;\n\n// Фактический риск\nconst risk_actual = qty_final * stop_loss_dist;\n\n// Потенциальная прибыль и RR\nconst profit_dist      = Math.abs(tp - entry);\nconst profit_potential = qty_final * profit_dist;\nconst rr_actual        = risk_actual > 0 ? profit_potential / risk_actual : 0;\n\n// Дифф. по риску (% отклонение от таргета)\nconst risk_target = RISK_PARAMS.risk_per_trade_usd;\nconst risk_diff_pct =\n  risk_target > 0 ? ((risk_actual - risk_target) / risk_target) * 100 : 0;\n\n// Собираем position в формате, который ждут after_decisions1 и Formatter\nconst position = {\n  entry_price: entry,\n  sl,\n  tp,\n  qty: qty_final,\n  qty_required: qty_final,\n  qty_rounded: qty_final,\n  risk_usd_target: parseFloat(risk_target.toFixed(2)),\n  risk_usd_actual: parseFloat(risk_actual.toFixed(2)),\n  risk_diff_pct: parseFloat(risk_diff_pct.toFixed(2)),\n};\n\n// Обёртка risk_manager (для себя)\nconst risk_manager = {\n  qty_req: parseFloat(qty_final.toFixed(4)),\n  position_usd: parseFloat(position_value_usd.toFixed(2)),\n  risk_usd: parseFloat(risk_actual.toFixed(2)),\n  rr_actual: parseFloat(rr_actual.toFixed(2)),\n  leverage_used: parseFloat(\n    (position_value_usd / RISK_PARAMS.account_balance).toFixed(2),\n  ),\n};\n\nconst out = {\n  ...s,\n  decision: s.decision || \"TAKE\", // Gate v2: сюда попадают уже прошедшие фильтр\n  position,\n  risk_manager,\n};\n\nreturn [{ json: out }];\n"},"id":"861738fb-9e96-424e-8ed9-ff5da7471231","name":"Risk Calculation","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1632,688]},{"parameters":{"jsCode":"// Корневой объект от Webhook\nconst root = items[0].json;\n\n// Полезная нагрузка TradingView\nconst b = root.body || root;  // если когда‑то Webhook будет слать сразу плоско\n\n// Нормализуем RVOL: берём rvol или rvol_time, иначе 1.0\nconst rvol = b.rvol ?? b.rvol_time ?? 1.0;\n\n// Нормализуем спред\nlet spreadPct = b.spread_pct;\nif (spreadPct == null && b.spread_cost != null && b.entry_price != null) {\n  spreadPct = (b.spread_cost / b.entry_price) * 100;\n}\nif (spreadPct == null) {\n  spreadPct = 0;\n}\n\n// Дистанция от VWAP в ATR\nlet distATR = b.dist_vwap_atr;\nif (distATR == null && b.vwap != null && b.atr != null && b.entry_price != null) {\n  distATR = Math.abs(b.entry_price - b.vwap) / b.atr;\n}\nif (distATR == null) {\n  distATR = 0;\n}\n\n// RR из цен\nlet rrCalc = b.rr;\nif ((rrCalc == null || rrCalc === 0) && b.tp != null && b.sl != null && b.entry_price != null) {\n  const profitDist = Math.abs(b.tp - b.entry_price);\n  const stopDist   = Math.abs(b.entry_price - b.sl);\n  rrCalc = stopDist > 0 ? profitDist / stopDist : 0;\n}\n\n// --- КОНФИГ ФИЛЬТРОВ ---\nconst CONFIG = {\n  min_rvol: 1.1,\n  max_spread_pct: 0.15,\n  max_dist_vwap_atr: 3.5,\n  allowed_tf: [\"15\"],\n  min_rr: 1.5,\n};\n\nlet isPassed = true;\nlet failReason = null;\n\n// 1) Таймфрейм\nif (!CONFIG.allowed_tf.includes(b.tf)) {\n  isPassed = false;\n  failReason = `Wrong TF (${b.tf})`;\n}\n\n// 2) RVOL\nelse if (rvol < CONFIG.min_rvol) {\n  isPassed = false;\n  failReason = `Low Volume (RVOL ${rvol.toFixed(2)} < ${CONFIG.min_rvol})`;\n}\n\n// 3) Перегрев от VWAP\nelse if (distATR > CONFIG.max_dist_vwap_atr) {\n  isPassed = false;\n  failReason = `Overextended (Price is ${distATR.toFixed(2)} ATR from VWAP)`;\n}\n\n// 4) Спред\nelse if (spreadPct > CONFIG.max_spread_pct) {\n  isPassed = false;\n  failReason = `High Spread (${spreadPct.toFixed(3)}% > ${CONFIG.max_spread_pct}%)`;\n}\n\n// 5) RR\nelse if (rrCalc < CONFIG.min_rr) {\n  isPassed = false;\n  failReason = `Low RR (${rrCalc.toFixed(2)} < ${CONFIG.min_rr})`;\n}\n\n// Собираем «плоский» сигнал + служебную инфу\nconst out = {\n  // ВСЕ торговые поля — на верхнем уровне:\n  ...b,\n\n  // analytics для after_decisions1 и Formatter\n  analytics: {\n    rr_calc: rrCalc,\n    dist_vwap_atr: distATR,\n    cmf: b.cmf,\n    rvol,\n    spread_pct: spreadPct,\n  },\n\n  rvol,\n  spread_pct: spreadPct,\n\n  gate_v2: {\n    passed: isPassed,\n    status: isPassed ? \"PASS_FILTER\" : \"REJECTED\",\n    fail_reason: failReason,\n    checked_at: new Date().toISOString(),\n    metrics: {\n      rvol,\n      dist_atr: distATR,\n    },\n  },\n\n  // Дополнительно при желании сохраняем метаданные Webhook\n  headers: root.headers,\n  webhookUrl: root.webhookUrl,\n  executionMode: root.executionMode,\n};\n\n// ВАЖНО: всегда возвращаем массив items\nreturn [{ json: out }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2128,704],"id":"0c1d3df1-1543-4d75-a424-d1689ca61601","name":"Technical Pre-Filter"},{"parameters":{"jsCode":"// raw может быть строкой или объектом вида { text: \"...\"} — подстрахуемся\nconst raw = items[0].json;\n\nlet text;\nif (typeof raw === 'string') {\n  text = raw;\n} else if (typeof raw.text === 'string') {\n  text = raw.text;\n} else if (typeof raw.output === 'string') {\n  text = raw.output;\n} else {\n  // на всякий случай\n  text = JSON.stringify(raw);\n}\n\nlet obj;\ntry {\n  obj = JSON.parse(text);\n} catch (e) {\n  // fallback: если модель всё равно выдала мусор\n  obj = {\n    decision: \"PASS\",\n    confidence: 0,\n    short_reason: \"AI response parse error, forced PASS.\",\n    risks: [text.slice(0, 200)]\n  };\n}\n\n// Нормализуем типы\nobj.decision    = obj.decision || \"PASS\";\nobj.confidence  = typeof obj.confidence === \"number\" ? obj.confidence : 0;\nobj.short_reason = obj.short_reason || \"\";\nobj.risks       = Array.isArray(obj.risks) ? obj.risks : [];\n\nreturn [{ json: obj }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-720,432],"id":"a5a6f258-70b1-4334-bc18-a919a3473e76","name":"AI Verdict Normalize"},{"parameters":{"jsCode":"const gate = $node[\"IF TAKE\"].json;   // сигнал после Risk Calculation\nconst ai   = items[0].json;           // результат AI Verdict Normalize\n\nfunction num(val, d = 2) {\n  if (val == null || val === '-') return '-';\n  const n = parseFloat(val);\n  return Number.isNaN(n) ? '-' : n.toFixed(d);\n}\n\n// Функция защиты текста для HTML режима Телеграм\nfunction escapeHtml(text) {\n  if (!text) return \"\";\n  return String(text)\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\");\n}\n\nconst decision = gate.decision || \"PASS\";\nconst symbol   = gate.symbol  || \"-\";\nconst action   = gate.action  || \"BUY\";\n\nconst entry = num(gate.position?.entry_price);\nconst sl    = num(gate.position?.sl);\nconst tp    = num(gate.position?.tp);\nconst qty   = num(gate.position?.qty);\nconst rr    = num(gate.analytics?.rr_calc);\n\nconst rActual = num(gate.position?.risk_usd_actual);\nconst rTarget = num(gate.position?.risk_usd_target);\n\nconst statusEmoji = decision === \"TAKE\" && ai.decision !== \"PASS\" ? \"🟢\" : \"🔴\";\nconst actionEmoji = action === \"BUY\" ? \"📈\" : \"📉\";\n\n// Собираем сообщение\nlet msg = `${statusEmoji} ${decision} ${actionEmoji} ${escapeHtml(symbol)}\\n\\n` +\n          `Entry: ${entry} | SL: ${sl} | TP: ${tp} (RR: ${rr})\\n` +\n          `Size: ${qty} | Risk: $${rActual} / $${rTarget}\\n\\n` +\n          `🤖 AI (${num(ai.confidence, 2)}): ${escapeHtml(ai.short_reason || '-')}`;\n\nif (ai.risks && ai.risks.length > 0) {\n  // Джойним риски и тоже экранируем\n  const risksText = ai.risks.map(r => escapeHtml(r)).join('; ');\n  msg += `\\n⚠️ Risks: ${risksText}`;\n}\n\n// ЖЕСТКАЯ ЗАЩИТА ОТ ДЛИНЫ (Телеграм лимит 4096)\n// Режем на 4000, чтобы оставить запас под системные символы\nif (msg.length > 4000) {\n  msg = msg.substring(0, 4000) + \"... (обрезано)\";\n}\n\nreturn {\n  json: {\n    message: msg,\n    gate_decision: decision,\n    ai_decision: ai.decision,\n    ai_confidence: ai.confidence\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-480,432],"id":"251c0bf6-c8dd-4f16-bc3f-a41d3a884c9f","name":"Formatter"}],"connections":{"OpenAI Chat Model":{"ai_languageModel":[[{"node":"TradingMasterAI","type":"ai_languageModel","index":0}]]},"IF TAKE":{"main":[[{"node":"TradingMasterAI","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Technical Pre-Filter","type":"main","index":0}]]},"TradingMasterAI":{"main":[[{"node":"AI Verdict Normalize","type":"main","index":0}]]},"If":{"main":[[{"node":"Risk Calculation","type":"main","index":0}]]},"Risk Calculation":{"main":[[{"node":"after_decisions1","type":"main","index":0},{"node":"signals_raw1","type":"main","index":0},{"node":"IF TAKE","type":"main","index":0}]]},"Technical Pre-Filter":{"main":[[{"node":"If","type":"main","index":0}]]},"AI Verdict Normalize":{"main":[[{"node":"AI Verdict","type":"main","index":0},{"node":"Formatter","type":"main","index":0}]]},"Formatter":{"main":[[{"node":"Me1","type":"main","index":0},{"node":"Me","type":"main","index":0},{"node":"Nurzhan","type":"main","index":0},{"node":"Nurzhan1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":true},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"n8n.truffles.kz","user-agent":"Go-http-client/1.1","content-length":"608","accept-encoding":"gzip","content-type":"application/json; charset=utf-8","x-forwarded-for":"52.32.178.7","x-forwarded-host":"n8n.truffles.kz","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"68926a3e1a32","x-real-ip":"52.32.178.7"},"params":{},"query":{},"body":{"action":"BUY","dir":"long","symbol":"GOLD","symbol_id":"CAPITALCOM:GOLD","tf":"15","htf":"60","entry_price":4171.51,"sl":4159.41358,"tp":4195.70285,"rr":2,"equity":500,"risk_pct":0.75,"vwap":4177.12022,"sma20":4171.6265,"atr":10.08035,"cmf":0.05639,"htf_ema":4160.75731,"rvol_time":1.674,"vwap_relation":"below","session":"Gold","gold_prime_time":true,"risk_event":false,"mintick":0.01,"pointvalue":1,"lot_step":0.01,"spread_cost":0,"bar_time":1764328501511,"strategy":"HYBRID_CORE_v1_7_4","strategy_version":"HYBRID_CORE_v1_7_4","experiment_id":"crypto_exp_base","dist_vwap_atr":0.56,"qty_hint_oz":0.31},"webhookUrl":"https://n8n.truffles.kz/webhook/money","executionMode":"production"}}]},"versionId":"17ea76b4-a404-4fea-9136-158d915abf3f","triggerCount":1,"shared":[{"updatedAt":"2025-11-27T21:18:18.259Z","createdAt":"2025-11-27T21:18:18.259Z","role":"workflow:owner","workflowId":"uplsVTCuGfH9Yafv","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-11-27T06:11:33.174Z","createdAt":"2025-11-27T06:11:33.174Z","id":"jpta0H3sZxVGTF8B","name":"trading"}]},{"updatedAt":"2025-11-30T05:43:02.549Z","createdAt":"2025-11-19T16:15:23.801Z","id":"9LukFnXTRJgsUuO2","name":"Gate GOLD exp2 Gemini","active":true,"isArchived":false,"nodes":[{"parameters":{"method":"POST","url":"https://api.telegram.org/bot7730378933:AAHG1lZY6u6AmvNDF7DT29veuXUDu8EeqIc/setWebhook?url=https://n8n.truffles.kz/webhook/money","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2096,1056],"id":"6582dc82-5a55-46e5-bd3e-977c561cd402","name":"HTTP Request1","disabled":true},{"parameters":{"model":{"__rl":true,"value":"gpt-5.1","mode":"list","cachedResultName":"gpt-5.1"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-1216,672],"id":"8e572864-da9a-4002-9161-b45b1e6451e7","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{"jsonSchemaExample":"{\n  \"verdict\": \"ENTER | SKIP | MANUAL_CHECK\",\n  \"confidence\": 0.85,\n  \"fatal_flag\": \"MOMENTUM_DEATH_CROSS | WRONG_SESSION_RISK | EXHAUSTION_RISK | null\",\n  \"action_comment\": \"Жесткий вывод одним предложением\",\n  \"checklist\": [\n    {\n      \"name\": \"Price > SMA20 (Momentum)\",\n      \"ok\": false,\n      \"details\": \"Цена 4109 ниже SMA 4113\"\n    },\n    {\n      \"name\": \"Prime Time\",\n      \"ok\": true,\n      \"details\": \"Сессия подходит\"\n    }\n  ],\n  \"reasons_for\": [\n    \"Тренд HTF восходящий\",\n    \"RVOL в норме\"\n  ],\n  \"reasons_against\": [\n    \"Цена под SMA20\",\n    \"Слабый CMF\"\n  ]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-1088,672],"id":"93ac6ed9-dacf-44f9-b1ea-7d2b2a7c2928","name":"Structured Output Parser"},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.decision }}","value2":"TAKE"}]}},"id":"6d69c57d-d6cb-44da-8d10-bb0ae314f74d","name":"IF TAKE","type":"n8n-nodes-base.if","typeVersion":1,"position":[-1456,464]},{"parameters":{"httpMethod":"POST","path":"exp2gold","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-2096,640],"id":"13c5c10a-bc47-418a-890a-df5cd9173587","name":"Webhook","webhookId":"19c4dd1a-b257-4636-9375-e00293b88ad8"},{"parameters":{"promptType":"define","text":"={{ JSON.stringify($json) }}","hasOutputParser":true,"needsFallback":true,"options":{"systemMessage":"Ты — TradingMasterAI v2 (Gatekeeper Edition). Твоя единственная цель — защитить капитал. Ты не ищешь причины \"войти\", ты ищешь малейшую причину \"ОТКАЗАТЬ\".\n\nТВОЯ ЛОГИКА ПРИНЯТИЯ РЕШЕНИЙ:\nТы получаешь JSON сделки. Ты обязан сначала проверить ФАТАЛЬНЫЕ ФИЛЬТРЫ. Если хоть один из них срабатывает — вердикт немедленно \"SKIP\" с confidence 1.0.\n\n🔥 ФАТАЛЬНЫЕ ФИЛЬТРЫ (Сразу SKIP, если true):\n1. MOMENTUM_DEATH_CROSS (Только для BUY):\n   - Проверь: `entry_price` < `sma20`?\n   - Логика: Нельзя покупать импульс, если цена ниже краткосрочной средней. Это ловля ножей.\n2. WRONG_SESSION_RISK (Только для GOLD/XAUUSD):\n   - Проверь: `gold_prime_time` == false И (`rvol_time` < 1.5 ИЛИ `cmf` < 0.1)?\n   - Логика: Золото вне прайм-тайма (Азия/Тихий океан) часто флэтит. Без экстремального объема вход запрещен.\n3. EXHAUSTION_RISK (Риск истощения):\n   - Проверь: `dist_vwap_atr` (дистанция от VWAP в ATR) > 4.0?\n   - Логика: Цена улетела слишком далеко, математическое ожидание отката выше, чем продолжения.\n\nЕСЛИ ФАТАЛЬНЫХ ОШИБОК НЕТ, ПРОВЕРЬ КАЧЕСТВО (Чек-лист):\n1. RR Compliance: `rr` >= 2.0? (Если ровно 2.0 — требуем идеальных остальных условий).\n2. Volume Support: `cmf` > 0.05 и `rvol_time` > 1.0? (Подтверждает ли поток денег движение?).\n3. Trend Alignment: Цена выше `htf_ema` и выше `vwap`?\n\nТВОЙ ВЕРДИКТ (Один из трех):\n- \"SKIP\": Сработал любой фатальный фильтр ИЛИ есть 2+ слабых места в чек-листе.\n- \"MANUAL_CHECK\": Данные противоречивы (например, супер-объем, но цена чуть ниже SMA).\n- \"ENTER\": Идеальный сетап. Цена НАД SMA20, НАД VWAP, есть Объём, RR >= 2."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-1216,448],"id":"bf840cbe-1dbd-4e72-8847-472238316dfd","name":"TradingMasterAI"},{"parameters":{"jsCode":"// Получаем данные от Gate (из ноды IF TAKE или аналогичной)\n// ВАЖНО: Убедись, что имя ноды совпадает. Если у тебя \"IF TAKE\" или \"Gate GOLD v1\", используй правильную ссылку.\nconst gateNodeName = \"IF TAKE\"; // Имя предыдущей ноды с данными Gate\nconst gateItem = $node[gateNodeName] ? $node[gateNodeName].json : ($input.first().json.body || {});\n\n// Получаем ответ AI\nconst ai = $json.output || {};\n\n// ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====\nfunction get(obj, path, fallback = \"-\") {\n  if (!obj) return fallback;\n  const keys = path.split(\".\");\n  let res = obj;\n  for (const k of keys) {\n    if (res && typeof res === \"object\" && k in res) {\n      res = res[k];\n    } else {\n      return fallback;\n    }\n  }\n  return res ?? fallback;\n}\n\nfunction num(val, d = 2) {\n  if (val === \"-\" || val === null || val === undefined) return \"-\";\n  const n = parseFloat(val);\n  return Number.isNaN(n) ? \"-\" : n.toFixed(d);\n}\n\n// ===== ДАННЫЕ GATE/IF =====\nconst decision = get(gateItem, \"decision\", \"PASS\");\nconst symbol   = get(gateItem, \"symbol\", get(gateItem, \"echo.symbol\", \"Unknown\"));\nconst action   = get(gateItem, \"action\", \"BUY\");\n\n// Пытаемся достать цену и стоп из разных возможных структур (Gate v1 vs Raw)\nconst entry = num(get(gateItem, \"position.entry_price\") !== \"-\" ? get(gateItem, \"position.entry_price\") : get(gateItem, \"entry_price\"));\nconst sl    = num(get(gateItem, \"position.sl\") !== \"-\" ? get(gateItem, \"position.sl\") : get(gateItem, \"sl\"));\nconst tp    = num(get(gateItem, \"position.tp\") !== \"-\" ? get(gateItem, \"position.tp\") : get(gateItem, \"tp\"));\nconst qty   = num(get(gateItem, \"position.qty\") !== \"-\" ? get(gateItem, \"position.qty\") : get(gateItem, \"qty_hint_oz\"));\nconst rr    = num(get(gateItem, \"analytics.rr_calc\") !== \"-\" ? get(gateItem, \"analytics.rr_calc\") : get(gateItem, \"rr\"));\n\nconst rActual = num(get(gateItem, \"position.risk_usd_actual\"));\nconst rTarget = num(get(gateItem, \"position.risk_usd_target\"));\n\n// ===== ДАННЫЕ TradingMasterAI (v2) =====\nconst verdict     = get(ai, \"verdict\", \"MANUAL_CHECK\");\nconst conf        = num(get(ai, \"confidence\"), 2);\nconst aiComment   = get(ai, \"action_comment\", \"-\");\nconst fatalFlag   = get(ai, \"fatal_flag\", null); // НОВОЕ ПОЛЕ\nconst pros        = Array.isArray(ai.reasons_for) ? ai.reasons_for : [];\nconst cons        = Array.isArray(ai.reasons_against) ? ai.reasons_against : [];\n\n// ===== ЭМОДЗИ И СТАТУСЫ =====\nconst statusEmoji = decision === \"TAKE\" ? \"🟢\" : \"🔴\";\nconst actionEmoji = action === \"BUY\" ? \"📈\" : \"📉\";\n\nlet verdictEmoji = \"🟡\";\nif (verdict === \"ENTER\") verdictEmoji = \"✅\";\nif (verdict === \"SKIP\")  verdictEmoji = \"⛔\";\n\n// Если есть фатальный флаг — ставим череп\nif (fatalFlag && fatalFlag !== \"null\" && fatalFlag !== \"None\") {\n    verdictEmoji = \"💀\";\n}\n\n// ===== СБОРКА СООБЩЕНИЯ =====\nlet msg = `${statusEmoji} *${decision}* ${actionEmoji} *${symbol}*\\n`;\nmsg += `\\n📊 *Entry:* ${entry}`;\nmsg += `\\n🛑 *Stop:* ${sl}`;\nmsg += `\\n🎯 *Target:* ${tp}`;\nmsg += `\\n\\n⚖️ *RR:* ${rr} | 💰 *Vol:* ${qty}`;\n\n// Блок AI\nmsg += `\\n\\n────────────────\\n`;\nmsg += `🤖 *AI Architect:* ${verdictEmoji} *${verdict}* (${conf})\\n`;\n\nif (fatalFlag && fatalFlag !== \"null\" && fatalFlag !== \"None\") {\n    msg += `\\n🚨 *FATAL REJECTION:* \\n❌ _${fatalFlag}_\\n`;\n}\n\nmsg += `\\n_${aiComment}_`;\n\nif (pros.length > 0 && verdict === \"ENTER\") {\n  msg += `\\n\\n✅ *Плюсы:*\\n- ${pros.join(\"\\n- \")}`;\n}\n\nif (cons.length > 0) {\n  msg += `\\n\\n⚠️ *Риски/Минусы:*\\n- ${cons.join(\"\\n- \")}`;\n}\n\n// Итоговый объект\nreturn {\n  json: {\n    message: msg,\n    gate_decision: decision,\n    ai_verdict: verdict,\n    ai_confidence: conf,\n    fatal_flag: fatalFlag\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-864,544],"id":"a2eaa637-1a07-4a99-bcfb-c85c0ed96cde","name":"Formatter"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO trade.ai_decisions (\n  gate_ts,\n  symbol_id,\n  gate_decision,\n  ai_verdict,\n  ai_confidence,\n  reasons_for,\n  reasons_against,\n  checklist,\n  full_json,\n  strategy_version,\n  gate_version,\n  experiment_id\n) VALUES (\n  {{ $node[\"IF TAKE\"].json.gate_ts }},\n  '{{ $node[\"IF TAKE\"].json.echo.symbol_id || $node[\"IF TAKE\"].json.echo.symbolid }}',\n  '{{ $node[\"IF TAKE\"].json.decision }}',\n  '{{ $json.output.verdict }}',\n  {{ $json.output.confidence }},\n  '{{ JSON.stringify($json.output.reasons_for || []) }}'::jsonb,\n  '{{ JSON.stringify($json.output.reasons_against || []) }}'::jsonb,\n  '{{ JSON.stringify($json.output.checklist || []) }}'::jsonb,\n  '{{ JSON.stringify($json.output) }}'::jsonb,\n  '{{ $node[\"IF TAKE\"].json.echo.strategy_version }}',\n  'Gate_GOLD_exp1',\n  '{{ $node[\"IF TAKE\"].json.echo.experiment_id }}'\n);\n","options":{"queryReplacement":""}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-864,352],"id":"fca46766-de2b-45d0-b91e-5b5f3d54cf52","name":"AI Verdict","credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO trade.signals_raw (\n    symbol, symbol_id, tf, htf, bar_time_ms,\n    entry_price, sl, tp, rr, equity, risk_pct,\n    cmf, rvol_time, mintick, pointvalue, lot_step,\n    session, strategy, strategy_version, gate_version, experiment_id,\n    raw_json, created_at\n)\nVALUES (\n    '{{ $json.echo.symbol }}',\n    '{{ $json.echo.symbolid }}',\n    '{{ $json.echo.tf }}',\n    '{{ $json.echo.htf }}',\n    {{ $json.echo.bar_time }},\n    {{ $json.echo.entry_price }},\n    {{ $json.echo.sl }},\n    {{ $json.echo.tp }},\n    {{ $json.echo.rr }},\n    {{ $json.echo.equity }},\n    {{ $json.echo.risk_pct }},\n    {{ $json.echo.cmf }},\n    {{ $json.echo.rvoltime }},\n    {{ $json.body.mintick }},\n    {{ $json.body.pointvalue }},\n    {{ $json.body.lot_step }},\n    '{{ $json.body.session }}',\n    '{{ $json.echo.strategy }}',\n    '{{ $json.echo.strategy_version }}',\n    'Gate_GOLD_exp1',\n    '{{ $json.echo.experiment_id }}',\n    '{{ JSON.stringify($json.body) }}'::jsonb,\n    NOW()\n);\n","options":{}},"id":"f198505c-9959-4c51-9b81-59c9602a738a","name":"signals_raw","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1440,640],"credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO trade.gate_decisions (\n    symbol_id, decision, reasons, qty_req, qty_rnd,\n    risk_usd, rr, stop_dist_atr, cmf, rvol,\n    spread_pct, full_json, qty_hint_oz, action, gate_ts,\n    risk_target, risk_actual, risk_diff_pct,\n    strategy_version, gate_version, experiment_id,\n    created_at\n)\nVALUES (\n    '{{ $json.echo.symbolid }}',\n    '{{ $json.decision }}',\n    '{{ JSON.stringify($json.reasons || []) }}',\n    {{ $json.position.qty_required }},\n    {{ $json.position.qty_rounded }},\n    {{ $json.position.risk_usd_actual }},\n    {{ $json.analytics.rr_calc }},\n    {{ $json.analytics.dist_vwap_atr }},\n    {{ $json.analytics.cmf }},\n    {{ $json.analytics.rvol }},\n    {{ $json.analytics.spread_pct }},\n    '{{ JSON.stringify($json) }}'::jsonb,\n    {{ $json.echo.qty_hint_oz }},\n    '{{ $json.echo.action }}',\n    {{ $json.gate_ts }},\n    {{ $json.position.risk_usd_target }},\n    {{ $json.position.risk_usd_actual }},\n    {{ $json.position.risk_diff_pct }},\n    '{{ $json.echo.strategy_version }}',\n    'Gate_GOLD_exp1',\n    '{{ $json.echo.experiment_id }}',\n    NOW()\n);\n","options":{}},"id":"a8754c15-5c1c-4fb3-b2e0-80055c229e2d","name":"gate_decisions","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1440,832],"credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}}},{"parameters":{"operation":"executeQuery","query":"SELECT gate_ts, symbol_id, gate_decision, ai_verdict,\n       (full_json->'analytics'->>'dist_vwap_atr')::float AS dist_vwap_atr\nFROM trade.ai_decisions\nWHERE experiment_id = 'gold_exp1'\nORDER BY gate_ts DESC;\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2080,288],"id":"859b4803-7783-47ce-97ad-e3b47cfb3826","name":"findLongShit","credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}}},{"parameters":{"modelName":"models/gemini-3-pro-preview","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-1328,704],"id":"186c4c9c-3a4e-4aed-b601-d1116486b26a","name":"Google Gemini Chat Model","credentials":{"googlePalmApi":{"id":"OGavRZ0nAmCDepHr","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"jsCode":"const src = $input.item.json.body || $input.item.json;\n\nfunction asNum(val, fallback = 0) {\n  if (typeof val === 'number' && !isNaN(val)) return val;\n  const parsed = parseFloat(val);\n  return isNaN(parsed) ? fallback : parsed;\n}\n\nfunction asStr(val, fallback = '') {\n  return typeof val === 'string' ? val : String(val || fallback);\n}\n\nconst p = {\n  action: asStr(src.action, 'BUY').toUpperCase(),\n  dir: asStr(src.dir, 'long').toLowerCase(),\n  symbol: asStr(src.symbol),\n  symbol_id: asStr(src.symbol_id),\n  tf: asStr(src.tf),\n  htf: asStr(src.htf),\n  entry_price: asNum(src.entry_price),\n  sl: asNum(src.sl),\n  tp: asNum(src.tp),\n  rr: asNum(src.rr),\n  equity: asNum(src.equity, 500),\n  risk_pct: asNum(src.risk_pct, 0.75),\n  vwap: asNum(src.vwap),\n  sma20: asNum(src.sma20),\n  atr: asNum(src.atr),\n  cmf: asNum(src.cmf),\n  htf_ema: asNum(src.htf_ema),\n  rvol_time: asNum(src.rvol_time, 1.0),\n  vwap_relation: asStr(src.vwap_relation, 'unknown'),\n  session: asStr(src.session, 'unknown'),\n  gold_prime_time: src.gold_prime_time === true || src.gold_prime_time === 'true',\n  risk_event: src.risk_event === true,\n  mintick: asNum(src.mintick, 0.01),\n  pointvalue: asNum(src.pointvalue, 1),\n  lot_step: asNum(src.lot_step, 0.01),\n  spread_cost: asNum(src.spread_cost, 0),\n  bar_time: asNum(src.bar_time, Date.now()),\n  strategy: asStr(src.strategy, 'unknown'),\n  strategy_version: asStr(src.strategy_version, 'HYBRID_CORE_v1_7_2'),\n  experiment_id: asStr(src.experiment_id, 'gold_exp1'),\n  qty_hint_oz: asNum(src.qty_hint_oz, 0)\n};\n\nconst cfg = {\n  min_rr: 1.5,\n  min_cmf: 0.05,\n  min_rvol_gold: 1.0,\n  min_rvol_crypto: 0.65,      // снижено с 1.2 для SOL\n  max_spread_pct_gold: 0.30,\n  max_spread_pct_crypto: 0.50,\n  session_gate_on: false\n};\n\nconst isGold = p.symbol.includes('GOLD') || p.symbol.includes('XAU');\n\nconst distance_sl = Math.abs(p.entry_price - p.sl);\nconst distance_tp = Math.abs(p.tp - p.entry_price);\nconst rr_calc = distance_sl > 0 ? distance_tp / distance_sl : 0;\n\nconst dist_vwap = Math.abs(p.entry_price - p.vwap);\nconst dist_vwap_atr = p.atr > 0 ? dist_vwap / p.atr : 0;\n\nconst spread_pct = p.entry_price > 0 ? (p.spread_cost / p.entry_price) * 100 : 0;\n\nconst risk_usd = (p.equity * p.risk_pct) / 100;\nconst qty_required = distance_sl > 0 ? risk_usd / distance_sl : 0;\nconst qty_rounded = Math.floor(qty_required / p.lot_step) * p.lot_step;\n\n// пока фактический риск совпадает с таргетом, diff = 0\nconst risk_diff_pct = risk_usd > 0\n  ? parseFloat(((risk_usd - risk_usd) / risk_usd * 100).toFixed(2))\n  : 0;\n\nconst compliance = {\n  rr_ok: rr_calc >= cfg.min_rr,\n  cmf_ok: p.cmf >= cfg.min_cmf,\n  rvol_ok: isGold\n    ? (p.rvol_time >= cfg.min_rvol_gold)\n    : (p.rvol_time >= cfg.min_rvol_crypto),\n  spread_ok: isGold\n    ? (spread_pct <= cfg.max_spread_pct_gold)\n    : (spread_pct <= cfg.max_spread_pct_crypto),\n  vwap_ok: p.vwap_relation === 'above',\n  no_risk_event: !p.risk_event,\n  valid_inputs: p.entry_price > 0 && p.sl > 0 && p.tp > 0 && p.atr > 0\n};\n\nif (cfg.session_gate_on && isGold) {\n  compliance.session_ok = p.gold_prime_time;\n}\n\nlet all_ok = Object.values(compliance).every(v => v === true);\nlet decision = all_ok ? 'TAKE' : 'PASS';\nconst reasons = [];\n\n// базовые причины\nif (!compliance.rr_ok) reasons.push(`RR=${rr_calc.toFixed(2)} < ${cfg.min_rr}`);\nif (!compliance.cmf_ok) reasons.push(`CMF=${p.cmf.toFixed(3)} < ${cfg.min_cmf}`);\nif (!compliance.rvol_ok) reasons.push(`RVOL=${p.rvol_time.toFixed(2)} низкий`);\nif (!compliance.spread_ok) reasons.push(`Spread=${spread_pct.toFixed(2)}% высокий`);\nif (!compliance.vwap_ok) reasons.push(`Цена ниже VWAP`);\nif (!compliance.no_risk_event) reasons.push(`Risk event активен`);\nif (!compliance.valid_inputs) reasons.push(`Невалидные входные данные`);\n\nif (cfg.session_gate_on && isGold && !compliance.session_ok) {\n  reasons.push(`Вне Gold Prime Time (8-21 UTC)`);\n}\n\n// *** НОВЫЙ ФИЛЬТР ДЛЯ GOLD exp1: расстояние до VWAP > 3 ATR ***\nif (isGold && dist_vwap_atr > 3) {\n  decision = 'PASS';\n  compliance.vwap_ok = false;  // явно помечаем, что вход слишком далеко от VWAP\n  reasons.push(`VWAP distance ${dist_vwap_atr.toFixed(2)} ATR > 3 ATR limit for GOLD exp1`);\n}\n\n// итоговый объект\nreturn {\n  decision: decision,\n  timestamp: new Date().toISOString(),\n  gate_ts: Date.now(),\n\n  symbol: p.symbol,\n  action: p.action,\n  reasons: reasons,\n\n  position: {\n    entry_price: p.entry_price,\n    sl: p.sl,\n    tp: p.tp,\n    qty: qty_rounded,\n    qty_required: qty_rounded,\n    qty_rounded: qty_rounded,\n    qty_hint: p.qty_hint_oz,\n    qty_hint_oz: p.qty_hint_oz,\n    risk_usd_actual: parseFloat(risk_usd.toFixed(2)),\n    risk_usd_target: parseFloat(risk_usd.toFixed(2)),\n    risk_diff_pct: risk_diff_pct\n  },\n\n  analytics: {\n    rr_calc: parseFloat(rr_calc.toFixed(3)),\n    dist_vwap_atr: parseFloat(dist_vwap_atr.toFixed(3)),\n    cmf: parseFloat(p.cmf.toFixed(4)),\n    rvol: parseFloat(p.rvol_time.toFixed(3)),\n    spread_pct: parseFloat(spread_pct.toFixed(4))\n  },\n\n  compliance: compliance,\n\n  echo: {\n    symbol: p.symbol,\n    symbol_id: p.symbol_id,\n    action: p.action,\n    dir: p.dir,\n    tf: p.tf,\n    htf: p.htf,\n    entry_price: p.entry_price,\n    sl: p.sl,\n    tp: p.tp,\n    rr: p.rr,\n    atr: p.atr,\n    cmf: p.cmf,\n    rvol: p.rvol_time,\n    rvoltime: p.rvol_time,\n    vwap: p.vwap,\n    htf_ema: p.htf_ema,\n    equity: p.equity,\n    risk_pct: p.risk_pct,\n    qty_hint_oz: p.qty_hint_oz,\n    strategy: p.strategy,\n    strategy_version: p.strategy_version,\n    experiment_id: p.experiment_id,\n    bar_time: p.bar_time,\n    is_gold: isGold,\n    gold_prime_time: p.gold_prime_time\n  },\n\n  body: src\n};\n"},"id":"f07f5c35-9f21-4624-89e3-46e7803742eb","name":"Gate GOLD exp2","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1872,640]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"00f54a81-d59a-446a-9ef9-e73646508823","leftValue":"={{ $json.gate_decision }}","rightValue":"TAKE","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"aaf1569a-fe79-4847-8d92-0a35b796f1cc","leftValue":"={{ $json.ai_verdict }}","rightValue":"ENTER","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-496,448],"id":"09f3cd23-4a73-4290-bec8-782fe134d7c0","name":"If"},{"parameters":{"chatId":"1969855532","text":"=🛡 <b>SHIELD ACTIVATED</b>\n\n⛔ <b>Status:</b> REJECTED\n📉 <b>Pair:</b> {{ $json.message.match(/[*]([A-Z0-9]+)[*]/)?.[1] || \"Unknown\" }}\n\n💀 <b>Reason:</b>\n{{ $node[\"Formatter\"].json.fatal_flag ? \"⚠️ \" + $node[\"Formatter\"].json.fatal_flag : ($node[\"TradingMasterAI\"].json.output.reasons_against ? $node[\"TradingMasterAI\"].json.output.reasons_against[0] : \"Low Confidence\") }}\n\n<i>Сделка заблокирована алгоритмом.</i>","additionalFields":{"appendAttribution":false,"parse_mode":"HTML"}},"id":"3941ca86-cdb1-4ac7-b78e-04ab1def73a5","name":"MeNoSignal","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-96,704],"webhookId":"05ef7ac4-9617-4702-9215-60e5c446066c","credentials":{"telegramApi":{"id":"1YMuki43SISyhVa0","name":"Telegram account"}}},{"parameters":{"chatId":"1969855532","text":"=🚀 <b>EXECUTION TRIGGERED</b>\n\n✅ <b>Status:</b> CONFIRMED\n📈 <b>Pair:</b> {{ $json.message.match(/[*]([A-Z0-9]+)[*]/)?.[1] || \"Unknown\" }}\n💰 <b>Size:</b> {{ $json.message.match(/Position Size:\\s*([\\d\\.]+)/)?.[1] || \"Calc...\" }}\n\n<i>Ордер отправлен в исполнение...</i>","additionalFields":{"appendAttribution":false,"parse_mode":"HTML"}},"id":"d5ec738c-e267-4a4e-b6cc-ab4d17d70101","name":"MeSignal","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-288,144],"webhookId":"05ef7ac4-9617-4702-9215-60e5c446066c","credentials":{"telegramApi":{"id":"1YMuki43SISyhVa0","name":"Telegram account"}}},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Im1haW4tdHJhZGluZyJ9"},{"name":"jid","value":"=77015705555@s.whatsapp.net"},{"name":"msg","value":"=🚀 <b>EXECUTION TRIGGERED</b>\n\n✅ <b>Status:</b> CONFIRMED\n📈 <b>Pair:</b> {{ $json.message.match(/[*]([A-Z0-9]+)[*]/)?.[1] || \"Unknown\" }}\n💰 <b>Size:</b> {{ $json.message.match(/Position Size:\\s*([\\d\\.]+)/)?.[1] || \"Calc...\" }}\n\n<i>Ордер отправлен в исполнение...</i>"}]},"options":{}},"name":"MeSignalWP","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-160,208],"id":"6f38b6ba-f2fc-4f54-8d82-02e4ea40d538"},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Im1haW4tdHJhZGluZyJ9"},{"name":"jid","value":"=77015705555@s.whatsapp.net"},{"name":"msg","value":"=🛡 <b>SHIELD ACTIVATED</b>\n\n⛔ <b>Status:</b> REJECTED\n📉 <b>Pair:</b> {{ $json.message.match(/[*]([A-Z0-9]+)[*]/)?.[1] || \"Unknown\" }}\n\n💀 <b>Reason:</b>\n{{ $node[\"Formatter\"].json.fatal_flag ? \"⚠️ \" + $node[\"Formatter\"].json.fatal_flag : ($node[\"TradingMasterAI\"].json.output.reasons_against ? $node[\"TradingMasterAI\"].json.output.reasons_against[0] : \"Low Confidence\") }}\n\n<i>Сделка заблокирована алгоритмом.</i>"}]},"options":{}},"name":"MeNoSignalWP","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-112,544],"id":"9e60e5bd-1924-4110-9b50-7d02ca8fef9e"},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Im1haW4tdHJhZGluZyJ9"},{"name":"jid","value":"=77071956096@s.whatsapp.net"},{"name":"msg","value":"={{ $json.message }}"}]},"options":{}},"name":"Nurzhan","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[96,240],"id":"b13914e5-e315-4a16-9c42-c571adc4de3b","disabled":true},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Im1haW4tdHJhZGluZyJ9"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Im1haW4tdHJhZGluZyJ9"},{"name":"jid","value":"=77475111570@s.whatsapp.net"},{"name":"msg","value":"={{ $json.message }}"}]},"options":{}},"name":"Nurzhan1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[64,384],"id":"b4da4475-9ea5-4f3e-b7f4-a402db073555","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eb838ef6-d3a8-4c59-beaf-6fbc769b87be","leftValue":"={{ $json.echo.gold_prime_time }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1728,512],"id":"6181a299-fabf-4315-a4c3-c680e9dfe528","name":"If1"}],"connections":{"OpenAI Chat Model":{"ai_languageModel":[[{"node":"TradingMasterAI","type":"ai_languageModel","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"TradingMasterAI","type":"ai_outputParser","index":0}]]},"IF TAKE":{"main":[[{"node":"TradingMasterAI","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Gate GOLD exp2","type":"main","index":0}]]},"TradingMasterAI":{"main":[[{"node":"Formatter","type":"main","index":0},{"node":"AI Verdict","type":"main","index":0}]]},"Formatter":{"main":[[{"node":"If","type":"main","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"TradingMasterAI","type":"ai_languageModel","index":1}]]},"Gate GOLD exp2":{"main":[[{"node":"signals_raw","type":"main","index":0},{"node":"gate_decisions","type":"main","index":0},{"node":"If1","type":"main","index":0}]]},"If":{"main":[[{"node":"MeSignalWP","type":"main","index":0},{"node":"MeSignal","type":"main","index":0},{"node":"Nurzhan","type":"main","index":0},{"node":"Nurzhan1","type":"main","index":0}],[{"node":"MeNoSignal","type":"main","index":0},{"node":"MeNoSignalWP","type":"main","index":0}]]},"If1":{"main":[[{"node":"IF TAKE","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"connection":"upgrade","host":"n8n.truffles.kz","x-real-ip":"52.32.178.7","x-forwarded-for":"52.32.178.7","x-forwarded-proto":"https","content-length":"562","user-agent":"Go-http-client/1.1","content-type":"application/json; charset=utf-8","accept-encoding":"gzip"},"params":{},"query":{},"body":{"action":"BUY","dir":"long","symbol":"GOLD","symbol_id":"CAPITALCOM:GOLD","tf":"15","htf":"60","entry_price":4109.95,"sl":4097.63984,"tp":4134.57032,"rr":2,"equity":500,"risk_pct":0.75,"vwap":4094.4908,"sma20":4113.9995,"atr":10.25847,"cmf":0.05477,"htf_ema":4082.16537,"rvol_time":1.413,"vwap_relation":"above","session":"Gold","risk_event":false,"mintick":0.01,"pointvalue":1,"lot_step":0.01,"spread_cost":0,"bar_time":1763567101245,"strategy":"Gate GOLD exp1","strategy_version":"HYBRID_CORE_v1_7_2_gold_exp1","experiment_id":"gold_exp1","qty_hint_oz":0.3},"webhookUrl":"https://n8n.truffles.kz/webhook/exp1gold","executionMode":"production"}}],"TradingMasterAI":[{"json":{"output":{"verdict":"SKIP","confidence":1,"fatal_flag":"WRONG_SESSION_RISK","action_comment":"Отказ от входа: золото вне прайм-тайма, при этом CMF ниже 0.1 и нет экстремального RVOL. Это нарушает фильтр WRONG_SESSION_RISK, математическое ожидание недостаточно для входа.","checklist":[{"name":"RR Compliance (>= 2.0)","ok":true,"details":"RR = 2.0 — формально ок, но на пределе требований, требует идеальных условий, которых нет (непрайм-тайм, слабый поток денег)."},{"name":"Volume Support (CMF > 0.05 и RVOL > 1.0)","ok":false,"details":"CMF = 0.0548 чуть выше минимального порога, RVOL_time = 1.413 > 1.0, но для входа в золото вне прайм-тайма нужен либо CMF >= 0.1, либо экстремальный объём. Эти условия не выполнены — срабатывает фатальный фильтр WRONG_SESSION_RISK."},{"name":"Trend Alignment (цена выше HTF EMA и VWAP)","ok":true,"details":"Цена 4109.95 выше HTF EMA 4082.17 и выше VWAP 4094.49 — тренд и импульс поддерживают лонг."}],"reasons_for":["Цена находится выше HTF EMA и выше VWAP, что подтверждает лонговый тренд и импульс.","RR = 2.0 соответствует минимальному требованию по соотношению риск/прибыль.","RVOL_time = 1.413 указывает на активность выше средней."],"reasons_against":["Срабатывает фатальный фильтр WRONG_SESSION_RISK: золото вне прайм-тайма (gold_prime_time = false), CMF = 0.0548 < 0.1 и нет экстремального RVOL — повышенный риск флэта и выносов.","CMF лишь минимально положительный и не подтверждает мощный приток денег в инструмент.","RR только 2.0 — нет запаса по матожиданию, особенно в условиях повышенного сессионного риска."]}}}]},"versionId":"eef4ed50-bf87-4ed8-af6e-53755e51e9c2","triggerCount":1,"shared":[{"updatedAt":"2025-11-27T21:18:18.259Z","createdAt":"2025-11-27T21:18:18.259Z","role":"workflow:owner","workflowId":"9LukFnXTRJgsUuO2","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-11-27T06:11:33.174Z","createdAt":"2025-11-27T06:11:33.174Z","id":"jpta0H3sZxVGTF8B","name":"trading"}]},{"updatedAt":"2025-11-30T05:43:19.228Z","createdAt":"2025-11-19T11:51:18.185Z","id":"5Fo72obszME5y9q2","name":"Gate GOLD exp1","active":true,"isArchived":false,"nodes":[{"parameters":{"method":"POST","url":"https://api.telegram.org/bot7730378933:AAHG1lZY6u6AmvNDF7DT29veuXUDu8EeqIc/setWebhook?url=https://n8n.truffles.kz/webhook/money","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2096,1056],"id":"16b1df28-d952-4ccd-bd39-02c3d180a4e6","name":"HTTP Request1","disabled":true},{"parameters":{"model":{"__rl":true,"value":"gpt-5.1","mode":"list","cachedResultName":"gpt-5.1"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-1216,672],"id":"d9183a48-82f0-4a8c-952d-7b1ba0803eae","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{"jsonSchemaExample":"{\n  \"verdict\": \"ENTER | SKIP | MANUAL_CHECK\",\n  \"confidence\": 0.0,\n  \"action_comment\": \"краткий вывод по сделке, 1–2 предложения на русском\",\n  \"checklist\": [\n    { \"name\": \"RR\",           \"ok\": true,  \"details\": \"RR=2.0, minRR=1.5\" },\n    { \"name\": \"Stop_vs_ATR\",  \"ok\": true,  \"details\": \"Stop ≈ 1.2 ATR, в пределах нормы\" },\n    { \"name\": \"CMF\",          \"ok\": false, \"details\": \"CMF=0.01 < порога 0.05, слабый приток капитала\" },\n    { \"name\": \"RVOL\",         \"ok\": true,  \"details\": \"RVOL=1.3 > 1.15, инструмент 'в игре'\" },\n    { \"name\": \"VWAP_HTF\",     \"ok\": true,  \"details\": \"Цена выше VWAP и HTF EMA, сделка по тренду\" },\n    { \"name\": \"Spread\",       \"ok\": true,  \"details\": \"spreadPct в пределах лимита системы\" },\n    { \"name\": \"Session\",      \"ok\": true,  \"details\": \"Crypto сессия, условия допустимы\" },\n    { \"name\": \"Risk_Event\",   \"ok\": true,  \"details\": \"risk_event=false, нет запрета по новостям\" }\n  ],\n  \"reasons_for\": [\n    \"Цена выше VWAP и HTF EMA, сделка по направлению старшего тренда.\",\n    \"RR соответствует минимальным требованиям системы.\"\n  ],\n  \"reasons_against\": [\n    \"CMF ниже порога, покупательский поток слабее желаемого.\",\n    \"Сигнал близок к минимальным условиям, а не 'A+ сетап'.\"\n  ]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[-1088,672],"id":"523d8b9e-03c5-484b-8d7e-767e0bcfdc86","name":"Structured Output Parser"},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.decision }}","value2":"TAKE"}]}},"id":"7cc65144-fade-4180-ae3e-590cb384d589","name":"IF TAKE","type":"n8n-nodes-base.if","typeVersion":1,"position":[-1440,448]},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzYyMTExNDU2fQ.myOt6xgCLfqbD9IF9EdJxkAyjij3fMty1B7sOhP2iKA"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Im1haW4tdHJhZGluZyJ9"},{"name":"jid","value":"=77071956096@s.whatsapp.net"},{"name":"msg","value":"={{ $json.message }}"}]},"options":{}},"name":"Nurzhan","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-640,640],"id":"4fc8e7cb-6a9d-40f3-b530-e062f18a9572","disabled":true},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Im1haW4tdHJhZGluZyJ9"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Im1haW4tdHJhZGluZyJ9"},{"name":"jid","value":"=77015705555@s.whatsapp.net"},{"name":"msg","value":"={{ $json.message }}"}]},"options":{}},"name":"Me","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-640,448],"id":"72dc403d-fb98-4579-a51e-72fc75a7557a"},{"parameters":{"chatId":"1969855532","text":"={{ $json.message }}","additionalFields":{"appendAttribution":false,"parse_mode":"HTML"}},"id":"bbb5f092-5fca-4423-8c83-1fce47388ef0","name":"Me1","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-640,256],"webhookId":"306ca888-05f1-4859-b064-2eabeb1ff708","credentials":{"telegramApi":{"id":"1YMuki43SISyhVa0","name":"Telegram account"}}},{"parameters":{"httpMethod":"POST","path":"exp1gold","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-2320,624],"id":"94a76515-b8be-48a2-ad64-1313f30ea535","name":"Webhook","webhookId":"1b4cf07e-a0e0-41a5-8476-6609178fadd6"},{"parameters":{"promptType":"define","text":"={{ JSON.stringify($json) }}","hasOutputParser":true,"needsFallback":true,"options":{"systemMessage":"Ты — TradingMasterAI v1, строгий институциональный трейдер и риск-менеджер, работающий ВЕРХОМ над уже существующей механической системой сигналов.\n\nКОНТЕКСТ СИСТЕМЫ\n- Источник сигналов: стратегии HYBRID-CORE v1.7.x на TradingView.\n- Сигналы проходят через код Gate v1.x в n8n, который:\n  - нормализует входящие поля из TradingView (action, dir, symbol, tf, htf, entry_price, sl, tp, rr, equity, risk_pct, vwap, sma20, atr, cmf, htf_ema, rvol_time, vwap_relation, session, gold_prime_time, risk_event, mintick, pointvalue, lot_step, spread_cost, bar_time, strategy, qty_hint_oz и т.п.),\n  - рассчитывает derived-метрики (rr_calc, distSL, distTP, distVWAP, distVWAP_ATR, spreadPct и т.п.),\n  - применяет детерминированные фильтры (минимальный RR, минимальный CMF, минимальный RVOL, условия по VWAP/HTF, спреду, сессии, risk_event),\n  - формирует объект с решением decision (TAKE/PASS), массивом reasons[] и блоками position{}, analytics{}, compliance{}, echo{}.\n- Ты не переписываешь ни Pine-логику, ни численные расчёты Gate v1.x; ты именно ИНТЕРПРЕТИРУЕШЬ готовый сигнал+решение как старший трейдер.\n\nТВОЯ ЗАДАЧА\nПолучив один JSON-объект сигнала+решения Gate v1.x по стандартной схеме v2, ты:\n1) Проходишь по фиксированному чек-листу критериев.\n2) Находишь аргументы «ЗА» и «ПРОТИВ» сделки.\n3) Выносишь один из трёх вердиктов:\n   - \"ENTER\" — входить по рассчитанному размеру позиции и текущему SL/TP.\n   - \"SKIP\" — сделку пропустить.\n   - \"MANUAL_CHECK\" — данных недостаточно или есть противоречия, нужно ручное решение на графике.\n4) Возвращаешь ТОЛЬКО один JSON-объект строго по заданной ниже схеме.\n\nЧЕК-ЛИСТ, КОТОРЫЙ ТЫ ДОЛЖЕН ПРОЙТИ\n(названия критериев можешь использовать в поле \"name\" чек-листа)\n\nМинимальный набор критериев:\n1) RR и стоп:\n   - Достаточен ли фактический rr_calc относительно минимального RR (например, ≥ 1.5 или 2.0).\n   - Не слишком ли близок стоп (SL) к входу относительно ATR (например, стоп ≥ 0.5 ATR и ≤ 2.5 ATR).\n2) Объём и поток:\n   - CMF: знак и величина (положительный/отрицательный, величина относительно порога системы).\n   - RVOL (rvol_time): выше ли он минимального порога системы.\n3) Позиция к VWAP/HTF:\n   - vwap_relation (above/below) и соответствие направлению сделки.\n   - Позиция цены относительно HTF EMA (htf_ema) — торгуем ли мы по тренду старшего ТФ или против него.\n4) Ликвидность и издержки:\n   - spreadPct и связанные проверки (спред в пределах допустимого порога).\n   - mintick/lot_step/pointvalue — нет ли очевидных технических проблем с размером позиции.\n5) Режим рынка/сессия:\n   - session (например, \"Crypto\", \"Gold\") и соответствие активу.\n   - gold_prime_time / аналогичные флаги — торгуем ли в предпочтительное время.\n   - risk_event — не запрещает ли текущий риск-режим вход (важные новости, отключенные сессии и т.п.).\n6) Внутренняя консистентность:\n   - decision от Gate v1.x (TAKE или PASS) и reasons[].\n   - Любые странности/NaN/отрицательные значения там, где их не должно быть.\n\nОБЩИЙ ПРИНЦИП\n- Ты всегда чуть БОЛЕЕ строгий, чем код Gate v1.x.\n- Если критерии на грани, ты склоняешься к \"SKIP\" или \"MANUAL_CHECK\", а не к \"ENTER\".\n- Сначала ищешь причины НЕ входить, затем уже перечисляешь аргументы \"за\".\n- Если каких-то критичных полей нет во входном JSON, ты:\n  - отмечаешь это в чек-листе,\n  - понижаешь confidence,\n  - при сильном дефиците данных выбираешь \"MANUAL_CHECK\", а не \"ENTER\".\n\nТРЕБОВАНИЯ К ФОРМАТУ\n- ВСЕГДА возвращай только валидный JSON-объект без поясняющего текста до или после него.\n- Поле \"verdict\" обязательно и может быть только \"ENTER\", \"SKIP\" или \"MANUAL_CHECK\".\n- Поле \"confidence\" — число от 0 до 1 (например, 0.2 для слабой уверенности, 0.8 для сильной).\n- Массивы \"reasons_for\" и \"reasons_against\" содержат от 0 до 5 коротких строк каждый.\n- Массив \"checklist\" должен содержать не менее 5 критериев; имена \"name\" могут отличаться от примера, но должны быть осмысленными.\n- Пиши все комментарии и тексты на русском языке, кратко и по делу.\n\nЕСЛИ ДАННЫХ НЕДОСТАТОЧНО\n- Если во входном JSON нет важных полей (например, нет ATR, CMF, RVOL, VWAP или htf_ema), отмечай это в \"checklist\" и \"reasons_against\".\n- В тяжёлых случаях выставляй:\n  - \"verdict\": \"MANUAL_CHECK\"\n  - \"confidence\": низкое значение (0.1–0.3)\n  - \"action_comment\": пояснение, чего именно не хватает для уверенного решения.\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[-1216,448],"id":"f9838168-c1b8-4999-9646-4b1ac418ec33","name":"TradingMasterAI"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Результат Gate/IF (нода должна называться \"IF TAKE\")\nconst gate = $node[\"IF TAKE\"].json;\n\n// Ответ TradingMasterAI из AI Agent\n// AI Agent возвращает: { \"output\": { verdict, confidence, action_comment, ... } }\nconst ai = $json.output || {};\n\n// ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====\nfunction get(obj, path, fallback = \"-\") {\n  const keys = path.split(\".\");\n  let res = obj;\n  for (const k of keys) {\n    if (res && typeof res === \"object\" && k in res) {\n      res = res[k];\n    } else {\n      return fallback;\n    }\n  }\n  return res ?? fallback;\n}\n\nfunction num(val, d = 2) {\n  if (val === \"-\" || val === null || val === undefined) return \"-\";\n  const n = parseFloat(val);\n  return Number.isNaN(n) ? \"-\" : n.toFixed(d);\n}\n\n// ===== ДАННЫЕ GATE/IF =====\nconst decision = get(gate, \"decision\", \"PASS\");\nconst symbol   = get(gate, \"symbol\", \"-\");\nconst action   = get(gate, \"action\", \"BUY\");\n\nconst entry = num(get(gate, \"position.entry_price\"));\nconst sl    = num(get(gate, \"position.sl\"));\nconst tp    = num(get(gate, \"position.tp\"));\nconst qty   = num(get(gate, \"position.qty\"));\nconst rr    = num(get(gate, \"analytics.rr_calc\"));\n\nconst rActual = num(get(gate, \"position.risk_usd_actual\"));\nconst rTarget = num(get(gate, \"position.risk_usd_target\"));\n\n// ===== ДАННЫЕ TradingMasterAI =====\nconst verdict   = get(ai, \"verdict\", \"MANUAL_CHECK\");\nconst conf      = num(get(ai, \"confidence\"), 2);\nconst aiComment = get(ai, \"action_comment\", \"-\");\nconst pros      = Array.isArray(ai.reasons_for) ? ai.reasons_for : [];\nconst cons      = Array.isArray(ai.reasons_against) ? ai.reasons_against : [];\n\n// ===== ЭМОДЗИ/СТАТУСЫ =====\nconst statusEmoji =\n  decision === \"TAKE\" ? \"🟢\" : \"🔴\";\n\nconst actionEmoji =\n  action === \"BUY\" ? \"📈\" : \"📉\";\n\nconst verdictEmoji =\n  verdict === \"ENTER\"        ? \"✅\" :\n  verdict === \"SKIP\"         ? \"⛔️\" :\n                                \"🟡\"; // MANUAL_CHECK\n\n// ===== СБОРКА СООБЩЕНИЯ =====\nlet msg = `${statusEmoji} *${decision}* ${actionEmoji} *${symbol}*\n\n📊 *Entry:* ${entry}\n🛑 *Stop Loss:* ${sl}\n🎯 *Take Profit:* ${tp}\n\n⚖️ *Risk/Reward:* ${rr}\n💰 *Position Size:* ${qty}\n💵 *Risk:* $${rActual} / $${rTarget}\n`;\n\nmsg += `\n\n🤖 ${verdictEmoji} *TradingMasterAI:* ${verdict} (confidence: ${conf})\n_${aiComment}_`;\n\nif (pros.length > 0) {\n  msg += `\n\n✅ *Аргументы за:*\n- ${pros.join(\"\\n- \")}`;\n}\n\nif (cons.length > 0) {\n  msg += `\n\n⚠️ *Аргументы против:*\n- ${cons.join(\"\\n- \")}`;\n}\n\n// Итоговый объект для следующей ноды (HTTP/Telegram/WhatsApp и т.п.)\nreturn {\n  json: {\n    message: msg,\n    gate_decision: decision,\n    ai_verdict: verdict,\n    ai_confidence: conf\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-864,544],"id":"f5240d0c-82ba-451c-97d9-bc229139ceff","name":"Formatter"},{"parameters":{"url":"https://app.chatflow.kz/api/v1/send-text","sendQuery":true,"queryParameters":{"parameters":[{"name":"token","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Im1haW4tdHJhZGluZyJ9"},{"name":"instance_id","value":"eyJ1aWQiOiJhTFpMend0d1AzUnBCWHpHNlNzbG1aNWNTOTZib1F5YyIsImNsaWVudF9pZCI6Im1haW4tdHJhZGluZyJ9"},{"name":"jid","value":"=77475111570@s.whatsapp.net"},{"name":"msg","value":"={{ $json.message }}"}]},"options":{}},"name":"Nurzhan1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-640,832],"id":"afd5b12d-807c-4f41-96f1-e675524c47c5","disabled":true},{"parameters":{"operation":"executeQuery","query":"INSERT INTO trade.ai_decisions (\n  gate_ts,\n  symbol_id,\n  gate_decision,\n  ai_verdict,\n  ai_confidence,\n  reasons_for,\n  reasons_against,\n  checklist,\n  full_json,\n  strategy_version,\n  gate_version,\n  experiment_id\n) VALUES (\n  {{ $node[\"IF TAKE\"].json.gate_ts }},\n  '{{ $node[\"IF TAKE\"].json.echo.symbol_id || $node[\"IF TAKE\"].json.echo.symbolid }}',\n  '{{ $node[\"IF TAKE\"].json.decision }}',\n  '{{ $json.output.verdict }}',\n  {{ $json.output.confidence }},\n  '{{ JSON.stringify($json.output.reasons_for || []) }}'::jsonb,\n  '{{ JSON.stringify($json.output.reasons_against || []) }}'::jsonb,\n  '{{ JSON.stringify($json.output.checklist || []) }}'::jsonb,\n  '{{ JSON.stringify($json.output) }}'::jsonb,\n  '{{ $node[\"IF TAKE\"].json.echo.strategy_version }}',\n  'Gate_GOLD_exp1',\n  '{{ $node[\"IF TAKE\"].json.echo.experiment_id }}'\n);\n","options":{"queryReplacement":""}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-864,352],"id":"28dd26a2-7ab2-4d27-823e-b368b34013a5","name":"AI Verdict","credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Gate GOLD exp1 — с фильтром dist_vwap_atr > 3 ATR для золота [attached_file:91]\n\nconst src = $input.item.json.body || $input.item.json;\n\nfunction asNum(val, fallback = 0) {\n  if (typeof val === 'number' && !isNaN(val)) return val;\n  const parsed = parseFloat(val);\n  return isNaN(parsed) ? fallback : parsed;\n}\n\nfunction asStr(val, fallback = '') {\n  return typeof val === 'string' ? val : String(val || fallback);\n}\n\nconst p = {\n  action: asStr(src.action, 'BUY').toUpperCase(),\n  dir: asStr(src.dir, 'long').toLowerCase(),\n  symbol: asStr(src.symbol),\n  symbol_id: asStr(src.symbol_id),\n  tf: asStr(src.tf),\n  htf: asStr(src.htf),\n  entry_price: asNum(src.entry_price),\n  sl: asNum(src.sl),\n  tp: asNum(src.tp),\n  rr: asNum(src.rr),\n  equity: asNum(src.equity, 500),\n  risk_pct: asNum(src.risk_pct, 0.75),\n  vwap: asNum(src.vwap),\n  sma20: asNum(src.sma20),\n  atr: asNum(src.atr),\n  cmf: asNum(src.cmf),\n  htf_ema: asNum(src.htf_ema),\n  rvol_time: asNum(src.rvol_time, 1.0),\n  vwap_relation: asStr(src.vwap_relation, 'unknown'),\n  session: asStr(src.session, 'unknown'),\n  gold_prime_time: src.gold_prime_time === true || src.gold_prime_time === 'true',\n  risk_event: src.risk_event === true,\n  mintick: asNum(src.mintick, 0.01),\n  pointvalue: asNum(src.pointvalue, 1),\n  lot_step: asNum(src.lot_step, 0.01),\n  spread_cost: asNum(src.spread_cost, 0),\n  bar_time: asNum(src.bar_time, Date.now()),\n  strategy: asStr(src.strategy, 'unknown'),\n  strategy_version: asStr(src.strategy_version, 'HYBRID_CORE_v1_7_2'),\n  experiment_id: asStr(src.experiment_id, 'gold_exp1'),\n  qty_hint_oz: asNum(src.qty_hint_oz, 0)\n};\n\nconst cfg = {\n  min_rr: 1.5,\n  min_cmf: 0.05,\n  min_rvol_gold: 1.0,\n  min_rvol_crypto: 0.65,      // снижено с 1.2 для SOL\n  max_spread_pct_gold: 0.30,\n  max_spread_pct_crypto: 0.50,\n  session_gate_on: false\n};\n\nconst isGold = p.symbol.includes('GOLD') || p.symbol.includes('XAU');\n\nconst distance_sl = Math.abs(p.entry_price - p.sl);\nconst distance_tp = Math.abs(p.tp - p.entry_price);\nconst rr_calc = distance_sl > 0 ? distance_tp / distance_sl : 0;\n\nconst dist_vwap = Math.abs(p.entry_price - p.vwap);\nconst dist_vwap_atr = p.atr > 0 ? dist_vwap / p.atr : 0;\n\nconst spread_pct = p.entry_price > 0 ? (p.spread_cost / p.entry_price) * 100 : 0;\n\nconst risk_usd = (p.equity * p.risk_pct) / 100;\nconst qty_required = distance_sl > 0 ? risk_usd / distance_sl : 0;\nconst qty_rounded = Math.floor(qty_required / p.lot_step) * p.lot_step;\n\n// пока фактический риск совпадает с таргетом, diff = 0\nconst risk_diff_pct = risk_usd > 0\n  ? parseFloat(((risk_usd - risk_usd) / risk_usd * 100).toFixed(2))\n  : 0;\n\nconst compliance = {\n  rr_ok: rr_calc >= cfg.min_rr,\n  cmf_ok: p.cmf >= cfg.min_cmf,\n  rvol_ok: isGold\n    ? (p.rvol_time >= cfg.min_rvol_gold)\n    : (p.rvol_time >= cfg.min_rvol_crypto),\n  spread_ok: isGold\n    ? (spread_pct <= cfg.max_spread_pct_gold)\n    : (spread_pct <= cfg.max_spread_pct_crypto),\n  vwap_ok: p.vwap_relation === 'above',\n  no_risk_event: !p.risk_event,\n  valid_inputs: p.entry_price > 0 && p.sl > 0 && p.tp > 0 && p.atr > 0\n};\n\nif (cfg.session_gate_on && isGold) {\n  compliance.session_ok = p.gold_prime_time;\n}\n\nlet all_ok = Object.values(compliance).every(v => v === true);\nlet decision = all_ok ? 'TAKE' : 'PASS';\nconst reasons = [];\n\n// базовые причины\nif (!compliance.rr_ok) reasons.push(`RR=${rr_calc.toFixed(2)} < ${cfg.min_rr}`);\nif (!compliance.cmf_ok) reasons.push(`CMF=${p.cmf.toFixed(3)} < ${cfg.min_cmf}`);\nif (!compliance.rvol_ok) reasons.push(`RVOL=${p.rvol_time.toFixed(2)} низкий`);\nif (!compliance.spread_ok) reasons.push(`Spread=${spread_pct.toFixed(2)}% высокий`);\nif (!compliance.vwap_ok) reasons.push(`Цена ниже VWAP`);\nif (!compliance.no_risk_event) reasons.push(`Risk event активен`);\nif (!compliance.valid_inputs) reasons.push(`Невалидные входные данные`);\n\nif (cfg.session_gate_on && isGold && !compliance.session_ok) {\n  reasons.push(`Вне Gold Prime Time (8-21 UTC)`);\n}\n\n// *** НОВЫЙ ФИЛЬТР ДЛЯ GOLD exp1: расстояние до VWAP > 3 ATR ***\nif (isGold && dist_vwap_atr > 3) {\n  decision = 'PASS';\n  compliance.vwap_ok = false;  // явно помечаем, что вход слишком далеко от VWAP\n  reasons.push(`VWAP distance ${dist_vwap_atr.toFixed(2)} ATR > 3 ATR limit for GOLD exp1`);\n}\n\n// итоговый объект\nreturn {\n  decision: decision,\n  timestamp: new Date().toISOString(),\n  gate_ts: Date.now(),\n\n  symbol: p.symbol,\n  action: p.action,\n  reasons: reasons,\n\n  position: {\n    entry_price: p.entry_price,\n    sl: p.sl,\n    tp: p.tp,\n    qty: qty_rounded,\n    qty_required: qty_rounded,\n    qty_rounded: qty_rounded,\n    qty_hint: p.qty_hint_oz,\n    qty_hint_oz: p.qty_hint_oz,\n    risk_usd_actual: parseFloat(risk_usd.toFixed(2)),\n    risk_usd_target: parseFloat(risk_usd.toFixed(2)),\n    risk_diff_pct: risk_diff_pct\n  },\n\n  analytics: {\n    rr_calc: parseFloat(rr_calc.toFixed(3)),\n    dist_vwap_atr: parseFloat(dist_vwap_atr.toFixed(3)),\n    cmf: parseFloat(p.cmf.toFixed(4)),\n    rvol: parseFloat(p.rvol_time.toFixed(3)),\n    spread_pct: parseFloat(spread_pct.toFixed(4))\n  },\n\n  compliance: compliance,\n\n  echo: {\n    symbol: p.symbol,\n    symbol_id: p.symbol_id,\n    action: p.action,\n    dir: p.dir,\n    tf: p.tf,\n    htf: p.htf,\n    entry_price: p.entry_price,\n    sl: p.sl,\n    tp: p.tp,\n    rr: p.rr,\n    atr: p.atr,\n    cmf: p.cmf,\n    rvol: p.rvol_time,\n    rvoltime: p.rvol_time,\n    vwap: p.vwap,\n    htf_ema: p.htf_ema,\n    equity: p.equity,\n    risk_pct: p.risk_pct,\n    qty_hint_oz: p.qty_hint_oz,\n    strategy: p.strategy,\n    strategy_version: p.strategy_version,\n    experiment_id: p.experiment_id,\n    bar_time: p.bar_time,\n    is_gold: isGold,\n    gold_prime_time: p.gold_prime_time\n  },\n\n  body: src\n};\n"},"id":"3c4576ca-55a7-47ee-b8a2-27ef9cfe4618","name":"Gate GOLD v1 (control)","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1952,640]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO trade.signals_raw (\n    symbol, symbol_id, tf, htf, bar_time_ms,\n    entry_price, sl, tp, rr, equity, risk_pct,\n    cmf, rvol_time, mintick, pointvalue, lot_step,\n    session, strategy, strategy_version, gate_version, experiment_id,\n    raw_json, created_at\n)\nVALUES (\n    '{{ $json.echo.symbol }}',\n    '{{ $json.echo.symbolid }}',\n    '{{ $json.echo.tf }}',\n    '{{ $json.echo.htf }}',\n    {{ $json.echo.bar_time }},\n    {{ $json.echo.entry_price }},\n    {{ $json.echo.sl }},\n    {{ $json.echo.tp }},\n    {{ $json.echo.rr }},\n    {{ $json.echo.equity }},\n    {{ $json.echo.risk_pct }},\n    {{ $json.echo.cmf }},\n    {{ $json.echo.rvoltime }},\n    {{ $json.body.mintick }},\n    {{ $json.body.pointvalue }},\n    {{ $json.body.lot_step }},\n    '{{ $json.body.session }}',\n    '{{ $json.echo.strategy }}',\n    '{{ $json.echo.strategy_version }}',\n    'Gate_GOLD_exp1',\n    '{{ $json.echo.experiment_id }}',\n    '{{ JSON.stringify($json.body) }}'::jsonb,\n    NOW()\n);\n","options":{}},"id":"796f641e-96bc-4866-b9b8-c192e70a4b6c","name":"signals_raw","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1440,640],"credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO trade.gate_decisions (\n    symbol_id, decision, reasons, qty_req, qty_rnd,\n    risk_usd, rr, stop_dist_atr, cmf, rvol,\n    spread_pct, full_json, qty_hint_oz, action, gate_ts,\n    risk_target, risk_actual, risk_diff_pct,\n    strategy_version, gate_version, experiment_id,\n    created_at\n)\nVALUES (\n    '{{ $json.echo.symbolid }}',\n    '{{ $json.decision }}',\n    '{{ JSON.stringify($json.reasons || []) }}',\n    {{ $json.position.qty_required }},\n    {{ $json.position.qty_rounded }},\n    {{ $json.position.risk_usd_actual }},\n    {{ $json.analytics.rr_calc }},\n    {{ $json.analytics.dist_vwap_atr }},\n    {{ $json.analytics.cmf }},\n    {{ $json.analytics.rvol }},\n    {{ $json.analytics.spread_pct }},\n    '{{ JSON.stringify($json) }}'::jsonb,\n    {{ $json.echo.qty_hint_oz }},\n    '{{ $json.echo.action }}',\n    {{ $json.gate_ts }},\n    {{ $json.position.risk_usd_target }},\n    {{ $json.position.risk_usd_actual }},\n    {{ $json.position.risk_diff_pct }},\n    '{{ $json.echo.strategy_version }}',\n    'Gate_GOLD_exp1',\n    '{{ $json.echo.experiment_id }}',\n    NOW()\n);\n","options":{}},"id":"be78f159-52d8-4c63-843a-79317c012047","name":"gate_decisions","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1440,832],"credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}}},{"parameters":{"operation":"executeQuery","query":"SELECT gate_ts, symbol_id, gate_decision, ai_verdict,\n       (full_json->'analytics'->>'dist_vwap_atr')::float AS dist_vwap_atr\nFROM trade.ai_decisions\nWHERE experiment_id = 'gold_exp1'\nORDER BY gate_ts DESC;\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-2080,288],"id":"52760087-f4ae-4432-a90c-05d6264131bb","name":"findLongShit","credentials":{"postgres":{"id":"PmDbaGi6sRmIrlZN","name":"Trading DB"}}},{"parameters":{"modelName":"models/gemini-3-pro-preview","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-1328,704],"id":"8b634956-de29-4f4e-b886-b0b44aca7177","name":"Google Gemini Chat Model","credentials":{"googlePalmApi":{"id":"OGavRZ0nAmCDepHr","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ce5b5df2-2962-477e-8b9e-1e70e8f0df42","leftValue":"={{ $json.echo.gold_prime_time }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1728,560],"id":"c4232d89-93ea-4bf4-ba83-27e836e9b09e","name":"If"}],"connections":{"OpenAI Chat Model":{"ai_languageModel":[[{"node":"TradingMasterAI","type":"ai_languageModel","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"TradingMasterAI","type":"ai_outputParser","index":0}]]},"IF TAKE":{"main":[[{"node":"TradingMasterAI","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Gate GOLD v1 (control)","type":"main","index":0}]]},"TradingMasterAI":{"main":[[{"node":"Formatter","type":"main","index":0},{"node":"AI Verdict","type":"main","index":0}]]},"Formatter":{"main":[[{"node":"Me1","type":"main","index":0},{"node":"Me","type":"main","index":0},{"node":"Nurzhan","type":"main","index":0},{"node":"Nurzhan1","type":"main","index":0}]]},"Gate GOLD v1 (control)":{"main":[[{"node":"signals_raw","type":"main","index":0},{"node":"gate_decisions","type":"main","index":0},{"node":"If","type":"main","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"TradingMasterAI","type":"ai_languageModel","index":1}]]},"If":{"main":[[{"node":"IF TAKE","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"connection":"upgrade","host":"n8n.truffles.kz","x-real-ip":"34.212.75.30","x-forwarded-for":"34.212.75.30","x-forwarded-proto":"https","content-length":"584","user-agent":"Go-http-client/1.1","content-type":"application/json; charset=utf-8","accept-encoding":"gzip"},"params":{},"query":{},"body":{"action":"BUY","dir":"long","symbol":"GOLD","symbol_id":"CAPITALCOM:GOLD","tf":"15","htf":"60","entry_price":4170.95,"sl":4163.86025,"tp":4185.1295,"rr":2,"equity":500,"risk_pct":0.75,"vwap":4157.77217,"sma20":4162.121,"atr":5.90812,"cmf":0.19965,"htf_ema":4132.30667,"rvol_time":1.354,"vwap_relation":"above","gold_prime_time":true,"session":"Gold","risk_event":false,"mintick":0.01,"pointvalue":1,"lot_step":0.01,"spread_cost":0,"bar_time":1764159300373,"strategy":"Gate GOLD exp1","strategy_version":"HYBRID_CORE_v1_7_2_gold_exp1","experiment_id":"gold_exp1","qty_hint_oz":0.53},"webhookUrl":"https://n8n.truffles.kz/webhook/exp1gold","executionMode":"production"}}]},"versionId":"a2e9b671-02dd-4753-8b1b-3c3bfbf5740c","triggerCount":1,"shared":[{"updatedAt":"2025-11-27T21:18:18.259Z","createdAt":"2025-11-27T21:18:18.259Z","role":"workflow:owner","workflowId":"5Fo72obszME5y9q2","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[{"updatedAt":"2025-11-27T06:11:33.174Z","createdAt":"2025-11-27T06:11:33.174Z","id":"jpta0H3sZxVGTF8B","name":"trading"}]},{"updatedAt":"2025-11-30T14:02:11.114Z","createdAt":"2025-11-29T16:00:43.019Z","id":"Z25LwErPnfzIIDb4","name":"5_ClassifyIntent","active":false,"isArchived":false,"nodes":[{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"prompts","mode":"list","cachedResultName":"prompts"},"where":{"values":[{"column":"name","value":"intent_classifier"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[80,-112],"id":"1d111fb7-1272-47f2-9476-77fcd37ef27f","name":"GetPrompt","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"modelId":{"__rl":true,"value":"={{ $('GetPrompt').item.json.model }}","mode":"id"},"responses":{"values":[{"role":"system","content":"={{ $('GetPrompt').item.json.text }}"},{"content":"=User message: {{ $('Start').item.json.message }}\nConversation history: {{\n    $json.Context  || 'No history'\n     }}"}]},"builtInTools":{},"options":{"temperature":"={{ $('GetPrompt').item.json.temperature.toNumber() }}"}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":2,"position":[1504,-160],"id":"ef569fc3-19e0-476f-a07d-0c33ae806280","name":"Message a model","credentials":{"openAiApi":{"id":"C31JRkzPBiItNcOT","name":"OpenAi account"}}},{"parameters":{"workflowInputs":{"values":[{"name":"message"},{"name":"session_id"},{"name":"user_id"}]}},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-304,-96],"id":"c7c8092a-4e04-45ac-bfb3-843d12f112a5","name":"Start"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"messages","mode":"list","cachedResultName":"messages"},"columns":{"mappingMode":"defineBelow","value":{"user_id":"={{ $('Start').item.json.user_id }}","timestamp":"={{ new Date().toISOString() }}"},"matchingColumns":["user_id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"user_id","displayName":"user_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"role","displayName":"role","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"content","displayName":"content","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"intent","displayName":"intent","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"confidence","displayName":"confidence","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"timestamp","displayName":"timestamp","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"metadata","displayName":"metadata","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true},{"id":"channel","displayName":"channel","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1728,-320],"id":"a30625b3-8505-40a3-9e2a-530706d318f6","name":"Update rows in a table","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"assignments":{"assignments":[{"id":"d675b58d-4aff-4d72-bb6b-300a380ba147","name":"output[0].content[0].text","value":"={{ $json.output[0].content[0].text }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1728,-80],"id":"ba09ce98-59d9-498b-aa1c-e1ef1e9752fe","name":"UnpackObject"},{"parameters":{"assignments":{"assignments":[{"id":"1a0be346-b8c3-410a-9f68-c697a5e511e4","name":"intent","value":"={{ $json.output[0].content[0].text.intent }}","type":"string"},{"id":"0352f1c0-ba49-4842-853a-883a05620297","name":"confidence","value":"={{ $json.output[0].content[0].text.confidence }}","type":"number"},{"id":"1244cb32-0ac7-46d7-95b3-5accc5d19c5c","name":".language","value":"={{ $json.output[0].content[0].text.language }}","type":"string"},{"id":"2a1292de-ed28-40ef-8497-e80c4da970b7","name":"entities","value":"={{ $json.output[0].content[0].text.entities }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1936,-128],"id":"645f1d01-9a1a-4461-a27b-ca3ec00856ec","name":"Edit Fields"},{"parameters":{"operation":"select","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"messages","mode":"list","cachedResultName":"messages"},"limit":10,"where":{"values":[{"column":"session_id","value":"={{ $('Start').item.json.session_id }}"}]},"sort":{"values":[{"column":"timestamp","direction":"DESC"}]},"options":{"outputColumns":["role","content"]}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[720,-288],"id":"e1fdf4ec-45cc-42d9-b2f0-913e5e1c4e96","name":"GetContext","credentials":{"postgres":{"id":"vKMqOlLzwvXYU8uw","name":"Local"}}},{"parameters":{"operation":"get","propertyName":"Context","key":"=chat_history:{{ $('Start').item.json.session_id }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[352,-112],"id":"db40cf08-bbdb-4050-9c7f-8e51cd8f635e","name":"GetHistory","credentials":{"redis":{"id":"xMdLG7kqWMMoPY0M","name":"Local"}}},{"parameters":{"jsCode":"const messages = $input.all().map(item => {\n       return `${item.json.role}: ${item.json.content}`;\n     }).join('\\n');\n\n     return [{\n       json: { history: messages },\n       pairedItem: { item: 0 }\n     }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[944,-304],"id":"68f7288d-0746-4994-9461-6eefb20e7646","name":"Code in JavaScript"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"04058c62-b4ac-4b04-b5ca-f96e288afce0","leftValue":"={{$json.Context}}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[544,-160],"id":"b04aa42f-e646-458b-961a-5d7620b5785b","name":"If"},{"parameters":{"operation":"set","key":"=chat_history:{{ $('Start').item.json.session_id }}","value":"={{$('Code in JavaScript').first().json.history}}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1168,-304],"id":"0d1f3b28-0a3d-42ed-af8a-f2bc089b588c","name":"Redis","credentials":{"redis":{"id":"xMdLG7kqWMMoPY0M","name":"Local"}}},{"parameters":{"operation":"delete","key":"=chat_history:{{ $json.session_id }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[432,112],"id":"775d20e6-e2e9-40a4-a4fd-1c91b2d1b580","name":"Redis1","credentials":{"redis":{"id":"xMdLG7kqWMMoPY0M","name":"Local"}},"disabled":true}],"connections":{"GetPrompt":{"main":[[{"node":"GetHistory","type":"main","index":0}]]},"Start":{"main":[[{"node":"GetPrompt","type":"main","index":0},{"node":"Redis1","type":"main","index":0}]]},"Message a model":{"main":[[{"node":"Update rows in a table","type":"main","index":0},{"node":"UnpackObject","type":"main","index":0}]]},"UnpackObject":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"GetContext":{"main":[[{"node":"Code in JavaScript","type":"main","index":0}]]},"Code in JavaScript":{"main":[[{"node":"Redis","type":"main","index":0}]]},"GetHistory":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"GetContext","type":"main","index":0}],[{"node":"Message a model","type":"main","index":0}]]},"Redis":{"main":[[{"node":"Message a model","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Start":[{"json":{"message":"нет твоя мама","session_id":"77015705555@s.whatsapp.net","user_id":"16834089-a4ee-41f6-9fd7-1f8ff52da50a"}}]},"versionId":"feeb66c1-96a5-49cc-b165-86631864ddb6","triggerCount":0,"shared":[{"updatedAt":"2025-11-29T16:00:43.019Z","createdAt":"2025-11-29T16:00:43.019Z","role":"workflow:owner","workflowId":"Z25LwErPnfzIIDb4","projectId":"Edco4DKU0vG4cvNQ"}],"tags":[]}],"nextCursor":null}